# Анализ дублирования напоминаний для сделки 1680

## Проблема
По сделке 1680 приходит по 2 напоминания в день о втором платеже.

## Найденные факты

### 1. Сделка 1680
- **ID**: 1680
- **Название**: Заявка от Roman
- **Статус**: open
- **Сумма**: 750 EUR
- **График платежей**: 50/50
- **Создана**: 2025-12-03
- **Обновлена**: 2025-12-24

### 2. Напоминания в базе
- **Найдено в `proforma_reminder_logs`**: 0 записей
- Это означает, что либо напоминания не логируются, либо логируются в другую таблицу

### 3. Возможные причины дублирования

#### Причина 1: Два разных сервиса отправляют напоминания
В `src/services/scheduler.js` (строки 151-157) запускаются **ОДНОВРЕМЕННО** два сервиса:
1. `runProformaReminderCycle` - напоминания по проформам
2. `runStripeReminderCycle` - напоминания по Stripe платежам

**Проблема**: Если у сделки есть и проформа, и Stripe сессия, оба сервиса могут отправить напоминание!

#### Причина 2: Cron запускается несколько раз
- Cron выражение: `'0 9 * * *'` (ежедневно в 9:00)
- Если сервер рестартится или есть несколько инстансов, cron может запуститься несколько раз

#### Причина 3: Проблема с проверкой дубликатов
В `proformaSecondPaymentReminderService.js`:
- Метод `wasReminderSentRecently` проверяет `proforma_reminder_logs`
- Но если запись не сохранилась (ошибка при insert), проверка не сработает
- Также есть in-memory кэш `sentCache`, который сбрасывается при рестарте

#### Причина 4: Разные trigger_source
- `cron_proforma_reminder` - для проформ
- `cron_stripe_reminder` - для Stripe
- Уникальный индекс: `(deal_id, second_payment_date, sent_date)`
- Если `trigger_source` разный, но `sent_date` одинаковый, может быть конфликт

## Рекомендации по исправлению

### 1. Объединить проверку дубликатов
Создать общую таблицу `reminder_logs` для всех типов напоминаний:
- `deal_id`
- `reminder_type` (proforma/stripe)
- `sent_date`
- Уникальный индекс: `(deal_id, sent_date)` - одно напоминание в день независимо от типа

### 2. Добавить транзакционность
При отправке напоминания:
1. Проверить наличие в базе
2. Отправить сообщение
3. Сохранить в базу (в одной транзакции)

### 3. Улучшить логирование
- Логировать все попытки отправки (даже если пропущены)
- Логировать причину пропуска (уже отправлено, ошибка и т.д.)

### 4. Проверить множественные инстансы
Если приложение запущено на нескольких инстансах (Render auto-scaling), нужно использовать distributed lock

## Следующие шаги

1. ✅ Проверить логи приложения на наличие дубликатов
2. ✅ Проверить, есть ли у сделки 1680 и проформа, и Stripe сессия
3. ✅ Проверить, запускается ли cron несколько раз
4. ✅ Добавить более детальное логирование
5. ✅ Исправить логику проверки дубликатов
