# Корневая причина создания 2 сессий rest для сделки 1680

## Найденные факты

### 1. Сессии в Stripe
- **Сессия 1**: `cs_live_a1COQOrnCeJX5RozzTo0Bm7iHxb1ooEgIfzMQaTiDtkUTZK3fQtpRZHi9L`
  - Создана: 2025-12-15 22:12:24
  - Статус: expired, unpaid
  - Тип: rest

- **Сессия 2**: `cs_live_a1QZ6bfOmHxjBZCZIKTmmLBDw4dSpiTUUtJvxR7DcE2NyOyfrwPZQGTyxb`
  - Создана: 2025-12-15 22:10:59
  - Статус: expired, unpaid
  - Тип: rest

- **Разница во времени**: 1 минута 25 секунд (почти одновременно!)

### 2. Проблема в `hasSecondPaymentSession`

Метод `hasSecondPaymentSession` (строка 105-180 в `secondPaymentSchedulerService.js`):
- Проверяет только `status === 'open'` или `payment_status === 'paid'` (строка 146)
- **Просроченные сессии НЕ считаются существующими!**
- Результат: если сессия просрочена, метод вернет `false`, и может быть создана новая

### 3. Проблема в `createCheckoutSessionForDeal`

Метод `createCheckoutSessionForDeal` (строка 2506-2636 в `processor.js`):
- Проверяет `hasRest` через `existingPayments` из базы данных (строка 2518)
- Если сессия просрочена и не сохранена в базу (или сохранена, но не найдена), то `hasRest` будет `false`
- Результат: будет создана новая сессия, даже если есть просроченная

### 4. Почему создалось 2 сессии?

**Возможные причины:**

1. **Race condition**: 
   - Cron запустился дважды (или два процесса одновременно)
   - Оба вызова `hasSecondPaymentSession` вернули `false` (сессия еще не была создана)
   - Оба вызова `createSecondPaymentSession` создали сессию

2. **Проблема с проверкой в базе**:
   - Первая сессия создана, но еще не сохранена в базу
   - Второй вызов не нашел её в базе и создал вторую

3. **Проблема с проверкой в Stripe**:
   - `hasSecondPaymentSession` ищет только сессии, созданные за последние 7 дней (строка 130)
   - Если сессия старше 7 дней, она не будет найдена
   - Но это не наш случай (сессии созданы 2025-12-15, сегодня 2025-12-24)

## Решение

### Вариант 1: Исправить `hasSecondPaymentSession`
Проверять не только активные/оплаченные сессии, но и просроченные (за последние 30 дней):
- Если есть просроченная сессия типа `rest`, вернуть `true`
- Это предотвратит создание новой сессии

### Вариант 2: Исправить `processExpiredSessions`
В `findExpiredSessionTasks` дедуплицировать задачи по `deal_id`:
- Если для одной сделки есть несколько просроченных сессий типа `rest`, обработать только одну
- Это предотвратит отправку нескольких напоминаний

### Вариант 3: Добавить транзакционность
При создании сессии:
1. Проверить существование (с блокировкой)
2. Создать сессию
3. Сохранить в базу (в одной транзакции)

## Рекомендация

**Исправить `hasSecondPaymentSession`** - это корневая причина. Метод должен проверять не только активные сессии, но и просроченные (за последние 30 дней), чтобы не создавать дубликаты.
