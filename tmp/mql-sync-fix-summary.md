# Исправление проблемы с потерей данных в маркетинговом отчете

## Проблема
Цифры в маркетинговом отчете "слетают" после обновления раз в неделю, особенно те, что связаны с CRM (Pipedrive).

## Причина
При обновлении только текущего месяца (`runCurrentMonthOnly`) счетчики `won_deals`, `closed_deals` и `repeat_deals` для других месяцев не обновлялись из новых данных Pipedrive. Это происходило потому, что:

1. Данные для других месяцев загружались из существующих snapshots
2. Счетчики `won_deals`, `closed_deals` и `repeat_deals` восстанавливались из старых значений
3. Новые данные из Pipedrive собирались, но счетчики для других месяцев не обновлялись

## Решение
Исправлена логика в методе `runCurrentMonthOnly`:

1. **Для текущего месяца**: используются все новые данные (MQL, won_deals, closed_deals, etc.)
2. **Для других месяцев**: 
   - Сохраняются старые значения `pipedrive_mql` и `sendpulse_mql` (чтобы не пересчитывать историю)
   - **НО** счетчики `won_deals`, `closed_deals` и `repeat_deals` обновляются из новых данных Pipedrive
   - Это важно, так как сделки могут обновляться (меняться статус) даже после того, как месяц прошел

3. **Метрики стоимости** пересчитываются с учетом обновленных данных:
   - `cost_per_mql` = budget / combined_mql
   - `cost_per_deal` = budget / won_deals
   - `cost_per_subscriber` = budget / new_subscribers

## Изменения в коде

### Файл: `src/services/analytics/mqlSyncService.js`

1. **Метод `runCurrentMonthOnly`**:
   - Не восстанавливает старые значения `won_deals`, `closed_deals`, `repeat_deals` для других месяцев
   - Обновляет эти счетчики из новых данных Pipedrive для всех месяцев
   - Пересчитывает метрики стоимости с учетом обновленных данных
   - Добавлено логирование обновлений для других месяцев

2. **Метод `collectPipedrive`**:
   - Добавлено логирование количества собранных сделок

## Проверка данных

Создан скрипт для проверки целостности данных:
- `scripts/analytics/checkMqlDataIntegrity.js`

Скрипт проверяет:
- Наличие данных из Pipedrive для каждого месяца
- Соответствие данных в snapshots и leads
- Актуальность дат синхронизации
- Проблемы с нулевыми значениями при наличии лидов

## Как проверить исправление

1. Запустить проверку данных:
   ```bash
   node scripts/analytics/checkMqlDataIntegrity.js 2025
   ```

2. Проверить логи после следующего обновления:
   - Должны появиться сообщения об обновлении won/closed/repeat deals для прошлых месяцев
   - Счетчики должны обновляться даже для месяцев, которые уже прошли

3. Проверить отчет в UI:
   - Цифры для прошлых месяцев должны обновляться при изменении статусов сделок в Pipedrive

## Важные замечания

1. **Cutoff date**: Используется для оптимизации, но не должен пропускать обновленные сделки. Если сделка была обновлена недавно (update_time > cutoffDate), она попадет в выборку, даже если была создана давно.

2. **Производительность**: При обновлении только текущего месяца, данные из Pipedrive все равно собираются для всех месяцев (для обновления счетчиков won_deals). Это необходимо для корректности данных.

3. **Полная синхронизация**: Для полной синхронизации (например, раз в неделю) рекомендуется использовать метод `run()` без параметра `currentMonthOnly`, чтобы пересчитать все данные.
