# Анализ обработки webhook для сделки #2048

## Факты

### Платеж
- **Session ID**: `cs_live_a1hxYIqkFtBngUAXoVpZtBL4lbKrTj7UJmpm6qQwoxE2Zzx1BtoFLvbKBf`
- **Тип**: `single`
- **Сумма**: 700 EUR
- **Статус**: `paid`
- **Создан**: 2026-01-11T21:14:58
- **Обработан**: 2026-01-11T21:14:58 (0 минут разницы)

### Webhook
- ✅ Webhook пришел и обработан
- ✅ Событие сохранено в `stripe_event_items`
- ✅ Платеж сохранен в БД
- ✅ Заметка добавлена в сделку (2026-01-11 21:14:59)

### Автоматизация статусов
- ❌ **НЕ сработала сразу** при обработке webhook
- ✅ Статус обновлен на 39 (Camp Waiter) только **2026-01-12T16:31:49**
- ⏱️ **Задержка: 1156.85 минут (~19 часов)**

### Уведомления
- ❌ Не отправлены при обработке webhook
- ⚠️ В коде есть вызов `sendPaymentSuccessNotificationForDeal` (строка 404)

## Анализ кода

### Порядок операций в `persistSession`:
1. ✅ Строка 963: `savePayment()` - платеж сохранен
2. ✅ Строка 1401: `triggerCrmStatusAutomation()` - автоматизация вызвана
3. ✅ Строка 1409: `addPaymentNoteToDeal()` - заметка добавлена

### Логика для single платежа (строка 1394):
```javascript
if (paymentType === 'single' && session.payment_status === 'paid') {
  await this.triggerCrmStatusAutomation(dealId, {
    reason: 'stripe:single-payment-paid',
    paymentType: 'single'
  });
  // ...
  return; // Exit early
}
```

## Возможные причины

### 1. Ошибка в `triggerCrmStatusAutomation`
- Метод имеет try-catch (строка 190), который логирует ошибки как warnings
- Ошибка могла быть проигнорирована
- **Нужно проверить логи на момент 2026-01-11 21:14:58**

### 2. Snapshot не нашел платеж
- `buildDealSnapshot` вызывает `loadStripePayments` (строка 51)
- `loadStripePayments` использует `repository.listPayments({ dealId })`
- Платеж сохранен ДО вызова автоматизации, но возможна проблема с транзакцией/кэшем

### 3. Условие в `canUpdateStage` вернуло false
- Метод проверяет множество условий (строка 400+)
- Возможно, одно из условий не выполнилось

### 4. Уведомления не отправлены
- Вызов `sendPaymentSuccessNotificationForDeal` обернут в try-catch
- Ошибка могла быть проигнорирована
- **Нужно проверить логи на момент 2026-01-11 21:14:58**

## Рекомендации

1. **Проверить логи сервера** на момент 2026-01-11 21:14:58 для поиска ошибок
2. **Добавить более детальное логирование** в `triggerCrmStatusAutomation` и `syncDealStage`
3. **Проверить, не было ли исключения** при вызове автоматизации
4. **Проверить логи SendPulse** для уведомлений

## Вывод

Автоматизация и уведомления **должны были сработать**, но не сработали. Статус был обновлен позже (возможно, при повторной обработке процессором или вручную). Нужно найти причину в логах.





