# План перехода на базу данных и учёт платежей

## 1. Архитектура и подготовка

- Определить СУБД (для старта допускается локальный Postgres или SQLite).
- Спроектировать таблицы: `proformas`, `proforma_products`, `payments`, `payment_matching_history`.
- Настроить миграции: создание таблиц, индексация по `date`, `fullnumber`, `proforma_id`, уникальные ограничения на `id` проформ и `external_id` платежей.

## 2. Интеграция процессора проформ

- После успешного создания проформы в wFirma сохранять поля `id`, `fullnumber`, `date`, `currency`, `total`, `currency_exchange`.
- Сохранять продукты проформы (название или `good.id` в качестве резервного варианта) по связи `proforma_id`.
- Перед сохранением продукта проверять дубликаты по названию (case-insensitive) внутри проформы и в таблице `proforma_products`; при совпадении обновлять существующую запись вместо создания новой.
- Обеспечить идемпотентность: при повторном событии обновлять запись, не создавая дубликатов.
- Инициализировать `payments_total = 0`, фиксировать дату создания/обновления.
- Поддержать сценарий «Удалить» в CRM: новое значение поля `Invoice type`, при котором сервис:
  - находит связанную проформу (по сохранённому `invoiceId` или матчу в Supabase);
  - удаляет/аннулирует документ в wFirma и либо удаляет запись в Supabase, либо помечает `deleted_at`;
  - после успешного завершения сбрасывает триггер в Pipedrive.

## 3. Импорт и хранение платежей

- Реализовать загрузку CSV (разделитель `;`): валидация структуры, логирование ошибок, контроль дублей по `external_id`.
- Таблица `payments`: сумма, валюта, дата, описание, payer, источник (`csv_bank` или `wfirma_api`), обязательная ссылка на `proforma_id`, статус сопоставления.
- После каждого платежа пересчитывать `payments_total` как сумму привязанных платежей; поддерживать данные для месячных/годовых сводок (старт с августа 2025).
- Вычислять остаток (total - payments_total) и статус (Paid / Partially Paid / Unpaid).

## 4. Автосопоставление платежей

- Алгоритм матчингa: 
  1. точное совпадение номера проформы в назначении платежа;
  2. совпадение имени плательщика с клиентом проформы;
  3. точное совпадение суммы.
- Фиксировать уровень уверенности, результаты хранить в `payment_matching_history`.
- Платежи без уверенного совпадения помечать как `needs_review` и оставлять для ручной обработки в UI.

## 5. Источник оплат из wFirma

- Проверить наличие API wFirma для выгрузки банковских оплат.
- При наличии добавить как дополнительный источник (планировщик синхронизации, дедубликация с CSV).
- При отсутствии задокументировать и оставить CSV как основной канал, но сохранить расширяемость.

## 6. REST API и фронтенд

- Backend-эндпоинты: сводка по месяцам/годам, детализация продуктов, управление платежами и сопоставлением.
- Адаптация существующего UI: переход с `node-cache` на БД, отображение статусов оплаты и остатков.
- Добавить раздел «Сопоставление платежей» для полуавтоматической работы.

## 7. Тестирование и запуск

- Юнит-тесты: сохранение проформ, дедупликация, расчёт `payments_total`.
- Сквозные тесты: импорт CSV → автосопоставление → обновление отчёта.
- Нагрузочные проверки отчётности на диапазоне ~2 лет данных.
- План миграции/отката: резервное копирование, флаги переключения, мониторинг ошибок после релиза.


