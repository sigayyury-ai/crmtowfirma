# –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π –∏–∑ Events –∫–∞–±–∏–Ω–µ—Ç–∞

## –û–±–∑–æ—Ä

–ö–æ–≥–¥–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Ö–æ–¥–∏—Ç –æ–ø–ª–∞—á–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é —Å `deal_id` –≤ Events –∫–∞–±–∏–Ω–µ—Ç–µ, –æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É, –∫–∞–∫ –µ—Å–ª–∏ –±—ã —ç—Ç–æ –±—ã–ª–∞ –æ–±—ã—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ webhook.

## –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

### 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (`persistSession`)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `stripe_payments`
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ:
  - `session_id` - ID —Å–µ—Å—Å–∏–∏ –∏–∑ Stripe
  - `deal_id` - ID —Å–¥–µ–ª–∫–∏ –∏–∑ Pipedrive
  - `payment_status` - —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (`paid`, `unpaid`, etc.)
  - `original_amount` - —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
  - `currency` - –≤–∞–ª—é—Ç–∞
  - `amount_pln` - —Å—É–º–º–∞ –≤ PLN (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
  - `payment_type` - —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∞ (`deposit`, `rest`, `single`)
  - `payment_schedule` - –≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π (`50/50`, `100%`)
  - `customer_email` - email –∫–ª–∏–µ–Ω—Ç–∞
  - `checkout_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
  - `invoice_number` / `receipt_number` - –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞/—á–µ–∫–∞ (–¥–ª—è B2B/B2C)
  - `created_at` / `updated_at` - –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –ø–ª–∞—Ç–µ–∂ –±—ã–ª –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–≥ –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å CRM.

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ event items (`persistEventItems`)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö/—É—Å–ª—É–≥–∞—Ö –∏–∑ —Å–µ—Å—Å–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É `stripe_event_items`
- –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º

**–ó–∞—á–µ–º:** –î–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º –∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º.

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–ª–∞—Ç–µ–∂–µ–π (`updatePlanFromSession`)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–µ –ø–ª–∞—Ç–µ–∂–µ–π (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- –°–≤—è–∑—ã–≤–∞—é—Ç—Å—è –ø–ª–∞—Ç–µ–∂–∏ —Å –ø–ª–∞–Ω–æ–º

**–ó–∞—á–µ–º:** –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ç–æ—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π.

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–∫–∏ –≤ CRM (`syncDealStage`)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —Å–¥–µ–ª–∫–∏ (Stripe + –Ω–∞–ª–∏—á–Ω—ã–µ)
- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –ø—Ä–æ—Ñ–æ—Ä–º—ã –¥–ª—è —Å–¥–µ–ª–∫–∏
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–µ–π:
  - –°–∫–æ–ª—å–∫–æ –æ–ø–ª–∞—á–µ–Ω–æ
  - –°–∫–æ–ª—å–∫–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è
  - –ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π (50/50 –∏–ª–∏ 100%)
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è —Å–¥–µ–ª–∫–∏:
  - `First Payment` (18) - –µ—Å–ª–∏ –æ–ø–ª–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂
  - `Second Payment` (32) - –µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂
  - `Camp Waiter` (27) - –µ—Å–ª–∏ –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –æ–ø–ª–∞—á–µ–Ω—ã
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞–¥–∏—è —Å–¥–µ–ª–∫–∏ –≤ Pipedrive

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –≤ CRM —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª —Ä–µ–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø–ª–∞—Ç–µ–∂–µ–π.

### 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É (–¥–ª—è B2B)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –ï—Å–ª–∏ —ç—Ç–æ B2B —Å–¥–µ–ª–∫–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ Stripe API
- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å –≤ –∑–∞–º–µ—Ç–∫—É –∫ —Å–¥–µ–ª–∫–µ

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –∏–Ω–≤–æ–π—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã.

### 6. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ–∫–∞ –∫–ª–∏–µ–Ω—Ç—É (–¥–ª—è B2C)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –ï—Å–ª–∏ —ç—Ç–æ B2C —Å–¥–µ–ª–∫–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ–∫ —á–µ—Ä–µ–∑ Stripe API
- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–µ–∫–µ –≤ –∑–∞–º–µ—Ç–∫—É –∫ —Å–¥–µ–ª–∫–µ

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã.

### 7. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏–π –ø–æ –Ω–∞–ª–∏—á–Ω—ã–º (`syncCashExpectationFromStripeSession`)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –ï—Å–ª–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–Ω—ã—Ö (`cash_amount_expected`), —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `cash_payments`
- –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–∂–∏–¥–∞–µ–º—ã—Ö –Ω–∞–ª–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ –∑–Ω–∞–ª–∞, —á—Ç–æ –ø–æ—Å–ª–µ Stripe –ø–ª–∞—Ç–µ–∂–∞ –æ–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞–ª–∏—á–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫.

### 8. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è:**
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ SendPulse
- –°–æ–æ–±—â–µ–Ω–∏–µ: "‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞" + —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å/—á–µ–∫

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –∑–Ω–∞–ª, —á—Ç–æ –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.

## –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é:**
   ```
   Session: cs_live_xxx
   Deal: #2039
   Status: paid
   Amount: 1.00 EUR
   ```

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**
   ```sql
   INSERT INTO stripe_payments (
     session_id, deal_id, payment_status, 
     original_amount, currency, ...
   ) VALUES (...)
   ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CRM:**
   ```
   Deal #2039:
   - –°—Ç–∞—Ä–∞—è —Å—Ç–∞–¥–∏—è: First Payment (18)
   - –ù–æ–≤–∞—è —Å—Ç–∞–¥–∏—è: Camp Waiter (27) - –µ—Å–ª–∏ –≤—Å–µ –æ–ø–ª–∞—á–µ–Ω–æ
   ```

4. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   ```
   Telegram ‚Üí –ö–ª–∏–µ–Ω—Ç—É:
   "‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞
   –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å: https://..."
   ```

## –í–∞–∂–Ω–æ

- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π** (`payment_status === 'paid'`)
- –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
- –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ (–µ—Å—Ç—å –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `paid`), –æ–Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ —Ç–µ –∂–µ —Å–µ—Ä–≤–∏—Å—ã, —á—Ç–æ –∏ –æ–±—ã—á–Ω—ã–µ webhook'–∏, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–¥–µ–Ω—Ç–∏—á–µ–Ω

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:
```
üí∞ Processing paid session from Events cabinet
   dealId: 2039
   sessionId: cs_live_xxx
   amount: 1.00 EUR
```

–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```
‚úÖ Events Cabinet sessions check completed
   processed: 1
   skipped: 0
   errors: 0
```

