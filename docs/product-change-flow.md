# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Å–¥–µ–ª–∫–µ

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Å–¥–µ–ª–∫–µ Pipedrive, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—É –ø—Ä–æ—Ñ–æ—Ä–º—ã, –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ—ë –≤ wFirma –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

## –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```
Webhook –æ—Ç Pipedrive
    ‚Üì
–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ product_id)
    ‚Üì
–ü–µ—Ä–µ—Å—á–µ—Ç —Å—É–º–º—ã (–Ω–æ–≤–∞—è —Å—É–º–º–∞ - –æ–ø–ª–∞—á–µ–Ω–æ = –æ—Å—Ç–∞—Ç–æ–∫)
    ‚Üì
–†–∞—Å—á–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∏ ‚Üí –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫ –∫–∞–∫ –≤—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂)
    ‚Üì
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–æ—Ä–º—ã –≤ wFirma
    ‚Üì
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ (proforma_products)
    ‚Üì
–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ Pipedrive (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂)
    ‚Üì
–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ—É—Ç–∞ –≤ Pipedrive (—Å–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    ‚Üì
–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ SendPulse (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
    ‚Üì
–ö—Ä–æ–Ω-–∑–∞–¥–∞—á–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
```

## –¢—Ä–∏–≥–≥–µ—Ä

–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Å–¥–µ–ª–∫–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook –æ—Ç Pipedrive. –°–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–¥—É–∫—Ç –∏–∑ Pipedrive —Å –ø—Ä–æ–¥—É–∫—Ç–æ–º, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º –∫ –ø—Ä–æ—Ñ–æ—Ä–º–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É—è `product_id` –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç–∞–±–ª–∏—Ü—ã `products`.

## –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 1. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞

- –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–¥—É–∫—Ç –∏–∑ Pipedrive
- –ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `ensureProductId()`
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `product_id` —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —Å `product_id` –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `proforma_products`
- –ï—Å–ª–∏ `product_id` –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Üí –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞

**–í–∞–∂–Ω–æ:** –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ `product_id` –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∞ –Ω–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞.

### 2. –ü–µ—Ä–µ—Å—á–µ—Ç —Å—É–º–º—ã

–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ –ø–æ —Ñ–æ—Ä–º—É–ª–µ:

```
–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ = –ù–æ–≤–∞—è —Å—É–º–º–∞ —Å–¥–µ–ª–∫–∏ - –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
```

**–í–∞–∂–Ω–æ:** –°—Ç–∞—Ä–∞—è —Å—É–º–º–∞ –ø—Ä–æ—Ñ–æ—Ä–º—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ –æ—Å—Ç–∞—Ç–∫–∞. –°–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –Ω–æ–≤—É—é —Å—É–º–º—É –Ω–∞–ø—Ä—è–º—É—é —Å —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏.

**–ü—Ä–∏–º–µ—Ä:**
- –°—Ç–∞—Ä–∞—è —Å—É–º–º–∞ –ø—Ä–æ—Ñ–æ—Ä–º—ã: 2019 PLN
- –ù–æ–≤–∞—è —Å—É–º–º–∞ —Å–¥–µ–ª–∫–∏: 3605 PLN
- –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ: 2019 PLN
- **–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ: 3605 - 2019 = 1586 PLN**

### 3. –†–∞—Å—á–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π

#### –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∏ (`hasPayments = true`):
- **–ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è** –≥—Ä–∞—Ñ–∏–∫ 50/50
- –í–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ **–æ–¥–∏–Ω –≤—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂**
- –î–∞—Ç–∞ –≤—Ç–æ—Ä–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞: `expected_close_date - 1 –º–µ—Å—è—Ü`

#### –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç (`hasPayments = false`):
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞:
  - –ï—Å–ª–∏ –¥–æ `expected_close_date` > 30 –¥–Ω–µ–π ‚Üí –≥—Ä–∞—Ñ–∏–∫ 50/50
  - –ï—Å–ª–∏ –¥–æ `expected_close_date` ‚â§ 30 –¥–Ω–µ–π ‚Üí –≥—Ä–∞—Ñ–∏–∫ 100%

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í —Å–ª—É—á–∞–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –æ–±—ã—á–Ω–æ —É–∂–µ –µ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∏, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–æ—Ä–º—ã –≤ wFirma

–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø—Ä–æ—Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `updateProformaLines()`:
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—É–º–º–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ–ø–∏—Å–∞–Ω–∏–µ —Å –Ω–æ–≤—ã–º –≥—Ä–∞—Ñ–∏–∫–æ–º –ø–ª–∞—Ç–µ–∂–µ–π
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ wFirma:
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ `proforma_products` —á–µ—Ä–µ–∑ `persistProformaToDatabase()`
- –°–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å –ø—Ä–æ—Ñ–æ—Ä–º–æ–π
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—É–º–º–∞ –ø—Ä–æ—Ñ–æ—Ä–º—ã –≤ —Ç–∞–±–ª–∏—Ü–µ `proformas`

### 6. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ Pipedrive

–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ —Å —Ç–µ–º–æ–π:
```
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –ø–æ –ø—Ä–æ—Ñ–æ—Ä–º–µ [–Ω–æ–º–µ—Ä –ø—Ä–æ—Ñ–æ—Ä–º—ã]
```

- –°—Ä–æ–∫: –∑–∞–≤—Ç—Ä–∞
- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: "–ü—Ä–æ—Ñ–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞."

### 7. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ—É—Ç–∞ –≤ Pipedrive

–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ—É—Ç –≤ —Å–¥–µ–ª–∫—É —Å–æ —Å–≤–æ–¥–∫–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```
üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞

üìã –ü—Ä–æ—Ñ–æ—Ä–º–∞: [–Ω–æ–º–µ—Ä]

üì¶ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:
   –ë—ã–ª–æ: "[—Å—Ç–∞—Ä—ã–π –ø—Ä–æ–¥—É–∫—Ç]"
   –°—Ç–∞–ª–æ: "[–Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç]"

üí∞ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã:
   –ë—ã–ª–æ: [—Å—Ç–∞—Ä–∞—è —Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞]
   –°—Ç–∞–ª–æ: [–Ω–æ–≤–∞—è —Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞]
   –†–∞–∑–Ω–∏—Ü–∞: [—Ä–∞–∑–Ω–∏—Ü–∞] [–≤–∞–ª—é—Ç–∞]

üí≥ –ü–ª–∞—Ç–µ–∂–∏:
   –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ: [–æ–ø–ª–∞—á–µ–Ω–æ] [–≤–∞–ª—é—Ç–∞]
   –û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ: [–æ—Å—Ç–∞—Ç–æ–∫] [–≤–∞–ª—é—Ç–∞]
   –î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞: [–¥–∞—Ç–∞]

‚úÖ –ü—Ä–æ—Ñ–æ—Ä–º–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ wFirma.
```

### 8. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

–ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ª–æ–≤–∏—è:
- `remainingAmount > 0` (–µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ)
- `secondPaymentDateStr` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–µ—Å—Ç—å –¥–∞—Ç–∞ –≤—Ç–æ—Ä–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞)
- `hasPayments = true` (—É–∂–µ –±—ã–ª–∏ –ø–ª–∞—Ç–µ–∂–∏)

–°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SendPulse:

```
–ü—Ä–∏–≤–µ—Ç, [–∏–º—è]!

–û–±–Ω–æ–≤–∏–ª–∏ –∫–µ–º–ø –Ω–∞ "[–Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç]".

–ü—Ä–æ—Ñ–æ—Ä–º–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞: [–Ω–æ–º–µ—Ä –ø—Ä–æ—Ñ–æ—Ä–º—ã]

–†–∞—Å—á–µ—Ç:
- –ù–æ–≤–∞—è —Å—É–º–º–∞: [—Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞]
- –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ: [—Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞]
- –û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ: [—Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞]

–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞: [–¥–∞—Ç–∞]
–°—á–µ—Ç: [–Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞]

–í –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —É–∫–∞–∂–∏—Ç–µ: "[–Ω–æ–º–µ—Ä –ø—Ä–æ—Ñ–æ—Ä–º—ã]"
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ (–ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ), –±–µ–∑ —Ñ–∞–º–∏–ª–∏–∏
- –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ wFirma –ø–æ –≤–∞–ª—é—Ç–µ
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–æ—Ä–º—ã

### 9. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫—Ä–æ–Ω

–ö—Ä–æ–Ω-–∑–∞–¥–∞—á–∞ `ProformaSecondPaymentReminderService.processAllDeals()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç —ç—Ç—É —Å–¥–µ–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞, –µ—Å–ª–∏:

- –ï—Å—Ç—å –ø—Ä–æ—Ñ–æ—Ä–º–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ï—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∏ (`hasPayments = true`)
- –ï—Å—Ç—å `expected_close_date` –≤ —Å–¥–µ–ª–∫–µ
- –î–∞—Ç–∞ –≤—Ç–æ—Ä–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞

**–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–±–µ–∑ —ç–º–æ–¥–∂–∏):**

```
–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤—Ç–æ—Ä–æ–º –ø–ª–∞—Ç–µ–∂–µ

–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, [–∏–º—è]!

–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ–± –æ–ø–ª–∞—Ç–µ –≤—Ç–æ—Ä–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ —Å–¥–µ–ª–∫–µ "[–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏]".

–°—É–º–º–∞: [—Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞]
–ü—Ä–æ—Ñ–æ—Ä–º–∞: [–Ω–æ–º–µ—Ä –ø—Ä–æ—Ñ–æ—Ä–º—ã]
–°—á–µ—Ç: [–Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞]

–£–∫–∞–∂–∏—Ç–µ "[–Ω–æ–º–µ—Ä –ø—Ä–æ—Ñ–æ—Ä–º—ã]" –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞.
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ (–±–µ–∑ —Ñ–∞–º–∏–ª–∏–∏)
- –ë–µ–∑ —ç–º–æ–¥–∂–∏
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–æ—Ä–º—ã –≤ wFirma –Ω–µ —É–¥–∞–ª–æ—Å—å:

1. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ –≤ Pipedrive:
   ```
   –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–æ—Ä–º—ã [–Ω–æ–º–µ—Ä –ø—Ä–æ—Ñ–æ—Ä–º—ã]
   ```
   - –°—Ä–æ–∫: –∑–∞–≤—Ç—Ä–∞
   - –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–æ—Ä–º—ã –≤ wFirma –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é. –û—à–∏–±–∫–∞: [–æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏]"

2. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ—É—Ç –≤ —Å–¥–µ–ª–∫—É:
   ```
   ‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–æ—Ä–º—ã: [–æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏]. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é.
   ```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

```javascript
// –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
const { data: proformaProductData } = await supabase
  .from('proforma_products')
  .select('product_id, products(id, name)')
  .eq('proforma_id', existingProforma.invoiceId)
  .single();

const previousProductId = proformaProductData.product_id;

// –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑–µ
const currentProductIdInDb = await proformaRepository.ensureProductId(currentProductName);

// –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ ID
const productChanged = previousProductId !== null && 
  currentProductIdInDb !== null && 
  String(previousProductId) !== String(currentProductIdInDb);
```

### –†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞

```javascript
// –ü–æ–ª—É—á–∞–µ–º —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
const { data: paymentRows } = await supabase
  .from('payments')
  .select('amount, currency')
  .eq('manual_status', 'approved')
  .eq('manual_proforma_id', existingProforma.invoiceId);

const paidAmount = paymentRows.reduce((sum, p) => sum + parseFloat(p.amount), 0);

// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫ (–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é —Å—É–º–º—É –ø—Ä–æ—Ñ–æ—Ä–º—ã)
const totalAmountValue = parseFloat(fullDeal.value) || 0;
const remainingAmount = Math.max(0, totalAmountValue - paidAmount);
```

### –£—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

```javascript
if (remainingAmount > 0 && secondPaymentDateStr && hasPayments) {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫—Ä–æ–Ω-–∑–∞–¥–∞—á–∏
}
```

## –§–∞–π–ª—ã –∫–æ–¥–∞

- **Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫**: `src/routes/pipedriveWebhook.js` (—Å—Ç—Ä–æ–∫–∏ ~1770-2291)
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–æ—Ä–º—ã**: `src/services/invoiceProcessing.js` (–º–µ—Ç–æ–¥ `updateProformaLines`)
- **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è**: `src/services/proformaSecondPaymentReminderService.js`
- **SendPulse –∫–ª–∏–µ–Ω—Ç**: `src/services/sendpulse.js`

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–ª–æ—É

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–¥–µ–ª–∫–∏ 1623
node scripts/test-product-change-recalculation-1623.js

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–∫–∏ –∏ –ø—Ä–æ—Ñ–æ—Ä–º—ã
node scripts/get-deal-and-proforma-1623.js

# –†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É
node scripts/send-message-to-client-1623.js
```

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ ID, –∞ –Ω–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é**: –ü—Ä–æ–¥—É–∫—Ç—ã —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è –ø–æ `product_id` –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

2. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤**: –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ensureProductId()`.

3. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç invoice_type**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ–ª—è `invoice_type` –≤ —Å–¥–µ–ª–∫–µ.

4. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + –∫—Ä–æ–Ω**: –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:
   - –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ (—Å —Ä–∞—Å—á–µ—Ç–æ–º)
   - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –∫—Ä–æ–Ω (–±–µ–∑ —ç–º–æ–¥–∂–∏)

5. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**: –ö—Ä–æ–Ω-–∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –±—ã–ª–æ –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

