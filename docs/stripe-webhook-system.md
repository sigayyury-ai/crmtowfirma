# Stripe Webhook System - –°–∏—Å—Ç–µ–º–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Stripe webhook —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–¥–µ–ª–æ–∫ –≤ Pipedrive.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. Endpoint

**URL:** `https://invoices.comoon.io/api/webhooks/stripe`  
**–ú–µ—Ç–æ–¥:** `POST` (–æ—Å–Ω–æ–≤–Ω–æ–π), `GET` (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏)

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–∞:**
- –§–∞–π–ª: `src/routes/stripeWebhook.js`
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: `src/index.js:72` - `app.use('/api', stripeWebhookRoutes)`
- **–í–ê–ñ–ù–û:** –†–æ—É—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –î–û `express.json()` middleware, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `express.raw()` –¥–ª—è raw body

### 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è

–°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ Stripe webhook —Å–æ–±—ã—Ç–∏—è:

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ | –ö–æ–¥ |
|---------|----------|----------|-----|
| `checkout.session.completed` | –ü–ª–∞—Ç–µ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω | `updatePaymentStatus()` ‚Üí `persistSession()` ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞, –Ω–æ—É—Ç, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ | `stripeWebhook.js:86-99` |
| `checkout.session.async_payment_succeeded` | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω | `updatePaymentStatus()` ‚Üí `persistSession()` | `stripeWebhook.js:102-123` |
| `checkout.session.async_payment_failed` | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –Ω–µ—É–¥–∞—á–µ–Ω | `updatePaymentStatus(unpaid)` | `stripeWebhook.js:126-144` |
| `checkout.session.expired` | –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ | `updatePaymentStatus(unpaid)` | `stripeWebhook.js:147-165` |
| `payment_intent.succeeded` | Payment Intent —É—Å–ø–µ—à–µ–Ω | –ü–æ–ª—É—á–µ–Ω–∏–µ session ‚Üí `updatePaymentStatus()` ‚Üí `persistSession()` | `stripeWebhook.js:168-197` |
| `payment_intent.payment_failed` | Payment Intent –Ω–µ—É–¥–∞—á–µ–Ω | –ü–æ–ª—É—á–µ–Ω–∏–µ session ‚Üí `updatePaymentStatus(unpaid)` | `stripeWebhook.js:214-239` |
| `payment_intent.created` | Payment Intent —Å–æ–∑–¥–∞–Ω | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è) | `stripeWebhook.js:345-370` |
| `charge.refunded` | –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ | `triggerCrmStatusAutomation()` –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ | `stripeWebhook.js:242-270` |
| `charge.updated` | Charge –æ–±–Ω–æ–≤–ª–µ–Ω | `updatePaymentStatus()` ‚Üí `persistSession()` –µ—Å–ª–∏ succeeded | `stripeWebhook.js:273-310` |
| `charge.succeeded` | Charge —É—Å–ø–µ—à–µ–Ω | `updatePaymentStatus(paid)` ‚Üí `persistSession()` | `stripeWebhook.js:313-342` |
| `invoice.sent` | –ò–Ω–≤–æ–π—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è B2B) | `stripeWebhook.js:373-390` |

### 3. Flow –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞

```
1. –ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç Stripe Checkout Session
   ‚Üì
2. Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook —Å–æ–±—ã—Ç–∏–µ checkout.session.completed
   ‚Üì
3. Endpoint –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ ‚Üí –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (stripe.webhooks.constructEvent)
   ‚Üì
4. repository.updatePaymentStatus() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ë–î
   ‚Üì
5. processor.persistSession() - –æ—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (processor.js:550+):
   
   a) –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:
      - –ü–æ–ª—É—á–µ–Ω–∏–µ deal –∏–∑ Pipedrive API
      - –ü–æ–ª—É—á–µ–Ω–∏–µ CRM context (B2B/B2C, –∞–¥—Ä–µ—Å, VAT)
      - –ü–æ–ª—É—á–µ–Ω–∏–µ participant (email, –∏–º—è, –∞–¥—Ä–µ—Å)
   
   b) –†–∞—Å—á–µ—Ç—ã:
      - –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –≤ PLN (–≤–∞–ª—é—Ç–Ω—ã–π –∫—É—Ä—Å)
      - –†–∞—Å—á–µ—Ç VAT (23% –¥–ª—è PL, —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
      - –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ (–¥–ª—è VAT)
   
   c) –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:
      - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ stripe_payments
      - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ invoice_number / receipt_number
      - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ checkout_url
   
   d) –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω–≤–æ–π—Å–∞:
      - –î–ª—è B2B –∏ B2C: –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Stripe API
      - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ VAT breakdown –≤ footer (–¥–ª—è PL)
      - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ customer email –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
   
   e) –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–∫–∏:
      - triggerCrmStatusAutomation() ‚Üí syncDealStage()
      - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∞
      - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ Pipedrive
      - sendPaymentReceivedNotification() - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚úÖ –¢–≤–æ–π –ø–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω, —Å–ø–∞—Å–∏–±–æ!"
   
   f) –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ—É—Ç–∞:
      - addPaymentNoteToDeal() - –Ω–æ—É—Ç –æ –ø–ª–∞—Ç–µ–∂–µ
      - addAllPaymentsCompleteNote() - –µ—Å–ª–∏ –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –æ–ø–ª–∞—á–µ–Ω—ã
   
   ‚Üì
6. syncCashExpectationFromStripeSession() - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è cash –æ–∂–∏–¥–∞–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–¥–µ–ª–æ–∫

–õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ —á–µ—Ä–µ–∑ `persistSession()`:

| –¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞ | –£—Å–ª–æ–≤–∏–µ | –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-------------|---------|--------------|------------|
| `single` | –õ—é–±–æ–π | Camp Waiter (27) | –ï–¥–∏–Ω—ã–π –ø–ª–∞—Ç–µ–∂ |
| `deposit` | –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂, < 30 –¥–Ω–µ–π –¥–æ close_date | Camp Waiter (27) | –û–¥–∏–Ω –ø–ª–∞—Ç–µ–∂ –æ–∂–∏–¥–∞–µ—Ç—Å—è |
| `deposit` | –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂, >= 30 –¥–Ω–µ–π –¥–æ close_date | Second Payment (32) | –ñ–¥–µ–º –≤—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂ |
| `rest` | –í—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂, –æ–±–∞ –æ–ø–ª–∞—á–µ–Ω—ã | Camp Waiter (27) | –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã |
| `rest` | –í—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂, deposit –Ω–µ –æ–ø–ª–∞—á–µ–Ω | Second Payment (32) | –ñ–¥–µ–º deposit |

### 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:**
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚úÖ –¢–≤–æ–π –ø–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω, —Å–ø–∞—Å–∏–±–æ!" —á–µ—Ä–µ–∑ `statusAutomationService.sendPaymentReceivedNotification()`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ `syncDealStage()`

**–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ `sendPaymentNotificationForDeal()`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏, –ù–ï –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:**
- `STRIPE_MODE=live` (–∏–ª–∏ `test` –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- `STRIPE_EVENTS_API_KEY=sk_live_...` (live –∫–ª—é—á –¥–ª—è live mode)
- `STRIPE_WEBHOOK_SECRET=whsec_...` (signing secret –∏–∑ Stripe Dashboard)

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:**
- `STRIPE_API_KEY=sk_test_...` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ test mode)

### 2. Stripe Dashboard - Webhook Endpoint

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
1. Endpoint –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –≤ **Live mode** (–Ω–µ Test mode)
2. URL: `https://invoices.comoon.io/api/webhooks/stripe`
3. –í–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (—Å–º. —Ä–∞–∑–¥–µ–ª "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è")
4. Status: **Enabled**

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Stripe Dashboard ‚Üí Developers ‚Üí Webhooks
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω endpoint —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º URL
- Status –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Enabled"
- –í "Recent events" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

**GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
curl https://invoices.comoon.io/api/webhooks/stripe
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "Stripe webhook endpoint is available",
  "method": "POST",
  "url": "/api/webhooks/stripe"
}
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–æ–±—ã—Ç–∏—è –≤ Stripe Dashboard –Ω–µ –∏–º–µ—é—Ç `request.id`
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π `üì• Stripe webhook –ø–æ–ª—É—á–µ–Ω`
- –ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Endpoint –Ω–µ —Å–æ–∑–¥–∞–Ω –≤ Stripe Dashboard (Live mode)
2. Endpoint –æ—Ç–∫–ª—é—á–µ–Ω (Status: Disabled)
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤ endpoint
4. –°–æ–±—ã—Ç–∏—è –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ endpoint

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Stripe Dashboard ‚Üí Webhooks (Live mode)
2. –°–æ–∑–¥–∞—Ç—å/–≤–∫–ª—é—á–∏—Ç—å endpoint –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL: `https://invoices.comoon.io/api/webhooks/stripe`
4. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤–∫–ª—é—á–µ–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞: Signature verification failed

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö: `Stripe webhook signature verification failed`
- HTTP 401 –æ—Ç–≤–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
1. `STRIPE_WEBHOOK_SECRET` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å signing secret –≤ Stripe Dashboard
2. `STRIPE_WEBHOOK_SECRET` –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
3. Endpoint –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π secret (test vs live)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `STRIPE_WEBHOOK_SECRET` –≤ Render Dashboard
2. –ü–æ–ª—É—á–∏—Ç—å signing secret –∏–∑ Stripe Dashboard ‚Üí Webhooks ‚Üí [endpoint] ‚Üí Signing secret
3. –û–±–Ω–æ–≤–∏—Ç—å `STRIPE_WEBHOOK_SECRET` –≤ Render
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –Ω–æ —Å—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö: `‚úÖ Checkout Session –æ–±—Ä–∞–±–æ—Ç–∞–Ω`
- –ù–æ —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- –ù–æ—É—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω

**–ü—Ä–∏—á–∏–Ω—ã:**
1. `triggerCrmStatusAutomation()` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
2. –û—à–∏–±–∫–∞ –≤ `persistSession()`
3. –°–¥–µ–ª–∫–∞ —É–∂–µ –≤ –Ω—É–∂–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –≤ `persistSession()`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `crmStatusAutomationService` –≤–∫–ª—é—á–µ–Ω
3. –í—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `triggerCrmStatusAutomation()`

### –ü—Ä–æ–±–ª–µ–º–∞: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
- –ù–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚úÖ –¢–≤–æ–π –ø–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω, —Å–ø–∞—Å–∏–±–æ!" –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

**–ü—Ä–∏—á–∏–Ω—ã:**
1. `sendPaymentReceivedNotification()` –Ω–µ –≤—ã–∑–≤–∞–ª—Å—è (—Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞–ø—Ä—è–º—É—é, –º–∏–Ω—É—è `syncDealStage()`)
2. SendPulse ID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–µ—Ä—Å–æ–Ω—ã
3. –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ SendPulse

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `syncDealStage()` (–Ω–µ –Ω–∞–ø—Ä—è–º—É—é)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ SendPulse ID —É –ø–µ—Ä—Å–æ–Ω—ã –≤ Pipedrive
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ SendPulse –Ω–∞ –æ—à–∏–±–∫–∏

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**–£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
```
üì• Stripe webhook –ø–æ–ª—É—á–µ–Ω | –¢–∏–ø: checkout.session.completed
üí≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ Checkout Session | Deal: 1696 | Session: cs_live_...
‚úÖ Checkout Session –æ–±—Ä–∞–±–æ—Ç–∞–Ω | Deal: 1696 | Session: cs_live_...
```

**–û—à–∏–±–∫–∏:**
```
‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Checkout Session | Deal: 1696 | Session: cs_live_...
Stripe webhook signature verification failed
```

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ webhook —Å–æ–±—ã—Ç–∏–π** - –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
2. **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏** - –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
3. **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏** - –≤—Ä–µ–º—è –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è webhook –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
4. **–û—à–∏–±–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ failed signature verifications

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Stripe CLI –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ webhook –Ω–∞ localhost
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

### Production —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å–µ—Å—Å–∏—é –¥–ª—è —Å–¥–µ–ª–∫–∏
2. –û–ø–ª–∞—Ç–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ Render
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤ –ë–î
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –æ–±–Ω–æ–≤–∏–ª—Å—è
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ—É—Ç —Å–æ–∑–¥–∞–Ω
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

## –ö–æ–¥

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/routes/stripeWebhook.js` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook endpoint
- `src/services/stripe/processor.js` - –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π (`persistSession()`)
- `src/services/crm/statusAutomationService.js` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `src/services/stripe/repository.js` - —Ä–∞–±–æ—Ç–∞ —Å –ë–î

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã

- `stripeProcessor.persistSession(session)` - –æ—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
- `stripeProcessor.triggerCrmStatusAutomation(dealId)` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–∫–∏
- `statusAutomationService.sendPaymentReceivedNotification()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## –ß–µ–∫–ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Stripe Dashboard
- [ ] Endpoint —Å–æ–∑–¥–∞–Ω –≤ **Live mode** (–Ω–µ Test mode)
- [ ] URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: `https://invoices.comoon.io/api/webhooks/stripe`
- [ ] –í—Å–µ —Å–æ–±—ã—Ç–∏—è –≤–∫–ª—é—á–µ–Ω—ã (—Å–º. —Ä–∞–∑–¥–µ–ª "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è")
- [ ] Status: **Enabled**
- [ ] Signing secret –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω

### Render Environment Variables
- [ ] `STRIPE_MODE=live` (–∏–ª–∏ `test` –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- [ ] `STRIPE_EVENTS_API_KEY=sk_live_...` (live –∫–ª—é—á –¥–ª—è live mode)
- [ ] `STRIPE_WEBHOOK_SECRET=whsec_...` (signing secret –∏–∑ Stripe Dashboard)
- [ ] `STRIPE_API_KEY=sk_test_...` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ test mode)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
- [ ] GET –∑–∞–ø—Ä–æ—Å –∫ endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç success: `curl https://invoices.comoon.io/api/webhooks/stripe`
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: `üì• Stripe webhook –ø–æ–ª—É—á–µ–Ω | –¢–∏–ø: checkout.session.completed`
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: `‚úÖ Checkout Session –æ–±—Ä–∞–±–æ—Ç–∞–Ω`
- [ ] –ü–ª–∞—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î (—Å—Ç–∞—Ç—É—Å `paid`)
- [ ] –°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –æ–±–Ω–æ–≤–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] –ù–æ—É—Ç —Å–æ–∑–¥–∞–Ω –≤ Pipedrive
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –í Stripe Dashboard ‚Üí Webhooks ‚Üí [endpoint] ‚Üí Recent events –≤–∏–¥–Ω—ã —É—Å–ø–µ—à–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ signature verification –≤ –ª–æ–≥–∞—Ö
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –ª–æ–≥–∞—Ö

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `node scripts/diagnose-stripe-webhook.js [sessionId] [dealId]`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ Render
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ Stripe Dashboard ‚Üí Webhooks ‚Üí [endpoint] ‚Üí Recent events

