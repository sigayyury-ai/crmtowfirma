# Настройка Stripe Webhook для мгновенной обработки платежей

## Описание

Webhook автоматически обрабатывает Stripe платежи сразу после их завершения, без задержек на периодическую проверку. Это обеспечивает мгновенное обновление статусов в CRM и отчетах.

## URL Webhook

```
POST https://your-domain.com/api/webhooks/stripe
```

## Настройка в Stripe Dashboard

1. Перейдите в **Developers** → **Webhooks** (в левом меню Stripe Dashboard)
2. Нажмите **Add endpoint** (или **+ Add endpoint**)
3. Заполните форму:
   - **Endpoint URL**: `https://your-domain.com/api/webhooks/stripe`
   - **Description** (опционально): "Обработка платежей для CRM"
4. В разделе **"Select events to listen to"** выберите:
   - Нажмите **"Select events"** или **"Add events"**
   - Найдите и отметьте галочками:
     - ✅ `checkout.session.completed` (основное событие - срабатывает когда клиент оплатил через Checkout)
     - ✅ `checkout.session.async_payment_succeeded` (для асинхронных платежей - банковские переводы и т.д.)
     - ✅ `payment_intent.succeeded` (резервное событие - на случай если первое не сработало)
     - ✅ `charge.refunded` (для обработки возвратов средств)
   - Или выберите **"Select all events"** если хотите получать все события (не обязательно)
5. Нажмите **Add endpoint**
6. После создания webhook, откройте его и скопируйте **Signing secret** (начинается с `whsec_...`)
   - Это секретный ключ для проверки подлинности webhook запросов
7. Добавьте в `.env`:
   ```
   STRIPE_WEBHOOK_SECRET=whsec_ваш_секретный_ключ
   ```

## Как это работает

1. Клиент оплачивает через Stripe Checkout
2. Stripe отправляет webhook `checkout.session.completed`
3. Webhook обрабатывает платеж:
   - Проверяет, не был ли уже обработан
   - Сохраняет платеж в базу данных
   - Обновляет статус сделки в CRM
   - Добавляет заметку о платеже
4. Если обработка не удалась → создается задача в CRM для проверки

## Обрабатываемые события

### `checkout.session.completed`
Основное событие, срабатывает когда Checkout Session завершен и оплачен (мгновенные платежи).

### `checkout.session.async_payment_succeeded`
Событие для асинхронных платежей (например, банковские переводы), которые обрабатываются не мгновенно. Использует ту же логику обработки, что и `checkout.session.completed`.

### `payment_intent.succeeded`
Резервное событие на случай, если `checkout.session.completed` не сработало.

### `charge.refunded`
Событие для обработки возвратов средств. Обрабатывается мгновенно при создании возврата в Stripe.

## Обработка ошибок

Если webhook не смог обработать платеж, автоматически создается задача в CRM со следующими данными:

- **Тема**: "⚠️ Ошибка обработки Stripe платежа"
- **Срок**: через 24 часа
- **Описание**: 
  - Тип события
  - Session ID и Payment Intent ID
  - Ссылки на Stripe Dashboard
  - Описание ошибки
  - Инструкции по проверке

## Защита от дубликатов

- Проверка существующих платежей перед обработкой
- Idempotent обработка - повторные webhook события игнорируются
- Периодическая проверка остается как fallback механизм

## Безопасность

Webhook проверяет подпись Stripe для защиты от поддельных запросов. В development режиме проверка может быть отключена для тестирования.

## Тестирование

Для локального тестирования используйте Stripe CLI:

```bash
# Установите Stripe CLI
# https://stripe.com/docs/stripe-cli

# Логин
stripe login

# Пересылка webhook на локальный сервер
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# Триггер тестового события
stripe trigger checkout.session.completed
```

## Fallback

Периодическая проверка (каждый час) остается как резервный механизм на случай, если:
- Webhook не был доставлен
- Webhook был доставлен, но обработка не удалась
- Webhook был настроен неправильно

## Логирование

Все события логируются:
- Получение webhook
- Обработка платежа
- Ошибки обработки
- Создание задач в CRM

