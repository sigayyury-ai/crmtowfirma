## Привязка платежей к продуктам (Payment → Product Linking)

### Зачем это нужно

Функционал позволяет **вручную привязать банковский платёж** (как расход `direction=out`, так и приход `direction=in`) к конкретному продукту из VAT Margin Tracker, чтобы:

- **учитывать привязанные расходы** в расчёте VAT Margin по продукту;
- **видеть список привязанных платежей** в детальной карточке продукта (ниже проформ и Stripe).

---

### Где это находится в UI

- **Страница “Expenses” (`frontend/expenses.html`)**:
  - в детальной карточке расхода (`direction=out`) есть блок **“Привязка к продукту”** с выпадающим списком продуктов и кнопками **“Связать / Отвязать”**.
- **Карточка продукта VAT Margin (`frontend/vat-margin-product.html`)**:
  - есть блок **“Связанные платежи”**, который показывает **входящие** и **исходящие** привязанные платежи.
  - привязанные **исходящие** платежи используются как “Расходы (привязанные)” и попадают в расчёт VAT (распределяются “на участника”).

> Примечание: на текущий момент UI для привязки реализован в “Expenses” только для **расходов** (`direction=out`). API при этом поддерживает привязку и для **доходов** (`direction=in`).
>
> Планируемое расширение: вложения (чек/инвойс) к платежу и AI-подсказки для линковки — см. `docs/payments-attachments-and-ai.md`.

---

### Правила и ограничения

- **Доступны только активные продукты**: в списке показываются продукты, у которых `products.calculation_status = 'in_progress'`.
- **1 платёж → максимум 1 продукт**:
  - при попытке повторной привязки вернётся ошибка “Платеж уже связан с продуктом”.
- **Нельзя привязать удалённый платёж**: если у платежа `payments.deleted_at` заполнен — привязка запрещена.
- **Продукт должен быть `in_progress`**: привязка к продукту в других статусах запрещена.
- **Если продукт стал неактивным после привязки**:
  - связь остаётся в базе;
  - в “Expenses” такой продукт может быть показан как **“(неактивный)”** (если его нет в списке `in_progress`).
- **Аудит**:
  - в поле `linked_by` записывается `req.user.email` или `req.user.id` (если есть аутентификация), иначе `null`;
  - время фиксируется в `linked_at` (если настроено на уровне БД).

---

### Модель данных (Supabase)

Связи хранятся в таблице `payment_product_links`.

- **Ключевые поля**:
  - `payment_id` — идентификатор платежа
  - `product_id` — идентификатор продукта
  - `direction` — направление платежа (берётся из платежа при создании связи)
  - `linked_by` — кто привязал
  - `linked_at` — когда привязали
- **Ограничение уникальности**: один `payment_id` может встречаться в таблице только один раз (логика также проверяется на уровне сервиса).

---

### API (backend)

Все эндпоинты реализованы в `src/routes/api.js` и используют сервис `src/services/payments/paymentProductLinkService.js`.

#### Получить список доступных продуктов для привязки

`GET /api/products/in-progress`

- **Ответ**: `data` — массив продуктов (только `calculation_status=in_progress`), отсортированы по имени.

Пример ответа:

```json
{
  "success": true,
  "data": [
    { "id": 123, "name": "NY2026", "normalized_name": "ny2026", "calculation_status": "in_progress" }
  ]
}
```

#### Привязать платёж к продукту

`POST /api/payments/:id/link-product`

- **Path params**:
  - `id` — ID платежа (ожидается integer)
- **Body**:
  - `productId` — ID продукта (ожидается integer)
- **Ответ**: `data` — созданная связь + вложенный `product`.

Пример запроса:

```bash
curl -X POST "/api/payments/1001/link-product" \
  -H "Content-Type: application/json" \
  -d '{"productId":123}'
```

Пример ответа (поля могут отличаться в зависимости от схемы БД, но ключевые сохраняются):

```json
{
  "success": true,
  "data": {
    "id": "…",
    "payment_id": 1001,
    "product_id": 123,
    "direction": "out",
    "linked_by": "user@example.com",
    "linked_at": "2026-01-12T10:11:12.000Z",
    "product": { "id": 123, "name": "NY2026", "normalized_name": "ny2026" }
  }
}
```

Типовые ошибки:

- **400** `Некорректный идентификатор платежа`
- **400** `Некорректный идентификатор продукта`
- **400** `Платёж не найден` / `Продукт не найден`
- **400** `Связать можно только продукт со статусом In Progress`
- **400** `Платеж уже связан с продуктом`
- **400** `Нельзя связать удалённый платеж`

#### Получить текущую связь платежа с продуктом

`GET /api/payments/:id/link-product`

- **Ответ**: `data` — объект связи или `null`, если связи нет.

```json
{ "success": true, "data": null }
```

#### Отвязать платёж от продукта

`DELETE /api/payments/:id/link-product`

- **Ответ**:

```json
{ "success": true }
```

#### Получить все привязанные платежи по продукту (сырые строки ссылок)

`GET /api/products/:id/linked-payments`

- Возвращает массив ссылок из `payment_product_links` с вложенным `payment`.
- Удобно для дебага/интеграций, но **карточка продукта** обычно использует агрегированный эндпоинт VAT Margin (см. ниже).

#### Детальная карточка продукта (VAT Margin) включает `linkedPayments`

`GET /api/vat-margin/products/:productIdentifier/detail`

- Возвращает `data.linkedPayments` в виде:
  - `incoming`: массив привязанных входящих платежей
  - `outgoing`: массив привязанных исходящих платежей
- Также возвращает `data.expenseTotals`, рассчитанный из `linkedPayments.outgoing`.

---

### Как проверить, что всё работает (быстрый чеклист)

- **Привязка**:
  - открыть “Expenses”
  - выбрать расход → в деталях выбрать продукт → нажать “Связать”
  - увидеть мету “Связано … • …”
- **Отвязка**:
  - нажать “Отвязать” → увидеть, что связь пропала
- **Отображение в продукте**:
  - открыть карточку продукта (VAT margin) → увидеть платёж в “Связанные платежи”
  - убедиться, что “Расходы (привязанные)” изменились (если это `direction=out`)

