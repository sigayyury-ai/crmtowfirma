<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wFirma OAuth Callback</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .success { color: #28a745; background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .error { color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; word-break: break-all; }
        .button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîê wFirma OAuth 2.0 Callback</h1>
    
    <div id="result">
        <h3>‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</h3>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
    </div>

    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        const resultDiv = document.getElementById('result');

        if (error) {
            resultDiv.innerHTML = `
                <div class="error">
                    <h3>‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                    <p><strong>–û—à–∏–±–∫–∞:</strong> ${error}</p>
                </div>
            `;
        } else if (code) {
            resultDiv.innerHTML = `
                <div class="success">
                    <h3>‚úÖ –ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω!</h3>
                    <p><strong>–ö–æ–¥:</strong></p>
                    <div class="code">${code}</div>
                    <p>–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –æ–±–º–µ–Ω—è—Ç—å —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ access token.</p>
                    <button class="button" onclick="exchangeToken()">üîÑ –ü–æ–ª—É—á–∏—Ç—å Access Token</button>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="error">
                    <h3>‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                    <p>–ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL.</p>
                </div>
            `;
        }

        function exchangeToken() {
            if (!code) return;
            
            resultDiv.innerHTML = `
                <h3>üîÑ –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω...</h3>
                <p>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ wFirma API...</p>
            `;

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–∞
            const tokenData = {
                grant_type: 'authorization_code',
                client_id: '0a749723fca35677bf7a6f931646385e',
                client_secret: 'c5b3bc3058a60caaf13b4e57cd4d5c15',
                code: code,
                redirect_uri: 'https://comoon.io/oauth/callback/'
            };

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
            fetch('https://api2.wfirma.pl/oauth/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(tokenData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Access Token –ø–æ–ª—É—á–µ–Ω!</h3>
                            <p><strong>Access Token:</strong></p>
                            <div class="code">${data.access_token}</div>
                            <p><strong>–¢–∏–ø:</strong> ${data.token_type || 'Bearer'}</p>
                            ${data.expires_in ? `<p><strong>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> ${data.expires_in} —Å–µ–∫—É–Ω–¥</p>` : ''}
                            ${data.refresh_token ? `<p><strong>Refresh Token:</strong></p><div class="code">${data.refresh_token}</div>` : ''}
                            
                            <h4>üìã –î–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª:</h4>
                            <div class="code">WFIRMA_ACCESS_TOKEN=${data.access_token}</div>
                            ${data.refresh_token ? `<div class="code">WFIRMA_REFRESH_TOKEN=${data.refresh_token}</div>` : ''}
                            
                            <button class="button" onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</h3>
                            <p><strong>–û—à–∏–±–∫–∞:</strong> ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                            <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${data.message || '–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'}</p>
                        </div>
                    `;
                }
            })
            .catch(err => {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω.</p>
                        <p><strong>–û—à–∏–±–∫–∞:</strong> ${err.message}</p>
                    </div>
                `;
            });
        }

        function copyToClipboard() {
            const code = document.querySelector('.code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
    </script>
</body>
</html>






