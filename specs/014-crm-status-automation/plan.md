# План реализации: 014-crm-status-automation

## Обзор

План реализации автоматической системы изменения статусов CRM сделок на основе оплаты проформ. Общий срок: 2-3 недели.

## Фазы реализации

### Фаза 1: Анализ и проектирование (4-5 дней)

#### Задачи:
1. **Анализ текущей логики статусов**
   - Изучить существующие статусы в Pipedrive
   - Понять логику переходов между статусами
   - Проанализировать существующие автоматизации

2. **Проектирование бизнес-логики**
   - Определить правила переходов для разных графиков платежей
   - Спроектировать обработку частичных платежей
   - Определить пороги для изменения статусов

3. **Анализ источников данных**
   - Определить, какие события trigger изменения статуса
   - Проанализировать структуру данных платежей и проформ
   - Определить частоту проверок и обновлений

4. **Проектирование архитектуры**
   - Определить компоненты системы
   - Спроектировать обработку событий
   - Определить стратегию обработки ошибок

### Фаза 2: Core логика (5-7 дней)

#### Задачи:
1. **Создание StatusCalculator сервиса**
   - Логика определения графика платежей
   - Расчет процента оплаты
   - Определение целевого статуса

2. **Создание PaymentMonitor сервиса**
   - Отслеживание изменений в платежах
   - Обработка webhook от Stripe
   - Регулярные проверки банковских платежей

3. **Создание CRMStatusUpdater сервиса**
   - Интеграция с Pipedrive API
   - Логика изменения статусов
   - Обработка конфликтов и ошибок

4. **Создание AuditService**
   - Логирование всех изменений
   - Сохранение истории статусов
   - Генерация отчетов

### Фаза 3: Интеграция и обработка событий (4-5 дней)

#### Задачи:
1. **Webhook обработка**
   - Интеграция со Stripe webhooks
   - Обработка событий оплаты
   - Фильтрация тестовых платежей

2. **Регулярные проверки**
   - Cron job для проверки банковских платежей
   - Обработка накопленных платежей
   - Обновление статусов для старых сделок

3. **Обработка исключений**
   - Логика для ручных изменений статусов
   - Предупреждения о несоответствиях
   - Возможность принудительного обновления

4. **Кэширование и оптимизация**
   - Кэширование статусов сделок
   - Оптимизация запросов к Pipedrive
   - Batch операции для массовых обновлений

### Фаза 4: Тестирование и мониторинг (3-4 дня)

#### Задачи:
1. **Unit тестирование**
   - Тесты для StatusCalculator
   - Тесты для PaymentMonitor
   - Тесты для CRMStatusUpdater

2. **Integration тестирование**
   - Тесты для полного цикла оплаты
   - Тесты для разных графиков платежей
   - Тесты для обработки ошибок

3. **Мониторинг и алерты**
   - Dashboard для отслеживания работы автоматизации
   - Алерты при сбоях
   - Метрики производительности

4. **Документация и развертывание**
   - Обновление документации
   - Создание runbook для поддержки
   - Развертывание в production

## Риски и mitigation

### Риски:
1. **Pipedrive API лимиты** - превышение лимитов API вызовов
   - Mitigation: кэширование, batch операции, rate limiting

2. **Конфликты статусов** - ручные изменения перезаписываются автоматическими
   - Mitigation: интеллектуальная логика, пользовательские подтверждения

3. **Производительность** - большое количество одновременных платежей
   - Mitigation: очередь обработки, асинхронная обработка

4. **Надежность** - сбои в Pipedrive API или сети
   - Mitigation: retry логика, fallback стратегии, monitoring

## Критерии успеха

### Функциональные:
- [ ] Автоматическое изменение статусов работает для 50/50 графиков
- [ ] Автоматическое изменение статусов работает для 100% графиков
- [ ] Обработка частичных платежей корректна
- [ ] Ручные изменения не теряются без необходимости
- [ ] Все изменения логируются

### Нефункциональные:
- [ ] Время отклика < 5 секунд
- [ ] Корректность > 99%
- [ ] Доступность > 99.9%
- [ ] Код покрыт тестами > 80%

## Зависимости

### Внешние:
- Стабильность Pipedrive API
- Доступность Stripe webhooks
- Корректность данных в существующих таблицах

### Внутренние:
- Стабильность платежной системы
- Корректность данных проформ
- Координация с командой frontend

## Технические детали

### Компоненты:
- **StatusCalculator** - чистая логика расчета статусов
- **PaymentMonitor** - отслеживание платежей
- **CRMStatusUpdater** - обновление Pipedrive
- **AuditLogger** - логирование операций

### События:
- Stripe webhook: `checkout.session.completed`
- Cron job: каждые 5 минут для банковских платежей
- Manual trigger: через API для принудительного обновления

### Метрики:
- Количество обработанных платежей
- Время обработки одного платежа
- Процент успешных обновлений статусов
- Количество конфликтов и ручных вмешательств

## План отката

В случае проблем с автоматизацией:

1. **Отключение автоматизации** - флаг в конфиге
2. **Ручной режим** - только логирование без изменений
3. **Откат кода** - быстрая возможность отката
4. **Восстановление статусов** - скрипт для восстановления предыдущих статусов

## Следующие шаги

После реализации автоматизации статусов:

1. **Анализ эффективности** - измерение сэкономленного времени
2. **Улучшения UX** - добавление визуальных индикаторов в CRM
3. **Расширение логики** - поддержка дополнительных графиков платежей
4. **Интеграция с отчетами** - добавление информации в финансовые отчеты
