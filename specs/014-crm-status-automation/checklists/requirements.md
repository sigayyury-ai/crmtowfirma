# Чек-лист требований: 014-crm-status-automation

## Функциональные требования

### FR-001: Мониторинг оплаты проформ
- [ ] Отслеживание изменений в таблице `proformas`
- [ ] Обработка Stripe webhook для мгновенных обновлений
- [ ] Регулярные проверки банковских платежей
- [ ] Обработка частичных платежей
- [ ] Игнорирование тестовых платежей

### FR-002: Определение графика платежей
- [ ] Анализ поля `payment_schedule` в проформе
- [ ] Поддержка графиков "50/50", "100%", "70/30"
- [ ] Определение количества платежей в графике
- [ ] Обработка нестандартных графиков
- [ ] Кэширование информации о графике

### FR-003: Расчет статуса оплаты
- [ ] Суммирование всех платежей по сделке
- [ ] Учет частичных платежей и предоплат
- [ ] Расчет процента оплаты от общей суммы
- [ ] Обработка возвратов и отмен платежей
- [ ] Корректное определение "полной оплаты"

### FR-004: Автоматическое изменение статуса
- [ ] Изменение статуса через Pipedrive API
- [ ] Правильное определение целевого статуса
- [ ] Логирование всех изменений статусов
- [ ] Обработка ошибок API с повторными попытками
- [ ] Атомарность операций изменения статуса

### FR-005: Обработка частичных платежей
- [ ] Накопление суммы платежей по сделке
- [ ] Изменение статуса при достижении порогов (>=50%)
- [ ] Обработка платежей в разное время
- [ ] Корректный расчет процентов для разных графиков
- [ ] Обработка платежей больше 100% суммы

### FR-006: Обработка исключений
- [ ] Ручные изменения статуса не перезаписываются автоматически
- [ ] Обработка конфликтов при одновременных изменениях
- [ ] Graceful handling ошибок API
- [ ] Восстановление после сбоев и сетевых проблем
- [ ] Обработка недоступности Pipedrive API

### FR-007: Аудит и логирование
- [ ] Логирование каждого изменения статуса
- [ ] Сохранение информации о причине изменения
- [ ] Отображение истории изменений в интерфейсе
- [ ] Возможность отслеживания автоматических изменений
- [ ] Экспорт логов для анализа

### FR-008: Перезапись ручных изменений
- [ ] Проверка соответствия автоматического статуса реальному положению оплаты
- [ ] Предупреждение пользователя о несоответствии
- [ ] Возможность принудительного обновления статуса
- [ ] Сохранение истории ручных изменений
- [ ] Интеллектуальное определение необходимости перезаписи

### FR-009: Отображение количества платежей
- [ ] В отчетах по продуктам показывается "1/2 платежей" или "2/2 платежей"
- [ ] В карточках продуктов отображается прогресс оплаты
- [ ] Информация доступна в Pipedrive через custom fields
- [ ] Визуальные индикаторы прогресса
- [ ] Суммарная информация по всем продуктам

## Нефункциональные требования

### NFR-001: Надежность
- [ ] Время отклика: < 5 секунд на изменение статуса
- [ ] Доступность: 99.9% uptime
- [ ] Корректность расчетов: 100%
- [ ] Восстановление после сбоев: автоматическое
- [ ] Отказоустойчивость: работа при недоступности Pipedrive

### NFR-002: Производительность
- [ ] Обработка одного платежа: < 2 секунды
- [ ] Массовое обновление статусов: < 30 секунд на 100 сделок
- [ ] Минимальное влияние на общую производительность системы
- [ ] Оптимизация запросов к Pipedrive API
- [ ] Кэширование часто используемых данных

### NFR-003: Безопасность
- [ ] Аутентификация в Pipedrive API с правильными токенами
- [ ] Валидация прав доступа к сделкам
- [ ] Защита от несанкционированных изменений статусов
- [ ] Аудит всех операций с указанием пользователя
- [ ] Шифрование чувствительных данных

### NFR-004: Масштабируемость
- [ ] Обработка большого количества одновременных платежей
- [ ] Эффективная работа с тысячами сделок
- [ ] Оптимизация базы данных для частых запросов
- [ ] Горизонтальное масштабирование при необходимости

## Технические требования

### API интеграции
- [ ] Pipedrive API для изменения статусов сделок
- [ ] Webhook эндпоинты для обработки платежей
- [ ] Stripe webhook обработка
- [ ] Банковские API для проверки платежей

### Схема базы данных
- [ ] Таблица для логирования изменений статусов
- [ ] Индексы для быстрого поиска по deal_id
- [ ] Кэширование статусов сделок
- [ ] История изменений с timestamps

### Мониторинг и алерты
- [ ] Dashboard с текущими статусами автоматизации
- [ ] Уведомления о несоответствиях
- [ ] Метрики производительности
- [ ] Отчеты по автоматическим изменениям
- [ ] Алерты при сбоях

## Тестирование

### Модульное тестирование
- [ ] Тесты для логики расчета статуса
- [ ] Тесты для обработки частичных платежей
- [ ] Тесты для Pipedrive API интеграции
- [ ] Тесты для обработки ошибок

### Интеграционное тестирование
- [ ] Тесты end-to-end для полного цикла оплаты
- [ ] Тесты для разных графиков платежей
- [ ] Тесты для конфликтов и race conditions
- [ ] Тесты для восстановления после сбоев

### Производственное тестирование
- [ ] Тестирование с реальными данными Pipedrive
- [ ] Нагрузочное тестирование
- [ ] Тестирование граничных случаев
- [ ] Тестирование отказоустойчивости

## Критерии готовности

### Definition of Ready
- [ ] Бизнес-логика согласована со всеми заинтересованными сторонами
- [ ] Техническая архитектура утверждена
- [ ] Pipedrive API изучен и протестирован
- [ ] Оценка рисков выполнена и принята
- [ ] Дизайн решения задокументирован

### Definition of Done
- [ ] Все автоматические переходы работают корректно
- [ ] Ручные изменения обрабатываются правильно
- [ ] Аудит и логирование реализованы полностью
- [ ] Тестирование в production-like среде пройдено успешно
- [ ] Мониторинг и алерты настроены и работают
- [ ] Документация обновлена и доступна
- [ ] Производительность соответствует требованиям
- [ ] Безопасность проверена penetration testing
- [ ] UX соответствует ожиданиям пользователей
