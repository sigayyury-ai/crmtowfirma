# Спецификация фичи: Автоматическое изменение статусов в CRM при линковке платежей

**Интеграция в существующий флоу**: Функциональность автоматически меняет статусы сделок в CRM при линковке платежей к проформам, без создания дополнительных интерфейсов - только бизнес-логика.

**Ветка фичи**: `014-crm-status-automation`
**Создано**: 2025-11-27
**Статус**: Черновик
**Вводные данные**: Описание пользователя: "хочу в флоу платежи с помощью проформы менять статусы в CRM. Изначальный статус First Payment, при получении перевода мы линкуем платежи к проформам и если линк состоялся должен смениться стаус на следующий - Second payment если у нас в графике два платежа или если один то Camp waiter. Используй только в коде id stage для привязке. Тоесть тригер к изменению статуса есть привязка платежа к проформе. Мы уже отслеживаем также это вся сумма или часть суммы. Вот нужно добавить еще такую автоматизацию для упрощения работы человек аобрабатывающего платежи. Так как сейчас происходит двойная работа. А хочется упростить и не деелать это в CRM и в Vat margin отчете. Дополнительных интерфейсо вроде для этого н е надо. Только логика. Платеж слинковали с проформой сработо изменение стейджей в CRM"

## Сценарии использования и тестирование *(обязательно)*

### Пользовательская история 1 - Автоматическое продвижение статуса при накоплении суммы оплаты (Priority: P1)

Как сотрудник, обрабатывающий платежи, я хочу, чтобы при линковке платежа к проформе автоматически менялся статус сделки в CRM на следующий по графику, когда накопленная сумма линкированных платежей достигает порога для перехода (например, 50% для первого платежа из двух, или 100% для единственного платежа), чтобы избежать двойной работы по ручному обновлению статусов в двух системах.

**Почему этот приоритет**: Это основная автоматизация, которая устраняет двойную работу и снижает вероятность ошибок при обработке платежей.

**Независимое тестирование**: Может быть полностью протестировано путем линковки платежа к проформе и проверки автоматического изменения статуса в CRM.

**Сценарии приемки**:

1. **Учитывая** что сделка имеет график из двух платежей и статус "First Payment", **Когда** сумма линкированных платежей достигает ≥50% от общей суммы проформы, **Тогда** статус автоматически меняется на "Second Payment"
2. **Учитывая** что сделка имеет график из одного платежа и статус "First Payment", **Когда** сумма линкированных платежей достигает ≥100% от общей суммы проформы, **Тогда** статус автоматически меняется на "Camp Waiter"
3. **Учитывая** что сделка имеет график из двух платежей и уже имеет статус "Second Payment", **Когда** сумма линкированных платежей достигает ≥100% от общей суммы проформы, **Тогда** статус автоматически меняется на "Camp Waiter"

---

### Пользовательская история 2 - Отслеживание прогресса оплаты (Priority: P2)

Как менеджер по продажам, я хочу видеть корректные статусы сделок в CRM, отражающие реальный прогресс оплаты, чтобы понимать, какие сделки ждут оплаты и какие уже частично оплачены.

**Почему этот приоритет**: Обеспечивает прозрачность прогресса оплаты для всей команды и правильное распределение задач.

**Независимое тестирование**: Может быть полностью протестировано просмотром статусов сделок в CRM после обработки платежей.

**Сценарии приемки**:

1. **Учитывая** что по сделке получена первая оплата, **Когда** я проверяю статус в CRM, **Тогда** вижу "Second Payment" для сделок с двумя платежами
2. **Учитывая** что по сделке получена полная оплата, **Когда** я проверяю статус в CRM, **Тогда** вижу "Camp Waiter" для завершенных сделок

---

### Пользовательская история 3 - Упрощение рабочего процесса (Priority: P3)

Как сотрудник, обрабатывающий платежи, я хочу тратить меньше времени на рутинные операции обновления статусов, чтобы сосредоточиться на более важных задачах обработки платежей и работе с клиентами.

**Почему этот приоритет**: Улучшает эффективность работы и снижает операционную нагрузку на персонал.

**Независимое тестирование**: Может быть измерено сравнением времени на обработку платежей до и после внедрения автоматизации.

**Сценарии приемки**:

1. **Учитывая** что ранее требовалось вручную обновлять статусы в CRM после линковки платежей, **Когда** внедрена автоматизация, **Тогда** статусы обновляются автоматически без дополнительных действий

---

### Пограничные случаи

- Что происходит при частичных оплатах малыми суммами (например, 5 платежей по 20% каждый)?
- Как обрабатывать случаи, когда сумма линкированных платежей превышает порог (например, 120% из-за переплат)?
- Что происходит, если платежи линкируются не по порядку (второй платеж раньше первого)?
- Что происходит при разлинковке платежей - нужно ли пересчитывать статус?
- Что происходит, если платеж линкирован к проформе, но статус в CRM не удалось обновить из-за API ошибки?
- Система может перезаписывать статусы, измененные вручную, если они противоречат логике накопления платежей
- Что происходит при линковке платежа к проформе с уже завершенной сделкой?
- Как обрабатывать одновременные линковки нескольких платежей к одной проформе?
- Что происходит, если график платежей изменяется после линковки платежей?
- Система ДОЛЖНА позволять перезаписывать статусы, измененные вручную в CRM, если они не соответствуют логике накопления платежей

## Требования *(обязательно)*

### Функциональные требования

- **FR-001**: Система ДОЛЖНА автоматически изменять статус сделки в CRM при достижении пороговых значений суммы линкированных платежей
- **FR-002**: Система ДОЛЖНА использовать stage_id для определения статусов: 18 ("First Payment"), 32 ("Second Payment"), 27 ("Camp Waiter")
- **FR-003**: Система ДОЛЖНА рассчитывать пороги перехода статусов: ≥50% от суммы проформы → "Second Payment" (при графике 2 платежа), ≥100% от суммы проформы → "Camp Waiter"
- **FR-004**: Система ДОЛЖНА отслеживать накопительную сумму линкированных платежей по каждой проформе
- **FR-005**: Система ДОЛЖНА проверять пороги перехода после каждой линковки платежа и менять статус только при достижении порога
- **FR-005**: Система ДОЛЖНА логировать все попытки изменения статуса с результатами для аудита
- **FR-006**: Система ДОЛЖНА корректно обрабатывать ошибки API CRM без прерывания процесса линковки платежей
- **FR-007**: Система НЕ ДОЛЖНА менять статус сделки, если она уже находится в целевом статусе
- **FR-008**: Система ДОЛЖНА позволять перезаписывать статусы, измененные вручную в CRM, если они не соответствуют логике накопления суммы платежей

### Ключевые сущности *(включить если фича включает данные)*

- **Платеж**: Финансовая транзакция, которая линкируется к проформе
- **Проформа**: Документ, определяющий график платежей и условия оплаты
- **CRM Сделка**: Запись в Pipedrive с текущим статусом (stage_id)
- **Линковка Платеж-Проформа**: Связь между платежом и проформой, вызывающая автоматизацию

## Критерии успеха *(обязательно)*

### Измеримые результаты

- **SC-001**: 100% успешных линковок платежей к проформам вызывают автоматическое изменение статуса в CRM
- **SC-002**: Время на обработку одного платежа сокращается на 50% (с 5 минут до 2.5 минут)
- **SC-003**: Количество ручных операций в CRM по изменению статусов платежей уменьшается на 95%
- **SC-004**: Менеджеры продаж видят корректные статусы сделок в CRM в течение 1 минуты после обработки платежа
- **SC-005**: Уровень ошибок в статусах сделок снижается до 0%