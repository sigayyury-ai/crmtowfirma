# Задачи: 014-crm-status-automation

## Автоматическая система изменения статусов CRM

### Анализ и проектирование (4 дня)

#### ANALYSIS-001: Анализ существующих статусов
**Описание:** Изучить текущие статусы и логику переходов в Pipedrive
**Оценка:** 4h
**Критерии:**
- Документация существующих stage IDs
- Понимание бизнес-логики переходов
- Анализ существующих автоматизаций
- Определение точек интеграции

#### ANALYSIS-002: Проектирование бизнес-логики
**Описание:** Определить правила автоматических переходов
**Оценка:** 6h
**Критерии:**
- Логика для 50/50 графиков
- Логика для 100% графиков
- Обработка частичных платежей
- Правила для порогов изменения статуса

#### ANALYSIS-003: Анализ источников событий
**Описание:** Определить, какие события trigger изменения статуса
**Оценка:** 4h
**Критерии:**
- Stripe webhooks
- Банковские платежи
- Изменения в базе данных
- Внешние триггеры

#### ANALYSIS-004: Проектирование архитектуры
**Описание:** Спроектировать компоненты и взаимодействие
**Оценка:** 6h
**Критерии:**
- Определение сервисов и их ответственности
- Проектирование обработки событий
- Стратегия обработки ошибок
- Мониторинг и логирование

### Core сервисы (6 дней)

#### CORE-001: StatusCalculator сервис
**Описание:** Сервис для расчета целевых статусов сделок
**Оценка:** 8h
**Критерии:**
- Определение графика платежей из проформы
- Расчет процента оплаты
- Определение целевого статуса
- Обработка edge cases

#### CORE-002: PaymentMonitor сервис
**Описание:** Сервис для отслеживания платежей и изменений
**Оценка:** 6h
**Критерии:**
- Обработка Stripe webhooks
- Мониторинг изменений в payments таблице
- Регулярные проверки для банковских платежей
- Фильтрация тестовых платежей

#### CORE-003: CRMStatusUpdater сервис
**Описание:** Сервис для обновления статусов в Pipedrive
**Оценка:** 8h
**Критерии:**
- Интеграция с Pipedrive API
- Логика изменения статусов
- Обработка конфликтов
- Retry логика для API ошибок

#### CORE-004: AuditLogger сервис
**Описание:** Сервис для логирования всех операций
**Оценка:** 4h
**Критерии:**
- Логирование изменений статусов
- Сохранение истории
- Поиск и фильтрация логов
- Экспорт для анализа

### Обработка событий (5 дней)

#### EVENTS-001: Stripe webhook интеграция
**Описание:** Обработка платежных событий от Stripe
**Оценка:** 6h
**Критерии:**
- Webhook эндпоинт для checkout.session.completed
- Валидация webhook подписи
- Извлечение deal_id из метаданных
- Trigger расчета статуса

#### EVENTS-002: Банковские платежи обработка
**Описание:** Регулярная проверка банковских платежей
**Оценка:** 4h
**Критерии:**
- Cron job каждые 5 минут
- Поиск новых подтвержденных платежей
- Группировка по deal_id
- Trigger обновления статусов

#### EVENTS-003: Реальное время мониторинг
**Описание:** Мониторинг изменений в реальном времени
**Оценка:** 4h
**Критерии:**
- Database triggers на payments таблицу
- Обработка изменений proformas
- Queue система для обработки
- Дедупликация событий

#### EVENTS-004: Обработка исключений
**Описание:** Логика для обработки особых случаев
**Оценка:** 6h
**Критерии:**
- Обработка ручных изменений статусов
- Предупреждения о несоответствиях
- Принудительное обновление
- Обработка конфликтов

### Тестирование и QA (4 дня)

#### TEST-001: Unit тесты
**Описание:** Тесты для отдельных компонентов
**Оценка:** 6h
**Критерии:**
- Тесты StatusCalculator логики
- Тесты PaymentMonitor
- Тесты CRMStatusUpdater
- Mock для Pipedrive API

#### TEST-002: Integration тесты
**Описание:** Тесты взаимодействия компонентов
**Оценка:** 6h
**Критерии:**
- Тесты полного цикла оплаты
- Тесты разных графиков платежей
- Тесты обработки ошибок
- Тесты race conditions

#### TEST-003: E2E тесты
**Описание:** Сквозные тесты с реальными API
**Оценка:** 6h
**Критерии:**
- Тесты с staging Pipedrive
- Тесты с реальными Stripe webhooks
- Performance testing
- Load testing

#### TEST-004: Manual тестирование
**Описание:** Ручное тестирование граничных случаев
**Оценка:** 4h
**Критерии:**
- Тестирование edge cases
- UX тестирование
- Error scenarios
- Recovery testing

### Мониторинг и поддержка (3 дня)

#### MONITOR-001: Dashboard и метрики
**Описание:** Создание dashboard для мониторинга работы системы
**Оценка:** 6h
**Критерии:**
- Метрики успешных обновлений
- Графики производительности
- Статус автоматизации по продуктам
- Алerts для проблем

#### MONITOR-002: Логирование и troubleshooting
**Описание:** Система логирования для отладки проблем
**Оценка:** 4h
**Критерии:**
- Структурированное логирование
- Поиск по deal_id, времени
- Correlation IDs для tracing
- Error aggregation

#### MONITOR-003: Runbook и поддержка
**Описание:** Документация для поддержки и эксплуатации
**Оценка:** 4h
**Критерии:**
- Руководство по troubleshooting
- Процедуры восстановления
- Контакты и escalation
- FAQ по распространенным проблемам

### Развертывание и документация (2 дня)

#### DEPLOY-001: Production deployment
**Описание:** Безопасное развертывание в production
**Оценка:** 4h
**Критерии:**
- Feature flag для включения/отключения
- Gradual rollout
- Monitoring во время развертывания
- Rollback plan

#### DEPLOY-002: Документация
**Описание:** Полная документация системы
**Оценка:** 6h
**Критерии:**
- Техническая документация
- User guide для бизнес-пользователей
- API документация
- Архитектурная документация

## Оценки и зависимости

### Общая оценка: 24 дня (3.5 недели)
- Анализ: 4 дня
- Core сервисы: 6 дней
- Обработка событий: 5 дней
- Тестирование: 4 дня
- Мониторинг: 3 дня
- Развертывание: 2 дня

### Ключевые зависимости:
- Стабильность Pipedrive API
- Доступность Stripe webhooks
- Корректность существующих данных
- Координация с командой

### Критические риски:
- Pipedrive API downtime
- Изменения в структуре данных
- Высокая нагрузка на API
- Конфликты с существующими автоматизациями

### Milestones:
1. **Week 1:** Анализ завершен, core сервисы разработаны
2. **Week 2:** Обработка событий реализована, интеграционное тестирование
3. **Week 3:** Мониторинг, end-to-end тестирование, подготовка к развертыванию
4. **Week 3.5:** Развертывание, документация, handover

### Success criteria:
- 95% автоматических обновлений статусов успешны
- < 10 секунд среднее время обработки платежа
- < 1% false positives в логике статусов
- Полная traceability всех изменений через аудит
