# Спецификация: Автоматический и ручной матчинг расходов по категориям

## Цель
Реализовать систему автоматического и ручного матчинга расходных платежей к категориям расходов, аналогично системе матчинга платежей к проформам. После создания правила маппинга, оно автоматически применяется к будущим платежам.

## Текущее состояние
- Таблица `expense_category_mappings` уже создана в базе данных
- При импорте CSV расходов используется `ExpenseCategoryMappingService.findCategoryForPayment()` для автоматического определения категории
- Нет UI для управления маппингами
- Нет отображения предложений категорий при загрузке CSV
- Нет возможности ручного создания правил маппинга

## Требования

### 1. UI для управления маппингами в настройках

#### 1.1. Раздел в настройках PNL
- Добавить новую секцию "Правила категоризации расходов" в настройках PNL отчета
- Разместить после секции "Категории расходов"
- Показывать список всех существующих маппингов

#### 1.2. Отображение маппингов
Для каждого маппинга показывать:
- **Тип паттерна**: категория / описание / плательщик
- **Значение паттерна**: что ищется
- **Категория**: название категории расходов
- **Приоритет**: числовое значение (чем выше, тем раньше применяется)
- **Действия**: редактировать / удалить

#### 1.3. Создание нового маппинга
Форма должна содержать:
- **Тип паттерна** (dropdown):
  - `category` - точное совпадение с полем `category` из CSV
  - `description` - частичное совпадение в описании платежа (case-insensitive)
  - `payer` - частичное совпадение в имени плательщика (case-insensitive)
- **Значение паттерна** (input): текст для поиска
- **Категория расходов** (dropdown): выбор из списка категорий расходов
- **Приоритет** (input, number): по умолчанию 0, можно задать выше для приоритетных правил

#### 1.4. Редактирование маппинга
- Та же форма, что и для создания
- Предзаполненные значения текущего маппинга

#### 1.5. Удаление маппинга
- Подтверждение перед удалением
- После удаления правило перестает применяться к новым платежам

### 2. Автоматический матчинг при загрузке CSV

#### 2.1. Отображение предложений категорий
При загрузке CSV расходов:
- Для каждого расхода без категории показывать возможные совпадения
- Отображать процент попадания (confidence) на основе:
  - Точное совпадение (`category`) = 100%
  - Частичное совпадение в описании = 70-90% (зависит от длины совпадения)
  - Частичное совпадение в плательщике = 60-80% (зависит от длины совпадения)
- Показывать до 3 лучших предложений для каждого расхода

#### 2.2. UI для предложений
В таблице платежей добавить колонку "Предложенные категории":
- Показывать список предложений с процентами
- Кнопка "Применить" рядом с каждым предложением
- При клике на "Применить":
  - Присваивать категорию платежу
  - Создавать правило маппинга (если его еще нет)
  - Обновлять таблицу

#### 2.3. Автоматическое применение правил
- При загрузке CSV автоматически применять существующие правила
- Показывать в статистике загрузки:
  - Сколько расходов категоризировано автоматически
  - Сколько требует ручной категоризации

### 3. Ручной матчинг

#### 3.1. Выбор категории вручную
Для расходов без категории:
- Dropdown с выбором категории расходов
- Кнопка "Сохранить и создать правило"
- При сохранении:
  - Присваивать категорию платежу
  - Создавать правило маппинга на основе:
    - Тип паттерна: `description` (по умолчанию) или `payer` (если выбрано)
    - Значение паттерна: извлечь из описания/плательщика
    - Категория: выбранная категория
    - Приоритет: 0 (по умолчанию)

#### 3.2. Создание правила из предложения
- При применении предложения автоматически создавать правило
- Если правило уже существует - не дублировать

### 4. Backend изменения

#### 4.1. Обновить `ExpenseCategoryMappingService.findCategoryForPayment()`
- Возвращать не только `categoryId`, но и информацию о совпадении:
  ```javascript
  {
    categoryId: number,
    confidence: number, // 0-100
    patternType: string,
    patternValue: string,
    matchDetails: string // описание совпадения
  }
  ```
- Вычислять confidence на основе типа совпадения и длины

#### 4.2. Новый метод `findCategorySuggestions()`
- Находить все возможные совпадения для платежа
- Возвращать массив предложений, отсортированный по confidence
- Ограничить до 3 лучших предложений

#### 4.3. Обновить `ingestExpensesCsv()` в `PaymentService`
- При определении категории сохранять информацию о confidence
- Возвращать предложения для расходов без категории

#### 4.4. Новый API endpoint
- `POST /api/payments/:id/assign-expense-category`
  - Body: `{ expenseCategoryId: number, createMapping?: boolean, patternType?: string, patternValue?: string }`
  - Присваивает категорию платежу
  - Опционально создает правило маппинга

### 5. Frontend изменения

#### 5.1. Обновить страницу загрузки CSV расходов
- Показывать предложения категорий для каждого расхода
- Добавить UI для ручного выбора категории
- Показывать статистику категоризации

#### 5.2. Добавить секцию управления маппингами
- В настройках PNL отчета
- Список всех маппингов
- Форма создания/редактирования
- Удаление с подтверждением

### 6. База данных
Таблица `expense_category_mappings` уже существует:
```sql
CREATE TABLE expense_category_mappings (
    id SERIAL PRIMARY KEY,
    pattern_type VARCHAR(20) NOT NULL CHECK (pattern_type IN ('category', 'description', 'payer')),
    pattern_value VARCHAR(255) NOT NULL,
    expense_category_id INTEGER NOT NULL REFERENCES pnl_expense_categories(id) ON DELETE CASCADE,
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(pattern_type, pattern_value)
);
```

## Ограничения
- Правила применяются только к новым платежам при загрузке CSV
- Существующие платежи не перекатегоризируются автоматически
- При удалении категории расходов удаляются все связанные маппинги (CASCADE)
- Один паттерн (pattern_type + pattern_value) может быть связан только с одной категорией

## Приоритеты реализации
1. UI для управления маппингами в настройках (CRUD)
2. Обновление `findCategoryForPayment()` для возврата confidence
3. Метод `findCategorySuggestions()` для предложений
4. UI для отображения предложений при загрузке CSV
5. Ручной выбор категории с созданием правила
6. Автоматическое создание правил при применении предложений







