# Спецификация: Ручное редактирование полей в PNL отчете

## Цель
Добавить возможность ручного редактирования значений в PNL отчете для категорий, которые не имеют автоматизированных источников данных (например, "Наличные").

## Требования

### 1. Тип управления категориями
- Каждая категория должна иметь поле `management_type` со значениями:
  - `auto` - автоматическое управление (данные из платежей)
  - `manual` - ручное управление (ввод данных вручную)
- По умолчанию все существующие категории имеют тип `auto`
- Новые категории по умолчанию создаются с типом `auto`

### 2. Настройки категорий
- В разделе "Настройки" → "Категории приходов" добавить чекбокс "Ручное управление"
- При создании/редактировании категории можно поставить/снять галочку
- По умолчанию галочка не стоит (категория автоматическая)
- Для категорий типа `manual` отображать визуальный индикатор в списке категорий (например, иконка карандаша или метка "Ручное")

### 3. Таблица ручных записей
- Создать таблицу `pnl_manual_entries` для хранения ручных значений:
  ```sql
  CREATE TABLE pnl_manual_entries (
    id SERIAL PRIMARY KEY,
    category_id INTEGER NOT NULL REFERENCES pnl_revenue_categories(id) ON DELETE CASCADE,
    year INTEGER NOT NULL CHECK (year >= 2020 AND year <= 2030),
    month INTEGER NOT NULL CHECK (month >= 1 AND month <= 12),
    amount_pln NUMERIC(15, 2) NOT NULL DEFAULT 0,
    currency_breakdown JSONB, -- Опционально: разбивка по валютам
    notes TEXT, -- Опционально: заметки
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(category_id, year, month)
  );
  ```

### 4. UI редактирования в таблице отчета
- Для категорий типа `manual` ячейки таблицы должны быть редактируемыми
- Визуальное отличие редактируемых ячеек (например, курсор pointer, hover эффект)
- При клике на ячейку - переход в режим редактирования (input field)
- При потере фокуса (blur) или нажатии Enter - автоматическое сохранение
- Показ индикатора загрузки во время сохранения
- Обработка ошибок сохранения с показом сообщения пользователю

### 5. Backend API
- `GET /api/pnl/manual-entries?categoryId={id}&year={year}` - получить ручные записи для категории и года
- `POST /api/pnl/manual-entries` - создать/обновить ручную запись
  ```json
  {
    "categoryId": 1,
    "year": 2025,
    "month": 11,
    "amountPln": 1000.50,
    "currencyBreakdown": {"EUR": 200, "PLN": 800.50},
    "notes": "Наличные за ноябрь"
  }
  ```
- `DELETE /api/pnl/manual-entries/:id` - удалить ручную запись (опционально)

### 6. Логика агрегации
- Для категорий типа `auto`: использовать данные из платежей (как сейчас)
- Для категорий типа `manual`: использовать данные из `pnl_manual_entries`
- Если категория `auto` имеет ручные записи - они игнорируются (приоритет у автоматических данных)
- Если категория `manual` - показывать только ручные записи, игнорировать платежи

### 7. Валидация
- `amountPln` должен быть числом >= 0
- `year` должен быть в диапазоне 2020-2030
- `month` должен быть в диапазоне 1-12
- При сохранении проверять существование категории
- При сохранении проверять тип категории (можно сохранять только для `manual`)

## Примеры использования

### Пример 1: Создание категории "Наличные" с ручным управлением
1. Перейти в "Настройки" → "Категории приходов"
2. Нажать "Добавить категорию"
3. Ввести название: "Наличные"
4. Поставить галочку "Ручное управление"
5. Сохранить

### Пример 2: Редактирование значения в таблице
1. Открыть PNL отчет за нужный год
2. Найти строку категории "Наличные"
3. Кликнуть на ячейку нужного месяца
4. Ввести значение (например, 5000.00)
5. Убрать курсор из ячейки или нажать Enter
6. Значение автоматически сохраняется

### Пример 3: Просмотр данных
- В отчете категория "Наличные" показывает только ручные значения
- Категория "На счет" показывает только автоматические данные из платежей
- Категория "Мероприятия" показывает только автоматические данные из Stripe

## Технические детали

### Миграция базы данных
1. Добавить поле `management_type VARCHAR(10) DEFAULT 'auto'` в `pnl_revenue_categories`
2. Создать таблицу `pnl_manual_entries`
3. Создать индексы для быстрого поиска:
   - `CREATE INDEX idx_pnl_manual_entries_category_year ON pnl_manual_entries(category_id, year);`
   - `CREATE INDEX idx_pnl_manual_entries_category_month ON pnl_manual_entries(category_id, year, month);`

### Frontend изменения
1. Обновить форму создания/редактирования категории: добавить чекбокс "Ручное управление"
2. Добавить визуальный индикатор типа управления в списке категорий (для manual категорий)
3. Реализовать редактируемые ячейки в таблице отчета (только для manual категорий)
4. Добавить обработку событий blur/Enter для автоматического сохранения
5. Добавить индикаторы загрузки и ошибок при сохранении

### Backend изменения
1. Обновить `IncomeCategoryService` для поддержки `management_type`
2. Создать `ManualEntryService` для работы с ручными записями
3. Обновить `PnlReportService` для учета ручных записей при агрегации
4. Добавить API endpoints для CRUD операций с ручными записями

## Ограничения
- Ручные записи можно создавать только для категорий типа `manual`
- Нельзя изменить тип категории с `auto` на `manual`, если у нее уже есть платежи (или нужно предупреждение)
- Нельзя изменить тип категории с `manual` на `auto`, если у нее есть ручные записи (или нужно предупреждение)

## Будущие улучшения
- Поддержка ручных записей для категорий расходов (`pnl_expense_categories`)
- История изменений ручных записей
- Экспорт/импорт ручных записей
- Валидация на дубликаты при сохранении

