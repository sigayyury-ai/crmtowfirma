# Спецификация: Категории расходов в PNL отчете

## Цель
Добавить поддержку категорий расходов в PNL отчет с возможностью ручного ввода значений и автоматической агрегацией.

## Требования

### 1. База данных
- Использовать существующую таблицу `pnl_expense_categories`
- Текущая структура: `id`, `name`, `description`, `is_default`, `created_at`, `updated_at`
- Необходимо добавить поля:
  - `management_type VARCHAR(10) DEFAULT 'auto' CHECK (management_type IN ('auto', 'manual'))`
  - `display_order INTEGER` (опционально, для сортировки)
- Использовать существующую таблицу `pnl_manual_entries` для ручных записей расходов
  - Добавить поле `entry_type VARCHAR(10) DEFAULT 'revenue' CHECK (entry_type IN ('revenue', 'expense'))`
  - Обновить уникальный индекс: `UNIQUE(category_id, year, month, entry_type)`
  - Обновить существующие записи: `UPDATE pnl_manual_entries SET entry_type = 'revenue' WHERE entry_type IS NULL`

### 2. Настройки категорий расходов
- В разделе "Настройки" → добавить новую вкладку "Категории расходов"
- Функциональность аналогична категориям приходов:
  - Список категорий с возможностью редактирования/удаления
  - Форма создания/редактирования с полями:
    - Название (обязательное)
    - Описание (опциональное)
    - Чекбокс "Ручное управление"
  - Возможность изменения порядка категорий (если `display_order` поддерживается)

### 3. Отображение в таблице PNL отчета
- Расходы должны отображаться **выше** приходов в таблице
- Структура таблицы:
  1. Строка "Расходы" (сумма всех категорий расходов)
  2. Строки категорий расходов (с отступом)
  3. Строка "Приходы" (сумма всех категорий приходов)
  4. Строки категорий приходов (с отступом)
  5. Строка "Итого" (Приходы - Расходы) - опционально, если требуется

### 4. Ручной ввод значений
- Для категорий расходов с `management_type = 'manual'` ячейки должны быть редактируемыми
- Функциональность аналогична категориям приходов:
  - Клик по ячейке → режим редактирования
  - Потеря фокуса или Enter → автоматическое сохранение
  - Валидация: только неотрицательные числа

### 5. Backend API
- `GET /api/pnl/expense-categories` - список всех категорий расходов
- `GET /api/pnl/expense-categories/:id` - получить категорию по ID
- `POST /api/pnl/expense-categories` - создать категорию
  ```json
  {
    "name": "Аренда",
    "description": "Аренда офиса",
    "management_type": "manual"
  }
  ```
- `PUT /api/pnl/expense-categories/:id` - обновить категорию
- `DELETE /api/pnl/expense-categories/:id` - удалить категорию
- `POST /api/pnl/expense-categories/:id/reorder` - изменить порядок

- Для ручных записей расходов:
  - Использовать те же endpoints `/api/pnl/manual-entries`, но с `entryType: 'expense'`
  - Или создать отдельные endpoints `/api/pnl/expense-manual-entries`

### 6. Логика агрегации
- Для категорий расходов типа `auto`: использовать данные из банковских CSV файлов (платежи со знаком минус, `direction = 'out'`)
- Для категорий расходов типа `manual`: использовать данные из `pnl_manual_entries` с фильтром по `entry_type = 'expense'`
- Агрегация по месяцам аналогична категориям приходов
- Расчет итоговой строки "Расходы" как сумма всех категорий расходов

### 6.1. Автоматическая обработка CSV банковских файлов для расходов
- **Текущее состояние**: Расходные платежи (`direction = 'out'`) **НЕ сохраняются** в базу данных при импорте CSV
  - В `paymentService.js` строка 231: `const prepared = records.filter((item) => item.direction === 'in');`
  - Расходы просто игнорируются и считаются в `ignored`
- **Решение**: Создать **отдельный обработчик** для расходов, чтобы не ломать существующую логику приходов
- Создать новый метод `ingestExpensesCsv()` в `PaymentService` или отдельный сервис `ExpenseImportService`
- Использовать существующий код парсинга CSV из `bankStatementParser.js`
- Автоматически определять категорию расхода на основе:
  - Поля `category` из CSV файла (если есть)
  - Описания платежа (ключевые слова)
  - Плательщика (контрагента)
- Создать таблицу маппинга категорий: `expense_category_mappings`
  ```sql
  CREATE TABLE expense_category_mappings (
    id SERIAL PRIMARY KEY,
    pattern_type VARCHAR(20) NOT NULL, -- 'category', 'description', 'payer'
    pattern_value VARCHAR(255) NOT NULL,
    expense_category_id INTEGER NOT NULL REFERENCES pnl_expense_categories(id),
    priority INTEGER DEFAULT 0, -- Приоритет применения (больше = выше приоритет)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(pattern_type, pattern_value)
  );
  ```
- При импорте CSV:
  1. Парсить все записи (как сейчас)
  2. **Разделить на приходы и расходы**:
     - Приходы (`direction = 'in'`) → обрабатывать как сейчас (с матчингом к проформам)
     - Расходы (`direction = 'out'`) → обрабатывать отдельно для категоризации расходов
  3. Для расходных записей пытаться определить категорию:
     - Проверить маппинг по `category` из CSV (точное совпадение)
     - Проверить маппинг по ключевым словам в `description` (частичное совпадение, case-insensitive)
     - Проверить маппинг по `payer_name` (нормализованное имя)
     - Применять маппинги по приоритету (больше priority = выше приоритет)
     - Если категория не найдена → `expense_category_id = NULL` (требует ручной категоризации)
  4. Сохранять расходы в таблицу `payments` с полями:
     - `direction = 'out'`
     - `expense_category_id` (если определена)
     - `match_status = 'unmatched'` (расходы не матчатся к проформам)
     - Остальные поля аналогично приходам

### 7. Визуальное оформление
- Расходы должны визуально отличаться от приходов (например, красный цвет для расходов)
- Строка "Расходы" должна иметь стиль, отличный от строки "Приходы"
- Категории расходов должны иметь отступ (аналогично категориям приходов)

## Примеры использования

### Пример 1: Создание категории расходов "Аренда"
1. Перейти в "Настройки" → "Категории расходов"
2. Нажать "Добавить категорию"
3. Ввести название: "Аренда"
4. Поставить галочку "Ручное управление"
5. Сохранить

### Пример 2: Ввод расходов за месяц
1. Открыть PNL отчет за нужный год
2. Найти строку категории "Аренда" (в разделе расходов, выше приходов)
3. Кликнуть на ячейку нужного месяца
4. Ввести значение (например, 5000.00)
5. Убрать курсор из ячейки или нажать Enter
6. Значение автоматически сохраняется

### Пример 3: Просмотр отчета
- В таблице сначала отображаются расходы (сумма всех категорий расходов)
- Затем приходы (сумма всех категорий приходов)
- Можно видеть разницу между приходами и расходами по месяцам

## Технические детали

### Миграция базы данных
1. Обновить таблицу `pnl_expense_categories`:
   - Добавить поле `management_type VARCHAR(10) DEFAULT 'auto' CHECK (management_type IN ('auto', 'manual'))`
   - Добавить поле `display_order INTEGER` (опционально, для сортировки)
   - Обновить существующие категории: `UPDATE pnl_expense_categories SET management_type = 'auto' WHERE management_type IS NULL`
2. Обновить таблицу `payments`:
   - Добавить поле `expense_category_id INTEGER REFERENCES pnl_expense_categories(id) ON DELETE SET NULL`
   - Создать индекс: `CREATE INDEX idx_payments_expense_category ON payments(expense_category_id)`
3. Обновить таблицу `pnl_manual_entries`:
   - Добавить поле `entry_type VARCHAR(10) DEFAULT 'revenue' CHECK (entry_type IN ('revenue', 'expense'))`
   - Добавить поле `expense_category_id INTEGER REFERENCES pnl_expense_categories(id) ON DELETE CASCADE` (для связи с категориями расходов)
   - Обновить существующие записи: `UPDATE pnl_manual_entries SET entry_type = 'revenue' WHERE entry_type IS NULL`
   - Удалить старый уникальный индекс (если существует): `DROP INDEX IF EXISTS pnl_manual_entries_category_id_year_month_key`
   - Создать новый уникальный индекс: `CREATE UNIQUE INDEX pnl_manual_entries_unique ON pnl_manual_entries(COALESCE(category_id, expense_category_id), year, month, entry_type)`
4. Создать таблицу `expense_category_mappings`:
   - Для автоматического определения категорий расходов при импорте CSV
   - Структура: `id`, `pattern_type`, `pattern_value`, `expense_category_id`, `priority`, `created_at`
   - Уникальный индекс: `UNIQUE(pattern_type, pattern_value)`

### Frontend изменения
1. Добавить новую вкладку "Категории расходов" в настройках
2. Создать `expense-category-service.js` (или расширить существующий)
3. Обновить `pnl-report-script.js`:
   - Загружать категории расходов вместе с категориями приходов
   - Рендерить расходы выше приходов в таблице
   - Поддержать редактирование ячеек для расходов
4. Обновить стили для визуального различия расходов и приходов

### Backend изменения
1. Создать `ExpenseCategoryService` (аналогично `IncomeCategoryService`)
2. Обновить `ManualEntryService` для поддержки `entry_type`
3. Создать `ExpenseCategoryMappingService` для управления маппингами категорий
4. Создать новый метод `ingestExpensesCsv()` в `PaymentService`:
   - Отдельный обработчик для расходов (`direction = 'out'`)
   - Использовать `parseBankStatement()` для парсинга CSV
   - Фильтровать записи с `direction = 'out'`
   - Определять категорию расхода на основе маппингов
   - Сохранять в таблицу `payments` с `direction = 'out'` и `expense_category_id`
   - Не использовать матчинг к проформам (расходы не связаны с проформами)
5. Обновить `PnlReportService`:
   - Загружать категории расходов
   - Агрегировать расходы из таблицы `payments` с `direction = 'out'` (для `auto` категорий)
   - Агрегировать расходы из `pnl_manual_entries` (для `manual` категорий)
   - Возвращать расходы в ответе API
6. Добавить API endpoints:
   - Для категорий расходов (CRUD)
   - Для маппингов категорий расходов (CRUD)
   - `POST /api/payments/import-expenses` - новый endpoint для импорта CSV расходов

## Ограничения
- Ручные записи расходов можно создавать только для категорий типа `manual`
- При удалении категории расходов удаляются все связанные ручные записи (CASCADE)
- Нельзя изменить тип категории с `auto` на `manual`, если у нее есть автоматические данные (или нужно предупреждение)

## Будущие улучшения
- История изменений ручных записей расходов
- Экспорт/импорт категорий расходов
- Группировка расходов по типам (операционные, капитальные и т.д.)
- Машинное обучение для автоматического определения категорий на основе истории
- Поддержка регулярных выражений в маппингах категорий

