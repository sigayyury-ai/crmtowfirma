# Feature Specification: Stripe Events Storage & Reporting

**Feature Branch**: `001-stripe-events-storage`  
**Created**: 2025-12-02  
**Status**: Draft  
**Input**: User description: "Нужно добавить информацию о наших ивентах из страйп - Мероприятия в раздел продукты и отчеты по месяцам. А значит надо мероприятия из страйпа добавить в базу продуктов и обеспечить их тем же функционалом что и другие продукты. Возможность вдиеть список оплат из количество, статусы, сводные таблицы и цифры. Нужно интерегрировать в текущие отчеты отчет из страйп мероприятий. Для этого надо ознакомиться с тем как выводятся и работают отчет по месяцам и отчет по продуктам."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Список мероприятий из базы (Priority: P1)

Финансовый аналитик открывает вкладку «Мероприятия» и получает список событий, собранных из Supabase, с агрегированными суммами, количеством оплат и статусов без прямых запросов к Stripe.

**Why this priority**: Без локального хранения нельзя гарантировать стабильность отчётов и контроль источника данных.

**Independent Test**: Очистить кэш, запустить загрузку вкладки, убедиться, что данные берутся из Supabase (можно временно отключить доступ к Stripe — отчёт должен продолжать показывать последнюю синхронизацию).

**Acceptance Scenarios**:

1. **Given** Supabase содержит агрегаты мероприятий, **When** пользователь кликает «Обновить», **Then** таблица показывает актуальный список с суммами и количеством оплат.
2. **Given** Stripe недоступен, но Supabase заполнен, **When** пользователь открывает отчёт, **Then** он видит последние данные и отметку времени обновления.

---

### User Story 2 - Мероприятия в продуктовых и месячных отчётах (Priority: P2)

Финансовый аналитик формирует отчёт по продуктам или по месяцам и видит показатели мероприятий (выручка, количество оплат, статусы) рядом с остальными продуктами, с возможностью фильтрации и экспорта.

**Why this priority**: Бизнесу нужен сводный взгляд, где мероприятия учитываются в общей выручке и планах.

**Independent Test**: Сформировать отчёт за месяц с активными мероприятиями и проверить, что показатели совпадают с вкладкой «Мероприятия» и включаются в суммарные KPI.

**Acceptance Scenarios**:

1. **Given** в Supabase есть продукты и мероприятия за один месяц, **When** пользователь строит месячный отчёт, **Then** в итогах учитываются обе группы данных.
2. **Given** пользователь фильтрует отчёт по источнику (продукты или мероприятия), **When** применяет фильтр, **Then** таблица и сводные суммы обновляются без перезагрузки страницы.

---

### User Story 3 - Учёт возвратов и корректировок (Priority: P3)

Операционный менеджер отслеживает возвраты Stripe и ожидает, что они автоматически уменьшают выручку мероприятия и отражаются в отчётах без ручного вмешательства.

**Why this priority**: Возвраты напрямую влияют на прибыль и налоговые расчёты, данные должны быть точными.

**Independent Test**: Создать тестовый refund в Stripe, дождаться синхронизации, убедиться, что соответствующие суммы уменьшились, а статус платежа обновлён в Supabase и UI.

**Acceptance Scenarios**:

1. **Given** по мероприятию проведён refund, **When** агрегатор завершил цикл, **Then** в отчёте сумма и количество оплат уменьшаются, а запись помечена как возвращённая.
2. **Given** пользователь экспортирует CSV после возврата, **When** скачивает файл, **Then** он содержит уже скорректированные данные.

---

### Edge Cases

- Нет мероприятий за выбранный период → UI показывает пустой список и дату последнего обновления.
- Line item без описания (event_key) → должен подхватывать fallback (например, product name) и попадать в отчёт.
- Несколько валют внутри одного события → отчёт помечает предупреждение и выводит суммы отдельно по валютам и в PLN.
- Агрегатор не успел завершиться → UI отображает старые данные + явное предупреждение о дате последнего успешного цикла.
- Refund поступил после выгрузки → при следующем цикле данные пересчитываются, а выгрузки помечают время создания.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система должна сохранять и обновлять данные только по фактически оплаченным Stripe платежам (и их line items) в Supabase с event_key, валютой, суммой и статусом платежа/возврата; сессии без оплаты хранить не требуется.
- **FR-002**: Система должна инкрементально агрегировать мероприятия (payments_count, participants_count, gross_revenue, gross_revenue_pln, last_payment_at) не реже чем раз в 30 минут и по запросу пользователя.
- **FR-003**: Возвраты Stripe должны автоматически снижать суммы, количество оплат и отражаться в статусах line items и агрегатов.
- **FR-004**: API `/api/reports/stripe-events/summary`, `/api/reports/stripe-events/:eventKey`, `/api/reports/stripe-events/:eventKey/export` обязаны читать данные из Supabase и возвращать время последнего обновления.
- **FR-005**: Разделы «Продукты» и «Отчёт по месяцам» должны объединять данные продуктов и мероприятий, поддерживая фильтрацию/сводные значения и не допуская дублирования.
- **FR-006**: UI должен позволять аналитикам видеть список оплат, статусы и экспорт CSV для мероприятия, не обращаясь к Stripe напрямую.
- **FR-007**: Система должна вести журнал ошибок/статуса агрегатора и сигнализировать в UI, если последнее обновление старше заданного порога.
- **FR-008**: Интеграция с CRM автоматизациями, напоминаниями или статусами сделок не требуется; мероприятия отображаются только как отчётные данные без создания задач/уведомлений.

### Key Entities *(include if feature involves data)*

- **StripeEventItem**: отдельный line item Stripe (session_id, line_item_id, event_key, currency, amount_total, amount_pln, payment_status, customer info, timestamps).
- **StripeEventSummary**: агрегат по event_key (label, currency, payments_count, participants_count, gross_revenue, gross_revenue_pln, last_payment_at, updated_at, warnings).
- **StripeEventParticipant**: сумма оплат участника в рамках мероприятия (participant_id, email, total_amount, total_amount_pln, payments_count).
- **StripeEventAggregationJob**: метаданные последних запусков (started_at, finished_at, status, processed_sessions, detected_refunds).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Вкладка «Мероприятия» загружается < 3 секунд без активного соединения со Stripe (данные из Supabase).
- **SC-002**: Месячный отчёт отображает суммарную выручку (продукты + мероприятия) с расхождением не более 0,5% относительно данных Stripe за тот же период.
- **SC-003**: Возвраты отражаются в Supabase и UI не позднее 30 минут с момента события Stripe.
- **SC-004**: Не менее 95% запусков агрегатора завершаются успешно за < 10 минут, иначе система записывает ошибку и уведомляет аналитиков.
- **SC-005**: Экспорт CSV для мероприятия генерируется < 5 секунд и содержит статус каждого платежа и актуальные суммы на момент экспорта. 
