# Feature Specification: Безопасное логирование без чувствительных данных

**Feature Branch**: `002-sanitize-logs`  
**Created**: 2025-10-26  
**Status**: Draft  
**Input**: User description: "убрать чувствительную информацию из логов консоли для безопасности в браузере"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Сотрудник видит только обезличенные логи (Priority: P1)

Операционный сотрудник просматривает консоль браузера при ручном запуске интеграции и должен видеть только обезличенные сообщения без персональных данных клиентов или ключей.

**Why this priority**: Утечки чувствительных данных через консоль — основной риск. Без минимальной защиты нельзя тестировать интеграцию.

**Independent Test**: Запустить сценарий обработки проформ с реальными значениями и убедиться, что в консоли нет email, сумм, токенов или номеров проформ без маскировки.

**Acceptance Scenarios**:

1. **Given** произвольный объект логирования с полями email, phone и token, **When** он выводится в консоль, **Then** значения заменяются на маски вида `***masked***`.
2. **Given** сообщение об ошибке с данными проформы, **When** оно логируется, **Then** номер проформы сокращается до шаблона `CO-PROF ***/2025`, а сумма выводится диапазоном.

---

### User Story 2 - Разработчик сохраняет диагностическую ценность (Priority: P2)

Разработчик хочет видеть технические детали (тайминги, идентификаторы транзакций), но без реальных пользовательских данных.

**Why this priority**: Полное скрытие данных ухудшит отладку, нужно сбалансировать безопасность и информативность.

**Independent Test**: Включить режим логирования в разработке и убедиться, что технические поля (код ошибки, статус запроса) доступны, а PII замаскировано.

**Acceptance Scenarios**:

1. **Given** лог с полем `statusCode`, **When** он обрабатывается, **Then** статус выводится неизменным, а персональные поля маскируются.
2. **Given** включён режим детального логирования, **When** приложение работает локально, **Then** консоль содержит ссылки на correlation id и время выполнения, но не содержит реальные токены.

---

### User Story 3 - Аналитик получает отчёт о нарушениях (Priority: P3)

Ответственный за безопасность должен иметь возможность выявлять потенциальные нарушения в логах.

**Why this priority**: Даже после внедрения фильтров важно отслеживать случаи, когда данные всё же просочились.

**Independent Test**: Сохранить дамп консоли, запустить проверку и убедиться, что найденные совпадения с шаблонами PII попадают в отчёт.

**Acceptance Scenarios**:

1. **Given** в лог попало несанкционированное значение email, **When** сканер логов запускается, **Then** он помечает запись и формирует рекомендацию.
2. **Given** консоль чистая, **When** сканер запускается, **Then** отчёт не содержит предупреждений.

---

### Edge Cases

- Логи, сформированные сторонними библиотеками, нельзя напрямую модифицировать — нужно оборачивать вывод или предупреждать о невозможности фильтрации.
- В JSON-структуре по ключу `details` могут лежать вложенные объекты с секретами — фильтр должен рекурсивно искать и маскировать.
- В режиме отладки локально может потребоваться полный вывод — нужен явный флаг, чтобы не выкладывать сборку в прод с отключённой фильтрацией.
- Обработка ошибок должна учитывать сообщения, которые приходят текстом от wFirma/Pipedrive и могут содержать чувствительные данные.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST проходить все консольные сообщения через единый санитайзер перед выводом в браузер.
- **FR-002**: Санитайзер MUST маскировать персональные данные (email, телефон, ФИО), суммы платежей, номера проформ и токены доступа.
- **FR-003**: Система MUST позволять разработчику включать/выключать расширенный лог в локальном окружении через флаг окружения без изменения прод-логики.
- **FR-004**: Система MUST вести счётчик инцидентов (количество замаскированных значений) и выводить предупреждение, если встречено более N (configurable) случаев за сессию.
- **FR-005**: Для аналитики система MUST предоставлять экспорт отчёта (JSON/CSV) с перечислением найденных и замаскированных полей.
- **FR-006**: Система MUST документировать правила маскировки и накопление метрик в пользовательской инструкции.

### Key Entities *(include if feature involves data)*

- **LogEntry**: структура сообщения (уровень, текст, контекст, timestamp) до и после фильтрации.
- **SanitizedField**: объект, описывающий маскируемое поле (тип чувствительных данных, оригинальная длина, маска).
- **SanitizerConfig**: параметры (паттерны поиска, пределы предупреждений, режим разработки/production).
- **IncidentReport**: агрегированный отчёт о найденных чувствительных данных.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% сообщений, содержащих email/телефон/токен, проходят маскировку до вывода в консоль (тестируется автотестами на наборах ключевых слов).
- **SC-002**: В production-консоли ни одно сырое значение номера проформы или суммы не отображается во время ручного прогона smoke-теста.
- **SC-003**: Время обработки одного лог-сообщения санитайзером не превышает 5 мс, чтобы не тормозить UI.
- **SC-004**: Отчёт по инцидентам формируется не дольше 1 секунды для 10 000 записей.
- **SC-005**: Документация по правилам логирования обновлена и доступна операционным сотрудникам до релиза.

## Assumptions & Dependencies *(optional)*

- Приложение использует централизованный модуль логирования (возможно, расширение существующего `logger.js`).
- В production нет сторонних скриптов, которые пишут чувствительные данные напрямую.
- Список шаблонов PII (email, телефон, проформа) предоставит команда безопасности.
- Пользователи в браузере имеют консольный доступ (админы/операторы), поэтому защита логов критична.
