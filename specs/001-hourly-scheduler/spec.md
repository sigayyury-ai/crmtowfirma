# Feature Specification: Hourly CRM Scheduler

**Feature Branch**: `001-hourly-scheduler`  
**Created**: 2025-11-09  
**Status**: Ready for Planning  
**Input**: User description: "нужно переработать планировщик. Давай сделаем что каждый час будет срабатывать планировщик на поиск тригеров из CRM и удалим его ручной запуск, как будто это теперь не нужно. Он просто будет срабатывать раз в час ."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Автозапуск проверки триггеров (Priority: P1)

Финансовый координатор доверяет системе автоматическую проверку CRM-триггеров: процесс запускается каждый час без участия пользователя и подтягивает сделки, требующие генерации проформ.

**Why this priority**: Автоматический запуск устраняет человеческий фактор и снижает риск пропустить сделки, что напрямую влияет на своевременную выписку проформ.

**Independent Test**: «Поставить» тестовые CRM-сделки на триггеры, дождаться следующего часа и убедиться, что система их обработала без ручного вмешательства.

**Acceptance Scenarios**:

1. **Given** в CRM есть сделка с активным триггером, **When** наступает плановое часовое окно, **Then** система запускает обработчик и фиксирует триггер в очереди на обработку.
2. **Given** предыдущий запуск завершился с ошибкой, **When** наступает следующее часовое окно, **Then** система повторяет попытку и логирует результат.

---

### User Story 2 - Контроль и расследование без ручного запуска (Priority: P2)

Операционный менеджер контролирует процесс в интерфейсе: наблюдает историю автоматических запусков и, при необходимости, инициирует ручной polling конкретных сделок, не управляя расписанием.

**Why this priority**: Пользователям важно иметь прозрачность и возможность оперативно реагировать на исключения без риска случайно отключить регулярный процесс.

**Independent Test**: Просмотреть журнал запусков, убедиться, что данные обновляются каждый час, и выполнить ручной polling отдельно от планировщика.

**Acceptance Scenarios**:

1. **Given** пользователь открывает интерфейс мониторинга, **When** он смотрит историю запусков, **Then** видит последнюю метку времени, статус и краткую статистику без кнопок старт/стоп.
2. **Given** пользователь обнаружил непройденный триггер, **When** он инициирует ручной polling, **Then** система обрабатывает запрос, не изменяя расписание планировщика.

---

### User Story 3 - Снижение шума в интерфейсе (Priority: P3)

Пользователь не видит устаревшие элементы UI для управления планировщиком, поэтому не задаёт лишних вопросов и не совершает лишних действий.

**Why this priority**: Удаление нерелевантных контролов уменьшает когнитивную нагрузку и предотвращает ошибки.

**Independent Test**: Открыть страницу управления и убедиться, что кнопки запуска/остановки и статус планировщика отсутствуют, при этом функциональность ручного polling сохранена.

**Acceptance Scenarios**:

1. **Given** пользователь посещает страницу управления, **When** она загружается, **Then** на ней отсутствуют кнопки запуска/остановки планировщика и блок статуса.
2. **Given** пользователь обращается к API мониторинга, **When** делает запрос, **Then** получает только информацию об автоматических запусках и их результатах.

---

### Edge Cases

- Что происходит, если запланированный запуск совпадает с уже выполняющейся сессией (повторный старт должен ставиться в очередь либо пропускаться с записью в лог).
- Как система ведёт себя, если CRM недоступна в момент запуска (нужны повторные попытки и уведомление).
- Как фиксируется пропуск запуска при перезапуске сервера (после рестарта выполняется немедленный запуск, если прошёл более чем час).
- Как обрабатываются ситуации, когда в CRM нет новых триггеров (запуск должен завершаться успешно с нулевой статистикой).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST запускать обработчик CRM-триггеров автоматически каждые 60 минут, начиная с ближайшего целого часа.
- **FR-002**: Планировщик MUST исключать одновременные запуски: при активной сессии очередной запуск пропускается или ставится в очередь с записью в лог.
- **FR-003**: Планировщик MUST собирать и логировать итоги каждого запуска (время старта, длительность, количество обработанных триггеров, ошибки).
- **FR-004**: Система MUST сохранять и отображать последние N (не менее 24) результатов запусков для мониторинга.
- **FR-005**: Ручной polling MUST оставаться доступным через существующий интерфейс и API, и его выполнение не должно влиять на расписание автоматического планировщика.
- **FR-006**: Интерфейс MUST удалить элементы управления планировщиком (кнопки запуска/остановки, индикатор статуса), сохранив доступ к журналу выполнения и ручному polling.
- **FR-007**: При ошибке автоматического запуска система MUST предпринимать не менее одной повторной попытки в течение следующего часа и сигнализировать об ошибке (лог + визуальный маркер в UI).
- **FR-008**: Планировщик MUST корректно возобновляться после перезапуска приложения, учитывая время последнего успешного запуска.

### Key Entities *(include if feature involves data)*

- **SchedulerRun**: Запись о выполнении планировщика (идентификатор, время старта/окончания, длительность, статус, количество обработанных триггеров, сообщение об ошибке).
- **TriggerScanResult**: Срез найденных триггеров в конкретном запуске (идентификатор сделки, тип действия, приоритет обработки).
- **ManualPollingRequest**: История ручных запусков (время, инициатор, параметры фильтра, статус).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 95% автоматических запусков выполняются по расписанию без ручного вмешательства в течение календарной недели.
- **SC-002**: Каждый запуск завершается за ≤ 3 минут, включая повторные попытки.
- **SC-003**: 100% ошибок автоматического запуска сопровождаются записью в лог и визуальным предупреждением в UI в течение 5 минут.
- **SC-004**: Удаление ручных контролов планировщика снижает количество обращений в поддержку по вопросам расписания минимум на 50% в течение первого месяца (по сравнению со средним за предыдущие три месяца).

## Assumptions & Dependencies *(optional)*

- Текущее расписание планировщика основано на системном времени сервера и использует существующий механизм cron/node-cron.
- Ручной polling продолжает использовать текущий API и интерфейс, изменения касаются только визуального удаления кнопок планировщика.
- Уведомления об ошибках реализуются через существующую систему логирования и UI-алертов, дополнительных каналов не требуется.
- Доступ к CRM-API обеспечивает стабильное подключение; в случае длительных сбоев SLA определяется отдельно.
