# SendPulse Telegram Notification for Proforma Invoices

## Overview

После успешного создания проформы в wFirma, система должна автоматически отправлять уведомление в Telegram бот через SendPulse API (если у пользователя заполнено поле "Sendpulse ID" в Pipedrive). Уведомление информирует пользователя о том, что проформа была создана и отправлена по email. По возможности, проформу следует прикрепить к сообщению в виде файла.

## User Scenarios & Testing

### Primary Scenario: Успешное создание ProForma и отправка Telegram уведомления

1. **Предусловия**:
   - Проформа успешно создана в wFirma
   - В Pipedrive у пользователя (Person) заполнено поле "Sendpulse ID"
   - В SendPulse настроен мессенджер для Telegram

2. **Действия**:
   - Система создает проформу в wFirma и получает invoiceId
   - Система автоматически определяет SendPulse ID пользователя из Pipedrive
   - Система отправляет сообщение в Telegram через SendPulse API
   - Сообщение содержит информацию о том, что проформа была создана и отправлена по email
   - По возможности, проформа прикрепляется к сообщению в виде файла
   - Система отправляет проформу по email пользователю (отдельно, независимо от Telegram)

3. **Ожидаемый результат**:
   - Проформа успешно создана в wFirma
   - Пользователь получает уведомление в Telegram о создании проформы
   - Пользователь получает проформу по email
   - В логах фиксируется успешное создание проформы, отправка Telegram и email
   - Если прикрепление файла невозможно, отправляется только текстовое сообщение

### Alternative Scenario: Отсутствует SendPulse ID (только ProForma, без Telegram)

1. **Предусловия**:
   - Проформа успешно создана в wFirma
   - В Pipedrive у пользователя отсутствует поле "Sendpulse ID" или оно пустое

2. **Действия**:
   - Система создает проформу в wFirma и получает invoiceId
   - Система пытается получить SendPulse ID из Pipedrive
   - ID не найден или пустое
   - Система отправляет проформу по email пользователю

3. **Ожидаемый результат**:
   - Проформа успешно создана в wFirma
   - Пользователь получает проформу по email
   - Telegram уведомление не отправляется
   - В логах фиксируется успешное создание проформы, отправка email и пропуск Telegram с причиной "SendPulse ID not found"
   - Процесс создания проформы продолжается нормально (отсутствие SendPulse ID не является ошибкой)

### Alternative Scenario: Ошибка отправки через SendPulse

1. **Предусловия**:
   - Проформа успешно создана в wFirma
   - SendPulse ID найден в Pipedrive

2. **Действия**:
   - Система создает проформу в wFirma и получает invoiceId
   - Система пытается отправить сообщение через SendPulse API
   - Происходит ошибка (неверный токен, недоступен API, неверный ID мессенджера)
   - Система отправляет проформу по email пользователю (независимо от ошибки Telegram)

3. **Ожидаемый результат**:
   - Проформа успешно создана в wFirma
   - Пользователь получает проформу по email
   - Telegram уведомление не отправляется
   - В логах фиксируется успешное создание проформы, отправка email и ошибка Telegram с деталями
   - Процесс создания проформы продолжается нормально (ошибка Telegram не критична)

## Functional Requirements

### FR1: Интеграция с SendPulse API

**Описание**: Система должна интегрироваться с SendPulse API для отправки сообщений в Telegram.

**Детали**:
- Использовать ID и Secret SendPulse для аутентификации (хранятся в переменных окружения `SENDPULSE_ID` и `SENDPULSE_SECRET`)
- Использовать ID мессенджера для Telegram из переменной окружения `SENDPULSE_MESSENGER_ID`
- Поддерживать отправку текстовых сообщений через SendPulse API
- Поддерживать прикрепление файлов к сообщениям (если поддерживается SendPulse API)
- Получать учетные данные из SendPulse MCP: https://mcp.sendpulse.com/mcp

**Приемочные критерии**:
- Система успешно аутентифицируется в SendPulse API используя ID и Secret
- Система может отправлять текстовые сообщения в Telegram через SendPulse
- Система корректно обрабатывает ошибки API (неверные учетные данные, недоступность API)

### FR2: Получение SendPulse ID из Pipedrive

**Описание**: Система должна получать SendPulse ID пользователя из поля Pipedrive "Sendpulse ID".

**Детали**:
- Использовать ключ кастомного поля "Sendpulse ID": `ff1aa263ac9f0e54e2ae7bec6d7215d027bf1b8c` (переменная окружения `PIPEDRIVE_SENDPULSE_ID_FIELD_KEY` или конфигурация)
- Извлекать значение SendPulse ID из объекта Person в Pipedrive по ключу поля (значение динамическое для каждой персоны)
- Обрабатывать случаи, когда поле отсутствует или пустое

**Приемочные критерии**:
- Система корректно извлекает SendPulse ID из Pipedrive для пользователя с заполненным полем
- Система корректно обрабатывает отсутствие поля или пустое значение
- Система логирует успешное извлечение ID и пропуск отправки при отсутствии ID

### FR3: Отправка Telegram уведомления после создания ProForma

**Описание**: После успешного создания проформы в wFirma, система должна автоматически отправлять Telegram уведомление, если у пользователя есть SendPulse ID.

**Детали**:
- Отправка Telegram уведомления происходит только если:
  - Проформа успешно создана в wFirma (получен invoiceId)
  - У пользователя (Person) в Pipedrive заполнено поле "Sendpulse ID" (непустое значение)
- Отправка email происходит отдельно и независимо от Telegram (может быть до или после Telegram)
- Текст сообщения должен информировать пользователя о том, что проформа была создана и отправлена по email
- Текст сообщения должен просить пользователя проверить почту
- По возможности, проформа должна быть прикреплена к сообщению в виде файла
- Если SendPulse ID отсутствует или пустое, Telegram уведомление не отправляется, но процесс создания проформы продолжается нормально

**Приемочные критерии**:
- Telegram уведомление отправляется только после успешного создания проформы в wFirma и только если SendPulse ID заполнен
- Если SendPulse ID отсутствует, Telegram уведомление не отправляется (без ошибок)
- Создание проформы и отправка email продолжаются независимо от наличия SendPulse ID
- Текст сообщения содержит информацию о проформе (номер, сумма, если доступно)
- Если прикрепление файла невозможно, отправляется только текстовое сообщение
- Система логирует успешное создание проформы, отправку Telegram уведомления (или пропуск при отсутствии SendPulse ID) и отправку email

### FR4: Получение файла проформы из wFirma

**Описание**: Система должна получать файл проформы из wFirma для прикрепления к Telegram сообщению.

**Детали**:
- Использовать wFirma API для получения PDF файла проформы
- Сохранять файл временно для отправки через SendPulse
- Обрабатывать случаи, когда файл недоступен или получение файла не поддерживается

**Приемочные критерии**:
- Система успешно получает PDF файл проформы из wFirma (если доступно)
- Система корректно обрабатывает ошибки получения файла
- Если файл недоступен, отправляется только текстовое сообщение

### FR5: Обработка ошибок и логирование

**Описание**: Система должна корректно обрабатывать ошибки и логировать все операции.

**Детали**:
- Ошибки отправки Telegram уведомления не должны блокировать процесс создания проформы
- Все операции должны логироваться (успешная отправка, пропуск из-за отсутствия ID, ошибки API)
- Логи должны содержать достаточную информацию для диагностики (SendPulse ID, статус отправки, ошибки)

**Приемочные критерии**:
- Ошибки отправки Telegram не прерывают процесс создания проформы
- Все операции логируются с корректным уровнем (info для успеха, warn для пропусков, error для ошибок)
- Логи содержат информацию для диагностики проблем

## Success Criteria

1. **Успешная доставка уведомлений**: После отправки проформы по email, пользователи с заполненным SendPulse ID получают Telegram уведомление в течение 30 секунд в 95% случаев.

2. **Надежность системы**: Ошибки отправки Telegram уведомлений не влияют на основной процесс создания проформы (0% блокировок из-за ошибок SendPulse).

3. **Покрытие уведомлениями**: Все проформы, отправленные по email, должны получить попытку отправки Telegram уведомления (100% попыток для пользователей с SendPulse ID).

4. **Логирование**: Все операции по отправке Telegram уведомлений логируются с достаточным уровнем детализации для диагностики проблем в production.

## Key Entities

### SendPulseNotification

**Описание**: Сущность, представляющая Telegram уведомление через SendPulse.

**Поля**:
- `sendpulseId` (string, required) - ID пользователя в SendPulse
- `messageText` (string, required) - Текст сообщения
- `invoiceId` (string, required) - ID проформы в wFirma
- `invoiceNumber` (string, optional) - Номер проформы (PRO-...)
- `invoiceFile` (Buffer/File, optional) - Файл проформы для прикрепления
- `status` (string, enum: 'pending', 'sent', 'failed', 'skipped') - Статус отправки
- `error` (string, optional) - Описание ошибки (если status = 'failed')
- `sentAt` (Date, optional) - Время отправки

### PipedrivePerson

**Описание**: Объект Person из Pipedrive с дополнительным полем SendPulse ID.

**Дополнительные поля**:
- `sendpulseId` (string, optional) - Значение кастомного поля "Sendpulse ID" из Pipedrive

## Assumptions

1. **SendPulse API поддерживает Telegram**: Предполагается, что SendPulse API поддерживает отправку сообщений в Telegram через мессенджеры. Если это не так, функционал будет ограничен только текстовыми сообщениями или потребуется альтернативный подход.

2. **Прикрепление файлов**: Предполагается, что SendPulse API поддерживает прикрепление файлов к сообщениям в Telegram. Если это не поддерживается, система будет отправлять только текстовые сообщения.

3. **Формат файла проформы**: Предполагается, что wFirma API позволяет получить проформу в формате PDF. Если это не так, система будет работать без прикрепления файлов.

4. **Ключ поля Pipedrive**: Ключ кастомного поля "Sendpulse ID" в Pipedrive постоянный для всех персон: `ff1aa263ac9f0e54e2ae7bec6d7215d027bf1b8c`. Значение поля динамическое для каждой персоны.

5. **Не критичность ошибок**: Ошибки отправки Telegram уведомлений не должны блокировать основной процесс создания проформы. Это означает, что система должна продолжать работу даже при полном отказе SendPulse API.

6. **Таймауты и ретраи**: Предполагается, что SendPulse API имеет стандартные таймауты и может требовать retry логику. Система должна обрабатывать такие случаи корректно.

## Dependencies

- **SendPulse API**: Требуется доступ к SendPulse API для отправки сообщений в Telegram
- **SendPulse API Credentials**: 
  - ID: `SENDPULSE_ID` (переменная окружения) - предоставлен пользователем
  - Secret: `SENDPULSE_SECRET` (переменная окружения) - предоставлен пользователем
  - Получить можно в SendPulse MCP: https://mcp.sendpulse.com/mcp
- **SendPulse Messenger ID**: Требуется ID мессенджера для Telegram в SendPulse (переменная окружения `SENDPULSE_MESSENGER_ID`, будет определен из настроек SendPulse или конфигурации)
- **Pipedrive API**: Требуется доступ к Pipedrive API для получения SendPulse ID из поля "Sendpulse ID"
  - Ключ кастомного поля "Sendpulse ID": `ff1aa263ac9f0e54e2ae7bec6d7215d027bf1b8c` (переменная окружения `PIPEDRIVE_SENDPULSE_ID_FIELD_KEY`)
- **wFirma API**: Требуется доступ к wFirma API для получения файла проформы (опционально, для прикрепления файла)

## Constraints

1. **Не критичность ошибок**: Ошибки отправки Telegram уведомлений не должны блокировать процесс создания проформы. Система должна продолжать работу даже при полном отказе SendPulse API.

2. **Зависимость от SendPulse ID**: Telegram уведомление отправляется только если у пользователя заполнено поле "Sendpulse ID" в Pipedrive. Если поле пустое, уведомление не отправляется, но процесс создания проформы продолжается.

3. **Последовательность операций**: Telegram уведомление отправляется только после успешного создания проформы в wFirma (получения invoiceId). Отправка email происходит отдельно и независимо от Telegram.

4. **Ограничения SendPulse API**: Функционал ограничен возможностями SendPulse API (поддержка Telegram, прикрепление файлов, таймауты, rate limits).

## Out of Scope

1. **Отправка уведомлений в другие мессенджеры**: Функционал ограничен только Telegram через SendPulse. Отправка в другие мессенджеры (WhatsApp, Viber и т.д.) не входит в текущую версию.

2. **Управление мессенджерами в SendPulse**: Система не управляет настройками мессенджеров в SendPulse. Предполагается, что мессенджер для Telegram уже настроен в SendPulse.

3. **Автоматическое создание SendPulse ID**: Система не создает SendPulse ID автоматически. Предполагается, что ID уже заполнено в Pipedrive для пользователей, которые должны получать уведомления.

4. **Обработка ответов от пользователей**: Система не обрабатывает ответы от пользователей в Telegram. Функционал ограничен только отправкой уведомлений.

5. **Настройка текста сообщений через UI**: Текст сообщений предопределен в коде. Настройка текста через UI не входит в текущую версию.

