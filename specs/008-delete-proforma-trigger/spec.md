# Delete Trigger From CRM

## Overview

Команда продаж использует кастомное поле `delete` в карточке сделки Pipedrive, чтобы пометить проформу как неактуальную. Сейчас мы продолжаем хранить такие проформы в Supabase и не удаляем их из wFirma, поэтому отчёты содержат лишние строки и суммы. Нужно автоматизировать цикл: как только поле `delete` в CRM заполнено текстом `delete`, система должна удалить соответствующую проформу из wFirma, очистить связанные записи в Supabase и исключить её из всех отчётов и агрегаций.

## User Scenarios & Testing

### Primary Scenario: Менеджер помечает проформу к удалению
1. **Предусловия**: Существующая сделка Pipedrive связана с проформой в wFirma и Supabase.
2. **Действия**: менеджер CRM вводит значение `delete` в кастомное поле сделки.
3. **Ожидаемый результат**: фоновый процесс обнаруживает флаг, удаляет проформу из wFirma, удаляет записи в Supabase (`proformas`, `proforma_products`, `payments` и др.) и пишет лог события.

### Secondary Scenario: Повторная синхронизация данных
1. **Предусловия**: В Supabase осталась проформа со старым флагом `delete` (например, до запуска новой логики).
2. **Действия**: выполняется миграционный/синхронизационный скрипт.
3. **Ожидаемый результат**: проформа, помеченная `delete`, также удаляется из wFirma и Supabase, отчёты обновляются.

### Exception Scenario: Невозможно удалить проформу в wFirma
1. **Предусловия**: wFirma возвращает ошибку (например, проформа уже закрыта или не найдена).
2. **Действия**: сервис пытается удалить проформу по флагу `delete`.
3. **Ожидаемый результат**: Supabase не очищается, в логах фиксируется ошибка с описанием и идентификаторами. Задача выносится в дэшборд/алерт для ручного решения.

## Functional Requirements
1. **Источник флага**
   - При загрузке/обновлении сделок из Pipedrive считывать значение кастомного поля `delete`.
   - Значение сравнивается по точной строке `delete` (регистр — в Assumptions).

2. **Процесс удаления**
   - Если флаг активирован, процесс удаляет связанную проформу из wFirma через официальный API.
   - После успешного удаления из wFirma очищаются данные в Supabase: `proformas`, `proforma_products`, связанные `payments`, агрегаты и кэш.
   - В отчётные сервисы (`/vat-margin/...`) проформа больше не попадает.

3. **Идемпотентность и безопасность**
   - Повторный запуск обработки по той же проформе не должен вызывать ошибок (удаления idempotent).
   - Хранить журнал удалений (id проформы, deal id, время, инициатор) для аудита.
   - Предусмотреть защиту от случайного удаления: если проформа уже была оплачена или связана с бухгалтерским документом, поведение оговаривается (см. Assumptions).

4. **Миграция исторических данных**
   - Предоставить скрипт/процедуру, который обходит существующие проформы, смотрит поле `delete` в CRM и удаляет устаревшие записи.

5. **Обновление отчётов и агрегаций**
   - После удаления актуализировать суммы (`payments_total`, агрегаты по продуктам и т.д.), чтобы отчёты показывали корректные значения.

## Success Criteria
- 100 % проформ с полем `delete` удаляются из wFirma и Supabase в течение SLA (например, не позже 15 минут после изменения поля).
- Повторная синхронизация не возвращает удалённые проформы обратно в базу.
- Аудит-лог содержит запись о каждом удалении (с deal id, номером проформы, временем).
- Финансовые отчёты (месячный и по продуктам) не содержат проформ, помеченных `delete`, и их суммы не учитываются в агрегатах.

## Assumptions
- Значение поля `delete` задаётся точной строкой `delete` (в нижнем регистре); любое другое значение трактуется как «оставить проформу».
- Поле устанавливается вручную и намеренно; дополнительных подтверждений не требуется.
- Проформы, уже выставленные в бухгалтерию или отправленные клиенту, можно удалять (нет юридических ограничений). Если ограничения появятся, добавим дополнительную проверку статуса в wFirma.

## Out of Scope
- Удаление связанных документов вне wFirma (например, файлы или сообщения).
- Восстановление проформ после удаления (обговаривается отдельно).
- Изменение бизнес-процесса в Pipedrive (кто и когда ставит флаг delete).

## Key Entities
- **Deal (Pipedrive)**: содержит кастомное поле `delete`, хранит ссылку на проформу.
- **Proforma (wFirma + Supabase)**: удаляется при активации флага.
- **Audit log entry**: фиксирует факт удаления и контекст.
