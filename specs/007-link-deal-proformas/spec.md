# Link Proformas To CRM Deals

## Overview

Команде нужен единый источник данных, где каждая проформа связана с исходной сделкой в Pipedrive. Сейчас в Supabase нет идентификатора сделки, а в отчётах невозможно перейти к карточке сделки и проверить переписку или статус выполнения. Требуется сохранить `deal_id` при создании/миграции проформ и вывести ссылку на сделку в отчёте VAT Margin, чтобы можно было быстро перейти в CRM.

## User Scenarios & Testing

### Primary Scenario: Создание новой проформы
1. **Предусловия**: Процессор создаёт проформу по сделке Pipedrive, у сделки есть уникальный `deal_id`.
2. **Действия**: сервис обработки проформ сохраняет данные в Supabase.
3. **Ожидаемый результат**: запись в таблице `proformas` содержит `pipedrive_deal_id`; отчёт API возвращает ссылку на сделку.

### Secondary Scenario: Просмотр отчёта по проформам
1. **Предусловия**: В Supabase есть проформы с заполненным `pipedrive_deal_id`.
2. **Действия**: пользователь открывает вкладку отчёта, система загружает данные.
3. **Ожидаемый результат**: в таблице каждая строка содержит кликабельную ссылку вида `https://comoon.pipedrive.com/deal/<id>`.

### Secondary Scenario: Обратная совместимость
1. **Предусловия**: В базе уже есть проформы без `pipedrive_deal_id`.
2. **Действия**: выполняется скрипт миграции или повторная синхронизация, где известен идентификатор сделки.
3. **Ожидаемый результат**: существующие записи получают `pipedrive_deal_id`, таблица отчёта отображает ссылку только для тех проформ, где поле заполнено.

## Functional Requirements
1. **Хранение данных**
   - Добавить в таблицу `proformas` Supabase столбец `pipedrive_deal_id` (тип `text` или `bigint`, допускающий `NULL`).
   - Обновить репозиторий и сервисы сохранения проформ, чтобы при создании новой проформы (или обновлении) в Supabase записывался `pipedrive_deal_id`.
2. **Источник данных**
   - При создании проформы процессор должен получать deal id из исходной сделки (в invoiceProcessing уже есть информация о Pipedrive deal) и передавать его при сохранении.
   - Миграционный или повторный импорт должен уметь подставить `pipedrive_deal_id` для уже существующих проформ, если эта информация доступна (например, из Pipedrive API).
3. **API**
   - Endpoint `/api/vat-margin/monthly-proformas` и все внутренние сервисы, формирующие строки для фронтенда, должны добавлять в ответ два поля: `pipedrive_deal_id` и `pipedrive_deal_url` (`https://comoon.pipedrive.com/deal/<id>`).
   - При отсутствии `pipedrive_deal_id` сервис возвращает `null` и не формирует URL.
4. **Фронтенд**
   - Таблица отчёта показывает ссылку «Deal #<id>» рядом с номером проформы (или в отдельной колонке). Клик открывает Pipedrive в новой вкладке.
   - Для строк без `deal_id` интерфейс остаётся неизменным (нет пустых ссылок).
5. **Мониторинг качества данных**
   - В логах / метриках желательно фиксировать количество проформ без `deal_id`, чтобы команда могла найти пропуски.

## Success Criteria
- 100 % новых проформ получают `pipedrive_deal_id` в Supabase.
- В отчёте VAT Margin по выбранному периоду каждая строка с `deal_id` содержит рабочую ссылку на карточку сделки.
- Горизонтальная проверка: случайная выборка из 10 исторических проформ показывает, что ссылка ведёт на ожидаемую сделку.
- Количество проформ без `deal_id` после миграции не превышает заранее согласованный порог (зафиксировать в мониторинге).

## Assumptions
- Базовый URL CRM фиксированный: `https://comoon.pipedrive.com/deal/`.
- Процессор создания проформ всегда знает `deal_id` исходной сделки.
- Миграционные скрипты имеют возможность получить `deal_id` из Pipedrive (через API или кэш).

## Out of Scope
- Изменение прав доступа в Pipedrive или авторизации.
- Отображение дополнительных данных сделки (статус, суммы и т.п.).
- Работа с несколькими CRM одновременно.

## Key Entities
- **Proforma**: пополняется полем `pipedrive_deal_id`, связана с `deal_url` в отчёте.
- **Deal**: сущность в Pipedrive, идентифицируется `id`, используется для построения ссылок.

