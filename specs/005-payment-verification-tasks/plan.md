# Implementation Plan: Payment Verification Tasks in Pipedrive

## Overview

Этот план описывает реализацию функционала автоматического создания задач в Pipedrive для проверки платежей после успешного создания проформы в wFirma.

## Technical Context

### Current System Architecture

- **PipedriveClient** (`src/services/pipedrive.js`): Клиент для работы с Pipedrive API
- **InvoiceProcessingService** (`src/services/invoiceProcessing.js`): Сервис обработки сделок и создания проформ
- **WfirmaClient** (`src/services/wfirma.js`): Клиент для работы с wFirma API

### Payment Schedule Logic

Текущая логика определения графика платежей в `InvoiceProcessingService`:

1. **График 50/50** (если `expected_close_date` существует и до него больше месяца):
   - 50% предоплата сейчас
   - 50% остаток до `expected_close_date - 1 месяц`
   - Формат описания: `"График платежей: 50% предоплата (${depositAmount} ${currency}) оплачивается сейчас; 50% остаток (${balanceAmount} ${currency}) до ${secondPaymentDateStr}."`

2. **График 100%** (если нет `expected_close_date` или до него меньше месяца):
   - 100% оплата до `issueDate + PAYMENT_TERMS_DAYS` (3 дня)
   - Формат описания: `"График платежей: 100% оплата (${totalAmount} ${currency}) до ${paymentDateStr}."`

### Integration Point

Задачи должны создаваться после успешного создания проформы в wFirma, в методе `processDealInvoice()` в `InvoiceProcessingService`, после получения `invoiceId` и `invoiceNumber`.

### Pipedrive API

**NEEDS CLARIFICATION**: Точный endpoint для создания задач в Pipedrive API
- Возможные варианты: `POST /activities`, `POST /tasks`, `POST /activities/type/task`
- Требуется уточнение из документации Pipedrive API

## Implementation Strategy

### Phase 1: Parser for Payment Schedule

**Цель**: Создать парсер для извлечения графика платежей из описания проформы

**Задачи**:
1. Создать метод `parsePaymentSchedule(invoiceDescription)` в `InvoiceProcessingService`:
   - Распознавать график 50/50: извлекать даты и суммы из формата "50% предоплата ... до [дата]"
   - Распознавать график 100%: извлекать дату и сумму из формата "100% оплата ... до [дата]"
   - Возвращать структуру `PaymentSchedule` с типом, датами и суммами
   - Обрабатывать случаи, когда график не распознан

2. Добавить валидацию:
   - Проверка формата дат
   - Проверка сумм
   - Обработка ошибок парсинга

**Ключевые компоненты**:
- Регулярные выражения для распознавания формата графика
- Метод `parsePaymentSchedule()` в `InvoiceProcessingService`
- Структура данных `PaymentSchedule`

### Phase 2: Task Creation Logic

**Цель**: Реализовать логику определения количества задач и их параметров

**Задачи**:
1. Создать метод `determineTaskCount(paymentSchedule)`:
   - Определять, нужно ли создавать 1 или 2 задачи
   - Логика: если график 50/50 и разница между датами > 30 дней → 2 задачи, иначе → 1 задача
   - Возвращать массив задач с параметрами (название, описание, дата, сумма)

2. Создать метод `generateTaskParams(paymentSchedule, invoiceNumber, dealId)`:
   - Генерировать параметры для задач на основе графика платежей
   - Для графика 50/50: две задачи (предоплата + остаток)
   - Для графика 100%: одна задача (полная оплата)
   - Включать номер проформы в название и описание

**Ключевые компоненты**:
- Метод `determineTaskCount()` в `InvoiceProcessingService`
- Метод `generateTaskParams()` в `InvoiceProcessingService`
- Структура данных для параметров задач

### Phase 3: Pipedrive API Integration

**Цель**: Добавить метод создания задач в Pipedrive через API

**Задачи**:
1. Добавить метод `createTask(taskParams)` в `PipedriveClient`:
   - Использовать Pipedrive API для создания задачи
   - Endpoint: уточнить из документации (возможные варианты: `POST /activities`, `POST /tasks`)
   - Параметры: `deal_id`, `subject`, `note`, `due_date`, `type`
   - Обработка ошибок API

2. Добавить обработку ответа:
   - Проверка успешности создания
   - Возврат ID созданной задачи
   - Логирование результата

**Ключевые компоненты**:
- Метод `createTask()` в `PipedriveClient`
- Метод `createActivities()` или аналогичный (зависит от API)
- Обработка ошибок и логирование

### Phase 4: Integration with Invoice Processing

**Цель**: Интегрировать создание задач в процесс обработки сделки

**Задачи**:
1. Модифицировать `processDealInvoice()` в `InvoiceProcessingService`:
   - После успешного создания проформы (получения `invoiceId` и `invoiceNumber`)
   - Извлечь описание проформы из результата создания
   - Распарсить график платежей из описания
   - Определить количество и параметры задач
   - Создать задачи в Pipedrive для каждой задачи

2. Добавить обработку ошибок:
   - Ошибки парсинга графика не блокируют процесс
   - Ошибки создания задач не блокируют процесс
   - Логирование всех операций

**Точка интеграции**:
- В методе `processDealInvoice()` после строки 435 (после успешного создания проформы)
- После отправки Telegram уведомления (если есть)
- Перед или после отправки email

### Phase 5: Error Handling and Logging

**Цель**: Обеспечить надежную обработку ошибок и логирование

**Задачи**:
1. Обработка ошибок парсинга:
   - Не критичные ошибки (не блокируют процесс создания проформы)
   - Логирование предупреждений о невозможности определить график
   - Продолжение процесса создания проформы

2. Обработка ошибок создания задач:
   - Не критичные ошибки (не блокируют процесс создания проформы)
   - Логирование всех ошибок с деталями (ID сделки, номер проформы, ошибки API)
   - Продолжение процесса создания проформы

3. Логирование:
   - Успешное создание задач (количество, ID задач)
   - Пропуск создания задач при невозможности определить график
   - Ошибки API с деталями

## Dependencies

### External APIs

- **Pipedrive API**: Требуется доступ к API для создания задач
  - Endpoint: уточнить из документации (возможные варианты: `POST /activities`, `POST /tasks`)
  - Требуемые права: создание задач в сделках
  - Документация: https://developers.pipedrive.com/docs/api/v1

- **wFirma API**: Уже используется для получения информации о проформе
  - Endpoint: `GET /invoices/get/{invoiceId}`
  - Поле для графика платежей: `description` или `invoicecontents`

### Internal Dependencies

- **InvoiceProcessingService**: Требуется модификация метода `processDealInvoice()`
- **PipedriveClient**: Требуется добавление метода `createTask()`
- **Payment Schedule Parser**: Новый компонент для парсинга графика платежей

## Technical Decisions

### Decision 1: Payment Schedule Parsing

**Вариант A**: Парсить из описания проформы после создания
- **Плюсы**: Использует уже существующую информацию
- **Минусы**: Зависит от формата описания, который может измениться

**Вариант B**: Использовать данные из процесса создания проформы
- **Плюсы**: Не зависит от формата описания
- **Минусы**: Требует сохранения данных о графике платежей в процессе создания

**Решение**: Использовать Вариант A с возможностью перехода на Вариант B при необходимости

### Decision 2: Task Creation Endpoint

**Вариант A**: `POST /activities` с типом `task`
- **Плюсы**: Универсальный endpoint для всех типов активностей
- **Минусы**: Требует уточнения параметров

**Вариант B**: `POST /tasks` (если существует)
- **Плюсы**: Специализированный endpoint для задач
- **Минусы**: Может не существовать в API

**Решение**: **NEEDS CLARIFICATION** - требуется уточнение из документации Pipedrive API

### Decision 3: Error Handling Strategy

**Вариант A**: Строгая обработка ошибок (блокировать процесс при ошибках)
- **Плюсы**: Гарантирует создание задач
- **Минусы**: Блокирует процесс создания проформы при проблемах с задачами

**Вариант B**: Не критичная обработка ошибок (не блокировать процесс)
- **Плюсы**: Не блокирует основной процесс
- **Минусы**: Задачи могут не создаваться при ошибках

**Решение**: Использовать Вариант B - ошибки создания задач не должны блокировать процесс создания проформы (согласно спецификации)

## Research Required

1. **Pipedrive API для создания задач**:
   - Точный endpoint для создания задач
   - Обязательные и опциональные параметры
   - Формат запроса и ответа
   - Обработка ошибок

2. **Формат описания проформы в wFirma**:
   - Точный формат описания с графиком платежей
   - Возможность изменения формата
   - Альтернативные источники информации о графике платежей

## Testing Strategy

### Unit Tests

- Тестирование парсера графика платежей:
  - Распознавание графика 50/50
  - Распознавание графика 100%
  - Обработка неверного формата
  - Обработка отсутствия графика

- Тестирование логики определения количества задач:
  - График 50/50 с большими сроками → 2 задачи
  - График 50/50 с малыми сроками → 1 задача
  - График 100% → 1 задача

### Integration Tests

- Тестирование создания задач в Pipedrive:
  - Успешное создание одной задачи
  - Успешное создание двух задач
  - Обработка ошибок API
  - Проверка параметров задач

### End-to-End Tests

- Тестирование полного процесса:
  - Создание проформы → создание задач
  - Проверка наличия задач в сделке Pipedrive
  - Проверка параметров задач (название, описание, дата)

## Implementation Phases

### Phase 1: Payment Schedule Parser (MVP)
- Создать парсер графика платежей
- Распознавать график 50/50 и 100%
- Извлекать даты и суммы

### Phase 2: Task Creation Logic
- Реализовать логику определения количества задач
- Генерировать параметры задач
- Определять сроки выполнения

### Phase 3: Pipedrive API Integration
- Добавить метод создания задач в PipedriveClient
- Интегрировать с Pipedrive API
- Обработать ошибки API

### Phase 4: Full Integration
- Интегрировать создание задач в процесс обработки сделки
- Добавить обработку ошибок
- Добавить логирование

### Phase 5: Error Handling and Logging
- Улучшить обработку ошибок
- Добавить детальное логирование
- Тестирование всех сценариев

## Success Criteria

1. **Успешное создание задач**: После создания проформы, задачи создаются в сделке Pipedrive в 95% случаев
2. **Правильное количество задач**: Система корректно определяет количество задач (1 или 2) в 98% случаев
3. **Правильные сроки выполнения**: Сроки выполнения задач соответствуют датам платежей в 100% случаев
4. **Надежность системы**: Ошибки создания задач не влияют на основной процесс (0% блокировок)

