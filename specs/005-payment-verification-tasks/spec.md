# Payment Verification Tasks in Pipedrive

## Overview

После успешного создания проформы в wFirma, система должна автоматически создавать задачи в сделке Pipedrive для проверки платежей. Количество задач зависит от графика платежей, указанного в проформе. Если сроки платежей больше месяца (график 50/50), создаются две задачи. Если сроки меньше месяца (график 100%), создается одна задача. Задачи должны быть привязаны к сделке и иметь сроки выполнения, соответствующие срокам платежей из проформы.

## User Scenarios & Testing

### Primary Scenario: Создание задач для проверки платежей (график 50/50)

1. **Предусловия**:
   - Проформа успешно создана в wFirma
   - График платежей: 50% предоплата сейчас, 50% остаток до определенной даты (больше месяца от текущей даты)
   - Сделка существует в Pipedrive

2. **Действия**:
   - Система создает проформу в wFirma и получает invoiceId и invoiceNumber
   - Система определяет график платежей из описания проформы (50/50)
   - Система извлекает даты платежей из графика
   - Система создает первую задачу в сделке Pipedrive для проверки предоплаты (50%)
   - Система создает вторую задачу в сделке Pipedrive для проверки остатка (50%)
   - Задачи привязаны к сделке и имеют соответствующие сроки выполнения

3. **Ожидаемый результат**:
   - Проформа успешно создана в wFirma
   - В сделке Pipedrive созданы две задачи:
     - Первая задача: проверка предоплаты (50%) со сроком выполнения, соответствующим дате предоплаты
     - Вторая задача: проверка остатка (50%) со сроком выполнения, соответствующим дате остатка
   - Задачи имеют понятные названия и описания, указывающие на номер проформы
   - В логах фиксируется успешное создание задач

### Primary Scenario: Создание задачи для проверки платежа (график 100%)

1. **Предусловия**:
   - Проформа успешно создана в wFirma
   - График платежей: 100% оплата до определенной даты (меньше месяца от текущей даты)
   - Сделка существует в Pipedrive

2. **Действия**:
   - Система создает проформу в wFirma и получает invoiceId и invoiceNumber
   - Система определяет график платежей из описания проформы (100%)
   - Система извлекает дату платежа из графика
   - Система создает одну задачу в сделке Pipedrive для проверки платежа (100%)
   - Задача привязана к сделке и имеет срок выполнения, соответствующий дате платежа

3. **Ожидаемый результат**:
   - Проформа успешно создана в wFirma
   - В сделке Pipedrive создана одна задача:
     - Задача: проверка платежа (100%) со сроком выполнения, соответствующим дате платежа
   - Задача имеет понятное название и описание, указывающее на номер проформы
   - В логах фиксируется успешное создание задачи

### Alternative Scenario: Ошибка создания задачи в Pipedrive

1. **Предусловия**:
   - Проформа успешно создана в wFirma
   - Сделка существует в Pipedrive
   - Pipedrive API недоступен или возвращает ошибку

2. **Действия**:
   - Система создает проформу в wFirma и получает invoiceId и invoiceNumber
   - Система пытается создать задачу в Pipedrive
   - Происходит ошибка (недоступен API, неверные права доступа, неверный ID сделки)

3. **Ожидаемый результат**:
   - Проформа успешно создана в wFirma
   - Задача не создана в Pipedrive
   - В логах фиксируется ошибка создания задачи с деталями
   - Процесс создания проформы продолжается нормально (ошибка создания задачи не критична)

### Alternative Scenario: Не удалось определить график платежей

1. **Предусловия**:
   - Проформа успешно создана в wFirma
   - Описание проформы не содержит информации о графике платежей или формат не распознан
   - Сделка существует в Pipedrive

2. **Действия**:
   - Система создает проформу в wFirma и получает invoiceId и invoiceNumber
   - Система пытается определить график платежей из описания проформы
   - График платежей не распознан или отсутствует

3. **Ожидаемый результат**:
   - Проформа успешно создана в wFirma
   - Задача не создана в Pipedrive (не удалось определить сроки)
   - В логах фиксируется предупреждение о невозможности определить график платежей
   - Процесс создания проформы продолжается нормально (отсутствие задачи не критично)

## Functional Requirements

### FR1: Определение графика платежей из проформы

**Описание**: Система должна определять график платежей из описания проформы, созданной в wFirma.

**Детали**:
- Извлекать информацию о графике платежей из описания проформы (поле `description` или `invoicecontents`)
- Распознавать два типа графиков:
  - График 50/50: "50% предоплата ... оплачивается сейчас; 50% остаток ... до [дата]"
  - График 100%: "100% оплата ... до [дата]"
- Извлекать даты платежей из описания
- Определять, какой график применяется на основе структуры описания

**Приемочные критерии**:
- Система корректно распознает график 50/50 из описания проформы
- Система корректно распознает график 100% из описания проформы
- Система корректно извлекает даты платежей из обоих типов графиков
- Система корректно обрабатывает случаи, когда график не распознан

### FR2: Определение количества задач

**Описание**: Система должна определять количество задач для создания на основе графика платежей и сроков.

**Детали**:
- Если график 50/50 и сроки платежей больше месяца от текущей даты:
  - Создавать две задачи: одна для предоплаты (50%), вторая для остатка (50%)
- Если график 100% или сроки платежей меньше месяца:
  - Создавать одну задачу для проверки платежа (100%)
- Определение "больше месяца" должно быть основано на разнице между датой первого платежа и датой последнего платежа

**Приемочные критерии**:
- Система корректно определяет, что нужно создать две задачи для графика 50/50 с большими сроками
- Система корректно определяет, что нужно создать одну задачу для графика 100% или малых сроков
- Логика определения количества задач основана на разнице дат платежей

### FR3: Создание задач в Pipedrive

**Описание**: Система должна создавать задачи в сделке Pipedrive через Pipedrive API.

**Детали**:
- Использовать Pipedrive API для создания задач в сделке
- Задачи должны быть привязаны к сделке (deal_id)
- Задачи должны иметь:
  - Название (subject), указывающее на проверку платежа и номер проформы
  - Описание (note), содержащее информацию о проформе и сумме платежа
  - Срок выполнения (due_date), соответствующий дате платежа из графика
  - Тип задачи (type) - "payment_verification" или аналогичный
- Для графика 50/50: создавать две задачи с разными датами и суммами
- Для графика 100%: создавать одну задачу с датой и суммой платежа

**Приемочные критерии**:
- Система успешно создает задачи в Pipedrive через API
- Задачи корректно привязаны к сделке
- Задачи имеют правильные названия, описания и сроки выполнения
- Задачи содержат информацию о номере проформы и сумме платежа

### FR4: Обработка ошибок и логирование

**Описание**: Система должна корректно обрабатывать ошибки создания задач и логировать все операции.

**Детали**:
- Ошибки создания задач не должны блокировать процесс создания проформы
- Все операции должны логироваться (успешное создание задач, ошибки API, невозможность определить график)
- Логи должны содержать достаточную информацию для диагностики (номер проформы, ID сделки, количество задач, ошибки)

**Приемочные критерии**:
- Ошибки создания задач не прерывают процесс создания проформы
- Все операции логируются с корректным уровнем (info для успеха, warn для пропусков, error для ошибок)
- Логи содержат информацию для диагностики проблем

## Success Criteria

1. **Успешное создание задач**: После создания проформы, задачи для проверки платежей создаются в сделке Pipedrive в 95% случаев для проформ с распознаваемым графиком платежей.

2. **Правильное количество задач**: Система корректно определяет количество задач (1 или 2) на основе графика платежей в 98% случаев.

3. **Правильные сроки выполнения**: Сроки выполнения задач соответствуют датам платежей из графика проформы в 100% случаев.

4. **Надежность системы**: Ошибки создания задач не влияют на основной процесс создания проформы (0% блокировок из-за ошибок создания задач).

5. **Логирование**: Все операции по созданию задач логируются с достаточным уровнем детализации для диагностики проблем в production.

## Key Entities

### PaymentSchedule

**Описание**: Сущность, представляющая график платежей из проформы.

**Поля**:
- `type` (string, enum: '50/50', '100%') - Тип графика платежей
- `firstPaymentDate` (Date, optional) - Дата первого платежа (для графика 50/50)
- `firstPaymentAmount` (number, optional) - Сумма первого платежа (для графика 50/50)
- `secondPaymentDate` (Date, optional) - Дата второго платежа (для графика 50/50)
- `secondPaymentAmount` (number, optional) - Сумма второго платежа (для графика 50/50)
- `singlePaymentDate` (Date, optional) - Дата платежа (для графика 100%)
- `singlePaymentAmount` (number, optional) - Сумма платежа (для графика 100%)
- `currency` (string) - Валюта платежей

### PipedriveTask

**Описание**: Сущность, представляющая задачу в Pipedrive.

**Поля**:
- `subject` (string, required) - Название задачи
- `note` (string, optional) - Описание задачи
- `due_date` (Date, required) - Срок выполнения задачи
- `deal_id` (number, required) - ID сделки, к которой привязана задача
- `type` (string, optional) - Тип задачи
- `assigned_to_user_id` (number, optional) - ID пользователя, ответственного за задачу

## Assumptions

1. **Pipedrive API поддерживает создание задач**: Предполагается, что Pipedrive API поддерживает создание задач в сделках через API. Если это не так, функционал будет ограничен или потребуется альтернативный подход.

2. **Формат описания проформы**: Предполагается, что описание проформы в wFirma содержит информацию о графике платежей в формате, который можно распознать. Если формат изменится, потребуется обновление логики распознавания.

3. **Определение "больше месяца"**: Предполагается, что "больше месяца" означает разницу между датой первого платежа и датой последнего платежа более 30 дней. Это значение может быть настроено.

4. **Не критичность ошибок**: Ошибки создания задач не должны блокировать основной процесс создания проформы. Это означает, что система должна продолжать работу даже при полном отказе Pipedrive API.

5. **Права доступа**: Предполагается, что API токен Pipedrive имеет права на создание задач в сделках. Если прав недостаточно, система должна логировать ошибку и продолжать работу.

## Dependencies

- **Pipedrive API**: Требуется доступ к Pipedrive API для создания задач в сделках
  - Endpoint для создания задач: `POST /activities` или `POST /tasks` (требуется уточнение из документации Pipedrive)
  - Параметры: `deal_id`, `subject`, `note`, `due_date`, `type`
- **wFirma API**: Требуется доступ к wFirma API для получения информации о проформе (описание, график платежей)
  - Endpoint для получения проформы: `GET /invoices/get/{invoiceId}`
  - Поле для графика платежей: `description` или `invoicecontents`

## Constraints

1. **Не критичность ошибок**: Ошибки создания задач не должны блокировать процесс создания проформы. Система должна продолжать работу даже при полном отказе Pipedrive API.

2. **Зависимость от формата описания**: Система зависит от формата описания проформы в wFirma. Если формат изменится, потребуется обновление логики распознавания графика платежей.

3. **Последовательность операций**: Задачи создаются только после успешного создания проформы в wFirma (получения invoiceId и invoiceNumber).

4. **Ограничения Pipedrive API**: Функционал ограничен возможностями Pipedrive API (создание задач, права доступа, таймауты, rate limits).

## Out of Scope

1. **Управление задачами**: Система не управляет существующими задачами (обновление, удаление, закрытие). Функционал ограничен только созданием новых задач.

2. **Автоматическое закрытие задач**: Система не закрывает задачи автоматически при получении платежа. Это должен делать пользователь вручную или через другую автоматизацию.

3. **Уведомления о задачах**: Система не отправляет уведомления о созданных задачах. Уведомления обрабатываются самим Pipedrive.

4. **Настройка типов задач**: Система не управляет типами задач в Pipedrive. Предполагается, что тип задачи уже настроен в Pipedrive или будет использован стандартный тип.

5. **Назначение ответственных**: Система не назначает ответственных за задачи автоматически. Если требуется назначение, это должно быть настроено в Pipedrive или через другой механизм.

