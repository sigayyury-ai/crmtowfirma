# План внедрения: синхронизация номера проформы в CRM

## Обзор

Цель — автоматически заполнять поле «Invoice number» в сделке Pipedrive номером проформы сразу после создания документа в wFirma. Задача включает обновление основного процессора выставления проформ, обработку ошибок и скрипт повторной синхронизации для исторических сделок.

## Технический контекст

- **Процессор счетов** (`src/services/invoiceProcessing.js`):
  - Создаёт проформу в wFirma и сохраняет её в Supabase.
  - Содержит методы `createInvoiceInWfirma`, `persistProformaToDatabase`, `clearInvoiceTrigger`.
  - Уже умеет обновлять поле `Invoice type` в сделке (ключ `ad67729ecfe0345287b71a3b00910e8ba5b3b496`).
- **PipedriveClient** (`src/services/pipedrive.js`):
  - Оборачивает REST-вызовы Pipedrive, умеет читать/обновлять сделки (`updateDeal`).
  - На данный момент нет целевого поля для номера проформы.
- **Конфигурация**:
  - Секреты Pipedrive передаются через `PIPEDRIVE_API_TOKEN`.
  - В `.env` отсутствует ключ для нового поля «Invoice number».
- **Исторические данные**:
  - В Supabase хранится `proformas.fullnumber`.
  - В Pipedrive поле «Invoice number» пока пустое.

## Стратегия реализации

### Этап 0. Подготовка
- Получить у команды ключ нового поля (например, `PIPEDRIVE_INVOICE_NUMBER_FIELD_KEY`).
- Обновить `env.example`, README, прод/стейдж окружения.
- Уточнить требования к повторной синхронизации (объём, расписание).

### Этап 1. Обновление процессора
1. После успешного создания проформы извлекать `fullnumber` из результата (`invoiceResult.invoiceNumber`), либо догружать через `getFullProformaById`.
2. Расширить `clearInvoiceTrigger` или создать отдельный метод `updateInvoiceNumber(dealId, fullnumber)`:
   - Формировать payload `{ [invoiceNumberFieldKey]: fullnumber }`.
   - Использовать `PipedriveClient.updateDeal`.
3. Обновить `processDealInvoice`:
   - После `persistProformaToDatabase` вызвать обновление поля.
   - Логировать успех/ошибку.

### Этап 2. Обработка ошибок и ретраи
1. Добавить утилиту `retryAsync(fn, attempts, backoff)` или переиспользовать существующую реализацию (если есть).
2. Окружить вызов Pipedrive обновления ретраем (например, 3 попытки: 0с → 2с → 5с).
3. В случае окончательного провала:
   - Логировать error с dealId, fullnumber, причиной.
   - Отправить уведомление/метрику (опционально).

### Этап 3. Повторная синхронизация
1. Создать скрипт `scripts/backfillInvoiceNumbers.js`:
   - Читает проформы из Supabase.
   - Находит связанные сделок по `proformas.pipedrive_deal_id`.
   - Обновляет поле «Invoice number», если пусто или отличается от `fullnumber`.
2. Добавить dry-run режим и опции `--limit`, `--offset`, `--deal`.
3. Описать инструкцию запуска (README/docs).

### Этап 4. Тестирование
- Написать unit-тесты (если есть инфраструктура) или добавить manual-checklist:
  - Создание новой проформы → поле заполняется.
  - Ошибка Pipedrive → ретрай → лог.
  - Backfill для набора сделок.
- Подготовить e2e-скрипт (на стейдже) для выборочной проверки.

### Этап 5. Документация и релиз
- Обновить README раздел «Pipedrive поля».
- Документировать процесс backfill (внутренний runbook).
- Согласовать дату выполнения backfill с финансовой командой.

## Технические решения

1. **Обновление поля**: добавляем новое свойство в `InvoiceProcessingService`:
   ```js
   this.INVOICE_NUMBER_FIELD_KEY = process.env.PIPEDRIVE_INVOICE_NUMBER_FIELD_KEY?.trim();
   ```
2. **Payload**: `{ [this.INVOICE_NUMBER_FIELD_KEY]: fullnumber }`, без дополнительных структур.
3. **Идempotентность**: если поле уже содержит нужное значение, `updateDeal` не вызываем (сравниваем перед вызовом).
4. **Backfill**: использовать существующий Supabase клиент; для защиты от rate-limit Pipedrive — пауза между запросами (200–300 мс).
5. **Логирование ошибок**: `logger.error('Pipedrive invoice number update failed', { dealId, fullnumber, error });`.

## Требуемые исследования

- Проверить лимиты Pipedrive на обновление (requests per minute) и учесть их в ретраях/backfill.
- Убедиться, что поле «Invoice number» доступно через API (не скрыто/не read-only).
- Уточнить, нужно ли очищать поле при удалении проформы (если предусмотрен процесс удаления).
- Проверить, не конфликтует ли обновление поля с другими интеграциями (например, Zapier/Make).

## План тестирования

1. **Smoke**: вручную создать проформу → поле заполняется в Pipedrive.
2. **Negative**: смоделировать отказ Pipedrive (подменой токена) → ретраи + запись в логах.
3. **Backfill**: dry-run на 5 сделках, затем полный проход по стейджу.
4. **Regression**: убедиться, что `Invoice type` и другие поля обновляются как раньше.

## Риски и смягчающие действия

- **Rate limit Pipedrive** → добавить backoff и паузы, при необходимости группировать обновления.
- **Несоответствие номеров при ручном изменении** → backfill и логика overwrite при расхождении значений.
- **Отсутствие dealId** → если в Supabase нет `pipedrive_deal_id`, логируем и добавляем в отчёт для ручной обработки.
- **Изменение формата `fullnumber`** → держать fallback на fetch `getFullProformaById`.

## Метрики «готовности к релизу»

- 100 % новых проформ на стейдже/проде получают номер в CRM (проверка выборки).
- Backfill завершён без ошибок более чем для 95 % исторических сделок.
- В логах отсутствуют повторяющиеся ошибки обновления после 24 часов работы.
- Финансовая команда подтвердит, что новые сделки легко находятся по полю «Invoice number».
- Документация обновлена, инструкции по backfill доступны в репозитории.

