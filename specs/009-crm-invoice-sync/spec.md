# Sync Invoice Number To CRM

## Overview

После создания проформы в wFirma менеджерам нужно быстро находить её в Pipedrive и связывать дальнейшие действия с конкретным документом. Для этого в сделке Pipedrive добавлено новое поле «Invoice number», которое должно автоматически заполняться номером проформы (`fullnumber`) сразу после успешного создания документа в wFirma. Наличие номера в CRM позволит оперативно фильтровать сделки, сверять платежи и инициировать дополнительные процессы без ручного поиска.

## User Scenarios & Testing

### Primary Scenario: Создание новой проформы из сделки
1. **Предусловия**: Сделка в Pipedrive содержит признак, запускающий создание проформы (поле Invoice type = Proforma), и новая проформа успешно создаётся в wFirma.
2. **Действия**: процессор получает ответ от wFirma с номером проформы и обновляет сделку в Pipedrive.
3. **Ожидаемый результат**: в поле «Invoice number» появляется значение `CO-PROF XXX/YYYY`, совпадающее с номером проформы в wFirma; поле остаётся неизменным при последующих автоматических запусках для той же проформы.

### Secondary Scenario: Повторная синхронизация / восстановление данных
1. **Предусловия**: В Pipedrive есть сделки с ранее созданными проформами, но поле «Invoice number» пустует (например, после импорта).
2. **Действия**: запускается утилита повторной синхронизации (или переобработка сделок), которая подтягивает номер проформы и обновляет поле.
3. **Ожидаемый результат**: поле «Invoice number» заполняется корректным значением только если оно пусто либо отличается от актуального номера в wFirma.

### Secondary Scenario: Ошибка при обновлении CRM
1. **Предусловия**: wFirma вернула номер проформы, но обновление сделки в Pipedrive не выполнено (ошибка API).
2. **Действия**: процессор фиксирует ошибку, повторяет попытку согласно политике ретраев или помечает задачу для ручного вмешательства.
3. **Ожидаемый результат**: ошибка логируется с деталями по сделке и проформе; поле «Invoice number» либо обновлено успешно, либо остаётся пустым, но администратор видит запись в логах/метриках.

## Functional Requirements

1. **Получение номера проформы**
   - После успешного ответа от wFirma (`createInvoiceInWfirma` и связанные вызовы) процессор получает номер проформы (`fullnumber`).
   - В случае отсутствия `fullnumber` процессор пытается извлечь его через повторное обращение к wFirma (`getFullProformaById`) до наступления тайм-аута/лимита попыток.

2. **Обновление сделки Pipedrive**
   - Процессор вызывает обновление сделки и записывает номер проформы в поле «Invoice number» (тип: строка).
   - Значение записывается только если поле пустое или отличается от нового номера; повторная запись идентичного значения не должна вызывать ошибку.
   - При успешном обновлении процессор фиксирует событие в логах (deal id, fullnumber).

3. **Обработка ошибок**
   - Ошибки Pipedrive API логируются с уровнем error, включая HTTP‑код, текст ошибки и идентификатор сделки.
   - Предусмотреть минимум 2 автоматические повторные попытки с экспоненциальной задержкой; после исчерпания ретраев процессор формирует запись для ручной проверки.
   - Результаты неуспешных обновлений доступны для мониторинга (например, через отдельный лог/метрику).

4. **Повторная синхронизация**
   - Переиспользовать существующий механизм миграции/переобработки проформ, чтобы при повторном проходе поле «Invoice number» заполнялось, если оно пустует.
   - Если в сделке уже сохранён номер, отличный от текущего в wFirma, процессор обновляет его до актуального значения и логирует факт замены.

5. **Совместимость и безопасность**
   - Значение поля «Invoice number» очищается только вручную в CRM; автоматические процессы не должны сбрасывать его без новых данных.
   - Вся информация, передаваемая в Pipedrive, соответствует формату `CO-PROF NNN/YYYY` (строка до 255 символов) и не содержит персональных данных.

## Success Criteria
- 100 % новых проформ получают корректный номер в поле «Invoice number» Pipedrive не позднее чем через 1 минуту после создания документа в wFirma.
- Повторная синхронизация восстанавливает номер минимум для 95 % сделок, у которых номер уже присутствует в wFirma.
- Все ошибки обновления CRM фиксируются в логах с идентификатором сделки и числом попыток, чтобы команда могла воспроизвести проблему.
- Менеджеры могут отфильтровать сделки по полю «Invoice number» и найти нужную проформу без обращения к разработчикам.

## Assumptions
- Поле «Invoice number» уже создано в Pipedrive и доступно для записи через API.
- Интеграция обладает правами на чтение/обновление сделок.
- Номер проформы в wFirma имеет формат `CO-PROF XXX/YYYY` и не меняется после выдачи (кроме возможной перегенерации вручную).
- Повторная обработка сделок доступна через существующие скрипты/cron‑процессы.

## Out of Scope
- Обратная синхронизация при удалении или переименовании проформ напрямую из wFirma без участия процессора.
- Отображение номера проформы в отчётах или внешних интерфейсах (кроме непосредственного заполнения поля в CRM).
- Любые изменения в бизнес‑логике создания проформ (состав продуктов, суммы, валюты).

## Key Entities
- **Deal (Pipedrive)** — хранит пользовательскую информацию, обновляется полем «Invoice number».
- **Proforma (wFirma)** — источник номера `fullnumber`, создаётся через существующий процессор.
- **Sync Process** — сервис, который связывает deal и proforma, управляет ретраями и логированием.


