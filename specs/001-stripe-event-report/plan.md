# Implementation Plan: Отчет по мероприятиям (Stripe)

**Branch**: `001-stripe-event-report` | **Date**: 2025-11-10 | **Spec**: `specs/001-stripe-event-report/spec.md`  
**Input**: Feature specification from `/specs/001-stripe-event-report/spec.md`

## Summary

Создать внутренний отчет «мероприятия из Stripe», который группирует успешные платежи по значению `Checkout Line Item Summary`, агрегирует суммы по участникам, распределяет введенные расходы и рассчитывает маржу и VAT. Решение должно автоматически подтягивать данные через Stripe API, предоставлять аналитикам удобный интерфейс/выгрузку и соответствовать требованиям безопасности и наблюдаемости.

## Technical Context

**Language/Version**: Node.js ≥ 18 (backend), браузерный JS/HTML/CSS для отчётного интерфейса  
**Primary Dependencies**: `express`, существующая инфраструктура логирования (`winston`), Stripe Node SDK (`stripe`), возможно `dayjs`/`luxon` для дат, `papaparse` или `json2csv` для экспорта  
**Storage**: Постоянное хранилище не требуется — отчёт строится «на лету»; возможен in-memory cache для результатов запроса  
**Testing**: Jest (unit/service), supertest (API), scripted сверка с контрольным набором Stripe транзакций, ручная проверка UI  
**Target Platform**: Backend на Render/Node server; доступ через админский фронтенд в `frontend/`  
**Project Type**: Существующее web-приложение (single backend + статичный frontend)  
**Performance Goals**: Отчёт по мероприятию должен строиться < 10 секунд при до 500 платежах; экспорт выполняется мгновенно (< 3 секунд)  
**Constraints**: Не логировать персональные данные участников; все запросы к Stripe должны иметь таймаут и повторные попытки; работать в рамках лимитов Stripe API  
**Scale/Scope**: До нескольких сотен мероприятий в месяц, каждое с 1–200 участниками; роль — финансовые аналитики

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Принцип / Ограничение | Соответствие | Комментарий / Действия |
|-----------------------|--------------|-------------------------|
| Invoice Data Fidelity | ✅ | Отчёт только читает данные Stripe, не затрагивает Pipedrive/wFirma и не нарушает сопоставление проформ |
| Reliable Automation Flow | ✅ | Не добавляем автоматические мутации; отчёт выполняется по запросу, reuse существующих сервисов |
| Transparent Observability | ⚠️ | Нужно спроектировать логирование Stripe запросов с маскировкой персональных данных и корреляционными ID |
| Secure Credential Stewardship | ⚠️ | Требуется управление Stripe API ключом через `.env`, ограничение доступа и документирование политики |
| Spec-Driven Delivery Discipline | ✅ | Следуем цепочке Spec → Plan → Tasks → Implement |

**Gate**: Перед началом разработки описать и согласовать (1) правила безопасного логирования Stripe интеграции, (2) процесс хранения и ротации API ключей, (3) список ограничиваемых полей в выгрузке (например, email можно отображать частично). Эти вопросы закрываются в Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/001-stripe-event-report/
├── plan.md              # Этот документ
├── research.md          # Phase 0: результаты исследований Stripe API и требований безопасности
├── data-model.md        # Phase 1: сущности отчёта и структуры ответов
├── quickstart.md        # Phase 1: запуск, переменные окружения, проверка отчёта
├── contracts/           # Phase 1: спецификация API/форматов отчёта
└── tasks.md             # Phase 2: рабочий план задач
```

### Source Code (repository root)

```text
src/
├── routes/
│   ├── api.js
│   └── stripeEventReport.js        # новый маршрут для отчёта по мероприятиям
├── services/
│   ├── stripe/
│   │   ├── client.js               # обёртка над Stripe SDK (аутентификация, retries, таймауты)
│   │   └── eventReportService.js   # бизнес-логика агрегации платежей и расчётов
│   ├── reportExports/
│   │   └── csvFormatter.js         # переиспользуемая утилита экспорта (новая/существующая)
│   └── ...
├── utils/
│   └── currency.js                 # конвертация/округление (может быть новой утилитой)

frontend/
├── stripe-event-report/
│   ├── index.html
│   ├── styles.css
│   └── script.js                   # UI построения таблицы, расчётов и экспорта

tests/
├── integration/
│   └── stripeEventReport.test.js   # API тест с моками Stripe
└── unit/
    └── stripe/
        └── eventReportService.test.js
```

**Structure Decision**: Добавляем специализированный сервис Stripe в `src/services/stripe`, изолируя доступ к API и повторное использование в будущем. Отдельный маршрут `stripeEventReport.js` подключаем в `src/routes/api.js`. Для UI создаём статическую страницу в `frontend/stripe-event-report`, аналогично существующим отчётам. Тесты размещаем в `tests/unit` и `tests/integration`.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| — | — | — |

---

## Phase 0 – Research

**Goals**: Подтвердить источники данных, ограничения безопасности и финальный формат отчёта до начала реализации.

| Task | Owner | Notes |
|------|-------|-------|
| R1. Изучить Stripe API для получения `Checkout Line Item Summary` | Dev | Проверить, какие эндпоинты обеспечивают доступ к line items (Checkout Sessions vs. PaymentIntents) и как фильтровать по статусу `success` |
| R2. Определить модель идентификации участников | Dev/Product | Решить, используем ли `customer_details.name`, `customer.email` или комбинацию; определить правила маскировки |
| R3. Определить требования к валютам и конвертации | Dev/Finance | Уточнить, нужно ли конвертировать суммы, что делать при мультивалютности |
| R4. Согласовать политику логирования и хранения ключей Stripe | Dev/Security | Описать, какие поля исключаем из логов, где хранится ключ, как обеспечиваем least privilege |
| R5. Подготовить контрольный набор данных | Finance | Экспорт из Stripe или sandbox-набор для последующих тестов |

**Deliverable**: `research.md` с ответами на вопросы, ссылками на документацию Stripe и решениями по безопасности.

---

## Phase 1 – Design & Contracts

### Data Model (`data-model.md`)
- **EventReport**: идентификатор мероприятия (строка), период отбора, список участников, введённые расходы, агрегированные суммы/маржа/VAT, метаданные по валюте.
- **ParticipantSummary**: имя/идентификатор участника, количество успешных платежей, суммарная сумма, доля расходов, маржа, VAT к оплате.
- **StripeTransactionSnapshot**: минимальный набор полей из Stripe, который сохраняем для расчётов (id, amount_total, currency, status, created, customer info, line item summary).
- **ReportTotals**: итоговые суммы по отчёту (доход, расходы, маржа, VAT).

### API Contracts (`contracts/`)
- `GET /api/reports/stripe-events?eventKey=&from=&to=` — позволяет выбрать мероприятие/период, возвращает список участников и итоговые суммы.
- `GET /api/reports/stripe-events/summary?from=&to=` — выдаёт список доступных мероприятий с агрегированными оборотами (для выбора на UI).
- `POST /api/reports/stripe-events/:eventKey/expenses` — сохраняя введенную сумму расходов и возвращая обновлённый отчёт (без постоянного хранилища, данные могут храниться в сессии/кэше).
- `GET /api/reports/stripe-events/:eventKey/export?format=csv` — генерация файла для бухгалтерии.
- Все ответы должны содержать версию схемы, валюту и дату построения.

### Quickstart (`quickstart.md`)
- Шаги для получения Stripe API ключа (использование environment variables, права только на чтение).
- Настройка `.env` (переменные `STRIPE_API_KEY`, таймауты).
- Как запустить backend (`npm run dev`) и открыть страницу `frontend/stripe-event-report/index.html`.
- Как прогнать тестовый сценарий (загрузка данных, ввод расходов, экспорт).

### Observability & Security
- Логировать только агрегированные метрики (количество транзакций, total amount); детальные записи — в debug-режиме с маскировкой.
- Добавить correlation-id на запрос отчёта и прокинуть в Stripe вызовы.
- Ограничить эндпоинты отчёта существующим middleware авторизации (`auth.js`).
- Валидировать входные параметры (eventKey, диапазоны дат) и ограничивать размер выгрузок.

---

## Phase 2 – Implementation Outline

1. **Stripe client и сервис**  
   - Добавить модуль `stripe/client.js` с настройкой SDK, retries и таймаутами.  
   - Реализовать `eventReportService.js` (фильтрация транзакций по статусу success, агрегация по line item summary, расчёт маржи/VAT).

2. **REST API слой**  
   - Создать маршрут `stripeEventReport.js`, подключить к `api.js`.  
   - Реализовать эндпоинты `summary`, `detail`, `expenses`, `export` с валидацией, обработкой ошибок и логами.

3. **Расчётные утилиты**  
   - Написать функции распределения расходов, маржи и VAT (используя ставку 23%, правила округления).  
   - Учесть многовалютность: либо фильтровать, либо добавлять предупреждение.

4. **Frontend**  
   - Создать страницу с таблицей участников, блоком ввода расходов и итогами (по образцу из предоставленного скриншота).  
   - Добавить экспорт (CSV/копирование) и обработку пустых состояний/ошибок.

5. **Тестирование и проверка данных**  
   - Unit тесты для расчётных функций и сервиса.  
   - Интеграционные тесты API с моками Stripe SDK.  
   - Сверка с контрольным набором данных из Phase 0.

6. **Документация и handoff**  
   - Обновить `quickstart.md`, описать запуск и проверку.  
   - Внести инструкции по логированию и управлению ключами в `research.md` или отдельный раздел.

---

## Risks & Mitigations

- **Неполучение поля `Checkout Line Item Summary`**: проверить, что при запросе line items требуется `expand` параметр; добавить fallback (например, metadata).  
- **Частичные возвраты/разные статусы**: фильтровать только `paid`/`succeeded`; при отсутствии — отображать предупреждение о несовпадении totals.  
- **Мультивалютность**: при обнаружении транзакций в разных валютах помечать отчёт как требующий ручной проверки и не смешивать суммы.  
- **API rate limits Stripe**: внедрить аккуратное пагинирование (limit 100) и кеширование результатов на время сессии.  
- **Безопасность ключей**: доступ к отчёту ограничить авторизацией; ключ хранить в Render environment, не писать в логи.  
- **Формат экспорта**: согласовать с бухгалтерией; предусмотреть unit-тест на структуру CSV.

---

## Success Metrics

- Отчёт по мероприятию строится за < 10 секунд при 500 транзакциях и возвращает корректную агрегированную сумму.  
- Аналитики могут вручную ввести расходы и получить корректно пересчитанные поля маржи/VAT без Excel (# обращений в поддержку = 0).  
- Экспортированный CSV принимается бухгалтерией без доработок.  
- Логи демонстрируют, что персональные данные не выводятся в чистом виде, а ключ Stripe отсутствует в конфигурационных файлах.

---

## Next Steps

1. Выполнить задачи Phase 0 и зафиксировать выводы в `research.md` (включая решение по безопасности).  
2. Обновить `data-model.md`, `contracts/` и `quickstart.md` на основе принятых решений.  
3. После утверждения планов запустить `/speckit.tasks` для детализации инженерных задач.  
4. Подготовить контрольный набор Stripe данных для будущих тестов и согласовать формат отчёта с финансами.
