# Feature Specification: Отчет по мероприятиям (Stripe)

**Feature Branch**: `001-stripe-event-report`  
**Created**: 2025-11-10  
**Status**: Draft  
**Input**: User description: "Все, теперь тогда давай создадим новую спецификацию на русском языке, согласно тому, что мы с тобой перечислили в этом чате, выше в переписке"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Формирование отчета по мероприятию (Priority: P1)

Финансовый аналитик выбирает мероприятие (по значению поля `Checkout Line Item Summary` из Stripe) и получает таблицу с участниками, суммами успешных платежей, распределёнными расходами, маржей и VAT.

**Why this priority**: Без базовой таблицы по мероприятию невозможна подготовка налогового отчёта и расчёт VAT.

**Independent Test**: Можно проверить, сформировав отчет по мероприятию с известными тестовыми транзакциями и сверив итоговые суммы и VAT с контрольными расчетами.

**Acceptance Scenarios**:

1. **Given** в Stripe есть успешные платежи с одинаковым `Checkout Line Item Summary`, **When** аналитик запускает отчёт, **Then** система отображает одного участника на строку с суммой платежей и рассчитанными полями.
2. **Given** у мероприятия нет успешных платежей, **When** аналитик строит отчёт, **Then** система сообщает об отсутствии данных и не показывает пустые строки с расчётами.

---

### User Story 2 - Быстрый ввод общих расходов (Priority: P2)

Финансовый аналитик вводит общую сумму расходов по мероприятию, после чего система автоматически распределяет её поровну между всеми участниками отчёта.

**Why this priority**: Корректное распределение расходов напрямую влияет на маржу и VAT, поэтому нужно завершить расчёты без ручных вычислений.

**Independent Test**: Можно ввести тестовую сумму расходов и подтвердить, что на каждого участника применяется одинаковая доля и что маржа пересчитывается корректно.

**Acceptance Scenarios**:

1. **Given** у мероприятия 7 участников, **When** аналитик вводит расход 9 102,66, **Then** система распределяет по 1 300,38 на участника и пересчитывает маржу и VAT.
2. **Given** аналитик обновляет общую сумму расходов, **When** система пересчитывает отчёт, **Then** новые значения отражаются во всех строках и итогах.

---

### User Story 3 - Контроль итогов и выгрузка (Priority: P3)

Финансовый аналитик проверяет итоги (сумма доходов, суммарные расходы, маржа, VAT к оплате) и сохраняет отчёт для передачи бухгалтерии.

**Why this priority**: Итоги и выгрузка позволяют закрыть отчётность и передать данные вовне.

**Independent Test**: Можно сформировать отчёт, сверить блок итогов с ожиданиями и убедиться, что выгруженный файл/копия содержит те же значения.

**Acceptance Scenarios**:

1. **Given** отчёт сформирован и расходы введены, **When** аналитик просматривает блок итогов, **Then** значения сумм совпадают с суммой строк и отображаются отдельно по доходам, расходам, VAT.
2. **Given** отчёт подтверждён, **When** аналитик сохраняет его (экспорт/копирование), **Then** документ содержит построчные данные и блок итогов.

---

### Edge Cases

- Мероприятие с единственным успешным платежом (деление расходов и отображение VAT должны работать корректно).
- Платежи в разных валютах (нужно отфильтровать или предупредить, если валюта отличается от основной).
- Несколько платежей от одного участника (имя/идентификатор нужно агрегировать в одну строку).
- Платежи с отсутствующим `Checkout Line Item Summary` (должны быть исключены или помечены как требующие ручной классификации).
- Возвраты или отмены (не должны попадать в расчёт, если статус не `success`; требуется проверка).
- Очень большое количество участников (производительность и удобство работы с таблицей).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система должна получать из Stripe список всех транзакций со статусом `success` за выбранный период.
- **FR-002**: Система должна группировать транзакции по значению `Checkout Line Item Summary`, позволяя выбрать конкретное мероприятие.
- **FR-003**: Система должна агрегировать платежи по каждому участнику мероприятия, используя идентификаторы плательщика (имя, e-mail или иное поле Stripe), и суммировать их успешные платежи.
- **FR-004**: Система должна позволять аналитику внести единую сумму общих расходов по мероприятию и хранить её вместе с результатами расчёта.
- **FR-005**: Система должна автоматически вычислять долю расходов на участника как `общие расходы / количество участников` и отображать её в отчёте.
- **FR-006**: Система должна вычислять маржу по каждому участнику как `сумма платежей - доля расходов`.
- **FR-007**: Система должна рассчитывать VAT к оплате для каждого участника и итогов, используя фиксированную ставку VAT (23%) от маржи.
- **FR-008**: Система должна отображать блок итогов (общая сумма платежей, общие расходы, суммарная маржа, итоговый VAT) и гарантировать совпадение с построчными данными.
- **FR-009**: Система должна позволять сохранить/выгрузить сформированный отчёт в формате, пригодном для бухгалтерии (например, таблица или CSV).
- **FR-010**: Система должна предупреждать аналитика о записях, которые не попали в отчёт (например, из-за отсутствующего названия мероприятия или неподходящего статуса).

### Key Entities *(include if feature involves data)*

- **Мероприятие (Event Report)**: Объединяет успешные Stripe-транзакции с одинаковым `Checkout Line Item Summary`; хранит название, период, список участников, введённые расходы, итоговые расчёты.
- **Участник мероприятия**: Представляет человека/организацию, совершившую платежи; содержит идентификаторы из Stripe, сумму успешных платежей, долю расходов, маржу, VAT.
- **Запись о расходах**: Вводимое аналитиком значение общей суммы расходов по мероприятию, применяется для распределения между участниками и расчёта итогов.
- **Stripe транзакция**: Содержит исходную информацию из Stripe (идентификатор, сумма, валюта, статус, дата, `Checkout Line Item Summary`, данные плательщика); используется как исходные данные, но не изменяется.

## Допущения и зависимости

- Ставка VAT для мероприятий составляет 23% и одинакова для всех платежей.
- Все суммы приводятся к одной валюте (основной валюте аккаунта Stripe); если Stripe возвращает другую валюту, система уведомляет аналитика.
- Все необходимые права доступа к Stripe API уже настроены, и данные можно запрашивать без дополнительных согласований.
- Возвраты и частичные возвраты обрабатываются отдельно и не считаются «успешными» транзакциями для этого отчёта.
- Общая сумма расходов предоставляется бухгалтерией вручную и считается корректной.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Финансовый аналитик может сформировать отчёт по мероприятию и ввести расходы менее чем за 5 минут без ручных расчётов в сторонних инструментах.
- **SC-002**: Сумма платежей, маржи и VAT в итоговом блоке отчёта автоматически совпадает с суммой строк без расхождений более 0,5% вследствие округлений.
- **SC-003**: 100% успешных Stripe-платежей с выбранным `Checkout Line Item Summary` корректно попадают в отчёт, что подтверждается контрольной сверкой.
- **SC-004**: Финансовая команда подтверждает, что выгруженный отчёт можно напрямую использовать для подготовки налоговой отчётности без дополнительной ручной обработки.
