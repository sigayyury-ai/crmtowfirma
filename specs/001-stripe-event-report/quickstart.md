# Quickstart: Отчет по мероприятиям (Stripe)

Дата: 2025-11-10  
Предпосылки: выполнены исследования (`research.md`), определены data model и API контракты.

## 1. Подготовка окружения

1. Скопируйте `.env.example` в `.env`, затем добавьте переменную:
   ```
   STRIPE_API_KEY=sk_restricted_...
   ```
   - Используйте restricted ключ только с правами чтения (`checkout.sessions.read`, `customers.read`).
   - Не коммитите `.env`, убедитесь, что ключ не попадает в логи.
2. Проверьте, что уже настроена авторизация (Google OAuth) для административной панели:
   - `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` должны быть валидны.
   - Пользователь, который тестирует отчёт, должен иметь доступ к защищённым маршрутам.
3. Установите зависимости и запустите сервер:
   ```bash
   npm install
   npm run dev
   ```
   Сервер поднимется на `http://localhost:3000`.

## 2. Конфигурация Stripe Sandbox

1. Включите test mode в Stripe Dashboard.
2. Создайте Checkout Product (например, «Workshop Autumn 2025») и проведите 3–4 тестовых платежа:
   - Используйте разные имена и emails для клиентов.
   - В каждую сессию добавьте описание (Checkout Line Item Summary) — оно будет ключом мероприятия.
3. Убедитесь, что платежи имеют статус `paid`. При необходимости вручную завершите сессии в Dashboard.

## 3. Проверка backend эндпоинтов

1. С помощью `curl` или Postman получите список мероприятий:
   ```bash
   curl -H "Cookie: session=..." \
     "http://localhost:3000/api/reports/stripe-events/summary?from=2025-11-01&to=2025-11-30"
   ```
   Убедитесь, что в ответе отображается созданное мероприятие.
2. Получите детальный отчет:
   ```bash
   curl -H "Cookie: session=..." \
     "http://localhost:3000/api/reports/stripe-events/workshop-autumn-2025"
   ```
   Проверьте, что участники и суммы совпадают с тестовыми платежами.
3. Примените расходы:
   ```bash
   curl -X POST \
     -H "Content-Type: application/json" \
     -H "Cookie: session=..." \
     -d '{"amount": 5000, "currency": "PLN"}' \
     "http://localhost:3000/api/reports/stripe-events/workshop-autumn-2025/expenses"
   ```
   Ответ должен содержать перерасчет маржи и VAT.
4. Экспорт:
   ```bash
   curl -H "Cookie: session=..." \
     -OJ "http://localhost:3000/api/reports/stripe-events/workshop-autumn-2025/export"
   ```
   Проверьте, что скачанный CSV открывается и совпадает с ожиданиями.

## 4. Фронтенд / UI

1. Откройте страницу отчета (после реализации UI-пути):
   - Ожидаемый маршрут: `http://localhost:3000/stripe-event-report/index.html` или вкладка в админке.
   - При первом входе UI предложит выбрать мероприятие из списка (данные с `summary`).
2. Выберите мероприятие, убедитесь, что таблица участников и блок итогов совпадают с API.
3. Введите сумму расходов, проверьте обновление таблицы и итогов.
4. Используйте кнопку «Экспорт» и сравните файл со скачанным через API.

## 5. Контрольные точки проверки

- **Доступность Stripe**: вызов `/api/reports/stripe-events/health` возвращает статус `ok`.
- **Авторизация**: неавторизованный запрос получает `401`.
- **Логи**: в `logs/combined*.log` отсутствуют полные email/имена, отображаются только агрегаты.
- **Мультивалютность**: при создании платежа в EUR API возвращает предупреждение `warnings: ["MULTI_CURRENCY"]`.

## 6. Частые проблемы и решение

| Проблема | Решение |
|----------|---------|
| `STRIPE_ERROR: invalid_api_key` | Проверьте, что ключ добавлен в `.env` и сервер перезапущен. |
| Отчёт пустой, хотя есть платежи | Убедитесь, что `line_item.description` совпадает с выбранным `eventKey` и что статус `paid`. |
| Расходы не применяются | Проверьте формат числа (используйте точку как десятичный разделитель), убедитесь, что значение > 0. |
| Экспорт CSV содержит кракозябры | Откройте файл в UTF-8; добавьте `--output` и `iconv` при необходимости. |

## 7. Следующие шаги

- После успешной проверки обновите `tasks.md` и приступайте к декомпозиции задач.
- Подготовьте скриншоты UI и результаты тестовых отчетов для команды финансов.

