# Задачи: 014-link-payments-products

## Система связи платежей с продуктами

### База данных (3 дня)

#### DB-001: Создание таблицы payment_product_links
**Описание:** Создать таблицу для хранения связей между платежами и продуктами
**Оценка:** 4h
**Критерии:**
- Таблица `payment_product_links` с полями: id, payment_id, product_id, linked_by, linked_at
- Foreign key constraints на payments и products
- Каскадное удаление при удалении платежа/продукта
- Unique constraint на payment_id (один платеж - один продукт)

#### DB-002: Миграции и индексы
**Описание:** Создать миграции и оптимизировать производительность
**Оценка:** 3h
**Критерии:**
- SQL миграция для создания таблицы
- Индексы на payment_id, product_id, linked_at
- Composite индекс для поиска по продукту + дата
- Rollback миграция

#### DB-003: Тестовые данные
**Описание:** Создать сиды для тестирования функциональности
**Оценка:** 2h
**Критерии:**
- Несколько тестовых связей в сидах
- Связи для разных типов платежей (входящие/исходящие)
- Связи для разных продуктов

### Backend API (5 дней)

#### API-001: Эндпоинт GET /api/products/in-progress
**Описание:** Получение списка продуктов доступных для связи
**Оценка:** 3h
**Критерии:**
- Фильтр по calculation_status = 'in_progress'
- Сортировка по названию
- Возврат id, name, normalized_name
- Кэширование результатов

#### API-002: Эндпоинт POST /api/payments/:id/link-product
**Описание:** Создание связи платежа с продуктом
**Оценка:** 4h
**Критерии:**
- Валидация существования платежа и продукта
- Проверка что платеж не связан с другим продуктом
- Проверка прав доступа
- Создание записи в payment_product_links
- Аудит логирование

#### API-003: Эндпоинт DELETE /api/payments/:id/link-product
**Описание:** Удаление связи платежа с продуктом
**Оценка:** 3h
**Критерии:**
- Проверка существования связи
- Soft delete или hard delete
- Аудит логирование
- Обновление связанных расчетов

#### API-004: Эндпоинт GET /api/products/:id/linked-payments
**Описание:** Получение связанных платежей для продукта
**Оценка:** 3h
**Критерии:**
- Группировка по типу платежа (входящие/исходящие)
- Суммирование по валютам
- Включение деталей платежей
- Оптимизация запросов

#### API-005: Валидация и безопасность
**Описание:** Добавить валидацию и безопасность ко всем эндпоинтам
**Оценка:** 4h
**Критерии:**
- Input validation для всех параметров
- SQL injection protection
- Rate limiting
- Authentication checks
- Error handling

### Backend сервисы (4 дня)

#### SVC-001: PaymentProductLinkService
**Описание:** Сервис для управления связями платежей и продуктов
**Оценка:** 6h
**Критерии:**
- Методы createLink, removeLink, getLinkedPayments
- Business logic валидация
- Transaction handling
- Error handling

#### SVC-002: Интеграция с ProductReportService
**Описание:** Обновление расчетов маржи для учета связанных платежей
**Оценка:** 5h
**Критерии:**
- Модификация aggregateProducts для включения связанных платежей
- Перерасчет сумм доходов/расходов
- Обновление процентной маржи
- Кэширование результатов

#### SVC-003: Аудит сервис
**Описание:** Сервис для логирования операций со связями
**Оценка:** 3h
**Критерии:**
- Логирование создания/удаления связей
- Сохранение истории изменений
- Экспорт аудита для анализа

### Frontend (5 дней)

#### FE-001: UI компонент выбора продукта
**Описание:** Выпадающий список продуктов в таблице платежей
**Оценка:** 4h
**Критерии:**
- Интеграция в существующую таблицу платежей
- Фильтр только "In Progress" продукты
- Поиск по названию
- Loading состояния

#### FE-002: Кнопки управления связями
**Описание:** Кнопки "Связать" и "Отвязать" для платежей
**Оценка:** 3h
**Критерии:**
- Показывать только для неподтвержденных платежей
- Confirmation dialogs
- Visual feedback при успехе/ошибке
- Disabled state при loading

#### FE-003: Отображение связанных платежей
**Описание:** Показ связанных платежей в карточках продуктов
**Оценка:** 4h
**Критерии:**
- Секция "Связанные платежи" под Stripe/проформы
- Группировка входящие/исходящие
- Суммарная информация
- Детали каждого платежа

#### FE-004: Реальное время обновления
**Описание:** Обновление интерфейса при изменениях связей
**Оценка:** 3h
**Критерии:**
- Автоматическое обновление сумм маржи
- Обновление списков связанных платежей
- Visual indicators для loading
- Error handling

#### FE-005: Интеграция в существующие интерфейсы
**Описание:** Интеграция в vat-margin.html и expenses.html
**Оценка:** 4h
**Критерии:**
- Минимальные изменения существующих файлов
- Переиспользование компонентов
- Сохранение responsive design
- Accessibility compliance

### Тестирование (3 дня)

#### TEST-001: Unit тесты
**Описание:** Тесты для отдельных функций и методов
**Оценка:** 4h
**Критерии:**
- Тесты для API эндпоинтов
- Тесты для сервисов
- Тесты для валидации
- Coverage > 80%

#### TEST-002: Integration тесты
**Описание:** Тесты для взаимодействия компонентов
**Оценка:** 4h
**Критерии:**
- Тесты создания/удаления связей
- Тесты расчетов маржи
- Тесты UI взаимодействия
- End-to-end сценарии

#### TEST-003: Приемочные тесты
**Описание:** Тесты с реальными данными
**Оценка:** 4h
**Критерии:**
- Тестирование с production-like данными
- Performance testing
- Security testing
- User acceptance testing

### Документация (2 дня)

#### DOC-001: API документация
**Описание:** Документация для новых API эндпоинтов
**Оценка:** 2h
**Критерии:**
- OpenAPI/Swagger спецификация
- Примеры запросов/ответов
- Error codes документация
- Rate limiting информация

#### DOC-002: User guide
**Описание:** Руководство пользователя по работе со связями
**Оценка:** 3h
**Критерии:**
- Скриншоты интерфейса
- Пошаговые инструкции
- Best practices
- Troubleshooting guide

#### DOC-003: Developer documentation
**Описание:** Документация для разработчиков
**Оценка:** 3h
**Критерии:**
- Архитектурные решения
- Code examples
- Database schema
- Deployment guide

### Развертывание (1 день)

#### DEPLOY-001: Production deployment
**Описание:** Развертывание в production с миграциями
**Оценка:** 4h
**Критерии:**
- Database migrations
- Backend deployment
- Frontend deployment
- Smoke testing
- Rollback plan

## Оценки и зависимости

### Общая оценка: 21 день (3 недели)
- База данных: 3 дня
- Backend: 9 дней (API + сервисы)
- Frontend: 5 дней
- Тестирование: 3 дня
- Документация: 2 дня
- Развертывание: 1 день

### Ключевые зависимости:
- Стабильность существующих API
- Доступ к базе данных для миграций
- Координация frontend/backend команд
- Доступность staging среды для тестирования

### Риски:
- Сложность интеграции в существующие интерфейсы
- Производительность при большом количестве связей
- Конфликты при одновременном редактировании
- Обучение пользователей новой функциональности
