# 014-link-payments-products

## Система связи платежей с продуктами для VAT margin отчетов

### Обзор

Система позволяет вручную связывать входящие платежи (банковские) и исходящие платежи (расходы) с конкретными продуктами для точного расчета маржи в VAT Margin Tracker.

### Бизнес-контекст

В текущей системе платежи группируются по продуктам автоматически на основе связи с проформами. Однако некоторые платежи (особенно общие расходы или платежи без четкой привязки) не попадают в правильные продукты, что искажает расчет маржи.

### Функциональные требования

#### FR-001: Ручная связь платежей с продуктами
**Описание:** Система ДОЛЖНА позволять пользователю вручную связывать платежи с продуктами в интерфейсе VAT Margin Tracker.

**Критерии приемки:**
- В таблице платежей должна быть возможность выбрать продукт из выпадающего списка
- Доступны только продукты со статусом "In Progress"
- Связь сохраняется в базе данных
- Несколько платежей могут быть связаны с одним продуктом

#### FR-002: Отображение связанных платежей
**Описание:** Система ДОЛЖНА отображать связанные платежи в отчете по продукту под списками проформ/Stripe.

**Критерии приемки:**
- В карточке продукта показывается список связанных платежей
- Для каждого платежа отображается дата, сумма, описание
- Платежи группируются по типу (входящие/исходящие)

#### FR-003: Расчет маржи с учетом связанных платежей
**Описание:** Система ДОЛЖНА включать связанные платежи в расчет общей маржи продукта.

**Критерии приемки:**
- Входящие платежи добавляются к доходам продукта
- Исходящие платежи добавляются к расходам продукта
- Пересчитывается процентная маржа
- Обновление происходит в реальном времени

#### FR-004: Удаление связи платежей
**Описание:** Система ДОЛЖНА позволять удалять связь платежа с продуктом.

**Критерии приемки:**
- Кнопка "Отвязать" рядом с каждым связанным платежом
- Подтверждение действия
- Платеж возвращается в общий пул неподтвержденных платежей

#### FR-005: Фильтрация продуктов
**Описание:** В выпадающем списке ДОЛЖНЫ показываться только продукты со статусом "In Progress".

**Критерии приемки:**
- Список продуктов фильтруется по `calculation_status = 'in_progress'`
- Продукты сортируются по названию
- Пустой вариант "Не выбрано" доступен

#### FR-006: Интеграция с существующими потоками
**Описание:** Система ДОЛЖНА интегрироваться с существующими интерфейсами без создания новых страниц.

**Критерии приемки:**
- Для входящих платежей: интеграция в VAT Margin Tracker (`vat-margin.html`)
- Для исходящих платежей: интеграция в Expenses (`expenses.html`)
- Переиспользование существующих компонентов

#### FR-007: Сохранение связей в базе данных
**Описание:** Система ДОЛЖНА сохранять связи платежей с продуктами в таблице `product_links` или аналогичной.

**Критерии приемки:**
- Создается таблица `payment_product_links` (если не существует)
- Структура: `payment_id`, `product_id`, `linked_by`, `linked_at`
- Каскадное удаление при удалении платежа или продукта

#### FR-008: Аудит связей
**Описание:** Система ДОЛЖНА вести аудит создания и удаления связей.

**Критерии приемки:**
- Логирование действий пользователя
- Отображение информации "связано пользователем X в дату Y"
- Возможность просмотра истории изменений

### Нефункциональные требования

#### NFR-001: Производительность
- Загрузка списка продуктов: < 500ms
- Сохранение связи: < 200ms
- Пересчет маржи: < 1s

#### NFR-002: Безопасность
- Проверка прав доступа к продуктам
- Валидация входных данных
- Защита от SQL-инъекций

#### NFR-003: Удобство использования
- Интуитивный интерфейс связи
- Ясные обозначения связанных платежей
- Возможность массовых операций

### Интерфейсные требования

#### UI-001: Элемент управления связью
```
[Выпадающий список продуктов] [Кнопка "Связать"]
```

#### UI-002: Отображение связанных платежей
```
Продукт: "NY2026"
├── Проформы: ...
├── Stripe платежи: ...
└── Связанные платежи:
    ├── Входящие: 2 платежа, 1500€
    └── Исходящие: 1 платеж, -300€
```

### Технологические решения

#### Архитектура
- Backend: Node.js с Supabase
- Frontend: Vanilla JavaScript
- База данных: PostgreSQL через Supabase

#### API эндпоинты
- `GET /api/products/in-progress` - список доступных продуктов
- `POST /api/payments/:id/link-product` - связать платеж с продуктом
- `DELETE /api/payments/:id/link-product` - удалить связь

#### Схема базы данных
```sql
CREATE TABLE payment_product_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  payment_id UUID NOT NULL REFERENCES payments(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  linked_by UUID, -- user_id если есть аутентификация
  linked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(payment_id)
);
```

### Критерии готовности

#### Definition of Ready
- [ ] Спецификация утверждена
- [ ] Архитектурное решение согласовано
- [ ] Оценка трудозатрат выполнена
- [ ] Приоритезация требований ясна

#### Definition of Done
- [ ] Все функциональные требования реализованы
- [ ] Автоматизированные тесты написаны
- [ ] Код прошел ревью
- [ ] Документация обновлена
- [ ] Функциональное тестирование пройдено
- [ ] Производительность соответствует требованиям
