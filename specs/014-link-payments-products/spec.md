# Спецификация фичи: Привязка платежей к продуктам

**Интеграция в существующие флоу**: Функциональность привязки платежей к продуктам должна быть встроена в уже существующие интерфейсы обработки платежей (VAT Margin Tracker для входящих платежей и Expenses для исходящих платежей), без создания отдельных страниц или UI.

**Ветка фичи**: `014-link-payments-products`  
**Создано**: 2025-11-27  
**Статус**: Черновик  
**Вводные данные**: Описание пользователя: "хочу привязывать платежи к конкретному продукты, чтобы готовать отчеты ват маржа. Во входящих и исходящих платежах. Должна быть возможностьлинковать их с продуктами. В ручном режиме. У нас есть отчет по продуктам, вот к продуктам в нем и должны линковаться такие траты и приходы. Выводить нужно только продукты с активным статусом - В процессе. Остальные выводить не надо. Наверно линковака будет при поощи отельного выпадающего списка. При обработке платежей. Добавить еще одно поле. Нужно иметь возможность добавлять линковку но и также ее удалять если будет совершено ошибочное добавление. Зная расходы по продукту. их можно вывести в сводку. Одной цифрой а также . Вывести список всех прилинкованных платажей ниже списка с проформами и страйп платежами."

## Сценарии использования и тестирование *(обязательно)*

### Пользовательская история 1 - Привязка платежей к продуктам для отчетов VAT margin (Приоритет: P1)

Как финансовый аналитик, я хочу вручную привязывать входящие и исходящие платежи к конкретным продуктам непосредственно в существующих интерфейсах обработки платежей (VAT Margin Tracker для приходных платежей и Expenses для расходов), чтобы готовить точные отчеты VAT margin, показывающие расходы и доходы по каждому продукту.

**Почему этот приоритет**: Это основная функциональность, необходимая для генерации правильных отчетов VAT margin по продуктам, что критично для финансовой отчетности и соблюдения требований.

**Независимое тестирование**: Может быть полностью протестировано путем привязки платежей к продуктам и проверки их отображения в сводке отчета по продукту.

**Сценарии приемки**:

1. **Учитывая** что я обрабатываю приходные платежи в VAT Margin Tracker, **Когда** я выбираю продукт из выпадающего списка для конкретного платежа, **Тогда** платеж привязывается к этому продукту
2. **Учитывая** что я обрабатываю расходы в интерфейсе Expenses, **Когда** я выбираю продукт из выпадающего списка для конкретного расхода, **Тогда** платеж привязывается к этому продукту
3. **Учитывая** что платеж уже привязан к продукту, **Когда** я отвязываю его в существующем интерфейсе обработки платежей, **Тогда** платеж больше не появляется в сводке этого продукта

---

### Пользовательская история 2 - Просмотр привязанных платежей, количества платежей и маржинальности в отчете по продукту (Приоритет: P2)

Как финансовый аналитик, я хочу видеть все привязанные платежи ниже списков проформ и платежей Stripe в отчете по продукту, количество платежей для понимания накопления, а также маржинальность продукта (доходы минус расходы), чтобы иметь полное представление о финансовой эффективности каждого продукта.

**Почему этот приоритет**: Обеспечивает всестороннюю видимость всех платежей и финансовой эффективности, связанных с каждым продуктом, для лучшего финансового анализа и принятия решений.

**Независимое тестирование**: Может быть полностью протестировано просмотром отчета по продукту и подтверждением, что привязанные платежи и расчет маржинальности отображаются правильно.

**Сценарии приемки**:

1. **Учитывая** что платежи привязаны к продуктам, **Когда** я просматриваю отчет по продукту, **Тогда** привязанные платежи появляются ниже списков проформ и платежей Stripe
2. **Учитывая** что продукт имеет несколько привязанных платежей, **Когда** я просматриваю отчет по продукту, **Тогда** отображается количество платежей для понимания накопления
3. **Учитывая** что продукт имеет доходы и расходы, **Когда** я просматриваю отчет по продукту, **Тогда** отображается маржинальность как (доходы - расходы) с указанием суммы и процента
4. **Учитывая** что продукт имеет несколько привязанных платежей, **Когда** я просматриваю отчет по продукту, **Тогда** все привязанные платежи показаны с их суммами и деталями

---

### Пользовательская история 3 - Фильтр только активных продуктов (Приоритет: P3)

Как финансовый аналитик, я хочу видеть только продукты со статусом "В процессе" в выпадающем списке привязки платежей, чтобы случайно не привязать платежи к завершенным или отмененным продуктам.

**Почему этот приоритет**: Предотвращает ошибки и поддерживает целостность данных, гарантируя, что платежи привязываются только к релевантным активным продуктам.

**Независимое тестирование**: Может быть полностью протестировано проверкой того, что выпадающий список продуктов показывает только продукты со статусом "В процессе".

**Сценарии приемки**:

1. **Учитывая** что существуют продукты с разными статусами, **Когда** я открываю выпадающий список привязки продуктов, **Тогда** доступны для выбора только продукты со статусом "В процессе"

---

### Пограничные случаи

- Что происходит, когда статус продукта меняется с "В процессе" на завершенный после привязки платежей?
- Как система обрабатывает платежи, привязанные к продуктам, которые удаляются?
- Что происходит, если один и тот же платеж случайно привязывается к нескольким продуктам?
- Как обрабатываются конвертации валют для платежей, привязанных к продуктам в разных валютах?
- Как синхронизировать привязки платежей между интерфейсами VAT Margin Tracker и Expenses?
- Что происходит, если платеж привязан к продукту в одном интерфейсе, а потом обрабатывается в другом?

## Требования *(обязательно)*

### Функциональные требования

- **FR-001**: Система ДОЛЖНА позволять ручную привязку входящих и исходящих платежей к конкретным продуктам
- **FR-002**: Система ДОЛЖНА предоставлять выпадающий список, показывающий только продукты со статусом "В процессе" для привязки платежей
- **FR-003**: Система ДОЛЖНА позволять отвязывать платежи от продуктов при неправильной привязке
- **FR-004**: Система ДОЛЖНА отображать привязанные платежи в отчете по продукту ниже списков проформ и платежей Stripe
- **FR-005**: Система ДОЛЖНА показывать расходы по платежам на продукт как единую сводную цифру в отчете по продукту
- **FR-006**: Система ДОЛЖНА включать как доходные, так и расходные платежи в функциональность привязки к продуктам
- **FR-010**: Система ДОЛЖНА отображать количество привязанных платежей в отчете по продукту для понимания накопления
- **FR-009**: Система ДОЛЖНА рассчитывать и отображать маржинальность продукта как (доходы - расходы) с показом абсолютной суммы и процента от доходов
- **FR-007**: Система ДОЛЖНА поддерживать целостность данных при изменении статусов продуктов или их удалении
- **FR-008**: Система НЕ ДОЛЖНА требовать обязательной привязки платежей к продуктам - платежи без привязки считаются общими расходами и не требуют дополнительной обработки
- **FR-010**: Система ДОЛЖНА интегрировать функциональность привязки платежей к продуктам в существующие интерфейсы: выпадающий список продуктов в VAT Margin Tracker для приходных платежей и в Expenses для расходных платежей

### Ключевые сущности *(включить если фича включает данные)*

- **Платеж**: Представляет входящие или исходящие финансовые транзакции, которые могут быть привязаны к продуктам
- **Продукт**: Представляет бизнес-продукты, которые имеют связанные финансовые транзакции
- **Связь Платеж-Продукт**: Представляет отношение между платежом и продуктом для целей отчетности

## Критерии успеха *(обязательно)*

### Измеримые результаты

- **SC-001**: Финансовые аналитики могут привязывать платежи к продуктам менее чем за 30 секунд на платеж
- **SC-002**: 100% платежей, привязанных к продуктам, правильно отображаются в отчетах VAT margin
- **SC-003**: Отчеты по продуктам показывают точные сводки расходов в течение 5 секунд после загрузки
- **SC-004**: Ноль неправильных привязок платежей остается в системе после ручной проверки
- **SC-005**: 95% финансовых аналитиков успешно завершают задачи привязки платежей с первой попытки