# Чек-лист требований: 014-link-payments-products

## Функциональные требования

### FR-001: Ручная связь платежей с продуктами
- [ ] В таблице платежей есть выпадающий список продуктов
- [ ] Доступны только продукты со статусом "In Progress"
- [ ] Связь сохраняется в базе данных
- [ ] Один платеж может быть связан только с одним продуктом
- [ ] Несколько платежей могут быть связаны с одним продуктом

### FR-002: Отображение связанных платежей
- [ ] В карточке продукта показывается список связанных платежей
- [ ] Для каждого платежа отображается дата, сумма, описание
- [ ] Платежи группируются по типу (входящие/исходящие)
- [ ] Суммы связанных платежей суммируются в общем итоге

### FR-003: Расчет маржи с учетом связанных платежей
- [ ] Входящие платежи добавляются к доходам продукта
- [ ] Исходящие платежи добавляются к расходам продукта
- [ ] Пересчитывается абсолютная и процентная маржа
- [ ] Обновление происходит в реальном времени

### FR-004: Удаление связи платежей
- [ ] Кнопка "Отвязать" рядом с каждым связанным платежом
- [ ] Подтверждение действия перед удалением
- [ ] Платеж возвращается в общий пул неподтвержденных платежей
- [ ] История связи сохраняется для аудита

### FR-005: Фильтрация продуктов
- [ ] В выпадающем списке только продукты со статусом "In Progress"
- [ ] Продукты сортируются по названию
- [ ] Доступен пустой вариант "Не выбрано"
- [ ] Список обновляется при изменении статуса продуктов

### FR-006: Интеграция с существующими потоками
- [ ] Для входящих платежей: интеграция в VAT Margin Tracker
- [ ] Для исходящих платежей: интеграция в Expenses
- [ ] Переиспользование существующих компонентов
- [ ] Сохранение существующего UX

### FR-007: Сохранение связей в базе данных
- [ ] Создана таблица `payment_product_links`
- [ ] Структура: payment_id, product_id, linked_by, linked_at
- [ ] Каскадное удаление при удалении платежа или продукта
- [ ] Индексы для быстрого поиска

### FR-008: Аудит связей
- [ ] Логирование создания связей
- [ ] Логирование удаления связей
- [ ] Отображение информации о том, кто и когда связал платеж
- [ ] Возможность просмотра истории изменений

## Нефункциональные требования

### NFR-001: Производительность
- [ ] Загрузка списка продуктов: < 500ms
- [ ] Сохранение связи: < 200ms
- [ ] Пересчет маржи: < 1s
- [ ] Поиск связанных платежей: < 100ms

### NFR-002: Безопасность
- [ ] Проверка прав доступа к продуктам
- [ ] Валидация входных данных
- [ ] Защита от SQL-инъекций
- [ ] Аутентификация пользователей при создании связей

### NFR-003: Удобство использования
- [ ] Интуитивный интерфейс связи
- [ ] Ясные обозначения связанных платежей
- [ ] Возможность массовых операций
- [ ] Подсказки и помощь пользователю

## Интерфейсные требования

### UI-001: Элемент управления связью
- [ ] Выпадающий список продуктов с поиском
- [ ] Кнопка "Связать" с подтверждением
- [ ] Визуальная обратная связь при успехе/ошибке
- [ ] Loading состояния

### UI-002: Отображение связанных платежей
- [ ] Секция "Связанные платежи" в карточке продукта
- [ ] Группировка по типу платежа
- [ ] Суммарная информация
- [ ] Возможность просмотра деталей каждого платежа

## Технологические требования

### API эндпоинты
- [ ] `GET /api/products/in-progress` - список доступных продуктов
- [ ] `POST /api/payments/:id/link-product` - связать платеж с продуктом
- [ ] `DELETE /api/payments/:id/link-product` - удалить связь
- [ ] `GET /api/products/:id/linked-payments` - получить связанные платежи

### Схема базы данных
- [ ] Создана таблица `payment_product_links`
- [ ] Миграции написаны и протестированы
- [ ] Сиды для тестовых данных
- [ ] Резервное копирование настроено

## Критерии готовности

### Definition of Ready
- [ ] Спецификация утверждена
- [ ] Архитектурное решение согласовано
- [ ] Оценка трудозатрат выполнена
- [ ] Приоритезация требований ясна
- [ ] Дизайн интерфейса согласован

### Definition of Done
- [ ] Все функциональные требования реализованы
- [ ] Автоматизированные тесты написаны (unit, integration, e2e)
- [ ] Код прошел ревью
- [ ] Документация обновлена
- [ ] Функциональное тестирование пройдено
- [ ] Производительность соответствует требованиям
- [ ] Безопасность проверена
- [ ] UX/UI соответствует требованиям
