# План реализации: 014-link-payments-products

## Обзор

План реализации системы связи платежей с продуктами для VAT margin отчетов. Общий срок: 2-3 недели.

## Фазы реализации

### Фаза 1: Проектирование и подготовка (3-4 дня)

#### Задачи:
1. **Анализ текущей архитектуры**
   - Изучить существующие таблицы платежей и продуктов
   - Определить структуру связи payment-product
   - Проанализировать существующие API эндпоинты

2. **Проектирование схемы базы данных**
   - Создать таблицу `payment_product_links`
   - Добавить необходимые индексы
   - Спроектировать миграции

3. **Проектирование API**
   - Определить новые эндпоинты
   - Спроектировать форматы запросов/ответов
   - Определить валидацию данных

4. **Проектирование интерфейса**
   - Определить места интеграции в существующие интерфейсы
   - Спроектировать UI компоненты
   - Создать макеты и прототипы

### Фаза 2: Backend разработка (5-7 дней)

#### Задачи:
1. **Создание таблицы и миграций**
   - Написать SQL миграцию для `payment_product_links`
   - Добавить foreign key constraints
   - Создать индексы для производительности

2. **Разработка API эндпоинтов**
   - `GET /api/products/in-progress` - получение списка доступных продуктов
   - `POST /api/payments/:id/link-product` - создание связи
   - `DELETE /api/payments/:id/link-product` - удаление связи
   - `GET /api/products/:id/linked-payments` - получение связанных платежей

3. **Разработка сервисов**
   - PaymentProductLinkService для управления связями
   - Валидация данных и бизнес-правил
   - Обработка ошибок и транзакций

4. **Интеграция с существующими сервисами**
   - Обновление ProductReportService для учета связанных платежей
   - Модификация расчетов маржи
   - Обновление кэширования

### Фаза 3: Frontend разработка (4-5 дней)

#### Задачи:
1. **Разработка UI компонентов**
   - Выпадающий список продуктов в таблице платежей
   - Кнопки "Связать" и "Отвязать"
   - Отображение связанных платежей в карточках продуктов

2. **Интеграция с существующими интерфейсами**
   - Модификация `vat-margin.html` для входящих платежей
   - Модификация `expenses.html` для исходящих платежей
   - Переиспользование существующих компонентов

3. **JavaScript логика**
   - Обработка выбора продуктов
   - AJAX запросы для создания/удаления связей
   - Обновление интерфейса в реальном времени

4. **Валидация и обработка ошибок**
   - Клиентская валидация
   - Обработка ошибок сервера
   - User-friendly сообщения

### Фаза 4: Тестирование и развертывание (3-4 дня)

#### Задачи:
1. **Модульное тестирование**
   - Тесты для API эндпоинтов
   - Тесты для сервисов
   - Тесты для валидации

2. **Интеграционное тестирование**
   - Тесты для полного цикла создания/удаления связей
   - Тесты для расчетов маржи
   - Тесты для UI взаимодействия

3. **Приемочное тестирование**
   - Тестирование с реальными данными
   - Проверка производительности
   - Проверка UX/UI

4. **Развертывание**
   - Миграция базы данных
   - Деплой backend изменений
   - Деплой frontend изменений

## Риски и mitigation

### Риски:
1. **Производительность** - большое количество связанных платежей может замедлить отчеты
   - Mitigation: оптимизация запросов, кэширование, индексы

2. **Сложность UI** - интеграция в существующие интерфейсы может быть сложной
   - Mitigation: поэтапная интеграция, рефакторинг существующих компонентов

3. **Целостность данных** - нарушение связей при удалении платежей/продуктов
   - Mitigation: каскадное удаление, проверки целостности

4. **Конфликты** - одновременное редактирование связей разными пользователями
   - Mitigation: optimistic locking, conflict resolution

## Критерии успеха

### Функциональные:
- [ ] Пользователь может связывать платежи с продуктами
- [ ] Связанные платежи учитываются в расчете маржи
- [ ] Интерфейс интуитивен и не ломает существующий UX
- [ ] Все edge cases обработаны

### Нефункциональные:
- [ ] Производительность не ухудшилась
- [ ] Код прошел ревью
- [ ] Документация обновлена
- [ ] Автоматизированные тесты написаны

## Зависимости

### Внешние:
- Доступ к базе данных для миграций
- Развертывание на staging для тестирования

### Внутренние:
- Стабильность существующих API
- Доступность Pipedrive API (для потенциальной интеграции)
- Координация с командой frontend/backend

## Метрики успеха

- **Время реализации:** 2-3 недели
- **Количество строк кода:** ~500-800 строк
- **Количество API эндпоинтов:** 4 новых
- **Количество UI компонентов:** 3-5 новых
- **Coverage тестами:** >80%
- **Производительность:** <500ms на операцию
