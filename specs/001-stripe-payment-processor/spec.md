# Feature Specification: Stripe Payment Processor

**Feature Branch**: `001-stripe-payment-processor`  
**Created**: 2025-11-17  
**Status**: Draft  
**Input**: User description: "Техническое резюме для разработки нового процессора для обработки страйп платежей. Я хочу, чтобы мы, пользуясь логикой работы текущего процессор обработки ProForm, сделали новый процессор обработки платежей Stripe. Триггер для него будет такой же, только его название будет уже не ProForm, а Stripe. Вот. И тогда он будет отрабатывать. Что в этом такого? То есть нам надо интгрировать и сделать функционал точно такой же. То есть смотреть отчеты по месяцам, смотреть полные отчеты по продуктам, которые у нас есть. Просто заинтегрировать оплату через Stripe уже в существующие отчеты нужно. Все эти платежи и обработку платежей нужно будет заносить в базу данных, как и с проформами. Сами и остальные документы, которые будут создаваться в Stripe нужно также заносить в наши текущие таблицы, которые уже есть. То есть используем текущую инфраструктуру и текущую логику, но включаем туда интеграцию со Stripe и платежи через Stripe."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Запуск Stripe-процессора расчётов (Priority: P1)

Операционный менеджер настраивает расписание, и новый процессор Stripe автоматически срабатывает по тому же триггеру, что и ProForm, забирает все новые Checkout Sessions кампаний, сохраняет платежи, метаданные и созданные документы в БД, связывая их с участниками и продуктами кемпов.

**Why this priority**: Без надёжной загрузки данных невозможно построить аналитику или частичные оплаты; это фундамент всей интеграции.

**Independent Test**: Запустить триггер вручную/по расписанию, убедиться, что Stripe-сессии считываются и появляются записью в БД вместе с документами и статусами обработки.

**Acceptance Scenarios**:

1. **Given** доступный Stripe product для кемпа и активные Checkout Sessions, **When** срабатывает триггер `Stripe`, **Then** все новые сессии импортируются, конвертируются в таблицы платежей и маркируются как обработанные.
2. **Given** у платежа в Stripe есть metadata `deal_id`, `product_id`, `payment_id`, `payment_type`, **When** процессор сохраняет транзакцию, **Then** эти значения переносятся в соответствующие поля записи и используются для связи с участником и продуктом.

---

### User Story 2 - Аналитика по месяцам и продуктам (Priority: P2)

Финансовый аналитик открывает существующие отчёты (месячные и по продуктам) и видит объединённые цифры по ProForm и Stripe: суммы в оригинальной валюте, конвертацию в PLN, количество платежей и статусы частичных оплат.

**Why this priority**: Бизнесу нужно быстро сравнивать продажи и загрузку кемпов, поэтому отчётность должна сразу отражать новые источники.

**Independent Test**: Сгенерировать отчёт за период с данными Stripe и убедиться, что суммы, конверсии и счётчики совпадают с выгрузкой из Stripe Dashboard.

**Acceptance Scenarios**:

1. **Given** месяц, где есть и ProForm, и Stripe оплаты, **When** пользователь строит месячный отчёт, **Then** все Stripe платежи агрегируются по дате/продукту в тех же таблицах без необходимости переключать источник.
2. **Given** продукт-кемп с частичными оплатами, **When** открывается полный отчёт по продукту, **Then** отображаются все взносы (депозит, остаток, доп. услуги) участников с правильными валютами и суммой в PLN.

---

### User Story 3 - Управление частичными оплатами и статусами сделки (Priority: P3)

Координатор кемпа видит список платежей конкретного участника, где каждый взнос оформлен отдельной Stripe Checkout Session, но все они связаны общим продуктом и metadata, что позволяет отслеживать прогресс оплаты, outstanding balance и автоматические переходы стадий сделки (First Payment → Second Payment → Compater).

**Why this priority**: Индивидуальные цены и гибкие планы оплаты — ключевой бизнес-требование; без этого менеджеры не смогут работать только через Stripe.

**Independent Test**: Создать участнику минимум две частичные оплаты, убедиться, что обе транзакции ссылаются на один product_id и отображаются в CRM/отчётах как единый план оплаты.

**Acceptance Scenarios**:

1. **Given** участник с индивидуальной стоимостью и несколькими платежами, **When** менеджер открывает карточку участника, **Then** система показывает всю историю платежей, их типы (`deposit`, `rest`, `addon`), статусы и текущую стадию сделки.
2. **Given** доп. плата за услуги после основного взноса, **When** создаётся новая Checkout Session с тем же product_id, **Then** аналитика кемпа автоматически прибавляет сумму к продукту и корректирует стадию сделки согласно правилу (один платёж → Compater, два и более → Second Payment до финализации).

---

### Edge Cases

- Что происходит, если Stripe возвращает частичную оплату без обязательных metadata (deal_id, payment_type)? Система должна либо отказать обработке с ошибкой, либо записать её в очередь на ручное сопоставление.
- Как обрабатываются отменённые/неуспешные Checkout Sessions? Нужно гарантировать, что они не попадают в агрегированные суммы, но хранятся для расследований.
- Что делать, если участник оплачивает в валюте, для которой нет свежего курса? Нужно fallback-поведение: использовать последний валидный курс и отмечать запись как «ожидает обновления курса».
- Как синхронизировать документы (квитанции, receipt emails), если Stripe возвращает их позже, чем основной платёж? Процессор должен уметь догружать документы при повторном запуске.

## Requirements *(mandatory)*

### MVP Scope

- При ручном запуске триггера Stripe-процессор создаёт тестовый Checkout Session (режим `test`) для выбранной сделки, чтобы менеджер мог увидеть платёж в Stripe Dashboard и оплатить его тестовой картой.
- MVP считается успешным, когда полный цикл «назначить триггер → увидеть тестовый платёж → оплатить → запись попала в БД и отчёты» работает без вмешательства разработчика.

### Functional Requirements

- **FR-001**: Система MUST запускать новый «Stripe» процессор по тому же расписанию и условиям, что и текущий ProForm триггер, с возможностью ручного запуска для отладки.
- **FR-002**: Система MUST считывать Stripe Checkout Sessions для заданного product_id кемпа, обрабатывать их постранично и помечать как синхронизированные во внутреннем журнале.
- **FR-003**: Система MUST создавать для каждого платежа запись в существующих таблицах платежей с полями: оригинальная валюта и сумма, сумма в PLN (по актуальному курсу), ссылки на deal, продукт, участника и тип платежа.
- **FR-004**: Система MUST поддерживать частичные оплаты, храня минимум одно из metadata полей (`deal_id`, `product_id`, `payment_id`, `payment_type`) и агрегировать все транзакции участника в одной карточке в БД и отчётах.
- **FR-005**: Система MUST импортировать и хранить связанные Stripe документы (квитанции, confirmations) в тех же сущностях, что используются для ProForm, чтобы downstream процессы (wfirma, бухгалтерия) не отличали источник.
- **FR-006**: Система MUST обновить существующие отчёты (месячные, продуктовые, детализации) так, чтобы они могли фильтровать и суммировать данные Stripe вместе с ProForm, сохраняя текущий UX и форматы экспорта.
- **FR-007**: Система MUST обеспечивать консистентность валют: все отображения и экспорты должны включать оригинальную сумму, конверсию в PLN и банковское округление, использованное в ProForm.
- **FR-008**: Система MUST логировать каждую синхронизацию Stripe, включая количество обработанных платежей, пропущенных записей и ошибки, чтобы соблюдать требования аудита.
- **FR-009**: Система MUST поддерживать повторное выполнение процессора без дублирования записей, используя идемпотентные ключи (например, session id + metadata).
- **FR-010**: Система MUST выдавать статус обработки (успешно, ожидает данных, ошибка) для каждого платежа, чтобы операторы могли видеть, какие выплаты требуют ручного вмешательства.
- **FR-011**: Система MUST автоматически обновлять стадии сделок в CRM: `First Payment` (stage_id=18) → `Second Payment` (stage_id=32) при первом платеже, `Second Payment` → `Camp waiter` (stage_id=27) при втором платеже. Если для продукта предусмотрен единственный платёж, то `First Payment` → `Camp waiter` сразу после оплаты.
- **FR-012**: Система MUST позволять запускать полный процесс (импорт, отчёты, обновление стадий) на Stripe test mode с тестовыми данными, используя отдельный ключ и режим, чтобы отладить flow без затрагивания боевых платежей.
- **FR-013**: При назначении тестового триггера система MUST автоматически создавать Stripe Checkout Session в тестовой среде, возвращать ссылку менеджеру и логировать session_id, чтобы платёж был виден и доступен для оплаты тестовой картой.
- **FR-014**: Система MUST обеспечивать неизменяемый линк продукта между CRM ↔ Stripe ↔ внутренней БД: `crm_product_id` хранится вместе со `stripe_product_id` и внутренним `camp_product_id`, чтобы смена названия продукта в CRM не ломала агрегацию и отчёты.
- **FR-015**: Система MUST поддерживать B2B-поток: если у сделки есть `org_id`, данные плательщика (название, адрес, NIP) подтягиваются из организации в Pipedrive и сохраняются вместе с платёжной записью, а Checkout Session формируется с этими реквизитами.
- **FR-016**: Система MUST собирать VAT только для сделок с country = `PL`, используя режим Stripe Tax «collect, but not remit», и не запускать Checkout/Invoice, если в CRM отсутствует валидный адрес/страна; вместо этого создаётся задача на менеджера с описанием проблемы.

### Key Entities *(include if feature involves data)*

- **StripePayment**: Единичный платёж из Checkout Session; хранит session id, product_id, deal_id, payment_type, суммы в валюте и PLN, статус обработки, ссылки на документы и источник курса.
- **PaymentProcessorRun**: Журнал запуска процессора (источник, временные рамки, количества успешных/ошибочных транзакций, время выполнения, флаги идемпотентности).
- **CampProduct**: Существующая сущность продукта/кемпа, расширяемая признаками «Stripe-enabled» и маппингом на Stripe product_id.
- **ParticipantPaymentPlan**: Аггрегация всех платежей конкретного участника в рамках продукта (депозит, остаток, доп. услуги) с расчётом остатка к оплате.
- **StripeDocument**: Представление квитанций/документов, связанных с платежом, включая ссылки на файлы и статусы доставки.
- **ProductLink**: Таблица соответствия `crm_product_id`, `stripe_product_id`, `camp_product_id`, хранящая таймстемпы и статусы (активен/архив), используемая всеми отчётами вместо названия продукта.

### Data Field Inventory (поля, которые нужно заполнять)

- **Deal / CRM**  
  - `deal_id` (уникальный ID сделки в Pipedrive)  
  - `close_date` (дата кемпа; определяет одно- или двухэтапную оплату)  
  - `stage` (stage_id: 18 `First Payment`, 32 `Second Payment`, 27 `Camp waiter`)  
  - `invoice_number` / `invoice_id` (возвращается в CRM из Stripe, как и из ProForm)
  - `country` (кастомное поле сделки, используется для включения VAT и выбора режима CheckOut)
  - `address` (основной адрес из CRM, обязателен для генерации документов и Checkout)
- **Payments (ProForm исторический аналог)**  
  - `payment_id` (внутренний первичный ключ)  
  - `source` (`proform`, `stripe`)  
  - `deal_id`, `participant_id`, `product_id` (stable internal id из ProductLink)  
  - `session_id` / `invoice_id` (Stripe)  
  - `payment_type` (`deposit`, `rest`, `addon`, autocalculated)  
  - `currency`, `amount`, `amount_pln`, `exchange_rate`, `bankers_rounding` флаг  
  - `amount_tax`, `amount_tax_pln`, `tax_behavior`, `tax_rate_id` (сохраняют расчёт VAT для сделок из Польши)  
  - `status` (`processed`, `pending_metadata`, `refunded`, `deleted`)  
  - `created_at`, `processed_at`, `processor_run_id`
- **Organization / Company data**  
  - `company_name`, `company_tax_id` (NIP), `company_address`, `company_country` — используются для B2B flow и хранятся вместе с платежом/участником.
- **Documents / Receipts**  
  - `document_id`, `document_type` (receipt, confirmation)  
  - `url` или `storage_path`, `mime_type`, `source_payment_id`
- **Deletion / Refund Log**  
  - `payment_id`, `deal_id`, `reason` (`stripe_refund`, `wfirma_deleted`)  
  - `amount`, `currency`, `amount_pln` (со знаком минус)  
  - `linked_report_ids` (месячный, продуктовый отчёт)  
  - `handled_at`, `handled_by`

Все перечисленные поля уже присутствуют или имеют аналоги в ProForm-процессоре; Stripe обязан писать в те же колонки, чтобы отчёты, экспорты и аудит продолжали работать без ветвлений.

### Operational Sequence (совпадает с текущим ProForm процессором)

1. **Выборка сделок**: триггер (CRON/ручной) подтягивает сделки из CRM по тем же критериям, что ProForm: активные стадии, фильтр по `invoice_type = STRIPE`, дата `close_date`, отсутствие дубликатов.  
2. **Проверка дубликатов**: как и `invoiceProcessing.findExistingProformaForDeal`, процессор ищет ранее импортированные Stripe-платежи по `deal_id`, `invoice_id`, `session_id` и не допускает повторов (идемпотентность).  
3. **Определение типа оплаты**: на основе `close_date` и бизнес-правил (>=30 дней → два платежа, <30 → один). Результат влияет на ожидания по стадиям и на заполнение `payment_type`.  
4. **Загрузка данных из источника**: Stripe-процессор запрашивает Checkout Sessions/Product → Line Items → Payments, аналогично тому, как ProForm создаёт данные через wFirma API.  
5. **Конвертация валют и расчёт сумм**: применяем тот же модуль (`convertCurrency`, `roundBankers`), чтобы `amount_pln` совпадал с ProForm логикой.  
6. **Сохранение в БД**: заполняем таблицы Payments, Documents, Activity Log, ProcessorRun в том же порядке, как `invoiceProcessing.persistProformaToDatabase` вызывает `ProformaRepository`.  
7. **Обновление CRM**: после успешной записи обновляем стадию сделки и номер инвойса (аналог `ensureInvoiceNumber` / `updateDealStage`).  
8. **Обработка ошибок и возвратов**: любые `refund`, `void` или отменённые сессии попадают в «Удалённые проформы» (существующий журнал), очищают сумму из отчётов и оставляют аудит-след. Повторные запуски подтягивают пропущенные документы и статусы.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 99% Stripe Checkout Sessions синхронизируются в БД в течение 5 минут после запуска процессора без ручного вмешательства.
- **SC-002**: Месячные и продуктовые отчёты должны отображать данные Stripe в тех же таблицах, что и ProForm, с расхождением не более 1% от показателей Stripe Dashboard за любой проверяемый период.
- **SC-003**: Координаторы кемпов могут увидеть полный статус частичных оплат участника (все платежи, суммы, типы) менее чем за 10 секунд после открытия карточки.
- **SC-004**: Финансовая команда может экспортировать комбинированный отчёт (ProForm + Stripe) и использовать его для бухгалтерии без дополнительной ручной конвертации, что сокращает время сверки минимум на 30%.
