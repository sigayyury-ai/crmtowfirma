# Research: VAT маржа — сопоставление платежей

## CSV формат и обработка

- **Решение**: использовать строковый парсер с поддержкой разделителя `;` (например, `papaparse` в потоковом режиме или `csv-parse`).
- **Результат анализа**:
  - Файл `test.csv` показывает наличие заголовков, метаданных и строк таблицы с полями: дата проводки, дата операции, тип операции, описание, отправитель, номер счёта, сумма, итоговое saldo.
  - Номер проформы встречается в поле `#Tytuł` (или описании) и имеет вид `CO-PROF NN/YYYY`, иногда с суффиксом (`CO-PROF 19/2025.`) или приставкой (`Sporthause/ singl. CO-PROF 45/2025`).
  - Встречаются строки без номера проформы (например, налоговые платежи, покупки картой). Такие записи должны попадать в очередь ручной обработки.
  - Сумма записана в формате `1 055,00` с пробелом как разделителем тысяч – нужна нормализация.
- **Настройки парсера**:
  - Кодировка UTF-8 (проверить, может потребоваться `iconv-lite` при других кодировках).
  - Игнорировать строки до заголовка таблицы (`#Data księgowania;...`).
  - Пропускать пустые строки и строки итогового баланса.

## Поиск проформ в wFirma

- **Текущий клиент**: `WfirmaClient` поддерживает получение контракторов и товаров, но нет быстрого поиска проформ по номеру.
- **Исследование API**:
  - wFirma предоставляет endpoint `/invoices/find` с фильтрацией по `number`. Нужно уточнить, доступен ли для проформ (тип `invoice_type=proforma`).
  - Альтернатива: хранить локальную таблицу сопоставлений (в рамках MVP выполняем прямой запрос к wFirma).
- **Выбор**: 
  - Реализовать сервис `wfirmaLookup.findProforma(number)` — обращение к wFirma с фильтром по номеру, кешировать ответы в памяти (Map) на время обработки CSV.
  - Если запрос возвращает несколько совпадений — отправлять в ручную очередь с пометкой «несколько проформ».

## Авторизация страницы / API

- **Требование**: ограничить доступ к странице «VAT маржа» и REST маршрутам.
- **Рассмотренные варианты**:
  1. Google OAuth с доменным фильтром (проверять `hd` и список разрешённых пользователей).
  2. API-ключ + Basic auth (быстрее внедрить, но менее удобен).
- **Решение**: использовать Google OAuth (или Google Sign-In) с проверкой домена. До реализации — предусмотреть middleware, который проверяет JWT Google и разрешает доступ только корпоративным адресам. Для прототипа — статическая страница можно разместить под временным токеном.

## Логирование и безопасность

- **Цель**: не выводить/не хранить полные строки CSV с персональными данными.
- **Выбор**: на уровне сервисов логировать только статистику (количество строк, количество сопоставлений, количество ошибок). Ошибки — в формате `Payment row 12: CO-PROF 19/2025 sum mismatch`. Файл логов — отдельный канал (например, `vat-margin.log`) или существующий Winston с redaction.
- **Дополнительно**: настроить ограничение размера загружаемого файла (`multer` с лимитом, например, 10 МБ) и rate limiting.

## Дополнительные вопросы

- **Конвертация валют**: при необходимости брать курс из wFirma или указывать, что входные CSV должны быть в PLN. На этапе MVP — принимаем только PLN (зафиксировано в spec/test.csv).
- **Прототип**: использовать тестовые данные (`test.csv`) → подготовить JSON/JS объект для отображения на странице без backend.
- **Хранение данных**: результаты обработки можно хранить в памяти (Map по jobId) до обновления страницы; для долгосрочного хранения — опция расширения.

## Итог

- Парсер CSV: `papaparse` (потоковый режим), нормализация чисел и строк.
- wFirma lookup: отдельный сервис, кеш на время обработки, обработка дубликатов.
- Авторизация: Google OAuth + проверка домена, middleware на backend.
- Логирование: агрегированная статистика, без персональных данных.
- Ограничения: CSV до 10 МБ, только PLN, операции без проформы → ручная очередь.
