# Feature Specification: VAT маржа — сопоставление платежей

**Feature Branch**: `003-vat-margin-tracker`  
**Created**: 2025-10-26  
**Status**: Draft  
**Input**: User description: "я хочу добавить новый функционал.  Должно работать на отдельной страничке. Который будет помогать нам собирать ежемесячные ответы - ват маржа. Он должн уметь агрегировать инвойсы по продуктам.  Я буду загружать файлы банковских выписок с приходами наших клиентов. Этот CVS файл надо будет анализировать назодить в нем номера проформы - они будут выглядеть примерно так CO-PROF 16/2025 будет меняться только номер и год. Эту проформу надо будет находить в Wfirma чтобы найти сколько всего в PLN должна придти сумма, также какой продукт был в описании этой проформы, а также в отчете помечать фактически прешедшую сумму из CSV выгрузки банка. После обработки операций из нужно агрегировать по продукту и месяцу в котом была совершена эта операция. Операции без номеров проформ отправлять в ручную обработку для разнесения по продуктам уже в конце. После того как станут известны продукты."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Автосопоставление банковских поступлений (Priority: P1)

Финансовый аналитик загружает CSV-файл с банковскими поступлениями на отдельной странице «VAT маржа». Система автоматически находит в каждой строке номер проформы вида `CO-PROF XX/YYYY`, подтягивает данные проформы из wFirma (сумму в PLN и продукт) и сопоставляет с фактическим поступлением.

**Why this priority**: Без корректного сопоставления поступлений с проформами невозможно вести учёт VAT маржи и сверять доходы по продуктам.

**Independent Test**: Загрузить тестовый CSV с несколькими платежами, убедиться, что для строк с корректным номером проформы выводятся данные проформы, рассчитанная разница и ФИО/название контрагента из wFirma.

**Acceptance Scenarios**:

1. **Given** CSV‑файл с платежом, содержащим номер `CO-PROF 16/2025`, **When** файл загружен, **Then** система отображает карточку операции с найденной проформой, суммой из wFirma, именем контрагента и фактической суммой платежа.
2. **Given** платеж с несколькими совпадениями проформ (дубликаты), **When** обработка завершена, **Then** система уведомляет о конфликте и требует ручного выбора, при этом в каждой записи отображается имя контрагента для проверки.

---

### User Story 2 - Агрегированный отчёт по продуктам и месяцам (Priority: P2)

Аналитик видит на той же странице сводку: суммы поступлений и ожиданий по каждому продукту и месяцу, включая разницу и статус (полностью оплачено/частично/переплата).

**Why this priority**: Агрегация по продуктам и месяцам позволяет формировать ежемесячную отчётность VAT маржи без ручных расчётов.

**Independent Test**: После обработки тестового CSV просмотреть отчёт, убедиться, что суммы сгруппированы по продукту и месяцу операции, а статусы корректны.

**Acceptance Scenarios**:

1. **Given** несколько платежей по одному продукту в одном месяце, **When** агрегация выполнена, **Then** отчёт показывает суммарную ожидаемую и фактическую сумму с указанием статуса оплаты.
2. **Given** платежи в разных валютах или с конвертацией, **When** отчёт построен, **Then** все суммы представлены в PLN с указанием источника (преференс wFirma).

---

### User Story 3 - Ручная обработка неподтверждённых операций (Priority: P3)

Операции без найденного номера проформы или с ошибками в суммах попадают в очередь ручной обработки, где аналитик может вручную привязать продукт/проформу или пометить операцию как требующую уточнений.

**Why this priority**: Без очереди ручной обработки часть операций останется неучтённой, что сорвёт отчётность.

**Independent Test**: Загрузить CSV с платежом без номера проформы, убедиться, что элемент появился в очереди, и протестировать ручное присвоение продукта.

**Acceptance Scenarios**:

1. **Given** платеж без номера проформы, **When** файл обработан, **Then** операция отображается в списке ручной обработки с пометкой «требует действия».
2. **Given** аналитик вручную назначил продукт и проформу, **When** изменения сохранены, **Then** операция исключается из очереди и включается в общий отчёт.

---

### Edge Cases

- Строки CSV с отсутствующим или неверным номером проформы (лишние символы, неверный формат).
- Частичные платежи (несколько поступлений по одной проформе, суммы не совпадают полностью).
- CSV с дублями или разными валютами (выписки мультивалютных счетов).
- Поступления с задержкой (дата платежа и дата проформы в разных месяцах).
- Несоответствие суммы (переплата/недоплата) — нужно фиксировать разницу и статус.
- Огромные CSV-файлы (десятки тысяч строк) — важно обработать без таймаута.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST предоставлять страницу «VAT маржа» с формой загрузки CSV-файла банковской выписки и описанием требований к формату.
- **FR-002**: Система MUST парсить CSV-файл, извлекать сумму, дату операции, описание, валюту и искать номер проформы по шаблону `CO-PROF NN/YYYY`.
- **FR-003**: Система MUST запрашивать из wFirma данные проформы (ожидаемая сумма в PLN, продукт/описание, статус) и сопоставлять с найденными платежами.
- **FR-004**: Система MUST фиксировать фактическую сумму из CSV и рассчитывать разницу с ожидаемой суммой проформы.
- **FR-005**: Система MUST агрегировать сопоставленные операции по продукту и месяцу (по дате платежа) с отображением сумм, количества операций и статусов.
- **FR-006**: Система MUST сохранять список операций без успешного сопоставления в очередь ручной обработки с причиной (нет номера, несколько совпадений, несовпадение суммы).
- **FR-007**: Система MUST позволять пользователю вручную назначать продукт/проформу операциям из очереди и пересчитывать агрегированные показатели после сохранения.
- **FR-008**: Система MUST поддерживать экспорт итогового отчёта (агрегированная таблица + список исключений) для отчётности VAT маржи.
- **FR-009**: Система MUST вести журнал обработки (дата загрузки, кто загрузил, количество сопоставленных/ручных операций) для аудита.
- **FR-010**: Система MUST валидировать размер файла и предоставлять понятные сообщения об ошибках при некорректном формате CSV.
- **FR-011**: Система MUST отображать в итоговом отчёте по каждому продукту общую ожидаемую сумму (по данным проформ) и общую фактическую сумму поступлений, а также разницу между ними.
- **FR-012**: Система MUST предоставить интерактивный HTML‑прототип страницы «VAT маржа» на основе тестовых данных (например, `test.csv`) до начала основной разработки; прототип должен содержать все ключевые элементы интерфейса (загрузка файла, очередь ручной обработки, сводка по продуктам) для согласования с бизнесом.
- **FR-013**: Система MUST выводить в таблицах операций и агрегированного отчёта название/ФИО контрагента из wFirma, связанного с проформой, и сохранять его при экспорте.

### Key Entities *(include if feature involves data)*

- **BankTransaction**: Запись из банковской выписки (дата, сумма, валюта, описание, найденный номер проформы, статус сопоставления).
- **ProformaInvoiceSummary**: Основные данные проформы из wFirma (ID, номер, продукт, ожидаемая сумма, статус, дата).
- **ProductMonthlyAggregate**: Агрегированная запись по продукту и месяцу (количество оплат, ожидаемая сумма, фактическая сумма, разница, статус оплаченности).
- **ManualReviewItem**: Операция, требующая ручной обработки (причина, предложение, комментарии пользователя, дата решения).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 90% платежей из CSV автоматически сопоставляются с проформами при корректных данных.
- **SC-002**: Полная обработка CSV на 5 000 строк завершается менее чем за 3 минуты.
- **SC-003**: Агрегированный отчёт показывает корректные ожидаемые и фактические суммы по каждому продукту и статусу для 100% проверенных кейсов (ручная проверка выборки).
- **SC-004**: Очередь ручной обработки даёт ответ пользователю менее чем за 10 секунд от момента загрузки файла.
- **SC-005**: Экспорт отчёта формируется менее чем за 30 секунд и содержит все поля, необходимые для VAT‑отчётности.
- **SC-006**: HTML‑прототип проходит UX‑ревью с бизнесом: замечания фиксируются и учитываются перед переходом к реализации.
- **SC-007**: В пользовательском интерфейсе 100% сопоставленных операций и агрегированных строк отображают корректное имя контрагента из wFirma.

## Assumptions & Dependencies *(optional)*

- CSV-файлы имеют единый разделитель `;` и кодировку UTF-8 (иначе файл нужно предварительно конвертировать).
- В выписке всегда указана валюта, при необходимости конвертация в PLN берётся из wFirma или фиксированного курса дня.
- Доступ к wFirma API стабильный; ошибки соединения обрабатываются повторными попытками.
- Ручная обработка выполняется пользователями, уже прошедшими аутентификацию системы.
- Ограничения по размеру файла (например, до 20 МБ) будут соблюдаться пользователем.
