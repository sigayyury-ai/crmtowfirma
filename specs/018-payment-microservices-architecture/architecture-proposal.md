# Архитектура микросервисов платежей - Предложение

## Обзор

Данный документ предлагает архитектуру микросервисов для системы обработки платежей через Stripe с поддержкой гибридных платежей, автоматизации статусов CRM и уведомлений.

## Принципы архитектуры

1. **Разделение ответственности**: Каждый микросервис отвечает за одну четко определенную область
2. **Независимость**: Микросервисы могут разрабатываться, тестироваться и развертываться независимо
3. **Идемпотентность**: Все операции должны быть идемпотентными для безопасной повторной обработки
4. **Event-Driven**: Использование событий для асинхронной коммуникации между сервисами
5. **Resilience**: Обработка ошибок, retry механизмы, circuit breakers
6. **Observability**: Логирование, метрики, трейсинг для всех операций

## Предлагаемые микросервисы

### 1. Payment Session Service (Сервис платежных сессий)

**Ответственность:**
- Создание Stripe Checkout Sessions
- Управление жизненным циклом сессий
- Поддержка изменения сумм сессий до оплаты
- Создание сессий для B2C и B2B клиентов
- Проверка дубликатов сессий перед созданием
- Сохранение состояния процесса при ошибках

**Основные операции:**
- `createSession(dealId, paymentType, amount, currency, metadata)` - создание сессии
- `updateSession(sessionId, newAmount)` - обновление суммы сессии
- `getSession(sessionId)` - получение информации о сессии
- `cancelSession(sessionId)` - отмена сессии
- `checkDuplicateSession(dealId, paymentType)` - проверка дубликатов
- `saveProcessState(processId, state, errors)` - сохранение состояния процесса
- `retryFailedProcess(processId, correctedData)` - перезапуск процесса после исправления ошибок

**Входные данные:**
- Данные сделки из CRM (deal_id, сумма, валюта, график платежей)
- Информация о клиенте (email, имя, адрес для B2B)
- Тип платежа (deposit, rest, single)

**Валидация данных:**
- Обязательные поля: deal_id, email клиента, сумма (> 0), валюта
- Проверка суммы: должна быть положительной и не превышать сумму сделки
- Проверка email: валидный формат email адреса
- Проверка дубликатов: наличие активной сессии того же типа для сделки
- Для B2B: проверка наличия реквизитов организации (название, адрес, NIP)

**Обработка ошибок:**
- При ошибке валидации: не создавать сессию, сохранить состояние процесса с информацией об ошибках, отправить уведомление менеджеру
- При ошибке внешнего сервиса: сохранить состояние, использовать retry с экспоненциальной задержкой, уведомить менеджера о задержке
- Возможность перезапуска: менеджер может исправить данные и перезапустить процесс без потери контекста

**Выходные данные:**
- Stripe Checkout Session ID (при успешном создании)
- URL для оплаты
- Метаданные сессии
- Информация об ошибках (при неудаче)
- Список недостающих или некорректных полей (при ошибке валидации)

**События:**
- `session.created` - сессия создана
- `session.updated` - сессия обновлена
- `session.cancelled` - сессия отменена
- `session.creation.failed` - ошибка создания сессии
- `session.duplicate.detected` - обнаружен дубликат сессии

**Интеграции:**
- Stripe API
- CRM (Pipedrive) для получения данных сделки
- Product Link Service для связи продуктов
- Validation Service для валидации данных (при создании сессии)
- Notification Service для уведомления менеджеров об ошибках
- Webhook Processing Service для обработки обновлений сделок (если триггер создания сессии)
- Deal Diagnostics Service для отображения ошибок валидации менеджерам

---

### 2. Webhook Processing Service (Сервис обработки webhook)

**Ответственность:**
- Прием и валидация webhook событий от Stripe
- Прием и обработка webhook событий от Pipedrive (обновления сделок)
- Маршрутизация событий к соответствующим обработчикам
- Обеспечение идемпотентности обработки

**Основные операции:**
- `processWebhookEvent(event)` - обработка webhook события
- `validateSignature(payload, signature)` - валидация подписи Stripe
- `deduplicateEvent(eventId)` - проверка дубликатов
- `processPipedriveWebhook(webhookData)` - обработка webhook от Pipedrive

**Обрабатываемые события Stripe:**
- `checkout.session.completed` - сессия оплачена
- `checkout.session.async_payment_succeeded` - асинхронный платеж успешен
- `checkout.session.async_payment_failed` - асинхронный платеж неудачен
- `checkout.session.expired` - сессия истекла
- `payment_intent.succeeded` - платеж успешен
- `payment_intent.payment_failed` - платеж неудачен
- `charge.refunded` - возврат средств
- `charge.updated` - обновление charge

**Обрабатываемые события Pipedrive:**
- `deal.updated` - обновление сделки
  - Если изменение `invoice_type` → триггер создания новой сессии → валидация через ValidationService
  - Если изменение других полей → проверка необходимости обновления сессий
- `deal.deleted` - удаление сделки
- `deal.stage_changed` - изменение стадии сделки

**События:**
- `payment.received` - платеж получен
- `payment.failed` - платеж неудачен
- `payment.refunded` - возврат платежа
- `session.expired` - сессия истекла

**Интеграции:**
- Stripe API для верификации событий
- Event Bus для публикации событий

---

### 3. Payment Processing Service (Сервис обработки платежей)

**Ответственность:**
- Валидация и сохранение платежей в БД
- Обработка гибридных платежей (Stripe + наличные)
- Конвертация валют
- Расчет VAT для B2B клиентов
- Управление историей изменений сумм

**Основные операции:**
- `processPayment(sessionId, eventData)` - обработка платежа
- `savePayment(paymentData)` - сохранение платежа в БД
- `updatePaymentAmount(paymentId, newAmount, reason)` - изменение суммы платежа
- `processHybridPayment(stripePaymentId, cashAmount)` - обработка гибридного платежа
- `calculateVAT(amount, country, isB2B)` - расчет VAT

**Входные данные:**
- Данные из Stripe webhook события
- Информация о сессии
- Данные о клиенте и сделке

**Выходные данные:**
- Сохраненный платеж в БД
- Конвертированные суммы в PLN
- Расчет VAT (если применимо)

**События:**
- `payment.processed` - платеж обработан
- `payment.amount.changed` - сумма платежа изменена
- `hybrid.payment.completed` - гибридный платеж завершен

**Интеграции:**
- База данных (Supabase) для хранения платежей
- Exchange Rate Service для конвертации валют
- Event Bus для публикации событий

---

### 4. Session Monitor Service (Сервис мониторинга сессий)

**Ответственность:**
- Периодическая проверка истекших Stripe сессий
- Обнаружение неоплаченных сессий
- Проверка консистентности данных между Stripe и БД
- Создание задач на пересоздание сессий

**Основные операции:**
- `checkExpiredSessions()` - проверка истекших сессий
- `checkPaymentConsistency()` - проверка консистентности платежей
- `createRecreationTask(sessionId, dealId)` - создание задачи на пересоздание

**Расписание:**
- Проверка истекших сессий: каждые 4 часа
- Проверка консистентности: ежедневно в 02:00

**События:**
- `session.expired.detected` - обнаружена истекшая сессия
- `consistency.issue.detected` - обнаружено расхождение данных

**Интеграции:**
- Stripe API для проверки статусов сессий
- База данных для сравнения данных
- Task Queue для создания задач

---

### 5. Session Recreation Service (Сервис пересоздания сессий)

**Ответственность:**
- Пересоздание истекших Stripe сессий
- Проверка отсутствия дубликатов активных сессий
- Обновление записей в БД

**Основные операции:**
- `recreateExpiredSession(sessionId, dealId)` - пересоздание сессии
- `checkActiveSessions(dealId, paymentType)` - проверка активных сессий
- `updateSessionRecord(oldSessionId, newSessionId)` - обновление записи в БД

**Логика пересоздания:**
1. Проверка что нет активной сессии того же типа для сделки
2. Определение типа платежа (deposit/rest/single) на основе истории
3. Расчет суммы платежа
4. Создание новой сессии через Payment Session Service
5. Обновление записи в БД
6. Публикация события для отправки уведомления

**События:**
- `session.recreated` - сессия пересоздана

**Интеграции:**
- Payment Session Service для создания сессий
- База данных для обновления записей
- Event Bus для публикации событий

---

### 6. Reminder Scheduler Service (Сервис планирования напоминаний)

**Ответственность:**
- Планирование напоминаний о платежах
- Определение дат напоминаний на основе графика платежей
- Создание задач на отправку напоминаний

**Основные операции:**
- `scheduleReminders()` - планирование напоминаний
- `calculateReminderDate(paymentSchedule, closeDate)` - расчет даты напоминания
- `createReminderTask(dealId, reminderType, date)` - создание задачи на напоминание

**Типы напоминаний:**
- `second_payment_reminder` - напоминание о втором платеже (график 50/50)
- `overdue_payment_reminder` - напоминание о просроченном платеже
- `upcoming_payment_reminder` - напоминание о предстоящем платеже

**Расписание:**
- Планирование напоминаний: ежедневно в 09:00
- Проверка просроченных платежей: ежедневно в 10:00

**События:**
- `reminder.scheduled` - напоминание запланировано
- `reminder.due` - наступила дата напоминания

**Интеграции:**
- База данных для получения данных о сделках и платежах
- Task Queue для создания задач
- Event Bus для публикации событий

---

### 7. CRM Status Service (Сервис статусов CRM)

**Ответственность:**
- Автоматическое обновление статусов сделок в CRM
- Определение целевого статуса на основе платежей и графика
- Обработка правил переходов статусов

**Основные операции:**
- `updateDealStatus(dealId, paymentData)` - обновление статуса сделки
- `calculateTargetStatus(dealId, payments)` - расчет целевого статуса
- `syncDealStage(dealId, targetStageId)` - синхронизация статуса в CRM

**Правила переходов статусов:**
- `First Payment (18)` → `Second Payment (32)` - при оплате первого платежа в графике 50/50
- `First Payment (18)` → `Camp Waiter (27)` - при полной оплате в графике 100%
- `Second Payment (32)` → `Camp Waiter (27)` - при оплате второго платежа

**События:**
- `crm.status.updated` - статус обновлен в CRM
- `crm.status.calculation.failed` - ошибка расчета статуса

**Интеграции:**
- Pipedrive API для обновления статусов
- База данных для получения данных о платежах
- Event Bus для публикации событий

---

### 8. Notification Service (Сервис уведомлений)

**Ответственность:**
- Отправка уведомлений клиентам и менеджерам
- Поддержка различных каналов (email, Telegram через SendPulse)
- Управление шаблонами уведомлений
- Предотвращение дублирования уведомлений

**Основные операции:**
- `sendNotification(recipient, type, data)` - отправка уведомления
- `sendPaymentLink(dealId, sessionUrl)` - отправка ссылки на оплату
- `sendPaymentConfirmation(dealId, paymentData)` - отправка подтверждения оплаты
- `sendReminder(dealId, reminderType)` - отправка напоминания
- `checkDuplicateNotification(dealId, type, ttl)` - проверка дубликатов

**Типы уведомлений:**
- `payment_link_created` - создана ссылка на оплату
- `payment_received` - платеж получен
- `payment_reminder` - напоминание о платеже
- `session_expired` - сессия истекла, создана новая
- `payment_refunded` - возврат платежа

**События:**
- `notification.sent` - уведомление отправлено
- `notification.failed` - ошибка отправки уведомления

**Интеграции:**
- SendPulse API для отправки уведомлений
- База данных для логирования отправок
- Event Bus для получения событий

---

### 9. Cash Payment Service (Сервис наличных платежей)

**Ответственность:**
- Управление наличными платежами
- Подтверждение наличных платежей
- Агрегация гибридных платежей (Stripe + наличные)
- Исключение наличных из бухгалтерских отчетов

**Основные операции:**
- `createCashPayment(dealId, amount, currency)` - создание записи о наличном платеже
- `confirmCashPayment(cashPaymentId, receivedAmount)` - подтверждение наличного платежа
- `aggregateHybridPayment(dealId)` - агрегация гибридного платежа
- `getCashPayments(dealId)` - получение наличных платежей для сделки

**События:**
- `cash.payment.created` - создан наличный платеж
- `cash.payment.confirmed` - наличный платеж подтвержден
- `hybrid.payment.aggregated` - гибридный платеж агрегирован

**Интеграции:**
- База данных для хранения наличных платежей
- CRM для получения данных о сделках
- Event Bus для публикации событий

---

### 10. Exchange Rate Service (Сервис курсов валют)

**Ответственность:**
- Получение актуальных курсов валют
- Кэширование курсов
- Конвертация сумм в PLN

**Основные операции:**
- `getExchangeRate(fromCurrency, toCurrency)` - получение курса валют
- `convertAmount(amount, fromCurrency, toCurrency)` - конвертация суммы
- `refreshRates()` - обновление курсов

**Интеграции:**
- open.er-api.com для получения курсов
- Кэш для хранения курсов

---

### 11. Validation Service (Сервис валидации данных)

**Ответственность:**
- Валидация данных перед созданием сессий и обработкой платежей
- Проверка обязательных полей
- Валидация форматов данных (email, суммы, валюты)
- Проверка бизнес-правил (суммы, диапазоны, ограничения)

**Основные операции:**
- `validateSessionData(data)` - валидация данных для создания сессии
- `validatePaymentData(data)` - валидация данных платежа
- `validateEmail(email)` - валидация email адреса
- `validateAmount(amount, dealAmount)` - валидация суммы платежа
- `getValidationErrors(data)` - получение списка ошибок валидации

**Правила валидации:**
- Email: валидный формат, обязательное поле
- Сумма: положительное число, не превышает сумму сделки, обязательное поле
- Валюта: поддерживаемая валюта (PLN, EUR, USD и т.д.), обязательное поле
- Deal ID: существующая сделка в CRM, обязательное поле
- Payment Type: допустимый тип (deposit, rest, single), обязательное поле
- Для B2B: название организации, адрес, NIP (для резидентов PL)

**Выходные данные:**
- Результат валидации (success/failure)
- Список ошибок с описанием и полями
- Рекомендации по исправлению ошибок

**События:**
- `validation.failed` - ошибка валидации
- `validation.succeeded` - валидация успешна

**Интеграции:**
- База данных для проверки существования сущностей
- CRM для проверки данных сделок

---

### 12. Duplicate Prevention Service (Сервис предотвращения дубликатов)

**Ответственность:**
- Проверка дубликатов сессий перед созданием
- Проверка дубликатов уведомлений перед отправкой
- Управление идемпотентными ключами
- Логирование попыток дублирования

**Основные операции:**
- `checkSessionDuplicate(dealId, paymentType)` - проверка дубликата сессии
- `checkNotificationDuplicate(recipient, type, ttl)` - проверка дубликата уведомления
- `checkEventDuplicate(eventId)` - проверка дубликата события
- `recordSessionCreation(sessionId, dealId, paymentType)` - запись создания сессии
- `recordNotificationSent(notificationId, recipient, type)` - запись отправки уведомления

**Логика проверки дубликатов сессий:**
- Проверка наличия активной сессии (status = 'open') того же типа (deposit/rest/single) для сделки
- Использование уникального ключа: deal_id + payment_type + status
- Возврат информации о существующей сессии при обнаружении дубликата

**Логика проверки дубликатов уведомлений:**
- Проверка истории отправленных уведомлений по типу и получателю
- TTL период: по умолчанию 24 часа
- Использование идемпотентного ключа: recipient + type + timestamp (округленный до часа)

**Хранение данных:**
- Таблица `session_duplicate_checks` - проверки дубликатов сессий
- Таблица `notification_logs` - логи отправленных уведомлений с TTL
- Таблица `event_logs` - логи обработанных событий для идемпотентности

**События:**
- `duplicate.session.detected` - обнаружен дубликат сессии
- `duplicate.notification.detected` - обнаружен дубликат уведомления

**Интеграции:**
- База данных для хранения логов и проверок
- Event Bus для публикации событий о дубликатах

---

### 12. Deal Diagnostics Service (Сервис диагностики сделок) - СУЩЕСТВУЮЩИЙ

**Ответственность:**
- Сбор полной диагностической информации по сделке для sales менеджеров
- Отображение состояния платежей, проформ, автоматизаций, уведомлений
- Анализ проблем и ошибок
- Предоставление доступных действий для менеджера

**Основные операции:**
- `getDealDiagnostics(dealId)` - получение полной диагностики по сделке
- `getSystemDiagnostics(options)` - системная диагностика всех сделок
- `analyzeIssues(...)` - анализ проблем и ошибок
- `getValidationInfo(dealId)` - получение информации о валидации (НОВОЕ)

**Что показывает:**
- Информация о сделке (dealInfo)
- Все платежи (Stripe, Proforma, Cash)
- Проформы
- Возвраты
- Автоматизации статусов
- Уведомления
- Задачи из Pipedrive
- Cron задачи
- **Валидация** (НОВОЕ):
  - Ошибки валидации из БД (блокирующие создание сессии)
  - Предупреждения валидации (не блокирующие)
  - Текущее состояние валидации (если сессия еще не создана)
  - Рекомендации по исправлению ошибок
- Issues (проблемы и ошибки)
- Available Actions (доступные действия)

**Интеграция с валидацией:**
- Получает ошибки валидации из таблицы `validation_errors`
- Получает предупреждения валидации (severity='warning')
- Проверяет текущее состояние валидации через ValidationService
- Отображает валидационные проблемы в issues
- Предоставляет действие "Перезапустить создание сессии" после исправления ошибок

**API Endpoint:**
- `GET /api/pipedrive/deals/:id/diagnostics` - диагностика конкретной сделки
- `GET /api/pipedrive/deals/system-diagnostics` - системная диагностика

**Интеграции:**
- Validation Service для проверки текущего состояния валидации
- База данных для получения истории ошибок валидации
- CRM (Pipedrive) для получения данных сделки и создания задач
- Stripe Repository для получения платежей
- Proforma Repository для получения проформ

**Статус**: Существующий сервис, требует интеграции с ValidationService

Подробнее: [diagnostics-integration.md](./diagnostics-integration.md)

---

### 13. Deal Update Monitor Service (Сервис мониторинга изменений сделок) - ОПЦИОНАЛЬНО

**Ответственность:**
- Отслеживание изменений в сделках через Pipedrive webhooks
- Обнаружение расхождений между данными сделки и созданными сессиями
- Предупреждение менеджеров о необходимости обновить сессии

**Когда нужен:**
- Если изменения в сделках частые и требуют внимания менеджеров
- Если нужно проактивно обнаруживать расхождения между ценой сделки и суммой сессии
- Если менеджеры часто сталкиваются с проблемами из-за изменений в сделках

**Основные операции:**
- `monitorDealUpdate(dealId, previousData, currentData)` - мониторинг изменений сделки
- `checkSessionConsistency(dealId)` - проверка консистентности сессий с данными сделки
- `detectPriceMismatch(dealId)` - обнаружение расхождения цены сделки и суммы сессии
- `createManagerTask(dealId, issue, recommendation)` - создание задачи для менеджера

**Что отслеживает:**
- Изменение цены сделки (если есть неоплаченные сессии)
- Изменение обязательных полей (адрес, email, имя) после создания сессии
- Изменение графика платежей (expected_close_date)
- Изменение invoice_type (триггер для создания новой сессии)

**Валидация:**
- ⚠️ НЕ выполняет валидацию при обновлении (сессия уже создана)
- ✅ Предупреждает менеджера о расхождениях
- ✅ Рекомендует обновить сессию или создать новую

**События:**
- `deal.price.changed` - цена сделки изменилась
- `deal.field.changed` - обязательное поле изменилось
- `deal.schedule.changed` - график платежей изменился
- `session.mismatch.detected` - обнаружено расхождение между сделкой и сессией

**Интеграции:**
- Webhook Processing Service для получения событий обновления сделок
- CRM (Pipedrive) для создания задач менеджерам
- База данных для проверки состояния сессий

**Статус**: Опциональный сервис для будущего (Фаза 9+), не обязателен для текущей миграции

---

## Event Bus (Шина событий)

Центральная шина событий для асинхронной коммуникации между микросервисами.

**Технологии:**
- RabbitMQ, Apache Kafka, или Redis Pub/Sub
- Поддержка гарантированной доставки
- Dead Letter Queue для обработки ошибок

**Основные события:**

```
payment.session.created
payment.session.updated
payment.session.expired
payment.received
payment.failed
payment.refunded
payment.amount.changed
hybrid.payment.completed
crm.status.updated
notification.sent
reminder.due
session.recreated
```

## База данных

**Общие таблицы:**
- `stripe_payments` - платежи Stripe
- `stripe_sessions` - сессии Stripe (все созданные сессии, включая истекшие и отмененные)
- `cash_payments` - наличные платежи
- `payment_status_history` - история изменений статусов и сумм
- `reminder_logs` - логи отправленных напоминаний
- `notification_logs` - логи отправленных уведомлений (с TTL для предотвращения дубликатов)
- `event_logs` - логи обработанных событий (для идемпотентности)
- `session_duplicate_checks` - проверки дубликатов сессий
- `process_states` - состояния процессов (для перезапуска после ошибок)
- `validation_errors` - ошибки валидации с информацией о недостающих полях
- `customer_payment_history` - агрегированная история всех платежей клиента

**Принципы:**
- Каждый микросервис имеет доступ только к необходимым таблицам
- Использование транзакций для критических операций
- Eventual consistency для некритических операций

## API Gateway

Единая точка входа для всех внешних запросов.

**Функции:**
- Маршрутизация запросов к соответствующим микросервисам
- Аутентификация и авторизация
- Rate limiting
- Логирование запросов

## Мониторинг и Observability

**Метрики:**
- Количество обработанных платежей по сервисам
- Время обработки операций
- Количество ошибок
- Доступность сервисов

**Логирование:**
- Структурированные логи для всех операций
- Correlation ID для трейсинга запросов
- Централизованное хранение логов

**Алерты:**
- Критические ошибки обработки платежей
- Недоступность сервисов
- Превышение времени обработки
- Расхождения данных

## Схема взаимодействия микросервисов

```
┌─────────────────┐
│   CRM (Pipedrive)│
└────────┬─────────┘
         │
         ▼
┌─────────────────────────────────────┐
│      API Gateway                    │
└────────┬────────────────────────────┘
         │
    ┌────┴────┬──────────┬──────────┬──────────┐
    │         │          │          │          │
    ▼         ▼          ▼          ▼          ▼
┌────────┐ ┌──────┐ ┌────────┐ ┌────────┐ ┌────────┐
│Session │ │Webhook│ │Payment │ │  CRM   │ │Notification│
│Service │ │Service│ │Service │ │Service │ │ Service │
└────┬───┘ └───┬──┘ └───┬────┘ └───┬────┘ └────┬─────┘
     │         │        │          │          │
     └─────────┴────────┴──────────┴──────────┘
                    │
                    ▼
            ┌───────────────┐
            │  Event Bus    │
            └───────┬───────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
        ▼           ▼           ▼
   ┌────────┐ ┌────────┐ ┌────────┐
   │Monitor │ │Reminder│ │  Cash  │
   │Service │ │Service │ │Service │
   └────────┘ └────────┘ └────────┘
```

## Последовательность обработки платежа

1. **Создание сессии:**
   - CRM → API Gateway → Payment Session Service
   - Payment Session Service вызывает Validation Service для валидации данных
   - Если валидация не прошла:
     - Сохраняет состояние процесса с ошибками в БД
     - Отправляет уведомление менеджеру со списком ошибок
     - Процесс останавливается, но не блокирует другие операции
     - Менеджер может исправить данные и перезапустить процесс
   - Если валидация прошла:
     - Duplicate Prevention Service проверяет наличие дубликатов
     - Если дубликат найден: возвращает информацию о существующей сессии, не создает новую
     - Если дубликата нет: Payment Session Service создает сессию в Stripe
     - Сохраняет сессию в БД (таблица stripe_sessions)
     - Публикует событие `session.created`
     - Notification Service проверяет дубликаты уведомлений и отправляет уведомление клиенту

2. **Оплата:**
   - Клиент оплачивает сессию в Stripe
   - Stripe отправляет webhook → Webhook Processing Service
   - Webhook Processing Service валидирует подпись события
   - Duplicate Prevention Service проверяет по event ID что событие еще не обработано
   - Если событие уже обработано: игнорирует дубликат, логирует попытку повторной обработки
   - Если событие новое: публикует событие `payment.received`

3. **Обработка платежа:**
   - Payment Processing Service получает событие
   - Валидирует и сохраняет платеж в БД
   - Конвертирует валюту через Exchange Rate Service
   - Публикует событие `payment.processed`

4. **Обновление CRM:**
   - CRM Status Service получает событие `payment.processed`
   - Рассчитывает целевой статус
   - Обновляет статус в Pipedrive
   - Публикует событие `crm.status.updated`

5. **Уведомление:**
   - Notification Service получает событие `crm.status.updated`
   - Duplicate Prevention Service проверяет что уведомление такого типа не отправлялось получателю в пределах TTL (24 часа)
   - Если уведомление уже отправлялось: пропускает отправку, логирует попытку дубликата
   - Если уведомление новое: отправляет уведомление клиенту об успешной оплате, логирует отправку с временной меткой

## Защита от ошибок и валидация данных

### Принципы обработки ошибок

1. **Неблокирующая обработка**: Ошибки в одном процессе не блокируют другие операции
2. **Сохранение состояния**: При ошибке состояние процесса сохраняется в БД для возможности перезапуска
3. **Информативные сообщения**: Менеджеры получают понятные сообщения об ошибках с указанием что нужно исправить
4. **Возможность перезапуска**: После исправления данных менеджер может перезапустить процесс без потери контекста

### Валидация данных

**Обязательные поля для создания сессии:**
- deal_id (ID сделки в CRM)
- email клиента (валидный формат)
- сумма (положительное число, не превышает сумму сделки)
- валюта (поддерживаемая валюта)
- тип платежа (deposit/rest/single)

**Проверки перед созданием сессии:**
1. Валидация формата данных (Validation Service)
2. Проверка существования сделки в CRM
3. Проверка дубликатов сессий (Duplicate Prevention Service)
4. Проверка бизнес-правил (сумма, валюта, график платежей)

**Обработка ошибок валидации:**
- Сохранение попытки создания с информацией об ошибках в таблице `validation_errors`
- Сохранение состояния процесса в таблице `process_states`
- Отправка уведомления менеджеру со списком ошибок
- Возможность исправления данных и перезапуска процесса

### Защита от дублирования

**Дубликаты сессий:**
- Проверка перед созданием: наличие активной сессии того же типа для сделки
- Уникальный ключ: deal_id + payment_type + status = 'open'
- При обнаружении дубликата: возврат информации о существующей сессии, логирование попытки

**Дубликаты уведомлений:**
- Проверка истории отправленных уведомлений по типу и получателю
- TTL период: 24 часа (настраивается)
- Идемпотентный ключ: recipient + type + timestamp (округленный до часа)
- При обнаружении дубликата: пропуск отправки, логирование попытки

**Дубликаты событий:**
- Проверка по event ID от Stripe
- Хранение обработанных event ID в таблице `event_logs`
- При обнаружении дубликата: игнорирование события, логирование попытки

### Полная история данных

**Хранение информации:**
- Все созданные сессии (активные, истекшие, отмененные) в таблице `stripe_sessions`
- Все платежи в таблице `stripe_payments`
- История изменений статусов и сумм в таблице `payment_status_history`
- Все события обработки в таблице `event_logs`
- Агрегированная история клиента в таблице `customer_payment_history`

**Доступ к истории:**
- API endpoint для получения истории платежей клиента
- API endpoint для получения истории сессий сделки
- API endpoint для получения истории изменений платежа
- Время ответа: менее 2 секунд для полной истории клиента

## Преимущества микросервисной архитектуры

1. **Масштабируемость**: Каждый сервис может масштабироваться независимо
2. **Надежность**: Изоляция ошибок - сбой одного сервиса не влияет на другие
3. **Разработка**: Команды могут работать над разными сервисами параллельно
4. **Технологии**: Возможность использовать разные технологии для разных сервисов
5. **Развертывание**: Независимое развертывание сервисов
6. **Тестирование**: Упрощенное тестирование изолированных компонентов
7. **Отказоустойчивость**: Ошибки в одном процессе не блокируют другие операции
8. **Валидация**: Централизованная валидация данных с понятными сообщениями об ошибках
9. **Защита от дублирования**: Автоматическое предотвращение дубликатов сессий и уведомлений
10. **Полная история**: Сохранение всех данных для аудита и анализа

## Риски и митигация

1. **Сложность**: Увеличение сложности системы
   - Митигация: Хорошая документация, стандартизация подходов

2. **Сетевая задержка**: Коммуникация между сервисами
   - Митигация: Использование асинхронной коммуникации, кэширование

3. **Консистентность данных**: Распределенные транзакции
   - Митигация: Eventual consistency, компенсирующие транзакции

4. **Мониторинг**: Отслеживание множества сервисов
   - Митигация: Централизованное логирование, метрики, трейсинг

## План миграции

**Подход**: Постепенная миграция (Strangler Fig Pattern) - начинаем с микросервисов вокруг монолита

### Рекомендуемый порядок миграции:

1. **Фаза 0**: Подготовка инфраструктуры (таблицы БД, базовые классы)
2. **Фаза 1**: Выделение Validation Service (быстрый результат, низкий риск)
3. **Фаза 2**: Выделение Duplicate Prevention Service (улучшает надежность)
4. **Фаза 3**: Выделение Notification Service (изолирует некритичные операции)
5. **Фаза 4**: Выделение CRM Status Service
6. **Фаза 5**: Выделение Payment Processing Service
7. **Фаза 6**: Внедрение Event Bus (после стабилизации сервисов)
8. **Фаза 7**: Выделение Webhook Processing Service
9. **Фаза 8**: Выделение Session Services (Payment Session, Monitor, Recreation)

**Принцип**: Каждый микросервис сначала вызывается из монолита, затем постепенно переходим на Event Bus

**Подробности**: См. [gradual-migration-strategy.md](./gradual-migration-strategy.md)
