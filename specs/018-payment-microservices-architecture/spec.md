# Feature Specification: Payment Microservices Architecture

**Feature Branch**: `018-payment-microservices-architecture`  
**Created**: 2026-02-02  
**Status**: Draft  
**Input**: User description: "изучи документацию по платежам через страйп и подкажи правильную архитектуру для нашего кейса. Самый главный вопрос как сделать понятную логику через микро сервисы. У нас есть страцп палатежи для физ лиц и юрлиц. У нас есть гибридные платежи часть страйпом часть наличнвми. У нас может менять сумма в процессе и. адо поддерживать изменения У нас есть проверка платежей. Проверка экспар сессий. Напоминание об олпате. Смена статусов в CRM . Отправка уведомлений. Нужна граматная архитектура."

**Research**: [research.md](./research.md) - Исследование текущей структуры базы данных для Stripe платежей  
**Architecture Comparison**: [current-vs-proposed-architecture.md](./current-vs-proposed-architecture.md) - Сравнение текущей монолитной архитектуры с предложенной микросервисной  
**Migration Strategy**: [gradual-migration-strategy.md](./gradual-migration-strategy.md) - Стратегия постепенной миграции (Strangler Fig Pattern)

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Обработка Stripe платежей через микросервисы (Priority: P1)

Менеджер создает Stripe Checkout Session для сделки через CRM. Система обрабатывает платеж через специализированные микросервисы: создание сессии, обработка webhook событий, валидация платежа, обновление статусов в CRM и отправка уведомлений. Каждый микросервис отвечает за свою область ответственности, что обеспечивает надежность и масштабируемость.

**Why this priority**: Без надежной обработки платежей невозможно функционирование бизнеса. Микросервисная архитектура обеспечивает изоляцию ошибок и возможность независимого масштабирования компонентов.

**Independent Test**: Создать тестовую Stripe сессию для сделки, оплатить её тестовой картой, проверить что все микросервисы обработали событие корректно: платеж сохранен, статус в CRM обновлен, уведомление отправлено.

**Acceptance Scenarios**:

1. **Given** менеджер создает Stripe Checkout Session для сделки с физ лицом, **When** клиент оплачивает сессию, **Then** платеж обрабатывается через микросервисы: Session Service создает сессию, Webhook Service обрабатывает событие, Payment Service валидирует и сохраняет платеж, CRM Service обновляет статус, Notification Service отправляет уведомление.
2. **Given** менеджер создает Stripe Checkout Session для сделки с юр лицом (B2B), **When** клиент оплачивает сессию, **Then** система обрабатывает платеж с учетом B2B логики: добавляются реквизиты организации, формируется инвойс с VAT, обновляется статус в CRM.

---

### User Story 2 - Гибридные платежи (Stripe + наличные) (Priority: P1)

Менеджер создает гибридный платеж: часть суммы через Stripe, часть наличными. Система отслеживает обе части платежа, агрегирует их для отображения в CRM и отчетах, но разделяет для бухгалтерской отчетности (только безналичная часть попадает в VAT отчеты).

**Why this priority**: Гибридные платежи - частый бизнес-кейс. Система должна корректно обрабатывать комбинацию безналичных и наличных платежей с правильной агрегацией и разделением для отчетности.

**Independent Test**: Создать сделку с гибридным платежом (Stripe депозит + наличный остаток), оплатить Stripe часть, подтвердить наличную часть, проверить что в CRM отображается полная сумма оплаты, но в VAT отчеты попадает только Stripe часть.

**Acceptance Scenarios**:

1. **Given** менеджер создает Stripe сессию на депозит и указывает ожидаемую наличную сумму, **When** клиент оплачивает Stripe депозит и затем привозит наличные, **Then** система отслеживает обе части: Stripe платеж обрабатывается автоматически через webhook, наличная часть подтверждается вручную, обе части агрегируются для отображения прогресса оплаты в CRM.
2. **Given** гибридный платеж с изменением суммы в процессе (клиент решил увеличить наличную часть), **When** менеджер обновляет ожидаемую наличную сумму, **Then** система пересчитывает агрегаты и обновляет отображение в CRM без потери истории изменений.

---

### User Story 3 - Изменение сумм в процессе обработки (Priority: P2)

В процессе обработки платежа сумма может измениться (скидка, корректировка, частичный возврат). Система должна поддерживать изменения сумм с сохранением истории, пересчетом агрегатов и обновлением связанных сущностей (CRM статусы, отчеты, уведомления).

**Why this priority**: Бизнес-требования часто меняются, суммы корректируются. Система должна гибко обрабатывать изменения без потери данных и консистентности.

**Independent Test**: Создать платеж на сумму 1000, затем изменить сумму на 800 (скидка), проверить что история изменений сохранена, агрегаты пересчитаны, CRM статусы обновлены корректно.

**Acceptance Scenarios**:

1. **Given** создана Stripe сессия на сумму 1000 EUR, **When** менеджер применяет скидку и обновляет сумму до 800 EUR, **Then** система обновляет сессию в Stripe (если еще не оплачена) или создает корректировочный платеж, пересчитывает агрегаты в БД, обновляет отображение в CRM.
2. **Given** оплаченный платеж на сумму 1000, **When** происходит частичный возврат на 200, **Then** система создает запись о возврате, пересчитывает агрегаты (вычитает возврат), обновляет статус в CRM если необходимо, отправляет уведомление о возврате.

---

### User Story 4 - Проверка платежей и expired сессий (Priority: P2)

Система автоматически проверяет статусы платежей и истекшие Stripe сессии. Для истекших сессий система пересоздает их и отправляет напоминания клиентам. Проверка платежей обеспечивает консистентность данных между Stripe и внутренней БД.

**Why this priority**: Истекшие сессии теряют клиентов, неконсистентные данные создают проблемы в отчетности. Автоматическая проверка и восстановление критичны для бизнеса.

**Independent Test**: Создать Stripe сессию, дождаться её истечения (или симулировать), запустить проверку, проверить что система обнаружила истекшую сессию, пересоздала её и отправила напоминание клиенту.

**Acceptance Scenarios**:

1. **Given** Stripe сессия истекла без оплаты, **When** система выполняет проверку истекших сессий (каждые 4 часа), **Then** система обнаруживает истекшую сессию, проверяет что нет активной сессии того же типа для сделки, пересоздает сессию, обновляет запись в БД, отправляет уведомление клиенту со ссылкой на оплату.
2. **Given** платеж обработан через webhook, **When** система выполняет проверку консистентности платежей, **Then** система сравнивает статусы в Stripe и БД, обнаруживает расхождения, синхронизирует данные, логирует расхождения для аудита.

---

### User Story 5 - Напоминания об оплате (Priority: P2)

Система автоматически отслеживает сроки платежей и отправляет напоминания клиентам о предстоящих или просроченных платежах. Напоминания учитывают график платежей (50/50 или 100%), статус предыдущих платежей и историю отправленных уведомлений.

**Why this priority**: Напоминания увеличивают конверсию платежей и снижают просрочку. Автоматизация экономит время менеджеров и обеспечивает своевременность уведомлений.

**Independent Test**: Создать сделку с графиком 50/50, оплатить первый платеж, дождаться даты второго платежа, проверить что система автоматически отправила напоминание о втором платеже.

**Acceptance Scenarios**:

1. **Given** сделка с графиком 50/50, первый платеж оплачен, **When** наступает дата второго платежа, **Then** система проверяет что второй платеж еще не оплачен, создает Stripe сессию для второго платежа (если еще не создана), отправляет напоминание клиенту со ссылкой на оплату, логирует отправку для предотвращения дублирования.
2. **Given** платеж просрочен на 1-3 дня, **When** система выполняет проверку просроченных платежей, **Then** система отправляет напоминание о просрочке с актуальной суммой и ссылкой на оплату, обновляет статус в CRM для видимости менеджерам.

---

### User Story 6 - Автоматическая смена статусов в CRM (Priority: P1)

Система автоматически обновляет статусы сделок в CRM на основе платежей. Статусы меняются по правилам: First Payment → Second Payment → Camp Waiter в зависимости от графика платежей и факта оплаты.

**Why this priority**: Автоматизация статусов исключает человеческий фактор, обеспечивает консистентность данных и экономит время менеджеров. Это критично для корректной работы CRM.

**Independent Test**: Создать сделку со статусом First Payment, оплатить первый платеж (график 50/50), проверить что статус остался First Payment, оплатить второй платеж, проверить что статус изменился на Camp Waiter.

**Acceptance Scenarios**:

1. **Given** сделка со статусом First Payment, график 50/50, **When** оплачивается первый платеж (deposit), **Then** система проверяет график платежей, определяет что ожидается второй платеж, оставляет статус First Payment или меняет на Second Payment в зависимости от бизнес-правил.
2. **Given** сделка со статусом Second Payment, график 50/50, **When** оплачивается второй платеж (rest), **Then** система проверяет что оба платежа оплачены, меняет статус на Camp Waiter, отправляет уведомление о завершении оплаты.

---

### User Story 7 - Отправка уведомлений через микросервисы (Priority: P2)

Система отправляет уведомления клиентам и менеджерам через специализированный микросервис уведомлений. Уведомления отправляются при различных событиях: создание платежной сессии, успешная оплата, истечение сессии, напоминания о платежах.

**Why this priority**: Уведомления улучшают коммуникацию с клиентами и информируют менеджеров о важных событиях. Централизованный сервис уведомлений обеспечивает единообразие и управляемость.

**Independent Test**: Создать платежную сессию, проверить что отправлено уведомление о создании сессии, оплатить платеж, проверить что отправлено уведомление об успешной оплате.

**Acceptance Scenarios**:

1. **Given** создана Stripe сессия для сделки, **When** система обрабатывает создание сессии, **Then** Notification Service отправляет уведомление клиенту со ссылкой на оплату через выбранный канал (email, Telegram через SendPulse), логирует отправку.
2. **Given** платеж успешно обработан, **When** система обновляет статус в CRM, **Then** Notification Service отправляет уведомление клиенту об успешной оплате, отправляет уведомление менеджеру о получении платежа (если настроено).

---

### User Story 8 - Защита от ошибок и валидация данных (Priority: P1)

Менеджер создает платежную сессию с неполными или некорректными данными. Система валидирует данные **перед созданием Stripe Checkout Session** (сессии оплаты), не блокирует весь процесс при ошибках, сохраняет информацию об ошибках для последующего исправления и уведомляет менеджера о том, какие данные необходимо исправить.

**ВАЖНО - Когда срабатывает валидация**:
- ✅ **Валидация срабатывает ПРИ СОЗДАНИИ СЕССИИ** (Stripe Checkout Session)
  - Когда менеджер создает сессию через API или интерфейс
  - Когда система автоматически создает сессию (cron, webhook триггеры)
  - **При обновлении сделки через webhook**, если это триггер для создания новой сессии (например, изменение `invoice_type`)
  - Перед вызовом Stripe API для создания Checkout Session
- ⚠️ **Валидация при обновлении сделки**:
  - Если обновление триггерит создание новой сессии → валидация нужна (та же что при создании)
  - Если сессия уже создана и оплачена → валидация не нужна
  - Если сессия создана, но не оплачена → валидация не нужна при обновлении (но может быть полезен отдельный сервис мониторинга для обнаружения расхождений)
- ❌ **Валидация НЕ срабатывает при самом платеже**
  - Платеж происходит позже, когда клиент переходит по ссылке и оплачивает сессию
  - К моменту оплаты сессия уже создана и валидирована

**Подробнее**: См. [validation-timing.md](./validation-timing.md) и [deal-update-validation.md](./deal-update-validation.md)

**Интеграция с Deal Diagnostics Service**:
- Ошибки и предупреждения валидации отображаются в сервисе диагностики сделок
- Менеджеры видят проблемы валидации в разделе `issues` с severity и рекомендациями
- Доступно действие "Перезапустить создание сессии" после исправления ошибок
- Подробнее: [diagnostics-integration.md](./diagnostics-integration.md)

**Why this priority**: Ошибки в данных не должны блокировать работу системы. Менеджеры должны получать понятные сообщения об ошибках и иметь возможность исправить данные и перезапустить процесс без потери данных.

**Принципы валидации для создания Stripe Checkout Session**:

Для успешного создания Stripe Checkout Session система должна проверить наличие следующих обязательных полей:

1. **Продукт (Product)** - обязателен
   - В сделке должен быть хотя бы один продукт
   - Продукт должен иметь корректный ID и название
   - Продукт должен быть связан с ProductLink (если используется)

2. **Цена (Price/Amount)** - обязательна
   - Сумма платежа должна быть больше нуля
   - Сумма не должна превышать сумму сделки (если указана)
   - Сумма должна быть числом (не строкой, не null)
   - Для графиков 50/50 сумма депозита и остатка должна соответствовать общей сумме сделки

3. **Адрес (Address)** - обязателен
   - Адрес клиента должен быть указан (для B2C - адрес Person, для B2B - адрес Organization)
   - Адрес должен содержать минимум страну (country)
   - Для платежей с VAT (Польша) адрес должен быть полным и валидированным
   - Адрес используется для определения применения VAT и создания инвойсов

4. **Имя клиента (Customer Name)** - обязательно
   - Для B2C: имя Person должно быть указано
   - Для B2B: название компании (Organization name) должно быть указано
   - Имя используется для создания Stripe Customer и документов

5. **B2B специфичные поля** (обязательны только для B2B сделок):
   - **Organization в CRM** - обязательна для B2B
     - Сделка должна быть связана с Organization в Pipedrive (`organization_id` должен быть заполнен и не равен 0/null)
     - Organization должна существовать в CRM и быть доступна через API
   - **Business ID (Tax ID/NIP)** - обязателен для B2B
     - Должен быть заполнен `company_tax_id` (NIP для Польши, VAT номер для других стран)
     - Может быть в поле `nip`, `tax_id`, `vat_number` или в кастомных полях Organization
     - Используется для создания инвойсов и VAT отчетов
     - Без Business ID нельзя создать корректный инвойс для B2B клиента

**Дополнительные обязательные поля**:
- **Email клиента** - обязателен для отправки уведомлений и создания Stripe Customer
  - Для B2C: email из Person
  - Для B2B: email из Organization или Person (если Organization не имеет email)
- **Notification Channel ID** - рекомендуется для отправки уведомлений клиенту (НЕ блокирует создание сессии)
  - Рекомендуется заполнить хотя бы один из способов отправки уведомлений:
    - **SendPulse ID** - ID клиента в SendPulse (для отправки через Telegram/Instagram через SendPulse)
      - Хранится в кастомном поле Person: `ff1aa263ac9f0e54e2ae7bec6d7215d027bf1b8c`
      - Используется для отправки уведомлений о создании сессии, оплате, напоминаниях
    - **Telegram Chat ID** - Chat ID в Telegram (альтернативный способ отправки уведомлений)
      - Может храниться в кастомном поле Person или Deal
  - **ВАЖНО**: Отсутствие Notification Channel ID НЕ блокирует создание сессии
    - Система использует email как резервный канал уведомлений
    - Email обязателен и всегда используется для отправки уведомлений
  - **Но**: При отсутствии SendPulse ID и Telegram Chat ID система должна:
    - Сохранить предупреждение (warning) в БД, а не ошибку (error)
    - Уведомить менеджера о том, что уведомления будут отправляться только по email
    - Создать задачу в CRM для менеджера с рекомендацией заполнить SendPulse ID или Telegram Chat ID
    - Позволить создать сессию успешно (сессия создается, но менеджер информирован)
- **Валюта (Currency)** - обязательна, должна быть валидным ISO кодом (PLN, EUR, USD, GBP)
- **Deal ID** - обязателен для связи платежа со сделкой
- **Payment Type** - должен быть валидным (`deposit`, `rest`, `single`, `addon`)

**Independent Test**: Попытаться создать сессию без обязательных полей (продукт, цена, адрес, имя), проверить что система сохранила ошибки валидации в БД с указанием всех недостающих полей, не создала сессию, но не упала с ошибкой. Исправить данные, перезапустить процесс, проверить что сессия создана успешно.

**Acceptance Scenarios**:

1. **Given** менеджер пытается создать Stripe сессию без продукта в сделке, **When** система выполняет валидацию, **Then** система обнаруживает отсутствие продукта, сохраняет ошибку валидации в БД с указанием недостающего поля (`missing_fields: ["product"]`), не создает сессию, но не падает с ошибкой, позволяет перезапустить процесс после добавления продукта в сделку.

2. **Given** менеджер пытается создать сессию без указания цены (или с нулевой/отрицательной ценой), **When** система выполняет валидацию, **Then** система обнаруживает некорректную цену, сохраняет ошибку валидации с указанием проблемы (`invalid_fields: ["amount"]`, `field_errors: { "amount": "Amount must be positive" }`), не создает сессию, уведомляет менеджера о необходимости исправления суммы.

3. **Given** менеджер пытается создать сессию без адреса клиента, **When** система выполняет валидацию, **Then** система обнаруживает отсутствие адреса, сохраняет ошибку валидации (`missing_fields: ["address"]`), не создает сессию, создает задачу в CRM для менеджера с указанием необходимости добавить адрес, позволяет перезапустить процесс после добавления адреса.

4. **Given** менеджер пытается создать сессию без имени клиента (Person name или Organization name), **When** система выполняет валидацию, **Then** система обнаруживает отсутствие имени, сохраняет ошибку валидации (`missing_fields: ["customer_name"]`), не создает сессию, позволяет перезапустить процесс после добавления имени.

5. **Given** менеджер пытается создать сессию для B2B сделки без Organization в CRM (organization_id пустой или равен 0), **When** система выполняет валидацию, **Then** система определяет что это B2B сделка (по invoice_type или другим признакам), обнаруживает отсутствие Organization, сохраняет ошибку валидации (`missing_fields: ["organization"]`, `field_errors: { "organization": "Organization is required for B2B deals" }`), не создает сессию, создает задачу в CRM для менеджера с указанием необходимости создать Organization и связать её со сделкой, позволяет перезапустить процесс после создания Organization.

6. **Given** менеджер пытается создать сессию для B2B сделки без Business ID (NIP/VAT номер), **When** система выполняет валидацию, **Then** система определяет что это B2B сделка, проверяет наличие Business ID в Organization (поля `nip`, `tax_id`, `vat_number` или кастомные поля), обнаруживает отсутствие Business ID, сохраняет ошибку валидации (`missing_fields: ["company_tax_id"]`, `field_errors: { "company_tax_id": "Business ID (NIP/VAT) is required for B2B deals" }`), не создает сессию, создает задачу в CRM для менеджера с указанием необходимости заполнить NIP/VAT номер в Organization, позволяет перезапустить процесс после добавления Business ID.

7. **Given** процесс создания сессии остановился из-за нескольких ошибок валидации (отсутствуют продукт, адрес и имя), **When** менеджер исправляет все данные и перезапускает процесс, **Then** система использует сохраненное состояние процесса из БД, повторяет валидацию с новыми данными, проверяет все обязательные поля, создает сессию успешно, помечает процесс как завершенный, очищает ошибки валидации.

8. **Given** менеджер пытается создать сессию без Notification Channel ID (нет SendPulse ID и Telegram Chat ID), **When** система выполняет валидацию, **Then** система обнаруживает отсутствие SendPulse ID и Telegram Chat ID, сохраняет предупреждение (warning) в БД вместо ошибки (`warnings: [{ field: "notification_channel_id", message: "SendPulse ID or Telegram Chat ID not found - notifications will be sent via email only" }]`), создает сессию успешно (так как email есть и используется как резервный канал), создает задачу в CRM для менеджера с рекомендацией заполнить SendPulse ID или Telegram Chat ID для улучшения коммуникации с клиентом, отправляет уведомление клиенту по email (резервный канал работает).

9. **Given** процесс создания сессии прервался из-за временной недоступности внешнего сервиса (Stripe API), **When** система обнаруживает ошибку, **Then** система сохраняет состояние процесса в БД, не блокирует другие операции, автоматически повторяет попытку с экспоненциальной задержкой, уведомляет менеджера о задержке, позволяет менеджеру вручную перезапустить процесс после исправления проблемы.

---

### User Story 9 - Полная история платежей и сессий клиента (Priority: P1)

Система хранит в базе данных полную информацию о всех платежах клиента и всех созданных сессиях. Менеджер может просмотреть полную историю платежей клиента, включая созданные сессии, оплаченные платежи, возвраты, изменения сумм и статусов.

**Why this priority**: Полная история необходима для аудита, анализа, решения спорных ситуаций и понимания полной картины взаимодействия с клиентом. Это критично для финансовой отчетности и работы с клиентами.

**Independent Test**: Создать несколько сессий для одного клиента, оплатить некоторые из них, выполнить возврат, изменить сумму, проверить что в БД сохранена полная история всех операций с возможностью просмотра через API или интерфейс.

**Acceptance Scenarios**:

1. **Given** клиент имеет несколько сделок с платежами, **When** менеджер запрашивает историю платежей клиента, **Then** система возвращает полный список всех созданных сессий (включая истекшие и отмененные), всех оплаченных платежей, всех возвратов, всех изменений сумм с временными метками и причинами изменений, агрегированную информацию о суммах по валютам.
2. **Given** создана сессия для сделки, **When** система обрабатывает различные события (создание, оплата, возврат, изменение суммы), **Then** каждое событие сохраняется в БД с полной информацией: тип события, временная метка, данные события, статус обработки, связь с сессией и платежом, информация о пользователе или системе, которая инициировала событие.

---

### User Story 10 - Защита от дублирования сессий и уведомлений (Priority: P1)

Система предотвращает создание дублирующихся сессий для одной сделки и отправку дублирующихся уведомлений клиентам. При попытке создать дубликат система обнаруживает существующую активную сессию и либо использует её, либо отклоняет создание с информацией о существующей сессии.

**Why this priority**: Дублирование сессий создает путаницу для клиентов и менеджеров, дублирование уведомлений раздражает клиентов и снижает доверие. Защита от дублирования критична для качества сервиса.

**Independent Test**: Создать сессию для сделки, попытаться создать вторую сессию того же типа для той же сделки, проверить что система обнаруживает дубликат и не создает новую сессию, проверить что уведомление отправляется только один раз даже при повторных событиях.

**Acceptance Scenarios**:

1. **Given** существует активная Stripe сессия типа "deposit" для сделки, **When** система пытается создать новую сессию типа "deposit" для той же сделки, **Then** система проверяет наличие активных сессий того же типа, обнаруживает дубликат, не создает новую сессию, возвращает информацию о существующей сессии (ID, URL, статус), логирует попытку создания дубликата для аудита.
2. **Given** система обрабатывает событие оплаты, которое уже было обработано ранее, **When** система получает дублирующееся webhook событие от Stripe, **Then** система проверяет по event ID что событие уже обработано, игнорирует дубликат, логирует попытку повторной обработки, не отправляет повторное уведомление клиенту.
3. **Given** система должна отправить напоминание клиенту о платеже, **When** система проверяет историю отправленных уведомлений, **Then** система проверяет что уведомление такого типа не отправлялось в течение TTL периода (например, 24 часа), если отправлялось - пропускает отправку, если не отправлялось - отправляет уведомление и логирует отправку с временной меткой и типом для предотвращения будущих дубликатов.

---

### Edge Cases

- Что происходит, если микросервис недоступен во время обработки платежа? Система должна использовать паттерн retry с экспоненциальной задержкой, сохранять события в очередь для повторной обработки, логировать ошибки для мониторинга.
- Как обрабатываются дублирующиеся webhook события от Stripe? Система должна быть идемпотентной: проверять что событие уже обработано по event ID, игнорировать дубликаты, логировать попытки повторной обработки.
- Что делать, если сумма платежа изменилась после создания сессии, но до оплаты? Система должна обновить сессию в Stripe (если возможно) или создать новую сессию с правильной суммой, отменить старую сессию, обновить запись в БД.
- Как обрабатываются гибридные платежи, если наличная часть не подтверждена в срок? Система должна отправлять напоминания менеджерам о неподтвержденных наличных платежах, показывать их в дашборде как требующие внимания.
- Что происходит при расхождении данных между Stripe и БД? Система должна иметь механизм синхронизации: периодически проверять консистентность, автоматически исправлять расхождения, логировать все исправления для аудита.
- Что происходит, если менеджер ввел некорректные данные при создании сессии? Система должна валидировать данные до создания сессии, сохранять информацию об ошибках в БД, уведомлять менеджера о проблемах, позволять исправить данные и перезапустить процесс без блокировки других операций.
- Как система предотвращает создание дублирующихся сессий? Система должна проверять наличие активных сессий того же типа для сделки перед созданием новой, использовать уникальные ключи (deal_id + payment_type + status), логировать все попытки создания для аудита.
- Как система предотвращает отправку дублирующихся уведомлений? Система должна проверять историю отправленных уведомлений по типу и получателю в пределах TTL периода, использовать идемпотентные ключи для уведомлений, логировать все отправки для предотвращения дубликатов.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST быть организована как набор независимых микросервисов, каждый из которых отвечает за свою область ответственности (создание сессий, обработка webhook, валидация платежей, обновление CRM, отправка уведомлений).
- **FR-002**: Система MUST поддерживать обработку Stripe платежей для физических лиц (B2C) и юридических лиц (B2B) с учетом различий в логике (реквизиты организации, VAT для B2B).
- **FR-003**: Система MUST поддерживать гибридные платежи (комбинация Stripe и наличных) с корректной агрегацией для CRM и разделением для бухгалтерской отчетности.
- **FR-004**: Система MUST поддерживать изменение сумм платежей в процессе обработки с сохранением истории изменений и пересчетом всех зависимых агрегатов.
- **FR-005**: Система MUST автоматически проверять статусы платежей и консистентность данных между Stripe и внутренней БД с периодичностью не реже чем каждые 4 часа.
- **FR-006**: Система MUST автоматически обнаруживать истекшие Stripe сессии и пересоздавать их с отправкой уведомлений клиентам, предотвращая дублирование активных сессий.
- **FR-007**: Система MUST автоматически отправлять напоминания о предстоящих и просроченных платежах с учетом графика платежей (50/50 или 100%) и истории отправленных уведомлений.
- **FR-008**: Система MUST автоматически обновлять статусы сделок в CRM на основе платежей по правилам: First Payment → Second Payment → Camp Waiter в зависимости от графика и факта оплаты.
- **FR-009**: Система MUST отправлять уведомления клиентам и менеджерам через централизованный сервис уведомлений при различных событиях (создание сессии, оплата, истечение сессии, напоминания).
- **FR-010**: Система MUST обеспечивать идемпотентность обработки событий: повторная обработка одного и того же события не должна создавать дубликаты данных.
- **FR-011**: Система MUST логировать все операции микросервисов для аудита, мониторинга и диагностики проблем.
- **FR-012**: Система MUST обрабатывать ошибки и недоступность микросервисов: использовать retry механизмы, сохранять события в очередь для повторной обработки, не терять данные при сбоях.
- **FR-013**: Система MUST обеспечивать консистентность данных между микросервисами: использовать транзакции или паттерны eventual consistency где необходимо.
- **FR-014**: Система MUST поддерживать горизонтальное масштабирование микросервисов для обработки пиковых нагрузок без деградации производительности.
- **FR-015**: Система MUST валидировать все входные данные перед созданием платежных сессий и не блокировать весь процесс при обнаружении ошибок: сохранять информацию об ошибках в БД, уведомлять менеджера о недостающих или некорректных данных, позволять исправить данные и перезапустить процесс.
- **FR-016**: Система MUST хранить в базе данных полную информацию о всех платежах клиента и всех созданных сессиях, включая: все созданные сессии (активные, истекшие, отмененные), все оплаченные платежи, все возвраты, все изменения сумм с историей, все статусы и их изменения, все события обработки с временными метками.
- **FR-017**: Система MUST предотвращать создание дублирующихся сессий: проверять наличие активных сессий того же типа для сделки перед созданием новой, использовать уникальные ключи (deal_id + payment_type + status), возвращать информацию о существующей сессии при попытке создания дубликата.
- **FR-018**: Система MUST предотвращать отправку дублирующихся уведомлений клиентам: проверять историю отправленных уведомлений по типу и получателю в пределах TTL периода (по умолчанию 24 часа), использовать идемпотентные ключи для уведомлений, логировать все отправки для предотвращения дубликатов.
- **FR-019**: Система MUST обеспечивать возможность перезапуска процессов после исправления ошибок: сохранять состояние неудачных операций в БД, позволять менеджеру исправить данные и перезапустить процесс, не терять контекст и историю операций при перезапуске.

### Key Entities *(include if feature involves data)*

- **Payment Session**: Представляет Stripe Checkout Session с метаданными (deal_id, payment_type, payment_schedule, сумма, валюта). Создается Session Service, обрабатывается Webhook Service.
- **Payment**: Представляет платеж в системе (Stripe или наличный). Содержит информацию о сумме, валюте, статусе, связи с сессией и сделкой. Обрабатывается Payment Service.
- **Hybrid Payment**: Представляет гибридный платеж, состоящий из безналичной (Stripe) и наличной частей. Агрегирует обе части для отображения, но разделяет для отчетности.
- **Payment Status History**: История изменений статусов платежа и сумм. Используется для аудита и отслеживания изменений.
- **Expired Session Task**: Задача на пересоздание истекшей сессии. Создается Session Monitor Service, обрабатывается Session Recreation Service.
- **Reminder Task**: Задача на отправку напоминания о платеже. Создается Reminder Scheduler Service, обрабатывается Notification Service.
- **CRM Status Update**: Обновление статуса сделки в CRM. Создается CRM Service на основе правил автоматизации статусов.
- **Notification**: Уведомление клиенту или менеджеру. Создается Notification Service, отправляется через различные каналы (email, Telegram).
- **Validation Error**: Информация об ошибке валидации данных при создании сессии. Содержит тип ошибки, описание проблемы, список недостающих или некорректных полей, временную метку, связь с попыткой создания сессии.
- **Process State**: Состояние процесса создания сессии или обработки платежа. Сохраняется при ошибках для возможности перезапуска, содержит все необходимые данные для восстановления процесса.
- **Session Duplicate Check**: Проверка дубликатов сессий. Хранит информацию о проверках, существующих активных сессиях, предотвращает создание дубликатов.
- **Notification Log**: Лог отправленных уведомлений. Содержит тип уведомления, получателя, временную метку, используется для предотвращения дубликатов в пределах TTL периода.
- **Customer Payment History**: Полная история всех платежей и сессий клиента. Агрегирует информацию из всех связанных сущностей для предоставления полной картины взаимодействия с клиентом.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Система обрабатывает 99% Stripe платежей без ручного вмешательства в течение 5 минут после получения webhook события.
- **SC-002**: Микросервисы обрабатывают пиковые нагрузки (до 100 одновременных платежей) без деградации производительности (время обработки платежа не превышает 10 секунд от webhook до обновления CRM).
- **SC-003**: Система автоматически обнаруживает и пересоздает 95% истекших сессий в течение 4 часов после истечения с отправкой уведомлений клиентам.
- **SC-004**: Автоматические напоминания о платежах отправляются в срок (не позднее дня наступления даты платежа) для 98% сделок с графиком платежей.
- **SC-005**: Статусы в CRM обновляются автоматически для 99% оплаченных платежей без необходимости ручного вмешательства менеджеров.
- **SC-006**: Уведомления доставляются клиентам в течение 1 минуты после события (создание сессии, оплата) для 95% случаев.
- **SC-007**: Система обеспечивает консистентность данных между Stripe и БД: расхождения обнаруживаются и исправляются автоматически в течение 1 часа для 99% случаев.
- **SC-008**: Гибридные платежи корректно обрабатываются: безналичная часть попадает в бухгалтерские отчеты, наличная часть исключается из VAT отчетов, но учитывается в управленческих отчетах для 100% случаев.
- **SC-009**: Система валидирует данные и обрабатывает ошибки без блокировки процесса: 95% ошибок валидации обрабатываются с сохранением состояния и уведомлением менеджера, менеджеры могут исправить данные и перезапустить процесс в течение 5 минут после получения уведомления об ошибке.
- **SC-010**: База данных содержит полную информацию о всех платежах и сессиях: 100% созданных сессий сохраняются в БД, 100% событий обработки логируются с временными метками, полная история платежей клиента доступна для просмотра через API менее чем за 2 секунды.
- **SC-011**: Система предотвращает дублирование сессий и уведомлений: 100% попыток создания дублирующихся сессий обнаруживаются и блокируются, 100% дублирующихся уведомлений предотвращаются в пределах TTL периода (24 часа), все попытки дублирования логируются для аудита.
