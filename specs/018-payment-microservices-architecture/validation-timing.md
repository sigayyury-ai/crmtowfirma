# Время срабатывания валидации

**Дата**: 2026-02-02  
**Цель**: Уточнить, когда именно срабатывает валидация в процессе обработки платежей

## Жизненный цикл Stripe платежа

### Этап 1: Создание Stripe Checkout Session (ВАЛИДАЦИЯ ЗДЕСЬ)

```
Менеджер/Система → Создание сессии → ВАЛИДАЦИЯ → Stripe API → Checkout Session создана
```

**Когда происходит**:
- Менеджер создает сессию через API: `POST /api/pipedrive/deals/:id/diagnostics/actions/create-stripe-session`
- Система автоматически создает сессию (cron job, webhook триггер)
- Скрипт создает сессию: `node scripts/create-session-for-deal.js <dealId>`

**Что валидируется**:
- ✅ Продукт в сделке
- ✅ Цена (amount > 0)
- ✅ Адрес клиента
- ✅ Имя клиента
- ✅ Email клиента
- ✅ Канал уведомлений (SendPulse ID или Telegram Chat ID)
- ✅ B2B поля (если B2B): Organization, Business ID
- ✅ Валюта
- ✅ Статус сделки

**Результат валидации**:
- ✅ Если валидация прошла → Stripe Checkout Session создается
- ❌ Если валидация не прошла → Сессия НЕ создается, ошибки сохраняются в БД

---

### Этап 2: Клиент получает ссылку на оплату

```
Checkout Session создана → Уведомление клиенту → Клиент получает ссылку
```

**Когда происходит**:
- После успешного создания сессии
- Система отправляет уведомление клиенту через SendPulse/Telegram
- Клиент получает ссылку на оплату

**Валидация**: НЕ выполняется на этом этапе (сессия уже создана)

---

### Этап 3: Клиент оплачивает сессию

```
Клиент → Переходит по ссылке → Stripe Checkout → Оплата → Webhook событие
```

**Когда происходит**:
- Клиент переходит по ссылке `checkout_url` из Checkout Session
- Заполняет данные карты в Stripe Checkout
- Подтверждает оплату

**Валидация**: НЕ выполняется на этом этапе
- Stripe сам валидирует данные карты
- Наша система получает webhook событие `checkout.session.completed`

---

### Этап 4: Обработка платежа (webhook)

```
Stripe → Webhook событие → Обработка платежа → Сохранение в БД → Обновление CRM
```

**Когда происходит**:
- Stripe отправляет webhook событие `checkout.session.completed`
- Система обрабатывает событие через `Webhook Processing Service`
- Платеж сохраняется в БД, статус обновляется в CRM

**Валидация**: 
- Выполняется валидация данных платежа (другая валидация, не та же что при создании сессии)
- Проверка: session_id существует, deal_id корректен, сумма совпадает

---

## Сравнение валидаций

### Валидация при создании сессии (ValidationService.validateSessionData)

**Когда**: Перед созданием Stripe Checkout Session  
**Цель**: Убедиться, что все данные для создания сессии корректны  
**Проверяет**:
- Продукт, цена, адрес, имя, email
- Канал уведомлений
- B2B поля (если B2B)

**Результат**:
- ✅ Успех → Сессия создается
- ❌ Ошибка → Сессия НЕ создается, ошибки в БД

---

### Валидация при обработке платежа (ValidationService.validatePaymentData)

**Когда**: При обработке webhook события от Stripe  
**Цель**: Убедиться, что данные платежа корректны  
**Проверяет**:
- session_id существует
- deal_id корректен
- payment_status валиден

**Результат**:
- ✅ Успех → Платеж обрабатывается
- ❌ Ошибка → Платеж помечается как ошибка, логируется

---

## Примеры сценариев

### Сценарий 1: Валидация при создании сессии

```
1. Менеджер вызывает API: POST /api/.../create-stripe-session
2. Система вызывает ValidationService.validateSessionData()
3. Валидация проверяет все обязательные поля
4. Если валидация успешна → создается Stripe Checkout Session
5. Если валидация не прошла → сессия НЕ создается, ошибки в БД
```

### Сценарий 2: Клиент оплачивает сессию

```
1. Клиент переходит по ссылке checkout_url
2. Stripe Checkout отображает форму оплаты
3. Клиент вводит данные карты
4. Stripe валидирует данные карты (не наша валидация)
5. Клиент подтверждает оплату
6. Stripe отправляет webhook событие
7. Система обрабатывает событие (другая валидация)
```

---

## Валидация при обновлении сделки

### Когда валидация нужна при обновлении

**Сценарий 1: Обновление → Создание новой сессии**
- ✅ **ДА, валидация нужна**
- Когда: Менеджер обновляет сделку (например, меняет `invoice_type` на "75"), система создает новую сессию
- Где: В `Webhook Processing Service` или `Payment Session Service` при обработке webhook `deal.updated`
- Какая: Та же валидация, что и при создании сессии (`validateSessionData`)

**Сценарий 2: Обновление → Сессия уже оплачена**
- ❌ **НЕТ, валидация не нужна**
- Когда: Менеджер обновляет сделку (например, меняет цену), но сессия уже оплачена
- Почему: Платеж уже обработан, изменения не влияют на создание сессии

**Сценарий 3: Обновление → Сессия создана, но НЕ оплачена**
- ⚠️ **УСЛОВНО - зависит от типа изменения**
- Изменение цены: Валидация не нужна при обновлении, но может быть полезен отдельный сервис мониторинга для обнаружения расхождений
- Изменение обязательных полей: Рекомендуется проверить, но не блокирует существующую сессию
- Изменение invoice_type: Валидация нужна (триггер для создания новой сессии)

**Рекомендация**: 
- Для текущей миграции: Валидация только при создании сессии (через webhook или API)
- Для будущего: Отдельный `Deal Update Monitor Service` для отслеживания изменений и предупреждений менеджера

Подробнее см. [deal-update-validation.md](./deal-update-validation.md)

---

## Итог

**Валидация срабатывает ПРИ СОЗДАНИИ СЕССИИ**, а не при самом платеже:

- ✅ **При создании сессии**: ValidationService.validateSessionData()
- ✅ **При обновлении сделки → создание новой сессии**: ValidationService.validateSessionData() (та же валидация)
- ❌ **При оплате**: Валидация НЕ выполняется (Stripe сам валидирует карту)
- ✅ **При обработке платежа**: ValidationService.validatePaymentData() (другая валидация)
- ⚠️ **При обновлении сделки → сессия уже создана**: Валидация не нужна (но может быть полезен мониторинг)

Это важно понимать, потому что:
1. Ошибки валидации обнаруживаются ДО создания сессии
2. Клиент не получит ссылку на оплату, если данные некорректны
3. Менеджер может исправить данные и перезапустить создание сессии
4. При обновлении сделки валидация нужна только если создается новая сессия
