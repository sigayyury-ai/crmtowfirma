# Валидация при обновлении сделки

**Дата**: 2026-02-02  
**Цель**: Определить, когда нужна валидация при обновлении сделки и как она должна работать

## Когда срабатывает валидация при обновлении сделки

### Сценарий 1: Обновление сделки → Создание новой сессии

**Когда**: Менеджер обновляет сделку (например, меняет `invoice_type` на "75" для Stripe), и система создает новую сессию

**Валидация**: ✅ **ДА, нужна** - та же валидация, что и при создании сессии

**Пример**:
```
1. Менеджер меняет invoice_type = 75 в сделке
2. Pipedrive отправляет webhook: deal.updated
3. Система обрабатывает webhook
4. Система определяет, что нужно создать Stripe сессию
5. ВАЛИДАЦИЯ (та же что при создании сессии)
6. Если валидация успешна → создается сессия
7. Если валидация не прошла → сессия НЕ создается, ошибки в БД
```

**Где происходит**: В `Webhook Processing Service` или `Payment Session Service` при обработке webhook события `deal.updated`

---

### Сценарий 2: Обновление сделки → Сессия уже создана и оплачена

**Когда**: Менеджер обновляет сделку (например, меняет цену), но сессия уже создана и оплачена

**Валидация**: ❌ **НЕТ, не нужна** - платеж уже обработан, изменения не влияют на создание сессии

**Пример**:
```
1. Сессия создана и оплачена клиентом
2. Менеджер меняет цену сделки с 1000 на 1200
3. Платеж уже обработан, изменения цены не требуют новой сессии
4. Валидация НЕ выполняется
```

---

### Сценарий 3: Обновление сделки → Сессия создана, но НЕ оплачена

**Когда**: Менеджер обновляет сделку (например, меняет цену), сессия создана, но клиент еще не оплатил

**Валидация**: ⚠️ **УСЛОВНАЯ** - зависит от типа изменения

**Подтипы**:

#### 3.1. Изменение цены сделки

**Валидация**: ❌ **НЕТ, не нужна** при обновлении сделки

**Но**: Нужен отдельный сервис мониторинга изменений, который:
- Обнаруживает изменение цены в сделке
- Проверяет, есть ли неоплаченные сессии
- Предупреждает менеджера о расхождении между ценой сделки и суммой сессии
- Предлагает обновить сессию в Stripe (если возможно) или создать новую

**Пример**:
```
1. Сессия создана на сумму 1000 EUR (не оплачена)
2. Менеджер меняет цену сделки на 1200 EUR
3. Deal Update Monitor Service обнаруживает изменение
4. Проверяет неоплаченные сессии для этой сделки
5. Обнаруживает расхождение: сессия 1000, сделка 1200
6. Создает задачу в CRM для менеджера: "Цена сделки изменилась. Обновить сессию?"
7. Валидация НЕ выполняется автоматически (только при обновлении сессии)
```

#### 3.2. Изменение обязательных полей (адрес, email, имя)

**Валидация**: ⚠️ **РЕКОМЕНДУЕТСЯ** - проверить, не нарушились ли обязательные поля

**Пример**:
```
1. Сессия создана (не оплачена)
2. Менеджер удаляет адрес клиента из сделки
3. Deal Update Monitor Service обнаруживает изменение
4. Проверяет валидацию обязательных полей
5. Обнаруживает отсутствие адреса
6. Предупреждает менеджера, но НЕ блокирует сессию (она уже создана)
7. Рекомендует обновить адрес перед оплатой
```

#### 3.3. Изменение invoice_type (создание новой сессии)

**Валидация**: ✅ **ДА, нужна** - это триггер для создания новой сессии

**Пример**:
```
1. Сессия создана (не оплачена)
2. Менеджер меняет invoice_type с "75" на "70" (Proforma)
3. Webhook обрабатывает изменение
4. Система определяет, что нужно создать Proforma вместо Stripe сессии
5. ВАЛИДАЦИЯ для создания Proforma (другая валидация)
6. Если валидация успешна → создается Proforma
```

---

## Рекомендуемая архитектура

### Вариант 1: Валидация только при создании сессии (текущий подход)

**Принцип**: Валидация срабатывает только когда создается новая сессия

**Плюсы**:
- ✅ Простота реализации
- ✅ Нет дублирования логики валидации
- ✅ Валидация всегда актуальна (проверяет текущие данные)

**Минусы**:
- ❌ Не отслеживает изменения в сделке после создания сессии
- ❌ Менеджер может не знать о расхождениях

**Когда использовать**: Если изменения в сделке редко требуют обновления сессий

---

### Вариант 2: Отдельный сервис мониторинга изменений (рекомендуется)

**Принцип**: Отдельный `Deal Update Monitor Service` отслеживает изменения в сделках и предупреждает менеджера

**Архитектура**:
```
Pipedrive Webhook → Deal Update Monitor Service
                    ├─→ Обнаруживает изменения
                    ├─→ Проверяет состояние сессий
                    ├─→ Сравнивает данные сделки с сессиями
                    └─→ Создает задачи в CRM при расхождениях
```

**Что отслеживает**:
- Изменение цены сделки (если есть неоплаченные сессии)
- Изменение обязательных полей (адрес, email, имя)
- Изменение invoice_type (триггер для создания новой сессии)
- Изменение графика платежей (expected_close_date)

**Валидация**:
- ✅ При создании новой сессии (через webhook или мониторинг)
- ⚠️ При обнаружении расхождений (предупреждения менеджеру, не блокирует)

**Плюсы**:
- ✅ Проактивное обнаружение проблем
- ✅ Менеджер всегда в курсе расхождений
- ✅ Валидация при создании сессии остается простой

**Минусы**:
- ❌ Дополнительный сервис для поддержки
- ❌ Больше сложности

**Когда использовать**: Если изменения в сделках частые и требуют внимания менеджеров

---

## Рекомендация

### Для текущей миграции (Фазы 1-3):

**Использовать Вариант 1**: Валидация только при создании сессии

**Причины**:
- Простота реализации
- Фокус на основной функциональности
- Изменения в сделках после создания сессии редки

**Что делать**:
- Валидация срабатывает при создании сессии (через webhook или API)
- При обновлении сделки через webhook → если нужно создать сессию → валидация
- Если сессия уже создана → валидация не нужна

---

### Для будущего (Фаза 9+):

**Добавить Вариант 2**: `Deal Update Monitor Service`

**Когда добавлять**:
- После стабилизации основных микросервисов
- Если появляется потребность в отслеживании изменений
- Если менеджеры часто сталкиваются с расхождениями

**Что будет делать**:
- Отслеживать изменения в сделках через webhook
- Проверять состояние сессий для сделки
- Сравнивать данные сделки с данными сессий
- Создавать задачи в CRM при обнаружении расхождений
- Предупреждать менеджера о необходимости обновить сессию

---

## Итоговая таблица

| Сценарий | Валидация нужна? | Когда | Как |
|----------|------------------|-------|-----|
| Обновление → Создание новой сессии | ✅ ДА | При создании сессии | Та же валидация что при создании |
| Обновление → Сессия оплачена | ❌ НЕТ | - | Изменения не влияют на оплаченную сессию |
| Обновление → Сессия не оплачена (цена) | ⚠️ Мониторинг | Отдельный сервис | Предупреждение менеджеру о расхождении |
| Обновление → Сессия не оплачена (обязательные поля) | ⚠️ Мониторинг | Отдельный сервис | Предупреждение менеджеру |
| Обновление invoice_type | ✅ ДА | При создании новой сессии | Валидация для нового типа документа |

---

## Вывод

**Текущая валидация работает при создании сессии** (через webhook или API).

**При обновлении сделки**:
- Если создается новая сессия → валидация нужна
- Если сессия уже создана → валидация не нужна (но может быть полезен мониторинг)

**Отдельный сервис мониторинга** - это будущее улучшение, не обязательное для текущей миграции.
