# Research: Facebook Ads Expenses Integration

## Формат CSV отчетов Facebook Ads

### Вопросы для уточнения

1. **Какие колонки присутствуют в CSV файле?**
   - Campaign Name (название кампании)
   - Amount Spent (сумма расходов)
   - Date / Date Range (дата или период)
   - Currency (валюта)
   - Другие колонки?

2. **Какой формат даты используется?**
   - YYYY-MM-DD
   - DD-MM-YYYY
   - Другой формат?

3. **Какой формат периода (Date Range)?**
   - "2025-01-01 - 2025-01-31"
   - "01/01/2025 - 31/01/2025"
   - Другой формат?

4. **В какой валюте приходят данные?**
   - Всегда PLN?
   - Или может быть другая валюта?

5. **Как часто выгружаются отчеты?**
   - Ежемесячно?
   - Еженедельно?
   - По запросу?

6. **Есть ли заголовки в CSV файле?**
   - Первая строка содержит названия колонок?
   - Или данные начинаются сразу?

### Примеры форматов

**Вариант 1: Простой формат**
```csv
Campaign Name,Amount Spent,Date Range
"NY2026 - Awareness","150.50","2025-01-01 - 2025-01-31"
"NY2026 - Conversion","200.75","2025-01-01 - 2025-01-31"
```

**Вариант 2: С дополнительными колонками**
```csv
Campaign Name,Amount Spent,Currency,Date Range,Impressions,Clicks
"NY2026 - Awareness","150.50","PLN","2025-01-01 - 2025-01-31",10000,500
"NY2026 - Conversion","200.75","PLN","2025-01-01 - 2025-01-31",15000,750
```

## Накопительная логика

### Как работает накопление расходов

1. **Месяц 1 (Январь 2025):**
   - Кампания "NY2026 - Awareness": 150.50 PLN
   - Создается запись: `expense_month = 2025-01-01, amount_pln = 150.50`

2. **Месяц 2 (Февраль 2025):**
   - Кампания "NY2026 - Awareness": 300.00 PLN (накопленная сумма)
   - Создается запись: `expense_month = 2025-02-01, amount_pln = 150.50` (дельта: 300.00 - 150.50)

3. **Месяц 3 (Март 2025):**
   - Кампания "NY2026 - Awareness": 300.00 PLN (не изменилась)
   - Кампания остановлена: `is_campaign_active = false`
   - Новая запись не создается (или создается с amount_pln = 0)

### Вопросы для уточнения

1. **Как определяется дельта расходов?**
   - Вычитаем сумму предыдущего месяца из текущей?
   - Или храним накопленную сумму и вычитаем при отображении?

2. **Что делать, если сумма уменьшилась?**
   - Это ошибка в данных?
   - Или возможен возврат средств?

3. **Как обрабатывать остановленные кампании?**
   - Если сумма не изменилась - кампания остановлена?
   - Или есть другой признак остановки?

## Маппинг кампаний на продукты

### Стратегии маппинга

1. **Точное совпадение нормализованных названий**
   - "NY2026 - Awareness" → "NY2026" (продукт)
   - Нормализация: удаление суффиксов, приведение к нижнему регистру

2. **Частичное совпадение**
   - "NY2026 - Awareness" содержит "NY2026"
   - Поиск продуктов, название которых содержится в названии кампании

3. **Ручной маппинг**
   - Пользователь вручную создает маппинг
   - Сохраняется для будущих импортов

### Вопросы для уточнения

1. **Есть ли паттерн в названиях кампаний?**
   - Всегда содержит название продукта?
   - Или может быть произвольное название?

2. **Может ли одна кампания мапиться на несколько продуктов?**
   - Или всегда 1:1?

3. **Может ли несколько кампаний мапиться на один продукт?**
   - Скорее всего да (разные типы кампаний для одного продукта)

## Интеграция с существующей системой

### Варианты интеграции

**Вариант 1: Через таблицу payments**
- Создавать записи в `payments` с `direction='out'`, `source='facebook_ads'`
- Связь через `payment_product_links`
- Плюсы: единообразие с банковскими платежами
- Минусы: структура payments может не подходить для накопительных расходов

**Вариант 2: Отдельная таблица + payment_product_links**
- Хранить в `facebook_ads_expenses`
- Создавать записи в `payments` для отображения
- Связь через `payment_product_links`
- Плюсы: специализированная структура, но единообразное отображение
- Минусы: дублирование данных

**Вариант 3: Только отдельная таблица**
- Хранить только в `facebook_ads_expenses`
- Отображать напрямую в отчете (не через payment_product_links)
- Плюсы: нет дублирования
- Минусы: нужна отдельная логика отображения

### Рекомендация

Использовать **Вариант 2**: отдельная таблица `facebook_ads_expenses` для хранения накопительных данных + создание записей в `payments` для единообразного отображения в разделе "Связанные платежи".

## Производительность

### Оценка объемов данных

- Количество кампаний: ~10-50
- Количество месяцев: ~12-24
- Общее количество записей: ~120-1200

### Оптимизации

1. **Индексы:**
   - `campaign_name_normalized` - для поиска маппинга
   - `product_id, expense_month` - для фильтрации в отчетах
   - `expense_month` - для фильтрации по периоду

2. **Батчинг:**
   - Импорт по батчам (например, по 100 записей)
   - Транзакции для целостности данных

3. **Кэширование:**
   - Кэширование маппингов в памяти при импорте
   - Кэширование агрегированных данных для отчетов

## Безопасность

### Валидация данных

1. **CSV файл:**
   - Максимальный размер: 10MB
   - Проверка формата перед парсингом
   - Валидация кодировки (UTF-8)

2. **Данные:**
   - Валидация сумм (положительные числа)
   - Валидация дат (корректный формат)
   - Валидация названий кампаний (не пустые)

3. **Маппинг:**
   - Проверка существования продукта
   - Проверка прав доступа (если есть)

## Тестирование

### Тестовые данные

1. **Пример CSV файла:**
   - Создать тестовый CSV с различными форматами
   - Проверить обработку ошибок

2. **Тестовые маппинги:**
   - Создать несколько маппингов для тестирования
   - Проверить автоматическое предложение маппинга

3. **Тестовые расходы:**
   - Создать расходы за несколько месяцев
   - Проверить накопительную логику
   - Проверить определение остановленных кампаний


