# Чек-лист требований: 018-facebook-ads-expenses

## Функциональные требования

### FR-001: Импорт CSV отчетов Facebook Ads
- [ ] Поддержка формата CSV отчетов Facebook Ads
- [ ] Парсинг названий кампаний и сумм расходов
- [ ] Определение месяца расходов из даты/периода
- [ ] Валидация формата файла перед импортом
- [ ] Обработка ошибок парсинга с понятными сообщениями

### FR-002: Маппинг кампаний на продукты
- [ ] Сохранение маппинга для старых кампаний
- [ ] Возможность создания маппинга для новых кампаний
- [ ] Интерфейс для управления маппингом (создание, редактирование, удаление)
- [ ] Автоматическое предложение маппинга на основе нормализованных названий
- [ ] Поддержка нескольких кампаний на один продукт

### FR-003: Накопительный учет расходов
- [ ] Хранение расходов по месяцам для каждой кампании
- [ ] Расчет дельты расходов между месяцами
- [ ] Остановка накопления расходов при остановке кампании
- [ ] Отображение накопленных расходов в отчетах

### FR-004: Создание записей расходов
- [ ] Создание записей в таблице расходов (facebook_ads_expenses)
- [ ] Связь расходов с продуктами через маппинг
- [ ] Сохранение метаданных: название кампании, месяц, сумма
- [ ] Автоматическое определение валюты

### FR-005: Отображение в отчете по продуктам
- [ ] Расходы отображаются в разделе "Связанные платежи" отчета по продуктам (VAT Margin)
- [ ] Группировка по типу (исходящие платежи)
- [ ] Отображение названия кампании, периода отчетности, суммы
- [ ] Включение в расчет общей суммы расходов продукта
- [ ] **ВАЖНО:** Расходы Facebook Ads НЕ попадают в PNL отчет (только реальные банковские транзакции)

### FR-006: Управление маппингом
- [ ] Список всех маппингов с возможностью редактирования
- [ ] Поиск и фильтрация маппингов
- [ ] Создание нового маппинга для неразмеченных кампаний
- [ ] Удаление маппинга (с сохранением истории)
- [ ] Экспорт/импорт маппингов (опционально)

### FR-007: Обработка дубликатов
- [ ] Проверка на существующие записи по комбинации: кампания + месяц + сумма
- [ ] Идемпотентность импорта (повторный импорт не создает дубликаты)
- [ ] Логирование пропущенных дубликатов

### FR-008: Обработка остановленных кампаний
- [ ] Определение остановленных кампаний по отсутствию роста расходов
- [ ] Автоматическое прекращение накопления расходов
- [ ] Отображение статуса кампании (активна/остановлена)

## Нефункциональные требования

### NFR-001: Производительность
- [ ] Импорт CSV файла (до 1000 строк): < 5 секунд
- [ ] Поиск маппинга: < 100ms
- [ ] Загрузка расходов в отчет: < 1 секунды

### NFR-002: Безопасность
- [ ] Валидация входных данных
- [ ] Защита от SQL-инъекций
- [ ] Ограничение размера загружаемых файлов (до 10MB)

### NFR-003: Удобство использования
- [ ] Понятные сообщения об ошибках
- [ ] Прогресс-бар при импорте
- [ ] Предпросмотр данных перед импортом (опционально)

## Технические требования

### Database
- [ ] Миграция для таблиц создана и применена
- [ ] Индексы созданы
- [ ] Foreign keys настроены

### API
- [ ] Эндпоинт импорта CSV реализован
- [ ] Эндпоинты управления маппингом реализованы
- [ ] Эндпоинт получения расходов реализован
- [ ] Документация API обновлена

### Frontend
- [ ] Интерфейс импорта CSV создан
- [ ] Интерфейс управления маппингом создан
- [ ] Интеграция с отчетом по продуктам выполнена
- [ ] Обработка ошибок реализована

### Testing
- [ ] Unit тесты для парсера написаны
- [ ] Integration тесты для импорта написаны
- [ ] Тесты на реальных данных выполнены

## Критерии готовности

### Definition of Ready
- [x] Спецификация создана
- [ ] Формат CSV Facebook Ads определен и протестирован
- [ ] Архитектурное решение согласовано
- [ ] Оценка трудозатрат выполнена

### Definition of Done
- [ ] Все функциональные требования реализованы
- [ ] Импорт CSV работает корректно
- [ ] Маппинг кампаний на продукты работает
- [ ] Расходы отображаются в отчете по продуктам
- [ ] Автоматизированные тесты написаны
- [ ] Код прошел ревью
- [ ] Документация обновлена
- [ ] Функциональное тестирование пройдено

