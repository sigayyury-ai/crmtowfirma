# Исключение расходов Facebook Ads из PNL отчета

## Важное требование

**Расходы Facebook Ads НЕ должны попадать в PNL отчет**, так как PNL использует только реальные расходы из банковских выгрузок.

## Обоснование

1. **PNL отчет** использует реальные банковские транзакции из таблицы `payments`, которые прошли через банк
2. **Расходы Facebook Ads** - это виртуальные расходы:
   - Они уже списаны Facebook со счета рекламодателя
   - Но не проходят через банк как отдельные транзакции
   - Они нужны только для расчета маржи по продуктам в VAT Margin отчете

## Реализация исключения

### Вариант 1: Использование поля `source`

Если расходы Facebook Ads создаются в таблице `payments`:
- Создавать записи с `source='facebook_ads'`
- PNL отчет должен фильтровать: `WHERE source != 'facebook_ads'` или `WHERE source IS NULL OR source != 'facebook_ads'`

**Пример SQL для PNL:**
```sql
SELECT * FROM payments 
WHERE direction = 'out'
  AND (source IS NULL OR source != 'facebook_ads')
  AND (manual_status = 'approved' OR match_status = 'matched')
```

### Вариант 2: Хранение только в `facebook_ads_expenses`

Если расходы Facebook Ads НЕ создаются в таблице `payments`:
- Хранить только в `facebook_ads_expenses`
- Отображать в отчете по продуктам напрямую из `facebook_ads_expenses`
- PNL отчет автоматически их исключит, так как не будет записей в `payments`

**Преимущества:**
- ✅ Полное разделение данных
- ✅ Нет риска попадания в PNL
- ✅ Чище структура данных

**Недостатки:**
- ❌ Нужна отдельная логика отображения в отчете по продуктам
- ❌ Не единообразие с другими расходами

### Вариант 3: Комбинированный подход (Рекомендуется)

1. **Основное хранилище:** `facebook_ads_expenses`
2. **Для отображения:** Создавать записи в `payments` с `source='facebook_ads'`
3. **Исключение из PNL:** PNL отчет фильтрует по `source != 'facebook_ads'`

**Преимущества:**
- ✅ Единообразное отображение в отчете по продуктам
- ✅ Гарантированное исключение из PNL
- ✅ Сохранение всех данных в специализированной таблице

## Требования к PNL отчету

PNL отчет должен быть обновлен, чтобы исключать расходы Facebook Ads:

### Текущая логика PNL (из `specs/011-pnl-report/data-model.md`):

```sql
-- Текущий фильтр для расходов (если есть)
WHERE direction = 'out'
  AND (manual_status = 'approved' OR match_status = 'matched')
```

### Обновленная логика PNL:

```sql
-- Обновленный фильтр с исключением Facebook Ads
WHERE direction = 'out'
  AND (source IS NULL OR source != 'facebook_ads')
  AND (manual_status = 'approved' OR match_status = 'matched')
```

## Проверка реализации

### Тест 1: Расходы Facebook Ads не попадают в PNL
1. Импортировать CSV с расходами Facebook Ads
2. Проверить, что расходы появились в отчете по продуктам
3. Проверить, что расходы НЕ появились в PNL отчете

### Тест 2: Реальные банковские расходы попадают в PNL
1. Обработать банковскую выгрузку с расходами
2. Проверить, что расходы появились в PNL отчете
3. Проверить, что расходы появились в отчете по продуктам (если связаны)

## Документация для разработчиков

При реализации PNL отчета необходимо:
1. Добавить фильтр по `source != 'facebook_ads'` во все запросы расходов
2. Обновить документацию PNL отчета с указанием исключения
3. Добавить комментарии в код о причине исключения

## Связанные файлы

- `specs/011-pnl-report/data-model.md` - модель данных PNL отчета
- `specs/011-pnl-report/spec.md` - спецификация PNL отчета
- `src/services/pnl/pnlReportService.js` - сервис PNL отчета (нужно обновить)

