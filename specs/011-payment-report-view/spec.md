# Отчёт по платежам VAT Margin

## Обзор
- Финансовая и операционная команды хотят вторую вьюху в VAT Margin Tracker, которая показывает выручку, начиная от банковских платежей, а не от выписанных проформ.
- Текущий отчёт фильтрует данные по месяцу создания проформы; новая вьюха должна фильтровать по дате поступления платежа, агрегировать сопоставленные платежи по продукту и выводить проформы, которые получили эти платежи.
- Повторное использование действующей верстки, элементов управления и стиля уменьшает когнитивную нагрузку и даёт аналитикам инструмент сверки поступлений с продажами по схеме VAT margin.

## Пользовательские сценарии и тестирование
1. **Бухгалтер смотрит платежи за текущий месяц**
   - Бухгалтер открывает новую вкладку «Отчёт 2».
   - По умолчанию система выбирает текущий месяц по датам платежей и показывает все поступления, которые связаны с проформами в этом диапазоне.
   - В строке платежа отображается сумма, плательщик, сопоставленная проформа и продуктовая группа, в которую она входит.
2. **Финансовый аналитик разбирает конкретный продукт**
   - Аналитик выбирает другой месяц через контролы месяц/год.
   - Отчёт перестраивает группировку по продукту, показывая суммарные поступления, число платежей и список связанных проформ.
   - Аналитик раскрывает продукт, чтобы проверить отдельные платежи, убедиться в правильной привязке и при необходимости открыть сделку.
3. **Операционный директор выгружает данные для сверки**
   - Директор задаёт произвольный период (например, квартал).
   - Отчёт обновляется под новый диапазон, сохраняя привязку к платежам.
   - Директор выгружает CSV и убеждается, что файл содержит те же строки и итоги, что и интерфейс.
4. **Контролёр проверяет неопределённые случаи**
   - Контролёр включает фильтр, добавляющий платежи без подтверждённой проформы.
   - Отчёт показывает такие платежи с пометками о том, что привязка отсутствует и требует внимания.

## Функциональные требования
1. **Навигация и компоновка**
   - Добавить вторую вкладку в интерфейсе VAT Margin Tracker с названием «Отчёт 2», повторяющую существующие контролы (выбор месяца/года, кнопки обновления и экспорта, логи).
   - Стартовый вид VAT Margin Tracker остаётся прежним; пользователь может переключаться между вкладками без перезагрузки страницы.
2. **Фильтрация по датам платежей**
   - Использовать `payments.operation_date` (или аналогичное поле) как главный фильтр.
   - Быстрые выборы месяца/года переводить в диапазон дат; предоставить ввод произвольного диапазона, если он уже поддержан в текущем отчёте.
   - Диапазон по умолчанию — текущий календарный месяц; при смене промежутка итоги пересчитываются.
3. **Правила выборки данных**
   - По умолчанию включать только входящие платежи (`direction = 'in'`) с `manual_status = 'approved'` и привязанной проформой (id и/или fullnumber).
   - Добавить опцию показа других статусов (автосопоставлено без подтверждения, не сопоставлено, отклонено) с наглядными бейджами.
   - Каждый платеж должен связываться со своей проформой и строками продуктов (`proforma_products`), чтобы учитывать только продукты, относящиеся к VAT margin.
4. **Модель агрегации**
   - Основная группировка — продукт (по product_id, при его отсутствии — по нормализованному названию).
   - Для каждой группы выводить: сумму платежей по каждой валюте, сумму в пересчёте на PLN (с использованием курса проформы при необходимости), количество платежей, число уникальных проформ, список проформ с данными покупателя и статус оплаты относительно полной суммы проформы (оплачено/частично/переплата/неизвестно).
   - Внутри группы показывать таблицу платежей с колонками: дата платежа, плательщик, сумма + валюта, сопоставленная проформа, дата проформы, ссылка на сделку, статус платежа.
5. **Поведение интерфейса**
   - Использовать текущий стиль таблиц: сворачиваемые карточки продукта, строки таблицы, статусные бейджи, форматирование валюты, контактные данные покупателя.
   - Подсвечивать расхождения (например, платеж больше остатка) теми же цветами, что и «требует проверки» в существующем интерфейсе платежей.
   - Логировать события загрузки, экспорта и ошибок в уже существующем блоке логов.
6. **Сводные показатели**
   - Над таблицей выводить итоги выбранного диапазона: количество платежей, суммы по валютам, общий эквивалент в PLN, число уникальных продуктов, количество непришитых платежей (если опция включена).
   - Давать быстрый ответ на вопрос, сколько денег поступило и сколько ещё остаётся собрать по связанным проформам.
7. **Экспорт**
   - Кнопка экспорта должна выгружать CSV, соответствующий текущему представлению (с учётом фильтров и опций), с построчными данными по платежам и колонками: продукт, проформа, ссылка на сделку, статус, суммы.
8. **Доступ и производительность**
   - Применять те же правила аутентификации и авторизации, что и для существующего VAT Margin Tracker.
   - Обеспечить время отклика ≤3 секунд для выборки до 5 000 платежей; при необходимости использовать пагинацию или ленивую загрузку.
9. **Обработка ошибок и аудит**
   - При недоступности данных (ошибка Supabase, API) показывать дружелюбное сообщение и писать событие в лог.
   - Сохранять журнал действий (загрузки, экспорты) так же, как в текущем отчёте.

## Критерии успеха
- Пользователь загружает платежный отчёт за любой месяц (до 5 000 платежей) менее чем за 3 секунды в 9 случаях из 10.
- Суммарные показатели (количество и сумма платежей) отличаются от ручных выборок в Supabase не более чем на 1 % для контрольного периода.
- Экспортированный CSV совпадает с данными на экране по количеству строк и итогам в проверках QA.
- Финансы и операционный блок отмечают сокращение времени на сверку поступлений с продуктовой выручкой минимум на 30 % по результатам пилота.

## Предпосылки
- По умолчанию показываем только платежи с подтверждённой ручной привязкой; аналитики могут включить другие статусы для уборки.
- Курсы валют для пересчёта в PLN доступны из связанных проформ; если курса нет, показываем суммы только в исходной валюте.
- Логика определения продуктов VAT margin уже реализована и может быть переиспользована без доработок.
- Элементы UI (вкладки, таблицы, фильтры, логи, экспорт) из действующего отчёта подходят для повторного использования.

## Ключевые сущности
- **Платёж**: { id, operation_date, amount, currency, direction, payer_name, manual_status, manual_proforma_id, manual_proforma_fullnumber, match_status }.
- **Проформа**: { id, fullnumber, issued_at, currency, currency_exchange, payments_total, payments_total_pln, buyer\_*, pipedrive_deal_id }.
- **ГруппаПродукта**: агрегат с product id/ключом, названием, итогами по валютам и PLN, платежами и связанными проформами.

## Вне рамок
- Изменение логики сопоставления платежей или порогов авто-сопоставления.
- Правки данных платежей или проформ из новой вьюхи.
- Создание тревог или уведомлений на основе найденных аномалий — только отчётность.

