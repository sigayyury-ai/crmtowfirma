# Спецификация: гибридная работа с оплатами (наличные + безнал)

## 1. Контекст и мотивация
- Клиентские сделки сейчас закрываются банковскими платежами (CSV/Stripe). Некоторые клиенты просят комбинировать оплату: часть перечислить на счёт, часть отдать наличными.
- Наличные не должны попадать в бухгалтерские отчёты (VAT Margin Tracker, P&L), но должны учитываться:
  - в прогрессе по проформе/продукту (сколько денег собрали);
  - в CRM, чтобы менеджеры видели «факт оплаты»;
  - при ручном расчёте остатков и долгів.
- Нужен единый сценарий, который умеет сочетать: проформа + банковская часть + наличная часть, Stripe + наличная часть, чисто наличный кейс.
- Сейчас нет UI/процессов для внесения наличных, нет понимания, как запускать гибрид из CRM, и как разделить отчётность.

## 2. Пользовательские роли
1. **Менеджер продаж** — фиксирует договорённость, создаёт проформу, получает часть денег на счёт/Stripe и часть наличными от клиента.
2. **Финансовый аналитик** — сверяет поступления, должен видеть, что по проформе X поступило N PLN банковских + M PLN наличных, но в официальные отчёты попадает только банковская часть.
3. **Бухгалтер** — формирует отчёты для налоговой, поэтому наличные гибриды не попадают в VAT/P&L.
4. **Кассовый администратор (опционально)** — отвечает за учёт фактической наличности, может подтверждать, что деньги приняты.

## 3. Сценарии использования
1. **Гибрид проформа + наличные**  
   - Менеджер создаёт проформу на всю сумму.  
   - Клиент перечисляет 60% на счёт, 40% отдаёт наличными.  
   - Феичер должен позволить установить статус «частичный гаш» (банковская часть подтягивается автоматически, наличная вносится вручную).  
   - Итог: проформа закрыта на 100%, но в отчёт попадает только банковская часть.

2. **Гибрид Stripe + наличные**  
   - Для события создаётся Stripe сессия на предоплату (например, депозит).  
   - Остаток вносят наличными на локации.  
   - Мы должны понимать, что признанный доход по событию = Stripe + кэш, но в отчёт CRM/операций, не в бухгалтерский.

3. **Полностью наличный кейс**  
   - Клиент безналом не пользовался.  
   - Проформа остаётся в статусе черновик? или формируем «квитанцию»? Нужно описать бизнес-решение (см. открытые вопросы).  
   - Наличные должны попадать в отчёт «учёт наличных» (внутренний), но не в VAT.

4. **Контроль остатков по гибриду**  
   - Менеджер видит по проформе: план = 10 000 PLN, собрано банка = 6 000 PLN, наличка = 4 000 PLN, остаток = 0 PLN.  
   - Аналитик видит aggregated view: сколько наличных по продукту/месяцу и кто их внёс.

## 4. Функциональные требования
### 4.1. Способы ввода кэш-платежей
- В UI (VAT Margin Tracker или отдельный модуль) должна появиться форма «Добавить наличный платёж»:
  - привязка к проформе (по ID/fullnumber) или к продукту;
  - сумма, валюта, дата;
  - кассир/ответственный;
  - подтверждение (опциональный чекбокс «подтверждено»).
- Также нужен API-эндпоинт, чтобы CRM (или automation) могла создавать кэш-платёж автоматически на основании статусного триггера.

### 4.2. Статусы и агрегация
- Проформа хранит два вида агрегатов: `payments_total_bank` и `payments_total_cash`.
- Логика определения статуса («оплачено/частично») учитывает сумму `bank + cash`.
- Отчёт VAT Margin для бухгалтерии: учитывает только банковскую часть (в `payments_total_bank`).  
  Для управленческого отчёта (который видит менеджер) — банковские + наличные.
- Наличные платежи не попадают в таблицу `payments` (или попадают, но помечаются `source = 'cash'` и фильтруются из отчётов).

### 4.3. CRM-флоу
- В карточке сделки появляется новый action: «Получили наличные».  
  - вводим сумму, назначение (депозит/остаток), дату;  
  - при необходимости создаём пуш в VAT Margin.
- Важно определить, кто подтверждает и может ли система автоматически закрывать стадию (например, перевод в `cash_received`).

### 4.4. Учёт наличных в отчётах
- Нужен отдельный интерфейс/отчёт: «Кассовый журнал» или «Наличные по продуктам».
- Поля: дата, продукт, проформа, сумма, кассир, комментарий, статус (подтверждено/на проверке).
- Возможность выгрузки CSV.
- Для P&L уже существует отдельная категория «Приходы — Наличные», которую мы сейчас заполняем вручную. Новый поток должен автоматически класть подтверждённые кэш-платежи в эту категорию (в Supabase `pnl_revenue_entries`), чтобы ручные манипуляции ушли.

### 4.5. Права доступа
- Добавлять/редактировать наличные платежи могут только роли «Менеджер»/«Кассир».
- Просматривать агрегаты — менеджеры/аналитики.
- Удалять/редактировать после подтверждения — только администратор.

## 5. Нефункциональные требования
- **Трассировка**: логировать каждое добавление/изменение кэша (таблица `cash_payments_audit`).
- **Валюта**: поддержка PLN и EUR (конвертация в PLN для агрегатов).
- **Отказоустойчивость**: если кэш-платёж не синхронизировался, показывать в UI статус «требует внимания».
- **Performance**: при загрузке отчётов не выполнять дополнительные тяжёлые запросы, если фильтр «только банк» включён.

## 6. Предлагаемая архитектура
1. **Новые сущности**
   - `cash_payments`:
     - `id`, `proforma_id`, `product_id`, `deal_id`;
     - `amount`, `currency`, `amount_pln`;
     - `payment_date`, `created_by`, `confirmed_by`;
     - `status` (`pending`, `confirmed`, `void`);
     - `source` (`manual`, `crm_trigger`), `note`.
   - `cash_balance_entries` (опционально) — если понадобится вести кассовый журнал.

2. **Изменения в существующих таблицах**
   - `proformas`: поля `cash_total`, `cash_total_pln`.
   - `payments`: возможно, `source='cash'` для унификации (но в отчёт включаем/исключаем через фильтр).
   - `product_summary`: хранить общую сумму наличными для продукта/месяца.

3. **Сервисы**
   - `cashPaymentService`: CRUD, агрегация, интеграция с reporting.
   - Расширение `pnlReportService` и `paymentRevenueReportService`: учитывать кэш в управленческом выгрузке, но фильтровать для бухгалтерии.
   - `crmSync`: новый webhook/endpoint для фиксации кэша из Pipedrive.

4. **Фронтенд**
   - VAT Margin Tracker: вкладка/диалог «Добавить наличный платёж».
   - Отдельный отчёт «Наличные» (таблица + фильтры).
   - Обновлённые summary-карточки: показывать две суммы (банковские, наличные).

## 7. Открытые вопросы
1. Печатный документ не нужен (серая схема, работаем без официальной квитанции).
2. Наличные не должны попадать в официальные бухгалтерские отчёты (VAT Margin, продуктовые отчёты), там остаются только безналичные поступления.
3. Подтверждением служит момент, когда сделка в Pipedrive переходит в статус `Won`. Дополнительные ручные подтверждения не нужны. Если сделка ушла в `Lost`, кэш-сценарий не рассматривается.
4. Учёт по кассирам или отдельный «склад» не нужен.
5. Для гибрида «нал→безнал» сейчас сценариев нет; считаем, что платёж либо чисто наличный, либо гибрид «безнал + наличный хвост».
6. `cash_amount` заполняется в момент запуска триггера Stripe/Proforma (когда продаём безналичную часть). Сам механизм гибрида стартует по тем же CRM-хукам: при заполнении поля и выставлении проформы система знает ожидаемую кэш-сумму. 
7. В управленческом P&L нужно автозаполнять раздел «Приходы — Наличные» (сейчас ставится вручную); в VAT Margin и отчёте по продуктам наличка не отображается — отдельного отчёта по кэшу нет, только блок в P&L.
8. В CRM добавляем новое поле `cash_amount`: менеджер сразу фиксирует, сколько клиент заплатит наличными. Поле хранится как число, валюта всегда наследуется из продукта/сделки (поддерживаем только совпадающую валюту). Безналичная часть считается как `product_total - cash_amount`, именно она идёт в проформу/банк. `cash_amount` становится источником правды для внутренних отчётов и не попадает в налоговые выгрузки. Сам факт заполнения поля служит триггером для запуска механизма работы с наличными (создание записи, ожидание подтверждения и т.п.). Если `cash_amount` меняется после запуска триггера, нужно явно решать, как пересчитывать проформу/банк — сейчас схема предполагает, что изменений не будет.
9. Нужна сущность для «фактически полученной наличной суммы» (например, `cash_received_amount`). Менеджер может ожидать одну сумму, а клиент принести другую — нужно где-то фиксировать реальный приход (и опционально дату возврата/коррекции, если клиент передумал).
10. Возвраты: клиенты могут отказаться (не поехать) или попросить вернуть наличные. Нужно описать процесс возврата (как в VAT Margin есть stripe_payment_deletions для безнала).

## 8. Вне рамок
- Реализация физической кассы/фискальных чеков.
- Автоматические уведомления в налоговые органы.
- Интеграция с POS-терминалами.

## 9. План внедрения (высокий уровень)
### План разработки

#### Этап 1. MVP
**Цель:** иметь минимальный рабочий контур, который:
- Читает `cash_amount` из CRM и создаёт заготовку в `cash_payments`.
- Позволяет вручную отметить «наличные получены» (восприятие «cash_received_amount»).
- Исключает наличные из VAT/продуктовых отчётов, но показывает их в P&L («Приходы — Наличные»).

**План MVP**
1. **Backend**
   - Миграция: таблица `cash_payments` (id, deal_id, proforma_id, cash_amount_expected, cash_amount_received, currency, status, confirmed_at).
   - API endpoint `/cash-payments` (create/update/list) c JWT/role checks.
   - Сервис, который слушает CRM-триггер (например, webhook или polling) и создает запись с `cash_amount_expected`.
   - Job, который при смене сделки на `Won` (или webhook из Pipedrive) проставляет `status=confirmed`.

2. **P&L интеграция**
   - Авто-пайплайн, который по расписанию смотрит `cash_payments` со `status=confirmed` и добавляет сумму в P&L категорию «Приходы — Наличные».
   - Простая админ-страница/CLI для просмотра cash-платежей (можно reuse VAT Margin UI).

3. **UI (минимум)**
   - В VAT Margin (или отдельной вкладке) список `cash_payments` с фильтром по продукту и кнопкой «Подтвердить».
   - Нет детальных отчётов, только статус и сумма.

4. **Процесс**
   - Менеджер выставляет проформу/Stripe → заполняет `cash_amount`.
   - Система создает pending cash entry.
   - При переходе сделки в `Won` менеджер указывает «наличку получили», либо триггер автоматически ставит `confirmed`.
   - P&L видит подтвержденные записи.

#### Этап 2. Пост-MVP / полноценный функционал
**Цель:** закрыть все реальные кейсы и убрать ручные обходы.
1. **UX и операционные сценарии**
   - Полноценная форма/таблица кэш-платежей с фильтрами, пагинацией, поиском.
   - Возможность редактировать `cash_amount` и `cash_received_amount` (в т.ч. до `Won`), фиксировать недоплату/переплату.
   - Поддержка нескольких траншей/взносов по одной проформе (например, `cash_split` по графику).
2. **Возвраты и корректировки**
   - Раздел `cash_refunds` (аналог `stripe_payment_deletions`): учёт отказов, возврат наличных, связь с deal_id.
   - API для автоматической/ручной коррекции, журнал аудита.
3. **Учёт и отчётность**
   - Кассовый журнал (отдельная вкладка в VAT Margin): даты, кассиры, статусы.
   - Отчёты по продуктам/месяцам: сколько кэша ожидали vs получили.
   - Интеграция с графиком платежей — например, авторазметка «депозит наличными / остаток банковский».
4. **CRM интеграция**
   - Notification hooks (например, Telegram/e-mail) менеджеру о том, что кэш ждёт подтверждения.
   - Политика изменения `cash_amount`: блокировка/расчёт разницы + обновление проформы/Stripe.
5. **Тесты и поддержка**
   - E2E-тесты (проформа + кэш, Stripe + кэш, полностью наличный, возврат).
   - Нагрузочные тесты, мониторинг (dashboards).
   - Документация и обучение менеджеров (видеогайд, чек-лист).

### Stripe-гибрид (MVP)
**Задача:** быстро добавить поддержку сценария «Stripe депозит + наличный остаток».

1. **CRM поток**
   - Для сделок с триггером Stripe использовать то же поле `cash_amount` при запуске Checkout Session.
   - В metadata каждой Session добавлять `cash_amount_expected` (чтобы backend понимал, сколько кэша ждать).

2. **Stripe Processor**
   - После импорта успешно оплаченной Session искать связанную запись `cash_payments` по deal_id.
   - Обновлять поля `bank_received_amount` (равно Stripe сумме) и оставлять `cash_amount_expected` как pending.

3. **Подтверждение**
   - Когда сделка становится `Won`, автоматически проставлять `cash_payment.status = confirmed`, вычислять `cash_amount_received = cash_amount_expected`.
   - Если клиент отказался (deal = `Lost`), переход в кэш-процесс не выполняем.

4. **Отчётность**
   - Stripe часть идёт в безналичные отчёты как сейчас.
   - Кэш часть, после подтверждения, попадает в P&L «Приходы — Наличные». Дополнительных UI-таблиц не делаем: достаточно карточки «Stripe: X, кэш: Y».
