# VAT Margin Tracker Product Report Tab

## Overview

Финансовой команде нужен сводный отчет по продуктам, который объединяет все проформы за весь период продаж. Новая вкладка «Отчет по продуктам» в VAT Margin Tracker должна показывать список всех продуктов, агрегировать их показатели (выручка, маржинальность, количество проформ и др.) за весь период и позволять вручную управлять статусом расчета для каждого продукта. При выборе продукта пользователь видит развернутый отчет с детализацией, аналогичной месячному отчету, а также может установить статус «В процессе» или «Рассчитан» и указать месяц, в котором необходимо завершить расчеты. Решение должно позволить формировать итоговые отчеты без выгрузки данных во внешние таблицы и фиксировать прогресс по подготовке расчетов.

## User Scenarios & Testing

### Primary Scenario: Просмотр сводки по продуктам

1. **Предусловия**:
   - Пользователь авторизован в VAT Margin Tracker и имеет доступ к отчетам
   - В системе есть проформы минимум по одному продукту

2. **Действия**:
   - Пользователь открывает вкладку «Отчет по продуктам»
   - Система отображает таблицу продуктов с агрегированными показателями за весь период
   - Пользователь просматривает ключевые метрики (выручка, количество проформ,имена контраегентов из проформ и номера проформ) для интересующих продуктов

3. **Ожидаемый результат**:
   - Таблица содержит все продукты из базы, включая те, по которым были продажи
   - Показатели агрегированы корректно по всем доступным проформам
   - Сводка обновляется автоматически при появлении новых проформ

### Primary Scenario: Детальный просмотр показателей выбранного продукта

1. **Предусловия**:
   - Выполнены предусловия предыдущего сценария
   - Для выбранного продукта есть хотя бы одна проформа

2. **Действия**:
   - Пользователь нажимает на строку продукта в сводном списке
   - Система открывает детальную панель/модальное окно с расширенным отчетом
   - В отчете отображаются:   перечень проформ с ключевыми полями, клиенты и статус оплаты
   - Пользователь проверяет, что суммы совпадают с ежемесячным отчетом за соответствующие периоды

3. **Ожидаемый результат**:
   - Детальный отчет полностью соответствует структуре и уровню детализации существующего отчета по месяцам
   - Каждая проформа отображается один раз со своими суммами и связанной сделкой/клиентом
   - Пользователь может закрыть детальный отчет и вернуться к сводному списку без потери контекста

### Primary Scenario: Обновление статуса расчета продукта

1. **Предусловия**:
   - Пользователь авторизован и имеет права редактировать статусы отчетов
   - На вкладке «Отчет по продуктам» отображается список продуктов

2. **Действия**:
   - Пользователь открывает детальный отчет по продукту
   - Устанавливает статус «Рассчитан» (или возвращает «В процессе»)
   - По необходимости задает или обновляет поле «Месяц расчёта»
   - Сохраняет изменения

3. **Ожидаемый результат**:
   - Статус и месяц расчёта сохраняются и отображаются в сводной таблице и деталях продукта
   - Исторические данные не перезаписываются, если статус изменился на «В процессе»
   - При повторном открытии вкладки значения сохраняются

### Alternative Scenario: Продукт без исторических продаж

1. **Предусловия**:
   - В базе есть продукт, по которому еще не создано проформ

2. **Действия**:
   - Пользователь открывает вкладку «Отчет по продуктам»
   - Находит продукт без продаж в списке
   - Открывает детальный отчет

3. **Ожидаемый результат**:
   - В сводной таблице для продукта отображаются значения «0» или «—» для количественных показателей
   - Детальный отчет сообщает, что нет проформ, и не показывает пустых таблиц без заголовков
   - Пользователю понятно, что данные появятся после первой продажи

## Functional Requirements

### FR1: Навигация к отчету по продуктам

**Описание**: В интерфейсе VAT Margin Tracker должна появиться новая вкладка «Отчет по продуктам», доступная пользователям с правом просмотра отчетов.

**Приемочные критерии**:
- Вкладка отображается рядом с существующими отчетами (например, месячным) и использует согласованный UI
- Доступ к вкладке ограничен тем же набором ролей, что и к другим отчетам
- При загрузке вкладки применяется стандартный заголовок и описание с пояснением назначения отчета

### FR2: Сводная таблица продуктов с агрегированными метриками

**Описание**: На вкладке выводится таблица со строками по каждому продукту и ключевыми агрегированными показателями за весь доступный период.

**Детали**:
- Таблица формируется из связки каталога продуктов и проформ
- Минимальный набор метрик по продукту: количество проформ, суммарная выручка (gross), суммарный доход (net), суммарная маржа, средний чек, доля продукта в общей выручке
- Данные охватывают весь период, доступный в системе, без ограничений по дате
- Продукты со статусом «Рассчитан» отображаются в конце списка, чтобы в верхней части оставались активные к расчёту позиции
- Таблица сортируется по выручке по умолчанию в рамках каждой группы статуса и поддерживает ручную сортировку по ключевым столбцам

**Приемочные критерии**:
- Каждая строка соответствует уникальному продукту
- Показатели в таблице равны сумме значений всех проформ, связанных с продуктом
- Продукты со статусом «В процессе» отображаются выше продуктов со статусом «Рассчитан»
- Сортировка работает для всех числовых столбцов и сохраняется при повторном открытии вкладки в рамках текущей сессии

### FR3: Согласованность с месячным отчетом

**Описание**: Значения в продуктовой сводке и детализации должны совпадать с данными существующего отчета по месяцам.

**Детали**:
- Для любого месяца сумма по продукту должна соответствовать сумме того же продукта в месячном отчете
- Расхождение между месячным отчетом и продуктовой сводкой не должно превышать 0,1% от соответствующей суммы
- Если в месячном отчете отсутствуют данные по продукту, продукт не должен появляться в продуктовой сводке за тот период

**Приемочные критерии**:
- При выборочной проверке (минимум 3 продукта) суммы и количество проформ совпадают между отчетами
- Допустимое расхождение 0,1% не превышено ни по одному проверенному продукту

### FR4: Детальный отчет по продукту

**Описание**: При выборе продукта отображается детальный отчет, повторяющий структуру месячного отчета, но отфильтрованный по выбранному продукту.

**Детали**:
- В верхней части детального отчета отображаются: общее количество проформ, суммарная выручка, маржа, доля продукта в общей выручке, последняя дата продажи
- Ниже отображается разбиение по месяцам: для каждого месяца — количество проформ, выручка, маржа, чистый доход, сумма VAT и средний чек
- В конце выводится список проформ с колонками: дата, номер проформы, клиент, связанная сделка, суммы (net, gross, VAT), статус оплаты
- Интерфейс позволяет сворачивать и разворачивать месячные блоки, если данных много

**Приемочные критерии**:
- Детальный отчет открывается не дольше чем за 3 секунды при объеме данных до 500 проформ
- Каждая проформа отображается с полным набором полей
- Пользователь может свернуть/развернуть месячные блоки без перезагрузки вкладки

### FR5: Актуальность и полнота данных

**Описание**: Отчет должен включать все проформы и продукты, добавленные в систему, без ручного обновления.

**Детали**:
- Данные обновляются в том же цикле, что и остальные отчеты VAT Margin Tracker
- Новые продукты появляются в списке не позже следующего обновления данных
- Удаленные/архивированные продукты скрываются или помечаются как архивные в соответствии с текущей политикой работы с каталогом

**Приемочные критерии**:
- После добавления новой проформы продукт отражается в отчете в течение одного цикла обновления
- Архивный продукт не мешает аналитике (либо отсутствует, либо помечен ясно)

### FR6: Обработка отсутствующих или неполных данных

### FR7: Ручное управление статусом расчета продукта

**Описание**: Пользователь должен вручную отмечать статус готовности расчетов по каждому продукту и указывать месяц, к которому нужно завершить расчеты.

**Детали**:
- Доступные статусы: «В процессе» (значение по умолчанию для новых продуктов) и «Рассчитан»
- Статус хранится в базе и отображается в сводной таблице и деталях продукта
- Поле «Месяц расчёта» (формат `YYYY-MM`) задается вручную для планирования, отображается рядом со статусом
- Изменения статуса и месяца фиксируются пользователем через интерфейс без автоматической перезаписи при обновлении данных
- Необходимо предусмотреть API для записи изменений статуса и месяца

**Приемочные критерии**:
- Новый продукт автоматически получает статус «В процессе» и пустое поле «Месяц расчёта»
- При смене статуса на «Рассчитан» и указании месяца значения сохраняются и отображаются после перезагрузки UI
- Пользователь может вернуть статус в «В процессе» без потери истории данных
- Попытка сохранить некорректный формат месяца блокируется с валидацией

**Описание**: Система должна корректно отображать продукты с отсутствующими данными и сигнализировать о проблемах в источниках.

**Приемочные критерии**:
- Для продуктов без продаж все числовые метрики показывают нули или явные маркеры отсутствия данных
- При невозможности загрузить данные отображается сообщение об ошибке с рекомендацией повторить попытку или обратиться в поддержку
- Ошибки логируются для дальнейшего анализа

## Success Criteria

1. **Полнота охвата**: Отчет по продуктам включает 100% проформ и продуктов, доступных в системе, в каждом цикле обновления данных.
2. **Точность данных**: Расхождение между продуктовым отчетом и месячным отчетом по выручке и марже не превышает 0,1% для любого продукта.
3. **Скорость доступа**: Сводная таблица продуктов загружается менее чем за 5 секунд при объеме до 1 000 продуктов.
4. **Работоспособность детализации**: Детальный отчет по продукту открывается и отображает данные менее чем за 3 секунды при объеме до 500 проформ.
5. **Удовлетворенность пользователей**: 90% финансовых менеджеров отмечают, что могут подготовить итоговый отчет по продуктам без экспорта в сторонние таблицы.
6. **Прозрачность статусов**: 100% продуктов в активной работе имеют актуальный статус и корректно заполненный «Месяц расчёта» (если требуется) по итогам ежемесячного обзора.

## Key Entities

### ProductSummary

**Назначение**: Агрегированная сводка по продукту в сводном списке.

**Атрибуты**:
- `productId` — уникальный идентификатор продукта
- `productName` — название продукта
- `proformaCount` — количество проформ
- `grossRevenue` — суммарная выручка (gross)
- `netRevenue` — суммарный доход (net)
- `marginTotal` — суммарная маржа
- `averageDealSize` — средний чек
- `revenueShare` — доля продукта в общей выручке
- `calculationStatus` — статус расчёта («В процессе» или «Рассчитан»)
- `calculationDueMonth` — месяц, к которому нужно завершить расчёты (формат `YYYY-MM` или `null`)

### ProductDetail

**Назначение**: Расширенная информация по продукту в детальном отчете.

**Атрибуты**:
- `totals` — агрегированные показатели (count, gross, net, margin, revenueShare, lastSaleDate)
- `monthlyBreakdown[]` — список месяцев с агрегированными метриками
- `proformas[]` — список проформ с ключевыми полями (дата, номер, клиент, сделка, суммы, статус оплаты)
- `calculationStatus` — текущий статус расчёта
- `calculationDueMonth` — установленный месяц расчёта

### MonthlyBreakdownItem

**Назначение**: Представление агрегированных показателей за конкретный месяц по выбранному продукту.

**Атрибуты**:
- `month` — обозначение месяца
- `proformaCount` — количество проформ
- `grossRevenue` — выручка
- `netRevenue` — доход
- `marginTotal` — маржа
- `vatAmount` — сумма VAT
- `averageDealSize` — средний чек

## Assumptions

1. **Метрики отчета**: Набор метрик в месячном отчете уже согласован и используется как эталон для продуктового отчета.
2. **Источник данных**: Все проформы и продукты доступны из существующих источников VAT Margin Tracker без дополнительной интеграции.
3. **Права доступа**: Права пользователей к новой вкладке совпадают с правами на просмотр месячного отчета.
4. **Архивация продуктов**: Статусы архивности или скрытия продуктов доступны через текущую систему управления продуктами.
5. **Ручное обновление статусов**: Предполагается, что финансовые менеджеры самостоятельно поддерживают актуальность статусов и месяца расчёта.

## Dependencies

- **VAT Margin Tracker UI** — требуется обновление интерфейса для добавления новой вкладки и детальной панели.
- **Каталог продуктов** — источник списка продуктов, их названий и статусов.
- **Хранилище статусов расчетов** — таблица/поле в базе данных, где сохраняются `calculationStatus` и `calculationDueMonth`.
- **Хранилище проформ** — источник данных о проформах, суммах, клиентах и статусах оплаты.
- **Существующий отчет по месяцам** — используется для валидации и сопоставления метрик.

## Constraints

1. **Большой объем данных**: Отчет должен корректно работать при росте числа продуктов и проформ без деградации производительности за пределами заявленных критериев.
2. **Единый источник правды**: Все показатели должны рассчитываться на основе тех же данных, что и месячный отчет, чтобы избежать разноочтений.
3. **Релиз без простоя**: Добавление новой вкладки не должно нарушить работу текущих отчетов.
4. **Ручное подтверждение статуса**: Система не может автоматически определить готовность расчёта, поэтому статусы зависят от дисциплины пользователей.

## Out of Scope

1. **Экспорт данных**: Автоматический экспорт в CSV/Excel не входит в текущий объем.
2. **Редактирование продуктов**: Удаление, переименование или объединение продуктов в рамках отчета не предусмотрено.
3. **Настройка индивидуальных фильтров**: Фильтрация по клиентам, странам и другим критериям планируется отдельно.
4. **Уведомления и оповещения**: Автоматические уведомления о изменении метрик по продуктам не реализуются в этой итерации.

