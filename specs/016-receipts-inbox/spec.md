# Feature Specification: Receipts Inbox (upload → auto-match bank payment)

**Feature Folder**: `specs/016-receipts-inbox/`  
**Created**: 2026-01-12  
**Status**: Draft  
**Input**: “Сделать отдельный таб в разделе с платежами. На странице одна кнопка загрузить документ/фото. Поддержка HEIC/JPG/PDF. Сценарий B: загружаем чек в инбокс, система предлагает к какому банковскому платежу привязать; дальше человек подтверждает и позже руками линкует платеж к продукту.”

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Быстро загрузить чек и получить кандидатов платежей (Priority: P1)

Как финансовый координатор, я хочу загрузить фото чека/инвойса в “инбокс чеков” (без выбора платежа), чтобы система сама предложила 3–10 кандидатов банковских платежей для привязки, и я мог(ла) быстро подтвердить правильный.

**Why this priority**: сокращает ручную рутину поиска нужной транзакции в списке банковских платежей и снижает риск ошибок.

**Independent Test**: загрузить 3 файла (HEIC/JPG/PDF) с разными суммами/датами и убедиться, что система показывает кандидатов с понятным скорингом/причинами; подтвердить матч.

**Acceptance Scenarios**:

1. **Given** я открыл(а) таб “Чеки” в разделе “Платежи”, **When** нажимаю “Загрузить” и выбираю файл, **Then** файл принимается и отображается карточка результата (статус обработки + кандидаты платежей).
2. **Given** документ распознан, **When** система показывает кандидатов, **Then** я вижу для каждого кандидата дату/сумму/описание и причину/скор совпадения (например “точная сумма + дата ±1 день”).
3. **Given** среди кандидатов есть нужный платёж, **When** я подтверждаю кандидата, **Then** документ считается привязанным к этому платежу и это видно в интерфейсе (статус “Привязан к платежу #…”).

---

### User Story 2 — Работа без распознавания/ошибки (Priority: P2)

Как пользователь, я хочу, чтобы загрузка работала даже если распознавание недоступно/упало, чтобы я мог(ла) всё равно сохранить документ и привязать его позже.

**Acceptance Scenarios**:

1. **Given** распознавание недоступно (лимит/нет ключа/ошибка), **When** я загружаю документ, **Then** документ сохраняется, а UI показывает статус “Требует обработки” или “Не удалось распознать” без потери файла.
2. **Given** кандидаты не найдены, **When** обработка завершилась, **Then** UI показывает “Кандидаты не найдены” и позволяет повторить подбор позже (например, после загрузки банковского CSV).

---

### User Story 3 — Подготовка к ручной линковке платежа к продукту (Priority: P3)

Как финансовый координатор, я хочу после подтверждения “чек → платеж” продолжить текущий процесс (категория/линковка платежа к продукту), чтобы чек был просто доказательством/контекстом, а продукт выбирался отдельно.

**Acceptance Scenarios**:

1. **Given** чек привязан к платежу, **When** я открываю детали этого платежа в текущем интерфейсе, **Then** я вижу, что к нему прикреплён документ (минимум ссылка/имя/дата).

---

### Edge Cases

- Загрузили чек, но **банковские платежи ещё не импортированы** (CSV не загружен) → кандидатов может не быть.
- **HEIC** может быть неподдерживаем в окружении обработки → система должна корректно обработать (конвертировать или пометить как “требует конвертации”), не теряя файл.
- PDF многостраничный → либо обрабатываем только первую страницу, либо выделяем все страницы (нужно явно определить поведение).
- В чеке сумма указана с чаевыми/скидкой → допускается толеранс по сумме.
- Валюта не указана/нестандартный формат → кандидатный матч не должен “ломаться”, а должен снижать уверенность.
- В один день несколько платежей на одинаковую сумму → кандидаты должны показывать различия (описание/контрагент/время).
- Один документ ошибочно привязали не к тому платежу → нужно уметь “отвязать” и выбрать другой.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST добавить в разделе “Платежи” отдельный саб-таб **“Чеки”**, в котором есть **ровно одна** основная CTA-кнопка: “Загрузить документ”.
- **FR-002**: Система MUST принимать форматы файлов: **HEIC**, **JPG/JPEG**, **PDF**.
- **FR-003**: Система MUST сохранять загруженный файл и метаданные (кто/когда/имя/размер/тип) независимо от успешности распознавания.
- **FR-004**: После загрузки система MUST попытаться извлечь структурированные поля документа: **сумма**, **валюта**, **дата документа**, **вендор/контрагент** (если возможно).
- **FR-005**: Система MUST предложить список кандидатов банковских платежей для привязки документа на основе извлечённых полей, показывая **скор/причины** совпадения.
- **FR-006**: Пользователь MUST иметь возможность **подтвердить** привязку документа к выбранному платежу.
- **FR-007**: Пользователь MUST иметь возможность **отменить/удалить** подтверждённую привязку и выбрать другой платеж (если требуется исправление).
- **FR-008**: Система MUST поддерживать сценарий “кандидаты не найдены” и отображать это как штатный результат, без ошибок и без потери документа.
- **FR-009**: Система MUST сохранять аудит действий: кто загрузил документ и кто подтвердил/изменил привязку.

### Non-Functional Requirements

- **NFR-001**: Время от загрузки до показа кандидатов SHOULD быть ≤ 10 секунд для изображений и ≤ 20 секунд для PDF при типичном размере файла.
- **NFR-002**: Система MUST не раскрывать документы по публичным ссылкам без контроля доступа.
- **NFR-003**: Ошибки распознавания MUST быть “мягкими”: документ сохраняется, UI сообщает, что кандидаты недоступны/нужен повтор.

### Key Entities *(include if feature involves data)*

- **ReceiptUpload**: загруженный документ (файл + метаданные).
- **ReceiptExtraction**: результат извлечения полей (сумма/дата/валюта/вендор + уверенность).
- **ReceiptPaymentMatch**: подтверждённая связь “документ → платеж”, включая аудит.
- **ReceiptPaymentCandidate**: вычисляемые кандидаты “платёж ↔ документ” со скорингом и объяснениями.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может загрузить документ и получить кандидатов за ≤ 20 секунд в 90% случаев на типичных файлах.
- **SC-002**: В 80% кейсов пользователь подтверждает правильный платеж из топ-5 кандидатов (по внутренней выборке).
- **SC-003**: 0 случаев потери файла при ошибках распознавания/матчинга.
- **SC-004**: Среднее время “загрузил чек → подтвердил платеж” ≤ 60 секунд.

