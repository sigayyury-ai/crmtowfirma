# Research Notes: 016-receipts-inbox

## Existing UI entry point

Таб “Платежи” уже существует в `frontend/vat-margin.html` и управляется `frontend/vat-margin-script.js` через саб-табы (`data-payments-tab`).
Это позволяет добавить “Чеки” как ещё один саб-таб без создания новой страницы.

## Existing backend primitives

- `src/routes/api.js` уже использует `multer` (memoryStorage) и имеет похожие загрузки (CSV).
- Supabase клиент используется с service role key (`src/services/supabaseClient.js`), что позволяет:
  - писать в таблицы,
  - работать с Supabase Storage (если включить в код).

## AI capabilities in repo

Есть `src/services/ai/openAIService.js`, который использует `chat/completions`.
Для сценария B понадобится либо:

- модель/режим, который умеет работать с изображениями (vision) и/или OCR, либо
- отдельный OCR шаг + LLM для структурирования текста.

V1 можно сделать “без AI”: хранить документ и давать ручной выбор платежа; но по текущей задаче требуется сценарий B с автоподбором, значит минимум нужно извлечение суммы/даты/валюты.

## HEIC

HEIC требует конвертации/декодирования. Это может потребовать доп. зависимости или поддержки libvips с heif.
Вариант стратегии:

- если HEIC конвертируется на сервере — делаем это автоматически,
- если нет — сохраняем файл и явно показываем пользователю, что “HEIC не удалось обработать, попробуйте JPG/PDF”.

Спека требует поддержки HEIC, поэтому в реализации нужно заранее выбрать стратегию и протестировать в окружении.

