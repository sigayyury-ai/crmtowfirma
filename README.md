# Pipedrive to wFirma Integration

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É Pipedrive CRM –∏ wFirma —Å–∏—Å—Ç–µ–º–æ–π —É—á–µ—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–æ–≤.

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **[–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è Sales –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤](docs/sales-manager-guide.md)** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã –¥–ª—è sales –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Proforma —Å—á–µ—Ç–æ–≤ –≤ wFirma –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–¥–µ–ª–æ–∫ Pipedrive
- –ü–æ–∏—Å–∫/—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤ wFirma –ø–æ email
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ Pipedrive (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
- –†–∞—Å—á—ë—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π (50/50 –∏–ª–∏ 100%) –∏ –≤—Å—Ç–∞–≤–∫–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—á–µ—Ç–∞
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ (—ç—Ç–∏–∫–µ—Ç–æ–∫) –≤ wFirma –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ 16 —Å–∏–º–≤–æ–ª–∞–º–∏)
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ –ø–æ –≤–∞–ª—é—Ç–µ
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é (CLI / REST) –∏ —á–µ—Ä–µ–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

–ü–æ–ª–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–º. –≤ `docs/architecture.md` –∏ `docs/business-requirements.md`.

## –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç—Ä–∞–Ω

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–¥–æ–≤ —Å—Ç—Ä–∞–Ω –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ ISO –∫–æ–¥—ã:

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

**–ü–æ–ª—å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∏–∑ wFirma):**
- `Polska` ‚Üí `PL`
- `Niemcy` ‚Üí `DE`
- `Francja` ‚Üí `FR`
- `Wielka Brytania` ‚Üí `GB`
- `Stany Zjednoczone` ‚Üí `US`
- `Czechy` ‚Üí `CZ`
- `Litwa` ‚Üí `LT`
- `≈Åotwa` ‚Üí `LV`
- `Estonia` ‚Üí `EE`

**–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∏–∑ CRM):**
- `Poland` ‚Üí `PL`
- `Germany` ‚Üí `DE`
- `France` ‚Üí `FR`
- `United Kingdom` ‚Üí `GB`
- `United States` ‚Üí `US`
- `Czech Republic` ‚Üí `CZ`
- `Lithuania` ‚Üí `LT`
- `Latvia` ‚Üí `LV`
- `Estonia` ‚Üí `EE`

**ISO –∫–æ–¥—ã (–ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):**
- `PL`, `DE`, `FR`, `GB`, `US`, `CZ`, `LT`, `LV`, `EE`

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–§—É–Ω–∫—Ü–∏—è `normalizeCountryCode()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤ wFirma –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `env.example`:

```bash
# Pipedrive API Configuration
PIPEDRIVE_API_TOKEN=your_pipedrive_token
PIPEDRIVE_BASE_URL=https://api.pipedrive.com/v1

# wFirma API Configuration
WFIRMA_APP_KEY=your_app_key
WFIRMA_ACCESS_KEY=your_access_key
WFIRMA_SECRET_KEY=your_secret_key
WFIRMA_BASE_URL=https://api2.wfirma.pl

# Server Configuration
PORT=3000
NODE_ENV=development
```

### –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞ –≤ `config/bank-accounts.js`:

```javascript
const BANK_ACCOUNT_CONFIG = {
  PLN: {
    name: 'PL / konto firmowe - 2693',
    fallback: 'M bank zl'
  },
  EUR: {
    name: 'EUR / konto firmowe - 2801',
    fallback: 'M Bank EUR'
  }
};
```

## –ó–∞–ø—É—Å–∫

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npm run dev

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞
npm start
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç –º–∞–ø–ø–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω
node test-country-mapping.js

# –¢–µ—Å—Ç –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
node test-new-contractor-logic.js

# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è Proforma
node test-proforma-with-dynamic-banks.js
```

## –°–ª—É–∂–µ–±–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### Backfill –Ω–æ–º–µ—Ä–∞ –ø—Ä–æ—Ñ–æ—Ä–º—ã –≤ CRM

–°–∫—Ä–∏–ø—Ç `scripts/backfillInvoiceNumbers.js` –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–µ ¬´Invoice number¬ª –≤ —Å–¥–µ–ª–∫–∞—Ö Pipedrive –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase:

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–≤—ã–µ 50 —Å–¥–µ–ª–æ–∫ –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
node scripts/backfillInvoiceNumbers.js --dry-run --limit=50

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–¥–µ–ª–∫—É
node scripts/backfillInvoiceNumbers.js --deal=1234

# –ë–∞—Ç—á–µ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–ø–æ–º–Ω–∏—Ç–µ –ø—Ä–æ rate limit Pipedrive)
node scripts/backfillInvoiceNumbers.js --limit=100 --offset=0
```

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `PIPEDRIVE_API_TOKEN`, –∞ —Ç–∞–∫–∂–µ `SUPABASE_URL` –∏ `SUPABASE_SERVICE_ROLE_KEY`.

## API Endpoints

- `GET /api/status` - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
- `POST /api/invoice-processing/run` - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `POST /api/invoice-processing/deal/:id` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–¥–µ–ª–∫–∏
- `GET /api/invoice-processing/pending` - –°–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö —Å–¥–µ–ª–æ–∫

## –§—Ä–æ–Ω—Ç–µ–Ω–¥

–û—Ç–∫—Ä–æ–π—Ç–µ `frontend/index.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.


