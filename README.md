# Pipedrive to wFirma Integration

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É Pipedrive CRM –∏ wFirma —Å–∏—Å—Ç–µ–º–æ–π —É—á–µ—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–æ–≤.

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **[–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è Sales –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤](docs/sales-manager-guide.md)** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã –¥–ª—è sales –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
- **[–ü–ª–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π](docs/payment-automation-plan.md)** - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤—Ç–æ—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Stripe –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ –ø—Ä–æ—Ñ–æ—Ä–º–∞–º
- **[–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ –ø—Ä–æ—Ñ–æ—Ä–º–∞–º](docs/proforma-reminder-integration-summary.md)** - –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º –æ –≤—Ç–æ—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
- **[–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Å–¥–µ–ª–∫–µ](docs/product-change-flow.md)** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞, –ø–µ—Ä–µ—Å—á–µ—Ç —Å—É–º–º—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
- **[–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∑–∞–¥–∞—á–∏ Cron](docs/how-cron-tasks-work.md)** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∏—Å–∫–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á
- **[–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ Cron](docs/cron-tasks-management-guide.md)** - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∑–∞–¥–∞—á–∞–º–∏: —É–¥–∞–ª–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **[–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Å Render](docs/render-logs-setup.md)** - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é –ª–æ–≥–æ–≤ —Å –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Render

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Proforma —Å—á–µ—Ç–æ–≤ –≤ wFirma –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–¥–µ–ª–æ–∫ Pipedrive
- –ü–æ–∏—Å–∫/—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤ wFirma –ø–æ email
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ Pipedrive (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
- –†–∞—Å—á—ë—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π (50/50 –∏–ª–∏ 100%) –∏ –≤—Å—Ç–∞–≤–∫–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—á–µ—Ç–∞
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ (—ç—Ç–∏–∫–µ—Ç–æ–∫) –≤ wFirma –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ 16 —Å–∏–º–≤–æ–ª–∞–º–∏)
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ –ø–æ –≤–∞–ª—é—Ç–µ
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é (CLI / REST) –∏ —á–µ—Ä–µ–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

–ü–æ–ª–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–º. –≤ `docs/architecture.md` –∏ `docs/business-requirements.md`.

## –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç—Ä–∞–Ω

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–¥–æ–≤ —Å—Ç—Ä–∞–Ω –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ ISO –∫–æ–¥—ã:

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

**–ü–æ–ª—å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∏–∑ wFirma):**
- `Polska` ‚Üí `PL`
- `Niemcy` ‚Üí `DE`
- `Francja` ‚Üí `FR`
- `Wielka Brytania` ‚Üí `GB`
- `Stany Zjednoczone` ‚Üí `US`
- `Czechy` ‚Üí `CZ`
- `Litwa` ‚Üí `LT`
- `≈Åotwa` ‚Üí `LV`
- `Estonia` ‚Üí `EE`

**–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∏–∑ CRM):**
- `Poland` ‚Üí `PL`
- `Germany` ‚Üí `DE`
- `France` ‚Üí `FR`
- `United Kingdom` ‚Üí `GB`
- `United States` ‚Üí `US`
- `Czech Republic` ‚Üí `CZ`
- `Lithuania` ‚Üí `LT`
- `Latvia` ‚Üí `LV`
- `Estonia` ‚Üí `EE`

**ISO –∫–æ–¥—ã (–ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):**
- `PL`, `DE`, `FR`, `GB`, `US`, `CZ`, `LT`, `LV`, `EE`

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–§—É–Ω–∫—Ü–∏—è `normalizeCountryCode()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤ wFirma –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `env.example`:

```bash
# Pipedrive API Configuration
PIPEDRIVE_API_TOKEN=your_pipedrive_token
PIPEDRIVE_BASE_URL=https://api.pipedrive.com/v1

# wFirma API Configuration
WFIRMA_APP_KEY=your_app_key
WFIRMA_ACCESS_KEY=your_access_key
WFIRMA_SECRET_KEY=your_secret_key
WFIRMA_BASE_URL=https://api2.wfirma.pl

# Server Configuration
PORT=3000
NODE_ENV=development

# Stripe (live mode only)
STRIPE_API_KEY=sk_live_your_stripe_live_key

# Stripe Events (–æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç COMOON Events)
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (sk_live_...); –±–µ–∑ –Ω–µ–≥–æ –æ—Ç—á—ë—Ç—ã –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º
# –±—É–¥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç—É.
STRIPE_EVENTS_API_KEY=sk_live_your_events_key
STRIPE_EVENTS_CACHE_TTL_MS=600000
```

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç Stripe-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `npm run dev`.
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ health-check: `curl http://localhost:3000/api/stripe-health`.
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä: `node scripts/runStripeProcessor.js --deal <dealId>`.
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Stripe Checkout Session –ø–æ—è–≤–∏–ª–∞—Å—å –≤ dashboard –∏ –æ–ø–ª–∞—Ç–∞ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –æ—Ç—á—ë—Ç–∞—Ö (—Å–º. `specs/001-stripe-payment-processor/quickstart.md` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è).

### –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞ –≤ `config/bank-accounts.js`:

```javascript
const BANK_ACCOUNT_CONFIG = {
  PLN: {
    name: 'PL / konto firmowe - 2693',
    fallback: 'M bank zl'
  },
  EUR: {
    name: 'EUR / konto firmowe - 2801',
    fallback: 'M Bank EUR'
  }
};
```

## –ó–∞–ø—É—Å–∫

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npm run dev

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞
npm start
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç –º–∞–ø–ø–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω
node test-country-mapping.js

# –¢–µ—Å—Ç –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
node test-new-contractor-logic.js

# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è Proforma
node test-proforma-with-dynamic-banks.js
```

## –°–ª—É–∂–µ–±–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### Backfill –Ω–æ–º–µ—Ä–∞ –ø—Ä–æ—Ñ–æ—Ä–º—ã –≤ CRM

–°–∫—Ä–∏–ø—Ç `scripts/backfillInvoiceNumbers.js` –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–µ ¬´Invoice number¬ª –≤ —Å–¥–µ–ª–∫–∞—Ö Pipedrive –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase:

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–≤—ã–µ 50 —Å–¥–µ–ª–æ–∫ –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
node scripts/backfillInvoiceNumbers.js --dry-run --limit=50

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–¥–µ–ª–∫—É
node scripts/backfillInvoiceNumbers.js --deal=1234

# –ë–∞—Ç—á–µ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–ø–æ–º–Ω–∏—Ç–µ –ø—Ä–æ rate limit Pipedrive)
node scripts/backfillInvoiceNumbers.js --limit=100 --offset=0
```

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `PIPEDRIVE_API_TOKEN`, –∞ —Ç–∞–∫–∂–µ `SUPABASE_URL` –∏ `SUPABASE_SERVICE_ROLE_KEY`.

### Backfill —Å–≤—è–∑–µ–π –ø—Ä–æ—Ñ–æ—Ä–º–∞ ‚Üî —Å–¥–µ–ª–∫–∞

–°–∫—Ä–∏–ø—Ç `scripts/backfillProformaDealIds.js` –∑–µ—Ä–∫–∞–ª–∏—Ç –Ω–æ–º–µ—Ä —Å–¥–µ–ª–∫–∏ (`pipedrive_deal_id`) –≤ —Ç–∞–±–ª–∏—Ü—É `proformas` –ø–æ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–º—É –Ω–æ–º–µ—Ä—É –ø—Ä–æ—Ñ–æ—Ä–º—ã:

```bash
# –°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ CRM –∑–∞–ø–æ–ª–Ω–µ–Ω—ã Invoice number
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
node scripts/backfillProformaDealIds.js --dry-run --limit=200

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø—Ä–æ—Ñ–æ—Ä–º—É –ø–æ –Ω–æ–º–µ—Ä—É
node scripts/backfillProformaDealIds.js --invoice="CO-PROF 136/2025"

# –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω (–±–∞—Ç—á–∞–º–∏ –ø–æ 500 —Å–¥–µ–ª–æ–∫)
node scripts/backfillProformaDealIds.js --limit=500 --start=0
```

–°–∫—Ä–∏–ø—Ç —á–∏—Ç–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ Pipedrive –Ω–∞–ø—Ä—è–º—É—é, –ø–æ—ç—Ç–æ–º—É –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `PIPEDRIVE_API_TOKEN`, `SUPABASE_URL` –∏ `SUPABASE_SERVICE_ROLE_KEY`.

## API Endpoints

- `GET /api/status` - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
- `POST /api/invoice-processing/run` - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `POST /api/invoice-processing/deal/:id` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–¥–µ–ª–∫–∏
- `GET /api/invoice-processing/pending` - –°–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö —Å–¥–µ–ª–æ–∫

## –§—Ä–æ–Ω—Ç–µ–Ω–¥

–û—Ç–∫—Ä–æ–π—Ç–µ `frontend/index.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.



